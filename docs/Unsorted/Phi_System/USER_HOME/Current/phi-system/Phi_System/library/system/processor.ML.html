<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/system/processor.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/system/processor.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(* FILE: library/system/processor.ML
   AUTHOR: Qiyuan Xu

   Processor of IDE-CP. Processor is the core unit implementing the constructs in the programming
   of IDE-CP.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PHI_CP_IDE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>include</span></span></span><span> </span><span class="entity"><span>PHI_CP_IDE</span></span><span>

</span><span class="comment1"><span>(*** Syntax Processors ***)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> Bypass
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> ReParse </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Token.src</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Opr_Stack.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eval_cfg</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Opr_Stack.context</span></span><span class="main"><span>)</span></span><span> </span><span>parser</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trace </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>processor</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
    name </span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
    pos </span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span class="main"><span>,</span></span><span>
    priorirty </span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(*the priority when the processor will be invoked*)</span></span><span>
    precedence </span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(*the processor will not be applied until all pending operations in the
                        operator stack and of a higher precedence are processed.*)</span></span><span>
    pattern </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(*applied only when match the pattern*)</span></span><span>
    proc </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>proc</span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_parser </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> * </span><span class="entity"><span>processor</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> apply_processors </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Token.src</span><span>
                    </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.eval_cfg</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Opr_Stack.context</span></span><span>
                    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Opr_Stack.context</span></span><span> * </span><span>Token.T</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> eval_tokens </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.config</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
               </span><span class="main"><span>-&gt;</span></span><span> </span><span>Token.src</span><span>
               </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.expr_id</span></span><span> * </span><span class="entity"><span>Phi_Opr_Stack.context</span></span><span>
               </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.expr_id</span></span><span> * </span><span class="entity"><span>Phi_Opr_Stack.context</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> eval_line </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.config</span></span><span> * </span><span>int</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*auto level*)</span></span><span> * </span><span>int</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*auto level if no user input*)</span></span><span>
             </span><span class="main"><span>-&gt;</span></span><span> </span><span>Token.src</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> list </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>processor</span></span><span> </span><span>Ord_List.T</span><span> </span><span>Symtab.table</span><span>

</span><span class="comment1"><span>(*
val internal_process : context_state -&gt; context_state parser
val simple_process   : context_state -&gt; context_state parser
val powerful_process : (Proof.state -&gt; Proof.state) (*continue*)
                    -&gt; Token.T list -&gt; Proof.state -&gt; Proof.state
val powerful_process_p : int (*auto-level*) * int (*auto-level when no user input*)
                     -&gt; (Proof.state -&gt; Proof.state) (*continue*)
                     -&gt; (Proof.state -&gt; Proof.state) parser
                    (*if the input is empty, then powerful_process_p_inert does nothing*)
val process_by_input : int (*auto-level*) option -&gt; Token.T list -&gt; context_state -&gt; context_state
val process_no_input : int (*auto-level*) option -&gt; context_state -&gt; context_state
val process_all_antecedents : int (*auto-level*) option -&gt; context_state -&gt; context_state
val process_attr : attribute parser
*)</span></span><span>

</span><span class="comment1"><span>(* be activated only when auto level &gt;= 1 *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> almost_safe </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>proc</span></span><span>
</span><span class="comment1"><span>(* be activated only when auto level &gt;= 2 *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> not_safe </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>proc</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_auto_level </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>proc</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> long_idt_to_triangle </span><span class="main"><span>:</span></span><span> 'a </span><span>parser</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>parser</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> translate_tokens </span><span class="main"><span>:</span></span><span> </span><span>Token.src</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Token.src</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Phi_CP_IDE</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PHI_CP_IDE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Phi_CP_IDE</span><span>

</span><span class="comment1"><span>(*** Syntax Processors ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Bypass</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>ReParse</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Token.src</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="IDE_CP_Core.\&lt;phi&gt;trace_processing|attribute"><span>φtrace_processing</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>proc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Opr_Stack.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eval_cfg</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Opr_Stack.context</span></span><span class="main"><span>)</span></span><span> </span><span>parser</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>processor</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
    name </span><span class="main"><span>:</span></span><span> </span><span>string</span><span class="main"><span>,</span></span><span>
    pos </span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span class="main"><span>,</span></span><span>
    priorirty </span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(*the priority when the processor will be invoked*)</span></span><span>
    precedence </span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(*the processor will not be applied until all pending operations in the
                        operator stack and of a higher precedence are processed.*)</span></span><span>
    pattern </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(*applied only when match the pattern*)</span></span><span>
    proc </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>proc</span></span><span>
  </span><span class="main"><span>}</span></span><span>

</span><span class="comment1"><span>(*val proc_eq = (op =) o apply2 #name*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proc_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>prod_ord</span><span> </span><span>int_ord</span><span> </span><span>string_ord</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>priorirty </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>name </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>priorirty </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>name </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Processors</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory_Data</span><span>
</span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>processor</span></span><span> </span><span>Ord_List.T</span><span> </span><span>Symtab.table</span><span> </span><span class="comment1"><span>(*indexed by leading keywords*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.join</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Ord_List.merge</span><span> </span><span class="entity"><span>proc_ord</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>list</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Processors.get</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_parser</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>keywords</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>proc</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>keywords</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>keywords</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Processors.map</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Symtab.map_default</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Ord_List.insert</span><span> </span><span class="entity"><span>proc_ord</span></span><span> </span><span class="entity"><span>proc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>keywords</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_processors</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>processors</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Processors.get</span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>post_app</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.Post_App.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Theory</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>next</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>tok</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                             </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Token.kind_of</span><span> </span><span class="entity"><span>tok</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Token.Cartouche</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"&lt;cartouche&gt;"</span></span><span>
                                 </span><span class="main"><span>|</span></span><span> </span><span>Token.Nat</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"&lt;number&gt;"</span></span><span>
                                 </span><span class="main"><span>|</span></span><span> </span><span>Token.String</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"&lt;string&gt;"</span></span><span>
                                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Token.content_of</span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>processors</span></span><span> </span><span class="entity"><span>next</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ps</span></span><span>
                        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Symtab.lookup</span><span> </span><span class="entity"><span>processors</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span>
                                     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ps</span></span><span>
                                      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invoke</span></span><span> </span><span class="entity"><span>prec</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>try_app</span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>prec</span></span><span> </span><span>&lt;</span><span> </span><span class="main"><span>#</span></span><span>precedence </span><span class="entity"><span>p</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                       </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>PLPR_Pattern.matches</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                                                              </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pattern </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span> </span><span>Scan.permissive</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>proc </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                               </span><span>||</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Bypass</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                               </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_tokens</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="entity"><span>cfg</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>toks</span></span><span>
                               </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Phi_Opr_Stack.is_interrupted</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                    </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span>
                                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>post_app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_tokens</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="entity"><span>cfg</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span>
                                   </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Bypass</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ReParse</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="entity"><span>prec</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
      
               </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>get_first</span><span> </span><span class="entity"><span>try_app</span></span><span> </span><span class="entity"><span>ps</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>invoke</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>apply</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eval_tokens</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_token</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>apply_processors</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Working_Mode.mode1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>one_step</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Opr_Stack.eval_one_step</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>eid_opr_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eid_opr_ctxt</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expr_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Token.content_of</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expr_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>processors</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_token</span></span><span> </span><span class="entity"><span>toks</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prev_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ecfg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span class="main"><span>=</span></span><span class="entity"><span>expr_id</span></span><span class="main"><span>,</span></span><span> config</span><span class="main"><span>=</span></span><span class="entity"><span>cfg</span></span><span class="main"><span>,</span></span><span> toks</span><span class="main"><span>=</span></span><span class="entity"><span>toks</span></span><span class="main"><span>}</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>processors</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Opr_Stack.precedence_of</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ecfg</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>opr_ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>toks'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="entity"><span>toks'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uptick_expr_id</span></span><span> </span><span class="entity"><span>expr_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opr_ctxt'</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>one_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ecfg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prev_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span>
                                     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prev_name'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opr_ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prev_name'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opr_ctxt'</span></span><span class="main"><span>)</span></span><span>
                                      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>string_of</span><span> </span><span class="main"><span>(</span></span><span>
                                                    </span><span>chunks</span><span> </span><span class="main"><span>[</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"Do not know how to parse the given source"</span></span><span class="main"><span>,</span></span><span>
                                                            </span><span>Token.pretty_src</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>toks</span></span><span class="main"><span>]</span></span><span>
                                                       </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>apply</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>Markup.plain_text</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"&lt;begining-of-parsing&gt;"</span></span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>loop</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty_tokens</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>Token.is_eof</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>triangle_brace_keywords</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Keyword.add_minor_keywords</span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"‣"</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>"]"</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>"$"</span></span><span class="main"><span>,</span></span><span class="inner_quoted"><span>"!"</span></span><span class="main"><span>]</span></span><span> </span><span>Keyword.empty_keywords</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>translate_token</span></span><span> </span><span class="entity"><span>tok</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Token.content_of</span><span> </span><span class="entity"><span>tok</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="inner_quoted"><span>")."</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Token.explode</span><span> </span><span class="entity"><span>triangle_brace_keywords</span></span><span> </span><span class="main"><span>(</span></span><span>Token.pos_of</span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>")‣"</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"]."</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Token.explode</span><span> </span><span class="entity"><span>triangle_brace_keywords</span></span><span> </span><span class="main"><span>(</span></span><span>Token.pos_of</span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"]‣"</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>".$"</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Token.explode</span><span> </span><span class="entity"><span>triangle_brace_keywords</span></span><span> </span><span class="main"><span>(</span></span><span>Token.pos_of</span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"‣$"</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="inner_quoted"><span>"!."</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Token.explode</span><span> </span><span class="entity"><span>triangle_brace_keywords</span></span><span> </span><span class="main"><span>(</span></span><span>Token.pos_of</span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"!‣"</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>translate_tokens</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>translate_tokens</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tok</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>translate_token</span></span><span> </span><span class="entity"><span>tok</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>toks'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>toks'</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>translate_tokens</span></span><span> </span><span class="entity"><span>toks</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tok</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>translate_tokens</span></span><span> </span><span class="entity"><span>toks</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eval_line</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cfg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>auto_lev</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>auto_lev_no_input</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Phi_CP_IDE.call_of_state_sequent</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>stat0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>translate_tokens</span></span><span> </span><span class="entity"><span>toks</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>auto_lev</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>empty_tokens</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>auto_lev_no_input</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>auto_lev</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>auto_lev</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Config.put</span><span> </span><span class="entity"><span>Phi_Reasoner.auto_level</span></span><span> </span><span class="entity"><span>lev</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stat0</span></span><span>
                                   </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>stat0</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span class="entity"><span>Phi_ID.next</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>oprs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Phi_Opr_Stack.Data.get</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expr_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>initial_expr_id</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Opr_Stack.Begin_of_Line.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                                          </span><span class="main"><span>{</span></span><span>id</span><span class="main"><span>=</span></span><span class="entity"><span>expr_id</span></span><span class="main"><span>,</span></span><span> config</span><span class="main"><span>=</span></span><span class="entity"><span>cfg</span></span><span class="main"><span>,</span></span><span> toks</span><span class="main"><span>=</span></span><span class="entity"><span>toks</span></span><span class="main"><span>}</span></span><span>
                                                          </span><span class="entity"><span>opr_ctxt</span></span><span>
                    </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Opr_Stack.uninitialize</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expr_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uptick_expr_id</span></span><span> </span><span class="entity"><span>expr_id</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_CP_IDE.Post_App.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>stat0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span class="main"><span>=</span></span><span class="entity"><span>expr_id</span></span><span class="main"><span>,</span></span><span> config</span><span class="main"><span>=</span></span><span class="entity"><span>cfg</span></span><span class="main"><span>,</span></span><span> toks</span><span class="main"><span>=</span></span><span class="entity"><span>toks</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expr_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uptick_expr_id</span></span><span> </span><span class="entity"><span>expr_id</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expr_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>empty_tokens</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expr_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span>
                                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>eval_tokens</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expr_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expr_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uptick_expr_id</span></span><span> </span><span class="entity"><span>expr_id</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Opr_Stack.end_expression</span></span><span> </span><span class="main"><span>{</span></span><span>id</span><span class="main"><span>=</span></span><span class="entity"><span>expr_id</span></span><span class="main"><span>,</span></span><span> config</span><span class="main"><span>=</span></span><span class="entity"><span>cfg</span></span><span class="main"><span>,</span></span><span> toks</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
                                                    </span><span class="entity"><span>opr_ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expr_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>uptick_expr_id</span></span><span> </span><span class="entity"><span>expr_id</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Opr_Stack.End_of_Line.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                                        </span><span class="main"><span>{</span></span><span>id</span><span class="main"><span>=</span></span><span class="entity"><span>expr_id</span></span><span class="main"><span>,</span></span><span> config</span><span class="main"><span>=</span></span><span class="entity"><span>cfg</span></span><span class="main"><span>,</span></span><span> toks</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span> </span><span>Phi_Opr_Stack.Data.put</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span>
                                   </span><span>#&gt;</span><span> </span><span>Config.restore</span><span> </span><span class="entity"><span>Phi_Reasoner.auto_level</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>stat0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Phi_Opr_Stack.precedence_of</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="inner_quoted"><span>"The expression does not end"</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
        </span><span>snd</span><span> </span><span class="entity"><span>opr_ctxt</span></span><span>
     </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Phi_Opr_Stack.Data.put</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*

exception Processed of (context_state * Token.T list)

fun eof_wrap parse [] = (fst (parse [Token.eof]), [])
  | eof_wrap parse toks = parse toks

fun process_impl procs =
  let fun eval toks proc stat = ()
      fun eval toks candidate_procs stat = ()
      fun process stat [] _ = stat
        | process stat toks step_num =
        let val tok = hd toks
            
         in ()
        end
   in ()
  end

fun process_impl procs (stat,toks) step_num =
      let
        val stat' = fold (fn (_, Processor {binding, pattern, proc,...}) =&gt; fn (ctxt,sequent) =&gt;
          if exists (fn pat =&gt;
                matches (Proof_Context.theory_of ctxt) pat (Thm.prop_of sequent)
             ) pattern
          then let
            val _ = if step_num &gt; 1000 then error "too deep process" else ();
            val (execute,toks) =
              eof_wrap (proc (ctxt,sequent) || (fn _ =&gt; raise Bypass NONE)) toks
            val _ = if Config.get ctxt trace
                    then tracing ("φprocess: " ^ Binding.print binding)
                    else ()
            in
            raise Processed (execute step_num, toks)
              handle Process_State_Call (meta,f) =&gt; raise Process_State_Call' (toks,meta,f)
                   | Terminate_Process (stat,f) =&gt; raise Terminate_Process' (toks,stat,f)
            end handle Bypass NONE =&gt; (ctxt,sequent)
              | Bypass (SOME stat') =&gt; stat'
              | Processed stat_toks =&gt; raise Processed stat_toks
              | Process_State_Call' arg =&gt; raise Process_State_Call' arg
          else (ctxt,sequent)) procs stat
      in (stat',toks)
      end
      handle Processed stat_toks =&gt; process_impl procs stat_toks (step_num + 1)
        | NDBG sequent =&gt; ((fst stat, sequent),[Token.eof])

fun internal_process (ctxt,sequent) toks =
  Runtime.exn_trace (fn _ =&gt;
  process_impl
    (Data.get (Context.Proof ctxt) |&gt; Name_Space.dest_table |&gt; sort (proc_ord o apply2 snd))
    ((ctxt,sequent),toks) 0)

fun simple_process stat toks =
  internal_process stat toks
  handle Process_State_Call' (toks,stat,_) =&gt; raise Fail "state call is not supported in simple process"
       | Terminate_Process'  (toks,stat,NONE) =&gt; (stat,toks)
       | Terminate_Process'  (toks,stat,SOME _) =&gt; raise Fail "state call is not supported in simple process"

fun powerful_process continue toks stat =
  let
    val sequent = Phi_Envir.the_state_sequent stat
  in
    stat
      |&gt; Proof.map_context_result (fn ctxt =&gt;
            (internal_process (ctxt,sequent) --| Scan.catch Parse.eof) toks
              |&gt; (fn ((ctxt,sequent),_) =&gt; (sequent,ctxt))
          )
      |-&gt; Phi_Envir.set_state_sequent
      |&gt; continue
    handle Process_State_Call' (toks,(ctxt,sequent),f) =&gt;
              powerful_process continue toks
                  (stat |&gt; Proof.map_context (K ctxt)
                        |&gt; Phi_Envir.set_state_sequent sequent
                        |&gt; f)
         | Terminate_Process' (toks,(ctxt,sequent), f) =&gt;
              (Scan.catch Parse.eof toks;
               stat |&gt; Proof.map_context (K ctxt)
                    |&gt; Phi_Envir.set_state_sequent sequent
                    |&gt; (case f of SOME f' =&gt; f' continue | _ =&gt; I))
  end


fun powerful_process_p_internal' lev continue toks s =
  if Phi_Envir.under_programming_environ (Proof.context_of s)
  then s |&gt; Proof.map_context (Config.put Phi_Reasoner.auto_level lev)
         |&gt; powerful_process continue (toks @ [Token.eof])
  else if Token.is_eof (hd toks)
       then s
       else error "Not in the φ programming environment"

fun powerful_process_p (lev1,lev2) continue toks =
      (if Token.is_eof (hd toks)
       then (if lev2 &lt; 0 then I else powerful_process_p_internal' lev2 continue toks)
       else powerful_process_p_internal' lev1 continue toks
      ,if Token.is_eof (hd toks) then [Token.eof] else [])


fun process_by_input lev tokens stat =
      let val stat' = case lev of SOME lv =&gt; apfst (Config.put Phi_Reasoner.auto_level lv) stat
                                | NONE =&gt; stat
       in simple_process stat' (tokens @ [Token.eof]) |&gt; #1 end
fun process_no_input lev = process_by_input lev []

fun process_all_antecedents lev s =
  let val (ctxt',sequent') = process_no_input lev s
   in if #constr_is_ready (Phi_Working_Mode.mode1 (fst s)) (Thm.prop_of sequent')
      then (ctxt',sequent')
      else error (Pretty.string_of (
        let val ant = Phi_Help.leading_antecedent' sequent'
         in case ant
              of Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹Trueprop›, _) $ (Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹Premise›, _) $ _ $ G) =&gt;
                  Pretty.chunks [
                    Pretty.str "Fail to solve obligation:",
                    Syntax.pretty_term ctxt' G,
                    Pretty.str "You may need to prove its obligations manually using <span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span>‹certified›."
                  ]
               | _ =&gt;
                  Pretty.chunks [
                    Pretty.str "Fail to solve reasoner job:",
                    Syntax.pretty_term ctxt' ant,
                    Pretty.str "It usually means you are doing unexpected operation."
                  ]
        end))
  end

*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>read_prop_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.read_props</span><span> </span><span>o</span><span> </span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_pattern</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_priority</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_precedence</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>keywords</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_pattern</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>proc</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt_parse'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.add_fixes_cmd</span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>read_prop_pattern</span></span><span> </span><span class="entity"><span>ctxt_parse'</span></span><span> </span><span class="entity"><span>raw_pattern</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Reasoner_Group.check_group</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span>Context.Theory</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_priority</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>precedence</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Reasoner_Group.check_group</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span>Context.Theory</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_precedence</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ML_Syntax</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>thy</span></span><span> </span><span>|&gt;</span><span> </span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span>ML_Context.expression</span><span> </span><span class="main"><span>(</span></span><span>Input.pos_of</span><span> </span><span class="entity"><span>proc</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span>ML_Lex.read</span><span>
          </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"Theory.setup (Phi_CP_IDE.add_parser ("</span></span><span class="main"><span>,</span></span><span>
           </span><span>print_strings</span><span> </span><span class="entity"><span>keywords</span></span><span class="main"><span>,</span></span><span>
           </span><span class="inner_quoted"><span>", {name="</span></span><span class="main"><span>,</span></span><span> </span><span>print_string</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>print</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="inner_quoted"><span>", pos="</span></span><span class="main"><span>,</span></span><span> </span><span>print_position</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span>
           </span><span class="inner_quoted"><span>", priorirty="</span></span><span class="main"><span>,</span></span><span> </span><span>print_int</span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span>
           </span><span class="inner_quoted"><span>", precedence="</span></span><span class="main"><span>,</span></span><span> </span><span>print_int</span><span> </span><span class="entity"><span>precedence</span></span><span class="main"><span>,</span></span><span>
           </span><span class="inner_quoted"><span>", pattern="</span></span><span class="main"><span>,</span></span><span> </span><span>print_list</span><span> </span><span>print_term</span><span> </span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span>
           </span><span class="inner_quoted"><span>", proc= let in ("</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
          </span><span>ML_Lex.read_source</span><span> </span><span class="entity"><span>proc</span></span><span> </span><span>@</span><span>
          </span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>") : Phi_CP_IDE.proc end}))"</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>almost_safe</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Phi_Reasoner.auto_level</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Bypass</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>not_safe</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Phi_Reasoner.auto_level</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Bypass</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_auto_level</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proc</span></span><span class="main"><span>:</span></span><span class="entity"><span>proc</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
    </span><span class="entity"><span>proc</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Reasoner.reduce_auto_level</span></span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Phi_Reasoner.auto_level</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>φlang_parser</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"define φlang_parser"</span></span><span>
      </span><span class="main"><span>(</span></span><span>  </span><span>Parse.name_position</span><span>
      </span><span>--</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>Reasoner_Group.parser</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>,</span></span><span>›</span></span></span><span> </span><span>--</span><span> </span><span class="entity"><span>Reasoner_Group.parser</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span>
      </span><span>--</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>[</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.list</span><span> </span><span>Parse.name</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>]</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span>
      </span><span>--</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.enum1</span><span> </span><span class="inner_quoted"><span>"|"</span></span><span> </span><span>Parse.term</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span> </span><span class="main"><span>)</span></span><span>
      </span><span>--</span><span> </span><span>Parse.for_fixes</span><span> </span><span>--</span><span> </span><span>Parse.ML_source</span><span>
        </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Toplevel.theory</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>setup_cmd</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>triangle_keywords</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Keyword.add_minor_keywords</span><span> </span><span class="main"><span>[</span></span><span class="inner_quoted"><span>"‣"</span></span><span class="main"><span>]</span></span><span> </span><span>Keyword.empty_keywords</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>long_idt_to_triangle</span></span><span> </span><span class="entity"><span>parse</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>translate</span></span><span> </span><span class="entity"><span>tok</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>String.translate</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="inner_quoted"><span>#"."</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"‣"</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>String.str</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Token.unparse</span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>Token.explode</span><span> </span><span class="entity"><span>triangle_keywords</span></span><span> </span><span class="main"><span>(</span></span><span>Token.pos_of</span><span> </span><span class="entity"><span>tok</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>toks</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>parse</span></span><span> </span><span class="entity"><span>toks</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>tok</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Token.kind_of</span><span> </span><span class="entity"><span>tok</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Token.Long_Ident</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>parse</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate</span></span><span> </span><span class="entity"><span>tok</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>parse</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>translate</span></span><span> </span><span class="entity"><span>tok</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>