<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/phi_type_algebra/deriver_framework.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/phi_type_algebra/deriver_framework.ML›</h1>
</div>

<pre class="source"><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PHI_TYPE_ALGEBRA_DERIVERS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>include</span></span></span><span> </span><span class="entity"><span>PHI_TYPE_ALGEBRA_DERIVERS</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span>

</span><span class="comment1"><span>(*** A common framework to build derivers fast ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>induct_inst_params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span>option</span><span> </span><span>list</span><span>
</span><span class="comment1"><span>(*parameters of the phi-type in the *reversed* order with the abstract object prepended to the begining,
  i.e., induct_inst_params[0] is the abstract object, induct_inst_params[i] is the $(n-i)$th parameter
  is there are $n$ parameters in total.
  all must be free variables.
  they are used to instantiate the induction rule.
  If certain parameter is not a fixed free variable in the goal (e.g.,
  represented by a universally quantified variable), preserve its place
  and set it to None.
  The first element must be the abstract object or None.*)</span></span><span>

</span><span class="comment1"><span>(** Component: unify_hint **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>parse_hint</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>  </span><span class="entity"><span>hint</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="comment1"><span>(*of the phi-typ const*)</span></span><span> * </span><span class="entity"><span>induct_inst_params</span></span><span> * </span><span class="entity"><span>hint</span></span><span>

</span><span class="comment1"><span>(* Common choices of the unification *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> malformed_hint </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_inst_params_from_phi_term </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>induct_inst_params</span></span><span>
</span><span class="comment1"><span>(*default parsing*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_hint </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*extract the phi-type part from the hint. can be either the type assertion,
                                  the type itself, or the type operator*)</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>parse_hint</span></span><span>

</span><span class="comment1"><span>(** Component: guess_property **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>guess_property</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
        </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*antecedents*)</span></span><span>
        * </span><span>term</span><span> </span><span class="comment1"><span>(*conclusion*)</span></span><span>
        * </span><span class="entity"><span>induct_inst_params</span></span><span>
        * </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>

</span><span class="comment1"><span>(*If user gives no hint, we need to guess the property to be reasoned.
  The `guess_property` may guess the abstract operator from the logic type of the abstract
  object (e.g. by Bounded Natural Functor) or by any other means. It can also instantiate any logic
  types in `x ⦂ T` and the `phi_type`, maybe into a smaller sort (e.g. from ‹?'a::type› to ‹?'a::one›).
  It can return terms containing schematic variables, and there is no requirement on the index.
*)</span></span><span>

</span><span class="comment1"><span>(* Guess from BNF *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> guess_operator </span><span class="main"><span>:</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> * </span><span>typ</span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span>list</span><span> * </span><span class="entity"><span>eBNF_Info.eBNF</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span class="main"><span>)</span></span><span>
            </span><span class="comment1"><span>(*make the operator and configure any necessary reasoning like adding simplification rules *)</span></span><span>
     </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*check if the type is alive meaning if it is to guess the operator for it recursively*)</span></span><span>
     </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*if the type is not alive, make the operator for this type*)</span></span><span>
     </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*make the operator for an atom type*)</span></span><span>
     </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*known operators and their types*)</span></span><span>
     </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="comment1"><span>(*target type*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> guess_set_opr </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="comment1"><span>(*container type*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="comment1"><span>(*the target element type*)</span></span><span>
                                  </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> guess_self_rel </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*known operators*)</span></span><span>
                                   </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="comment1"><span>(*container type*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> guess_predicate </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*known predicates*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> guess_rel_mapper </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*dead_opr*)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*f*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
                            </span><span>typ</span><span> </span><span class="comment1"><span>(*container type*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*the target element types*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
                            </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>
         </span><span class="comment1"><span>(*return the relation mapper from the container type T to f(T), which maps the inner element
              of type U to f(U)*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> guess_func_mapper </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*f*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="comment1"><span>(*container*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*the target elements*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> guess_pred_mapper </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span>typ</span><span> </span><span class="comment1"><span>(*container*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*the target elements*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> zip_typ </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span>
  </span><span class="comment1"><span>(* zip(T(a1,int,U(a3),W(nat,a4)) , T(b1,int,U(b3),W(nat,b4))) = T(a1*b1, int, U(a3*b3), W(nat,a4*b4))
     The zip only zips type variables (either fixed or schematic).*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unzip_typ </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> * </span><span>typ</span><span>
  </span><span class="comment1"><span>(*The inverse function of zip_typ*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> guess_zip_guided </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*true for zip, false for unzip*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
                       </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="comment1"><span>(*the target element types*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
                       </span><span>typ</span><span> * </span><span>typ</span><span> </span><span class="comment1"><span>(*container types*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
                       </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*domain constraining the arguments of the zip or the unzip*)</span></span><span>
                                        * </span><span>term</span><span> </span><span class="comment1"><span>(*the zip or the unzip*)</span></span><span class="main"><span>)</span></span><span>
                                        * </span><span class="entity"><span>Proof.context</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make_forall_quantified_property </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span class="comment1"><span>(*x_ty*)</span></span><span> * </span><span>typ</span><span> </span><span class="comment1"><span>(*model_ty*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*x*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*T*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*the property*)</span></span><span class="main"><span>)</span></span><span>
                                   </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*the φ-type operator*)</span></span><span>
                                   </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> make_forall_quantified_property_for_parameters_of_a_phi_type </span><span class="main"><span>:</span></span><span>
        </span><span class="main"><span>(</span></span><span>typ</span><span> </span><span class="comment1"><span>(*x_ty*)</span></span><span> * </span><span>typ</span><span> </span><span class="comment1"><span>(*model_ty*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*x*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*T*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*the property*)</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span>

</span><span class="comment1"><span>(* Guessing via φ-LPR, a framework *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoning_goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*the proposition of the reasoning goal*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>parse_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="comment1"><span>(*parses the result of the reasoning*)</span></span><span>
        </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*conclusion of the guessed property*)</span></span><span> *
               </span><span class="entity"><span>induct_inst_params</span></span><span> *
               </span><span>term</span><span> </span><span class="comment1"><span>(*conditions augmenting the antecedents*)</span></span><span> *
               </span><span>term</span><span> </span><span class="comment1"><span>(*(conjuncted) antecedents*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> Guess_Framework </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi_type</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoning_goal</span></span><span> * </span><span class="entity"><span>parse_result</span></span><span> * </span><span class="entity"><span>phi_type</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>guess_property</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> Guess_Framework' </span><span class="main"><span>:</span></span><span>
        </span><span>term</span><span> </span><span class="comment1"><span>(*template of the reasoning goal, containing schematic variables*)</span></span><span>
      * </span><span class="main"><span>(</span></span><span class="entity"><span>phi_type</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span>
           </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*instantiations of the template of the reasoning goal*)</span></span><span>
              * </span><span class="entity"><span>phi_type</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span>
      * </span><span>term</span><span> </span><span class="comment1"><span>(*a rule parsing the result of the reasoning, of form
            ‹(Result_of_Reasoning, Conclusion_of_Property, T x, conditions_of_antecedents, antecedents)›
            The ‹T x› is used to parse the instantiation parameteres of induction rule (by parse_inst_params_from_phi_term,
              where dummy variable can be used as place holders for parameteres that have no instantiation)*)</span></span><span>
      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>guess_property</span></span><span>

</span><span class="comment1"><span>(** Load Simpset **)</span></span><span>

</span><span class="comment1"><span>(*The simplification that unfolds the recursive φ-types and derives induction-hypothetic ToAs,
  uses a specific simpset instead of the default global to prevent over-simplification.
  The reasoning should only load the simplification rules of the used object operators (mapper or predicator etc).
  Bellow they are loaders of the operators.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> load_ss </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*set*)</span></span><span> * </span><span>bool</span><span> </span><span class="comment1"><span>(*pred*)</span></span><span> * </span><span>bool</span><span> </span><span class="comment1"><span>(*rel*)</span></span><span> * </span><span>bool</span><span> </span><span class="comment1"><span>(*map*)</span></span><span> * </span><span>bool</span><span> </span><span class="comment1"><span>(*zip*)</span></span><span>
           </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>eBNF_Info.eBNF</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> load_simpset </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
  </span><span class="comment1"><span>(*Given any object expressions, it parses the object operators used inside,
    and load the related simplification settings*)</span></span><span>



</span><span class="comment1"><span>(** A framework for deriving properties **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ind_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoning</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ind_insts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span>option</span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>list</span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ind_inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Subgoal.focus</span></span><span>
              * </span><span>term</span><span> </span><span>option</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*parameters of phi-type, if fixed*)</span></span><span>
              * </span><span class="entity"><span>phi_type</span></span><span>
              * </span><span>thm</span><span> </span><span class="comment1"><span>(*local sequent*)</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ind_insts</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arbitrary_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Subgoal.focus</span></span><span>
                   </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*user hints*)</span></span><span>
                   </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*user hints*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>subgoal_configure</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ind_inst</span></span><span> * </span><span class="entity"><span>arbitrary_args</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*If not given, no induction will be applied*)</span></span><span>
                       * </span><span class="entity"><span>ind_conv</span></span><span>
                       * </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Type.phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoning</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>solver</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span> * </span><span>thm</span><span> * </span><span class="entity"><span>Method.text</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>simplifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pre_simplifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

</span><span class="comment1"><span>(*Main Entry Point*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> deriving_framework </span><span class="main"><span>:</span></span><span>
      </span><span>string</span><span> </span><span class="comment1"><span>(*property name used in proof cache and Isabelle binding*)</span></span><span>
    * </span><span class="entity"><span>parse_hint</span></span><span>
    * </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*extract_oprs_from_hint*)</span></span><span>
    * </span><span class="entity"><span>guess_property</span></span><span>
    * </span><span>thm</span><span> </span><span class="comment1"><span>(*rule*)</span></span><span>
    * </span><span class="entity"><span>subgoal_configure</span></span><span> </span><span>list</span><span>
    * </span><span class="entity"><span>solver</span></span><span>
    * </span><span class="entity"><span>pre_simplifier</span></span><span> </span><span class="comment1"><span>(*simplifying the reasoning sequent before induction*)</span></span><span>
    * </span><span class="entity"><span>simplifier</span></span><span> </span><span class="comment1"><span>(*final simplification*)</span></span><span>
   </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span>
   </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span>
   </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>Seq.seq</span><span>

</span><span class="comment1"><span>(* Besides the parameters explained above,
  extract_oprs_from_hint allows user to indicate what are the mapper, predicator or other operators in
  the given hint, so that we can load reasoning configures like simplification sets binding on the
  operators (e.g., the simplification rules of the related BNF)

  `rule` is a PLPR reasoning rule describing how to derive the target property in detail, in the following form,
  ` ( &lt;the leading antecedent is the one to which induction applies&gt; ⟹
      &lt;some optional antecedents, but no induction will be applied on them&gt; ⟹
      𝗋Success (*terminates the deriving successfully*)
    ) (*repeats as a deriving can invole multiple subgoals*) ⟹
    𝗈𝖻𝗅𝗂𝗀𝖺𝗍𝗂𝗈𝗇 True (*stores the generated proof obligations*) ⟹
    &lt;derived property&gt;`

  A deriving may contain multiple subgoals, and for each subgoal, a configure describes it.
  The configure consists of an optional induction description and a reasoning description.
  It provides supports for applying induction at most once for each goal, but more induction
  can be applied manually.

  Induction description:

  The leading antecedent can be universally quantified by ⋀, the parameter `quant_interps` decides
    how to interpret the quantified variables in a *reversed* order.
  For the last $i$th variable (actually $i$ is the variable's de brujin index),
    quant_interps[i] = 0 means to interpret the variable as the abstract object and therefore the
        induction can destruct it according to the induction rule in the phi_type
    quant_interps[i] = j means to interpret the variable as the j-th parameter of the φ-type
    quant_interps[i] = ~1 means to interpret it as a fixed variable

  `ind_conv` : applies conversion and simplification on the induction rule.
  If not given, no induction will be applied.
  The default_ind_conv parses the induction hypotheses and conclusions, and supports to apply different
    conversion on them.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_ind_inst </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*fixed bound params*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>option</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ind_inst</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_ind_conv </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*converting induction hypotheses*)</span></span><span> *
                       </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*converting subgoals of the induction*)</span></span><span>
                    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ind_conv</span></span><span>

</span><span class="comment1"><span>(*To use `default_ind_conv`, you must tag the leading antecedent of the `rule` by `φTA_subgoal`,
  or else `default_ind_conv` cannot find which one is the induction hypothesis,
  see @{thm φTA_SH<span class="hidden">⇩</span><sub>I</sub>_rule} as an example.*)</span></span><span>

</span><span class="comment1"><span>(** Reasoning **)</span></span><span>
</span><span class="comment1"><span>(*`reasoning` specifies how to solve the reasoning goals in detail.*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>varifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cterm</span><span> </span><span>Vars.table</span><span> * </span><span class="entity"><span>Subgoal.focus</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoning_configure_ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoning_configure</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> * </span><span class="entity"><span>Subgoal.focus</span></span><span> * </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span>
                        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoning_configure_ret</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> varify_all_vars </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>varifier</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_reasoning </span><span class="main"><span>:</span></span><span>
        </span><span>bool</span><span> </span><span class="comment1"><span>(*to split the goals when they contain HOL.disj in antecedents, no matter if the conclusion
               contains schematic variables. it is false by default*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
        </span><span class="entity"><span>reasoning_configure</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>varifier</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoning</span></span><span>
</span><span class="comment1"><span>(*It is a general framework using φ-LPR and Isar subgoal tool.
  Because it uses Isar subgoal, it fixes all schematic variables. Users may expect the reasoning
  to infer some schematic variables. If so, `varifier` is used.
  Given a term, `varifier` returns the subterms that should be schematic variables, and
                a function substituting schematic variables for those subterms.

  `reasoning_configure` parses the role of local premises.
  It receives the subgoal context, local premises, local sequent, and should classify the local premises
  into three sorts, pure conditions, rewrites and reasoners respectively.
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pure_PLPR_reasoning </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoning</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pure_PLPR_reasoner </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>reasoner</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> exhaustive_PLPR_reasoner </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*chk*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="comment1"><span>(*TODO: supports chk*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> exhaustive_PLPR_reasoner_by_rule </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*chk*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoner</span></span><span>
  </span><span class="comment1"><span>(*The chk may check if the ith argument of the target reasoning goal is in a good form and
    raises warning if not*)</span></span><span>

</span><span class="comment1"><span>(* Default Reasoning Configure *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_reasoning_configure </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>reasoning_configure</span></span><span>
</span><span class="comment1"><span>(*classify local premises by syntactic tags. allows to extract additional local condition
  by Phi_Reasoners.extraction.

  It also recognizes premises tagged by φTA_pure_facts and φTA_conditioned_ToA_template.
  φTA_conditioned_ToA_template rules are conditioned by pure propositions which are solved and
  instantiated (to potentially multiple versions, if containing any schematic variables) by
  collecting pure facts tagged by φTA_pure_facts.
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pass_make_ToA </span><span class="main"><span>:</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Reasoner_Group.group</span></span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoning_configure_ret</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoning_configure_ret</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pass_make_ToA_default </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>reasoning_configure_ret</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoning_configure_ret</span></span><span>

</span><span class="comment1"><span>(** Solver **)</span></span><span>

</span><span class="comment1"><span>(*The `solver` optionally solves the proof obligation. It can return NONE to fallback to the
  default Auto_Sledgehammer solver.

  When the object operators are given by the hint, the proof obligations should contain no
    undetermined schematic variable and Auto_Sledgehammer is good in this case.
  When no hint is given, a deriver can provide a solver that infers the object operators
    and perhaps call the fallback sledgehammer solver after it.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> oblg_solver </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Method.text</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="comment1"><span>(*the default Sledgehammer solver*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> oblg_solver'</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>solver</span></span><span>

</span><span class="comment1"><span>(** Simplifier **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_simplifier </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi_type</span></span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*contextual boolean facts, extracted from antecedents*)</span></span><span>
                            </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>simplifier</span></span><span>
    </span><span class="comment1"><span>(*extracts boolean facts from the antecedents of the rule to simplify the rule*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_simplifier' </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>simplifier</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> simplifier_by_cong </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*congruence rules*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>simplifier</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> simplifier_by_LPR </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi_type</span></span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>simplifier</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> simplifier_by_LPR' </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>simplifier</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_pre_simplifier </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Type.phi_type</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pre_simplifier</span></span><span>

</span><span class="comment1"><span>(** A framework of deriver **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>hint_mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ACCEPT_NO_HINT</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ACCEPT_ONE_HINT</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ACCEPT_ANY_HINTS</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>REQUIRE_EXACT_ONE_HINT</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>REQUIRE_HINTS</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>multiple_call</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ONLY_ONCE</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ONLY_ONCE_IF_NO_HINT</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>MULTIPLE_TIMES</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>quiet</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>bool</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> deriver_framework </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>hint_mode</span></span><span> * </span><span class="entity"><span>multiple_call</span></span><span> * </span><span>string</span><span> </span><span class="comment1"><span>(*name*)</span></span><span>
                     </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>   </span><span>int</span><span> </span><span class="comment1"><span>(*the times that the deriver has been invoked*)</span></span><span>
                          * </span><span>string</span><span> </span><span class="comment1"><span>(*name suffixed by the time*)</span></span><span>
                          </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span>
                          </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span>
                          </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
                          </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*derived rule*)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>quiet</span></span><span> * </span><span>Position.T</span><span>
                     </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span> </span><span>list</span><span>
                     </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Type.derive</span></span><span>
</span><span class="comment1"><span>(*This simple framework handles the issue of invoking a deriver by multiple times,
  and also checks if the proper number of hints are given.
  Then it calls the given diver for each hint one by one, or call it by NONE is no hint is given.

  When the deriver is invoked more than once, the name is suffixed by an index to differentiate the
  binding of the resulted rule among the callings.

  The derived rule will be stored into φ-Type library but I will not bind it into the Isabelle environment.

  If `quiet` is turned on, no error will be printed and it returns silently with doing nothing,
  even when the deriver raises Automation_Fail.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> deriver_framework_no_hints </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>multiple_call</span></span><span> * </span><span>string</span><span> </span><span class="comment1"><span>(*name*)</span></span><span>
                     </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span class="comment1"><span>(*name*)</span></span><span>
                          </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span>
                          </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
                          </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*derived rule*)</span></span><span> * </span><span>local_theory</span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>quiet</span></span><span> * </span><span>Position.T</span><span>
                     </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Type.derive</span></span><span>

</span><span class="comment1"><span>(** Misc Tools / Unsorted **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> Automation_Fail </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> guess_fail </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a

</span><span class="comment1"><span>(*convention: do not add transformation_refl any time! *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> equip_expansion_ss0 </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> equip_expansion_ss  </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> case_split_simproc </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>simproc</span><span>

</span><span class="comment1"><span>(*
val accept : (hint option -&gt; Phi_Type.derive) -&gt; hint list -&gt; Phi_Type.derive
val accept_one : string (*name for printing*) -&gt;
      (hint option -&gt; Phi_Type.derive) -&gt;
       hint list -&gt; Phi_Type.derive
    (*wraps and checks if the user gives at most one hint*)
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> chk_unfolded </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*bads*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> conv_chk_unfolded </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>
      </span><span class="comment1"><span>(*roughly check if a phi-type expression is expanded, and warn if not.
        The bads are constants whose occurrence indicates the φ-type is not expanded*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> chk_abstract_object_quantified </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*get the abstract object*)</span></span><span>
                                  </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lift_types_sort </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span> * </span><span>sort</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>TVars.table</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> wrap_ind_target </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(**** Implementation ****)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Phi_Type_Derivers</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PHI_TYPE_ALGEBRA_DERIVERS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Phi_Type</span><span> </span><span>Phi_Type_Derivers</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span>

</span><span class="comment1"><span>(** Library **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess_fail</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>[</span></span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"Fail to guess the form of the property for φ-type"</span></span><span> </span><span>@</span><span>
            </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span>@</span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>induct_inst_params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span>option</span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>guess_property</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
        </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span>term</span><span> * </span><span>term</span><span> </span><span>option</span><span> </span><span>list</span><span> * </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lift_types_sort</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>typ_sorts</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Phi_Help.lift_types_sort</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>typ_sorts</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Phi_Help.LIFT_FAIL</span></span><span> </span><span class="entity"><span>ty_sorts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>paragraph</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"Fail to constrain type "</span></span><span> </span><span>@</span><span>
                  </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_typ_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
                  </span><span>text</span><span> </span><span class="inner_quoted"><span>"by sort"</span></span><span> </span><span>@</span><span>
                  </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_sort_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>sort</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ty_sorts</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_inst_params_from_phi_term</span></span><span> </span><span class="entity"><span>phity</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.strip_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.beta_eta_contract_term</span></span><span> </span><span class="entity"><span>phity</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"parse_inst_params_from_phi_term"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>phity</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Bound</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.is_dummy_pattern</span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(** Simplification Rules unfolding the constrains and conditions **)</span></span><span>

</span><span class="comment1"><span>(*
structure Type_specific_Simps = Generic_Data (
  type T = thm Net.net
  val empty = Net.empty
  val merge = Net.merge pointer_eq
)

exception Parse_Fail of string list

fun parse_which_type_for_the_rule rule =
  let val exclude = [<span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span>‹bool›, <span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span>‹nat›, <span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span>‹int›, <span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span>‹prop›, <span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span>‹fun›, <span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span>‹set›]
      fun fold_type_const f =
        let fun fld (Type (Tname, Targs)) x = fold fld Targs (f Tname x)
              | fld _ x = x
         in fld
        end
      fun add_tyconst tm = fold_types (fold_type_const (fn Tname =&gt;
              if member (op =) exclude Tname then I else insert (op =) Tname)) tm []
      val tyconsts = add_tyconst (Thm.concl_of rule)
   in case tyconsts
   of [tycon] =&gt; tycon
    | L =&gt; raise Parse_Fail L
  end

fun add_type_specific_simp (Tname, rules) ctxt =
  Type_specific_Simps.map (fold (fn rule =&gt;
      Net.insert_term (Thm.equiv_thm (Context.theory_of ctxt))
                      (Const(Tname, Term.dummyT) $ Thm.prop_of rule,
                       rule)
      ) rules) ctxt

fun del_type_specific_simp (Tname, rules) ctxt =
  Type_specific_Simps.map (fold (fn rule =&gt;
      Net.delete_term_safe (Thm.equiv_thm (Context.theory_of ctxt))
                           (Const(Tname, Term.dummyT) $ Thm.prop_of rule,
                            rule)
      ) rules) ctxt

fun get_type_specific_simp ctxt Tname =
  Net.unify_term (Type_specific_Simps.get ctxt) (Const(Tname, Term.dummyT) $ Var (("",0),TVar(("",0),[])))
*)</span></span><span>

</span><span class="comment1"><span>(*
structure Expansion = Simpset (
  val initial_ss = Simpset_Configure.Minimal_SS
  val binding = SOME <span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span>‹φderiver_simps›
  val comment = "Rules unfolding constraints and conditions in property deriving of φ-type algebra.\n\
                \Basically, simplification rules for object operators including mappers, relators, \
                \predicators of the abstract algebra of φ-types"
  val attribute = NONE (*SOME (fn add =&gt; fn del =&gt;
    let fun gen (opr1, opr2) =
          (fn SOME "" =&gt; opr1
            | NONE =&gt; Thm.declaration_attribute (fn th =&gt; let open Pretty in
                          opr2 (@{print} (parse_which_type_for_the_rule th), [th])
                        handle Parse_Fail [] =&gt; error (string_of (
                                  para "You are declaring a simp rule applying locally only on\
                                       \ certain specific type. The type is not given and I \
                                       \failed to parse it from the given rule. Please \
                                       \indicate it explicitly by [φderiver_simps for &lt;the type&gt;].\
                                       \ Otherwise, maybe you want the rule to be applied everywhere \
                                       \globally. If so, declare [φderiver_simps global]."))
                             | Parse_Fail L =&gt; error (string_of (chunks (
                                  para "You are declaring a simp rule applying locally only on\
                                       \ certain specific type. The type is not given and I \
                                       \tried to parse it from the given rule but I cannot \
                                       \determine which type you prefer from the candidates below." ::
                                  map (fn N =&gt; item [str N]) L @
                                 [para "Please indicate it explicitly by [φderiver_simps for &lt;the type&gt;].\
                                       \ Otherwise, maybe you want the rule to be applied everywhere \
                                       \globally. If so, declare [φderiver_simps global]."]
                                  )))
                        end)
            | SOME Tname =&gt; Thm.declaration_attribute (fn th =&gt; opr2 (Tname, [th])))
        val add' = gen (add, add_type_specific_simp)
        val del' = gen (del, del_type_specific_simp)
     in Scan.lift (Args.add &gt;&gt; K add' || Args.del &gt;&gt; K del' || Scan.succeed add')
          -- (  Scan.lift (Args.$$$ "global") &gt;&gt; K (SOME "")
             || Scan.lift <span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span>‹for› |-- Args.type_name {proper=true, strict=true} &gt;&gt; SOME
             || Scan.succeed NONE)
     &gt;&gt; (fn (attr, target) =&gt; attr target)
    end)*)
  val post_merging = I
)
*)</span></span><span>


</span><span class="comment1"><span>(*rule: Qx P x ⟷ Qa b. P (a,b)*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>case_split_simproc</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simproc_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Simplifier.make_simproc</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>simproc_name</span></span><span> </span><span class="main"><span>{</span></span><span>
      lhss </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span>Thm.term_of</span><span> </span><span class="main"><span>(</span></span><span>Thm.lhs_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
      proc </span><span class="main"><span>=</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_case_split</span></span><span> </span><span class="entity"><span>lv</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                        </span><span class="entity"><span>lv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_case_split</span></span><span> </span><span class="entity"><span>lv</span></span><span> </span><span class="entity"><span>B</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_case_split</span></span><span> </span><span class="entity"><span>lv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_case_split</span></span><span> </span><span class="entity"><span>lv</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_case_split</span></span><span> </span><span class="entity"><span>lv</span></span><span> </span><span class="entity"><span>B</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_case_split</span></span><span> </span><span class="entity"><span>lv</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_case_split</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lv</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_case_split</span></span><span> </span><span class="entity"><span>lv</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
               </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_case_split</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>X</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
           
    </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>

  </span><span class="entity"><span>Expansion.map</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimprocs</span><span> </span><span class="main"><span>[</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">simproc</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>HOL.defined_Ex</span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">simproc</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Set.defined_All</span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">simproc</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>ExBI_expand_quantifier</span><span>›</span></span></span><span class="main"><span>,</span></span><span>
                       </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">simproc</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>HOL.defined_All</span><span>›</span></span></span><span class="comment1"><span>(*, eq_simproc*)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">simproc</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>NO_MATCH</span><span>›</span></span></span><span class="main"><span>,</span></span><span>
                       </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">simproc</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Funcomp_Lambda</span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(*<span class="hidden">\&lt;^</span><span class="control">simproc</span><span class="hidden">&gt;</span>‹defined_ExBI›,*)</span></span><span>
                       </span><span class="entity"><span>case_split_simproc</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.split_paired_all|fact"><span>split_paired_all</span></a><span class="main"><span>[</span></span><span class="operator"><span>folded</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.atomize_eq|fact"><span>atomize_eq</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"split_paired_all-case_split"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span>
                       </span><span class="entity"><span>case_split_simproc</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.split_paired_All|fact"><span>split_paired_All</span></a><span class="main"><span>[</span></span><span class="operator"><span>folded</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.atomize_eq|fact"><span>atomize_eq</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"split_paired_All-case_split"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                      </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms'</span></span><span>
              </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Any.unfold|fact"><span>φAny.unfold</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Bot.unfold|fact"><span>φBot.unfold</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;None_itself_is_one|fact"><span>φNone_itself_is_one</span></a><span>
              </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.simp_thms|fact"><span>HOL.simp_thms</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.ex_simps|fact"><span>ex_simps</span></a><span class="main"><span>[</span></span><span class="operator"><span>symmetric</span></span><span class="main"><span>]</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Set.html#Set.mem_Collect_eq|fact"><span>mem_Collect_eq</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.imp_ex|fact"><span>imp_ex</span></a><span>
              </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod.case|fact"><span>prod.case</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod.sel|fact"><span>prod.sel</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.fst_apfst|fact"><span>fst_apfst</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.snd_apfst|fact"><span>snd_apfst</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.fst_apsnd|fact"><span>fst_apsnd</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.snd_apsnd|fact"><span>snd_apsnd</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.apfst_id|fact"><span>apfst_id</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.apsnd_id|fact"><span>apsnd_id</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.apfst_conv|fact"><span>apfst_conv</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.apsnd_conv|fact"><span>apsnd_conv</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod.inject|fact"><span>prod.inject</span></a><span>

              </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.ExBI_simps|fact"><span>ExBI_simps</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.ExBI_split_prod|fact"><span>ExBI_split_prod</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.ExBI_subj_split_prod|fact"><span>ExBI_subj_split_prod</span></a><span>
              </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.ExBI_times_left|fact"><span>ExBI_times_left</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.ExBI_times_right|fact"><span>ExBI_times_right</span></a><span>
              </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.Subjection_Subjection|fact"><span>Subjection_Subjection</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.Subjection_True|fact"><span>Subjection_True</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.Subjection_Flase|fact"><span>Subjection_Flase</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.Subjection_Zero|fact"><span>Subjection_Zero</span></a><span>
              </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.Subjection_addconj|fact"><span>Subjection_addconj</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.Subjection_times|fact"><span>Subjection_times</span></a><span>

              </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Prod_expn&apos;|fact"><span>φProd_expn'</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Prod_expn&apos;&apos;|fact"><span>φProd_expn''</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.REMAINS_def|fact"><span>REMAINS_def</span></a><span>

              </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.sep_quant_sing|fact"><span>sep_quant_sing</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.sep_quant_empty|fact"><span>sep_quant_empty</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.sep_quant_subjection|fact"><span>sep_quant_subjection</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.sep_quant_ExBI|fact"><span>sep_quant_ExBI</span></a><span>


              </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Groups.html#Groups.monoid_add_class.add_0_right|fact"><span>add_0_right</span></a><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/ISABELLE_HOME/src/HOL/Eisbach/eisbach_rule_insts.ML.html#Eisbach.where|attribute"><span class="operator"><span>where</span></span></a><span> 'a</span><span class="main"><span class="main"><span>=</span></span></span><span class="quoted"><span>‹</span><span class="tfree"><span>'a</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Algebras.html#Algebras.sep_magma|class"><span>sep_magma</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.BI|type"><span>BI</span></a><span>›</span></span><span class="main"><span>]</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Groups.html#Groups.monoid_add_class.add_0_left|fact"><span>add_0_left</span></a><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/ISABELLE_HOME/src/HOL/Eisbach/eisbach_rule_insts.ML.html#Eisbach.where|attribute"><span class="operator"><span>where</span></span></a><span> 'a</span><span class="main"><span class="main"><span>=</span></span></span><span class="quoted"><span>‹</span><span class="tfree"><span>'a</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Algebras.html#Algebras.sep_magma|class"><span>sep_magma</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.BI|type"><span>BI</span></a><span>›</span></span><span class="main"><span>]</span></span><span>
              </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Algebras.html#Algebras.zero_fun_def|fact"><span>zero_fun_def</span></a><span class="main"><span>[</span></span><span class="operator"><span>symmetric</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/ISABELLE_HOME/src/HOL/Eisbach/eisbach_rule_insts.ML.html#Eisbach.where|attribute"><span class="operator"><span>where</span></span></a><span> 'b</span><span class="main"><span class="main"><span>=</span></span></span><span class="quoted"><span>‹</span><span class="tfree"><span>'a</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Algebras.html#Algebras.sep_magma|class"><span>sep_magma</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.BI|type"><span>BI</span></a><span>›</span></span><span class="main"><span>]</span></span><span>
              </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Algebras.html#Algebras.plus_fun|fact"><span>plus_fun</span></a><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/ISABELLE_HOME/src/HOL/Eisbach/eisbach_rule_insts.ML.html#Eisbach.where|attribute"><span class="operator"><span>where</span></span></a><span> 'a</span><span class="main"><span class="main"><span>=</span></span></span><span class="quoted"><span>‹</span><span class="tfree"><span>'a</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Algebras.html#Algebras.sep_magma|class"><span>sep_magma</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.BI|type"><span>BI</span></a><span>›</span></span><span class="main"><span>]</span></span><span>
              </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Rings.html#Rings.semiring_class.distrib_right|fact"><span>distrib_right</span></a><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/ISABELLE_HOME/src/HOL/Eisbach/eisbach_rule_insts.ML.html#Eisbach.where|attribute"><span class="operator"><span>where</span></span></a><span> 'a</span><span class="main"><span class="main"><span>=</span></span></span><span class="quoted"><span>‹</span><span class="tfree"><span>'a</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Algebras.html#Algebras.sep_semigroup|class"><span>sep_semigroup</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.BI|type"><span>BI</span></a><span>›</span></span><span class="main"><span>]</span></span><span>
              </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Groups.html#Groups.semigroup_mult_class.mult.assoc|fact"><span>mult.assoc</span></a><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/ISABELLE_HOME/src/HOL/Eisbach/eisbach_rule_insts.ML.html#Eisbach.where|attribute"><span class="operator"><span>where</span></span></a><span> 'a</span><span class="main"><span class="main"><span>=</span></span></span><span class="quoted"><span>‹</span><span class="tfree"><span>'a</span></span><span class="main"><span>::</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Algebras.html#Algebras.sep_semigroup|class"><span>sep_semigroup</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.BI|type"><span>BI</span></a><span>›</span></span><span class="main"><span>]</span></span><span>

              </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/HOL-Library.FSet.html#FSet.ball_simps|fact"><span>FSet.ball_simps</span></a><span class="main"><span>(</span></span><span>5-7</span><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Set.html#Set.ball_simps|fact"><span>Set.ball_simps</span></a><span class="main"><span>(</span></span><span>5-7</span><span class="main"><span>,</span></span><span>9</span><span class="main"><span>)</span></span><span>
              </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/List.html#List.list_all2_Cons1|fact"><span>list_all2_Cons1</span></a><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/List.html#List.list_all2_Nil|fact"><span>list_all2_Nil</span></a><span>
              </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/List.html#List.map_ident|fact"><span>map_ident</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.add_cong</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.imp_cong|fact"><span>imp_cong</span></a><span class="main"><span>[</span></span><span class="operator"><span>folded</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.atomize_eq|fact"><span>atomize_eq</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.add_cong</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.conj_cong|fact"><span>HOL.conj_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.add_cong</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.PhiTool_Symbol.html#PhiTool_Symbol.mk_symbol_cong|fact"><span>mk_symbol_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span>
</span><span class="main"><span>)</span></span><span>
          </span><span class="comment1"><span>(*Because of this cong, the order of the conjunction is significant!*)</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>equip_expansion_ss0</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Expansion.enhance</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Safe_Simps.equip</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span>delsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.simp_thms|fact"><span>HOL.simp_thms</span></a><span class="main"><span>(</span></span><span>15</span><span class="main"><span>)</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.True_implies_equals|fact"><span>True_implies_equals</span></a><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>equip_expansion_ss</span></span><span> </span><span class="entity"><span>phity</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tagged_eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>Phi_Syntax.wrap_equation_by_OPEN</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>equations </span><span class="entity"><span>phity</span></span><span class="main"><span>)</span></span><span>
                     </span><span>@</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="entity"><span>Phi_Syntax.wrap_equation_by_OPEN</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>type_equations </span><span class="entity"><span>phity</span></span><span class="main"><span>)</span></span><span>
                     </span><span>@</span><span> </span><span>map</span><span> </span><span class="entity"><span>Phi_Syntax.wrap_equation_by_MAKE</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>equations </span><span class="entity"><span>phity</span></span><span class="main"><span>)</span></span><span>
                     </span><span>@</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="entity"><span>Phi_Syntax.wrap_equation_by_MAKE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>type_equations </span><span class="entity"><span>phity</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Expansion.equip</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>tagged_eqs</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(*
local
  fun is_atom (Bound _) = true
      | is_atom (Free _) = true
      | is_atom (Var _) = true
      | is_atom _ = false
in val eq_simproc = Simplifier.make_simproc <span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span> "Phi_Type.eq" {
    lhss = [<span class="hidden">\&lt;^</span><span class="control">pattern</span><span class="hidden">&gt;</span>‹_ = _›],
    proc = fn _ =&gt; fn ctxt =&gt; fn ctm =&gt;
      case Thm.term_of ctm
        of _ (*eq*) $ LHS $ RHS =&gt;
            if is_atom RHS andalso not (is_atom LHS)
            then SOME (Conv.rewr_conv (Thm.transfer' ctxt @{thm' eq_commute[folded atomize_eq]}) ctm)
            else NONE
         | _ =&gt; NONE
  }
end *)</span></span><span>

</span><span class="comment1"><span>(** Guess Abstract Operators from BNF **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>quasi_BNF</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="main"><span>}</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>eBNF</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>BNF</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> BNF_Def.bnf </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>qBNF</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> quasi_BNF

</span><span class="comment1"><span>(* Library *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_hhf</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_hhf</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract_hhf</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_hhf</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract_hhf</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_hhf</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>extract_hhf</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.beta_eta_contract</span><span> </span><span class="entity"><span>X</span></span><span>

</span><span class="comment1"><span>(* fun permute_seq (s::L) =
      Seq.maps (fn s' =&gt; permute_seq L |&gt; Seq.map (fn L' =&gt; s'::L')) s
  | permute_seq [] = Seq.single [] *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_guess_operator</span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>atom_opr</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess_operator'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>known_oprs</span></span><span> </span><span class="entity"><span>x_ty</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ty'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x_ty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
                        </span><span class="entity"><span>known_oprs</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>x_ty</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>Tname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Targs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Sign.arity_number</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Tname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>x_ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.get_bnf1</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Tname</span></span><span>
                       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D</span></span><span class="main"><span>,</span></span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.classify_bnf_dead_live</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>Targs</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>D</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>Seq.maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_params</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>AList.defined</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>known_oprs</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="entity"><span>ty</span></span><span>
                                   </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>guess_operator'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>known_oprs</span></span><span> </span><span class="entity"><span>ty</span></span><span>
                                   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                    </span><span>|&gt;</span><span> </span><span>Seq.maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>opr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                          </span><span class="entity"><span>mk_params</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>L</span></span><span>
                                            </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>opr</span></span><span>::</span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_params</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk_params</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>L</span></span><span>
                         </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                              </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params'</span></span><span> </span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>atom_opr</span></span><span> </span><span class="entity"><span>x_ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.of_list</span><span> </span><span class="entity"><span>L</span></span><span>
               </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>guess_operator'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess_operator</span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>atom_opr</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>known_oprs</span></span><span> </span><span class="entity"><span>x_ty</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_guess_operator</span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>atom_opr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>known_oprs</span></span><span> </span><span class="entity"><span>x_ty</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Fail to guess the abstract operator for type "</span></span><span>
                                    </span><span>^</span><span> </span><span>Syntax.string_of_typ</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>x_ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span>
                            </span><span>NONE</span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>some</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>some</span></span><span> </span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>guess</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_global_simps</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>Expansion.add_simps'</span></span><span> </span><span class="entity"><span>thms</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>thms</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>proof_map_result</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>load_ss</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set</span></span><span class="main"><span>,</span></span><span class="entity"><span>pred</span></span><span class="main"><span>,</span></span><span class="entity"><span>rel</span></span><span class="main"><span>,</span></span><span class="entity"><span>map</span></span><span class="main"><span>,</span></span><span class="entity"><span>zip</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>more_rule</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="entity"><span>gen</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>gen</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>more_rules</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="entity"><span>gen</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>gen</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>additional</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>more_rules</span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof_map_result</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eBNF_Info.relator_on_const_true</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>Expansion.add_simps'</span></span><span> </span><span class="main"><span>(</span></span><span> </span><span class="entity"><span>eBNF_Info.simps_of_ctr_safe</span></span><span> </span><span class="entity"><span>bnf</span></span><span>
                       </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>eBNF_Info.simps_of_set_safe</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                       </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>eBNF_Info.simps_of_pred_safe</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                       </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>eBNF_Info.simps_of_rel_safe</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                       </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>map</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>eBNF_Info.simps_of_map_safe</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                       </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>zip</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>eBNF_Info.simps_of_zip_safe</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                       </span><span>@</span><span> </span><span class="entity"><span>additional</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>add_global_simps</span></span><span> </span><span class="main"><span>(</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pred</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>eBNF_Info.global_simps_of_pred_safe</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                       </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rel</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>eBNF_Info.global_simps_of_rel_safe</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                       </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>map</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>eBNF_Info.global_simps_of_map_safe</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* Set *)</span></span><span>

</span><span class="comment1"><span>(*ty: container type*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess_set_opr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>element_ty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>element_ty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Set.html#Set.insert|const"><span>insert</span></a><span> </span><span class="entity"><span class="entity"><span class="entity"><span>ty</span></span></span></span><span>›</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>$</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Orderings.html#Orderings.bot_class.bot|const"><span>bot</span></a><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Set.html#Set.set|type"><span>set</span></a><span> </span><span class="entity"><span>ty</span></span><span>›</span></span></span><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ty</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>Tname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Targs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.get_bnf1</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Tname</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>D</span></span><span class="main"><span>,</span></span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.classify_bnf_dead_live</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>Targs</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eBNF_Info.sets_of_bnf</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tys1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.tabulate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span>K</span><span> </span><span class="entity"><span>D</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tys2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.tabulate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span>K</span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sets</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.mk_sets_of_bnf</span></span><span> </span><span class="entity"><span>tys1</span></span><span> </span><span class="entity"><span>tys2</span></span><span> </span><span class="entity"><span>bnf</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>(</span></span><span> </span><span class="entity"><span>eBNF_Info.simps_of_set_safe</span></span><span> </span><span class="entity"><span>bnf</span></span><span>
                                              </span><span>@</span><span> </span><span class="entity"><span>eBNF_Info.simps_of_ctr_safe</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Seq.of_list</span><span> </span><span class="entity"><span>sets</span></span><span>
                 </span><span>|&gt;</span><span> </span><span>Seq.maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>s</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Set.html#Set.set|type"><span>set</span></a><span> </span><span class="entity"><span>x</span></span><span>›</span></span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>element_ty</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>guess_set_opr</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>element_ty</span></span><span>
                                     </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s'</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                          </span><span class="main"><span>(</span></span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Set.html#Set.bind|const"><span>Set.bind</span></a><span> </span><span class="entity"><span class="entity"><span>x</span></span></span><span> </span><span class="entity"><span class="entity"><span>element_ty</span></span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Internal bug f07de235-2838-4483-b2f9-b0cce6d06676"</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.empty</span><span>

</span><span class="comment1"><span>(* Relator *)</span></span><span>

</span><span class="comment1"><span>(*the relation between terms in the same type*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>guess_self_rel</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>D</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>(</span></span><span> </span><span class="entity"><span>eBNF_Info.simps_of_rel_safe</span></span><span> </span><span class="entity"><span>bnf</span></span><span>
                                      </span><span>@</span><span> </span><span class="entity"><span>eBNF_Info.simps_of_ctr_safe</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span>
                     </span><span>|&gt;</span><span> </span><span class="entity"><span>add_global_simps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eBNF_Info.global_simps_of_rel</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eBNF_Info.mk_rel_of_bnf</span></span><span> </span><span class="entity"><span>D</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>true</span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Internal bug"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atom_opr</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>guess_operator</span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>atom_opr</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Predicator *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>guess_predicate</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>D</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>load_ss</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eBNF_Info.mk_pred_of_bnf</span></span><span> </span><span class="entity"><span>D</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>true</span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atom_opr</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>guess_operator</span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>atom_opr</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Mapper *)</span></span><span>

</span><span class="comment1"><span>(*ty: container_ty
  dead_opr: the relation for dead type parameters (including those are not the target element type)*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess_rel_mapper</span></span><span> </span><span class="entity"><span>dead_opr</span></span><span> </span><span class="entity"><span>target_ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ele_tys</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.invent</span><span> </span><span class="main"><span>(</span></span><span>Variable.names_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"g"</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ele_tys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_fixes_direct</span><span> </span><span class="entity"><span>g_names</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ele_tys'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>target_ty</span></span><span> </span><span class="entity"><span>ele_tys</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g_tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ele_ty</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ele_ty'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ele_ty</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>ele_ty'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ele_tys</span></span><span> </span><span class="entity"><span>ele_tys'</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g_terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g_names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>g_tys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>known_rels</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ele_tys</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>g_terms</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>D</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>load_ss</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eBNF_Info.mk_rel_of_bnf</span></span><span> </span><span class="entity"><span>D</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>target_ty</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.exists_subtype</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ele_tys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="entity"><span class="entity"><span>typ</span></span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_dead_opr</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dead_opr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>target_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>guess_operator</span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>mk_dead_opr</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>known_rels</span></span><span> </span><span class="entity"><span>ty</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rel_term'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>g_term</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Term.term_name</span><span> </span><span class="entity"><span>g_term</span></span><span class="main"><span>,</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>g_term</span></span><span class="main"><span>,</span></span><span> </span><span>Term.abstract_over</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g_term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>g_terms</span></span><span> </span><span class="entity"><span>rel_term'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess_func_mapper</span></span><span> </span><span class="entity"><span>target_ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ele_tys</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.invent</span><span> </span><span class="main"><span>(</span></span><span>Variable.names_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"g"</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ele_tys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_fixes_direct</span><span> </span><span class="entity"><span>g_names</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ele_tys'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>target_ty</span></span><span> </span><span class="entity"><span>ele_tys</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g_tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ele_ty</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ele_ty'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ele_ty</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>ele_ty'</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ele_tys</span></span><span> </span><span class="entity"><span>ele_tys'</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g_terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g_names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>g_tys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>known_mappers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ele_tys</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>g_terms</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>D</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>load_ss</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eBNF_Info.mk_map_of_bnf</span></span><span> </span><span class="entity"><span>D</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>target_ty</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.exists_subtype</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ele_tys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atom_opr</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>guess_operator</span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>atom_opr</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>known_mappers</span></span><span> </span><span class="entity"><span>ty</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_term'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>g_term</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Term.term_name</span><span> </span><span class="entity"><span>g_term</span></span><span class="main"><span>,</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>g_term</span></span><span class="main"><span>,</span></span><span> </span><span>Term.abstract_over</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g_term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>g_terms</span></span><span> </span><span class="entity"><span>map_term'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess_pred_mapper</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ele_tys</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.invent</span><span> </span><span class="main"><span>(</span></span><span>Variable.names_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"g"</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>ele_tys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_fixes_direct</span><span> </span><span class="entity"><span>g_names</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g_tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ele_ty</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ele_ty</span></span><span> </span><span>--&gt;</span><span> </span><span class="entity"><span>HOLogic.boolT</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ele_tys</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>g_terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g_names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>g_tys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>known_mappers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ele_tys</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>g_terms</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>D</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>load_ss</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eBNF_Info.mk_pred_of_bnf</span></span><span> </span><span class="entity"><span>D</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.exists_subtype</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ele_tys</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>atom_opr</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>guess_operator</span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="entity"><span>is_live</span></span><span> </span><span class="entity"><span>mk_operator_for_dead</span></span><span> </span><span class="entity"><span>atom_opr</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>known_mappers</span></span><span> </span><span class="entity"><span>ty</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>map_term'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>g_term</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span>Term.term_name</span><span> </span><span class="entity"><span>g_term</span></span><span class="main"><span>,</span></span><span> </span><span>fastype_of</span><span> </span><span class="entity"><span>g_term</span></span><span class="main"><span>,</span></span><span> </span><span>Term.abstract_over</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>g_term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>g_terms</span></span><span> </span><span class="entity"><span>map_term'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Zip \&amp; Unzip *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unzip_typ</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>a</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>b</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unzip_typ</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>a</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>b</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>unzip_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>Tname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Targs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.get_bnf1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Tname</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deads</span></span><span class="main"><span>,</span></span><span class="entity"><span>lives</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.classify_bnf_dead_live</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>Targs</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lives'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unzip_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lives</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>split_list</span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tname</span></span><span class="main"><span>,</span></span><span class="entity"><span>eBNF_Info.burrow_bnf_dead_live</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deads</span></span><span class="main"><span>,</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>lives'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tname</span></span><span class="main"><span>,</span></span><span class="entity"><span>eBNF_Info.burrow_bnf_dead_live</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deads</span></span><span class="main"><span>,</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>lives'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>zip_typ</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>b</span></span><span>›</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>zip_typ</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TVar</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>b</span></span><span>›</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>zip_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>Tname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Targs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>Tname'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Targs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Tname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tname'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"zip_typ"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.get_bnf1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>Tname</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deads</span></span><span class="main"><span>,</span></span><span class="entity"><span>lives</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.classify_bnf_dead_live</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>Targs</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deads'</span></span><span class="main"><span>,</span></span><span class="entity"><span>lives'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.classify_bnf_dead_live</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>Targs'</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deads'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"zip_typ"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lives_merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>zip_typ</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span class="entity"><span>t2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lives</span></span><span> </span><span class="entity"><span>lives'</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Targs_merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.burrow_bnf_dead_live</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deads</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lives_merge</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Targs_merge</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>occur_subtyp</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>true</span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>occur_subtyp</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>

</span><span class="comment1"><span>(*flag=true for zip, flag=false for unzip*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess_zip_guided</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span class="entity"><span>target'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>occur</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>occur_subtyp</span></span><span> </span><span class="entity"><span>target</span></span><span> </span><span class="entity"><span>T</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>occur'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>occur_subtyp</span></span><span> </span><span class="entity"><span>target'</span></span><span> </span><span class="entity"><span>T'</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>occur</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>occur'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>target</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>T'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>target'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"y"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>T'</span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
           </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>Tname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Targs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>Tname'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Targs'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Tname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tname'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"guess_zip"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.get_bnf1</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Tname</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deads</span></span><span class="main"><span>,</span></span><span class="entity"><span>lives</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.classify_bnf_dead_live</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>Targs</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deads'</span></span><span class="main"><span>,</span></span><span class="entity"><span>lives'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.classify_bnf_dead_live</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>Targs'</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deads'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"guess_zip"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fp_more</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>BNF_FP_Sugar_More.get_fp_more</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Tname</span></span><span>
                                    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span>
                                     </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                                  </span><span class="main"><span>[</span></span><span>Pretty.block</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Fail to guess the zip operator for type "</span></span><span class="main"><span>,</span></span><span>
                                                                 </span><span>Pretty.str</span><span> </span><span class="entity"><span>Tname</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>zip</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>BNF_FP_Sugar_More.mk_zip</span></span><span>
                                       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>BNF_FP_Sugar_More.mk_unzip</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="entity"><span>lives</span></span><span> </span><span class="entity"><span>lives'</span></span><span> </span><span class="entity"><span>fp_more</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>load_ss</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span>
                          </span><span>|&gt;</span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>guess_zip_guided</span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>target</span></span><span class="main"><span>,</span></span><span class="entity"><span>target'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                      </span><span class="main"><span>(</span></span><span class="entity"><span>lives</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>lives'</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>map_tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>z</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>z</span></span><span>
                                                     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>b</span></span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span>
                                </span><span>|&gt;</span><span> </span><span>split_list</span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.mk_map_of_bnf</span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>map_tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>map_tys</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eBNF_Info.mk_rel_of_bnf</span></span><span> </span><span class="entity"><span>deads</span></span><span> </span><span class="entity"><span>lives</span></span><span> </span><span class="entity"><span>lives'</span></span><span> </span><span class="entity"><span>bnf</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mp'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mp</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Term.list_comb</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rl</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                     </span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>,</span></span><span> </span><span>domain_type</span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>zip</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>mp'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>flag</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mp'</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>zip</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
                                      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>zip</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mp'</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                    </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Internal bug #928dccd3-7497-4f2c-867c-4b7407fcfdef"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>occur</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>occur'</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>T'</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="entity"><span class="entity"><span>T</span></span></span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod.fst|const"><span>fst</span></a><span> </span><span class="entity"><span class="entity"><span>T</span></span></span><span> </span><span class="entity"><span>T</span></span><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Only the target can vary in guided guess_zip"</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Internal bug #a1dd0817-f55a-468e-ba79-95183f145380"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* DO NOT REMOVE, still good and maybe useful, but not maintained
fun guess_zip flag (*(target,target')*) (Type(Tname, Targs), Type(Tname', Targs')) ctxt =
      let val _ = if Tname = Tname' then () else raise TYPE ("guess_zip", [], [])
          val bnf = eBNF_Info.get_bnf1 (Context.Proof ctxt) Tname
          val (deads,lives) = eBNF_Info.classify_bnf_dead_live bnf Targs
          val (deads',lives') = eBNF_Info.classify_bnf_dead_live bnf Targs'
          val _ = if deads = deads' then () else raise TYPE ("guess_zip", [], [])
          val fp_more = case BNF_FP_Sugar_More.get_fp_more (Context.Proof ctxt) Tname
                          of SOME x =&gt; x
                           | NONE =&gt; raise Automation_Fail ("Fail to guess the zip operator for type " ^ Tname)
          val zip = (if flag then BNF_FP_Sugar_More.mk_zip
                             else BNF_FP_Sugar_More.mk_unzip) deads lives lives' fp_more
          val (args, ctxt') = ctxt addsimps eBNF_Info.simps_of_ctr_safe bnf
                  |&gt; fold_map (guess_zip flag) (lives ~~ lives')
          val map_tys = map (fn z =&gt; case Term.fastype_of z
                                       of <span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span>‹fun a b› =&gt; (a,b)) args
                      |&gt; split_list
          val mp = eBNF_Info.mk_map_of_bnf deads (fst map_tys) (snd map_tys) bnf
       in (Abs("x", domain_type (Term.fastype_of zip),
                    Term.list_comb (mp, args) $ (zip $ Bound 0)),
           ctxt')
      end
  | guess_zip _ ((a as TFree _), (b as TFree _)) ctxt = (Abs("x", <span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span>‹prod a b›, Bound 0), ctxt)
  | guess_zip _ ((a as TVar _), (b as TVar _)) ctxt = (Abs("x", <span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span>‹prod a b›, Bound 0), ctxt)
  | guess_zip _ (a,b) _ = raise TYPE ("guess_zip", [a,b], [])
*)</span></span><span>

</span><span class="comment1"><span>(* load simpset *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>const_eq</span></span><span> </span><span class="entity"><span>const_name</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>const_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>const_eq</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mp</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>y</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>load_rel</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="quoted"><span>‹</span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>›</span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="quoted"><span>‹</span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>N'</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>›</span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span>›</span></span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>N'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>eBNF_Info.get_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>N</span></span><span>
              </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mp</span></span><span> </span><span class="entity"><span>eBNF_Info.rel_of_bnf_safe</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>const_eq</span></span><span> </span><span class="entity"><span>const_name</span></span><span> </span><span class="entity"><span>C</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>load_ss</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span>›</span></span></span><span>›</span></span></span><span> </span><span class="entity"><span>T</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="entity"><span>ty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*CN: const name*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>load_set</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="quoted"><span>‹</span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>›</span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Set.html#Set.set|type"><span>set</span></a><span> </span><span class="main"><span>_</span></span><span>›</span></span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>eBNF_Info.get_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>N</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mp</span></span><span> </span><span class="entity"><span>eBNF_Info.sets_of_bnf_safe</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const_eq</span></span><span> </span><span class="entity"><span>CN</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>C</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>load_ss</span></span><span> </span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>load_set</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>load_predicate</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="quoted"><span>‹</span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>›</span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>eBNF_Info.get_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>N</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mp</span></span><span> </span><span class="entity"><span>eBNF_Info.pred_of_bnf_safe</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>const_eq</span></span><span> </span><span class="entity"><span>CN</span></span><span> </span><span class="entity"><span>C</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>load_ss</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>load_predicate</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span>›</span></span></span><span> </span><span class="entity"><span>T</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>load_predicate</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>load_predicate</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>load_map</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="quoted"><span>‹</span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>›</span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>N'</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"fun"</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>load_map</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>eBNF_Info.get_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>N</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mp</span></span><span> </span><span class="entity"><span>eBNF_Info.map_of_bnf_safe</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>const_eq</span></span><span> </span><span class="entity"><span>CN</span></span><span> </span><span class="entity"><span>C</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>load_ss</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>load_map</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>load_map</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>load_map</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span></span><span> </span><span class="entity"><span>T</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>load_map</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>load_map</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>load_unzip</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>T2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>N''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts3</span></span><span class="main"><span>)</span></span><span>›</span></span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span> </span><span class="quoted"><span>‹</span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>ts1</span></span><span class="main"><span>)</span></span><span>›</span></span><span> </span><span class="quoted"><span>‹</span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>N'</span></span><span class="main"><span>,</span></span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span>::</span><span class="entity"><span>ts1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span>::</span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>b</span></span><span>›</span></span><span>::</span><span class="entity"><span>ts3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>chk_ts</span></span><span> </span><span class="entity"><span>ts1</span></span><span> </span><span class="entity"><span>ts2</span></span><span> </span><span class="entity"><span>ts3</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_ts</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_ts</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N''</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>chk_ts</span></span><span> </span><span class="entity"><span>ts1</span></span><span> </span><span class="entity"><span>ts2</span></span><span> </span><span class="entity"><span>ts3</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>eBNF_Info.get_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>N</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mp</span></span><span> </span><span class="entity"><span>eBNF_Info.fp_more_of</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fp_more</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>const_eq</span></span><span> </span><span class="entity"><span>CN</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>unzip </span><span class="entity"><span>fp_more</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>load_ss</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>load_unzip</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>load_unzip</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>load_unzip</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>T2</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>load_unzip</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>load_unzip</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>load_zip</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span> </span><span class="quoted"><span>‹</span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>ts1</span></span><span class="main"><span>)</span></span><span>›</span></span><span> </span><span class="quoted"><span>‹</span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>N'</span></span><span class="main"><span>,</span></span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span></span><span> </span><span class="quoted"><span>‹</span><span class="entity"><span>T2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>N''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ts3</span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_ts</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span>::</span><span class="entity"><span>ts1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span>::</span><span class="entity"><span>ts2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>b</span></span><span>›</span></span><span>::</span><span class="entity"><span>ts3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>t2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>chk_ts</span></span><span> </span><span class="entity"><span>ts1</span></span><span> </span><span class="entity"><span>ts2</span></span><span> </span><span class="entity"><span>ts3</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_ts</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_ts</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N''</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>chk_ts</span></span><span> </span><span class="entity"><span>ts1</span></span><span> </span><span class="entity"><span>ts2</span></span><span> </span><span class="entity"><span>ts3</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>eBNF_Info.get_bnf</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>N</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mp</span></span><span> </span><span class="entity"><span>eBNF_Info.fp_more_of</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fp_more</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bnf</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>const_eq</span></span><span> </span><span class="entity"><span>CN</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>zip </span><span class="entity"><span>fp_more</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>load_ss</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span>false</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bnf</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>load_zip</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>load_zip</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>load_zip</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>T2</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>load_zip</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>CN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>load_zip</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>load_const</span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>the_default</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ld</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ld</span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>[</span></span><span class="entity"><span>load_rel</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>load_set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>load_predicate</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>load_map</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>load_unzip</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>load_zip</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_consts'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_aterms</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Const</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>load_simpset</span></span><span> </span><span class="entity"><span>tms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>load_const</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>add_consts'</span></span><span> </span><span class="entity"><span>tms</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>


</span><span class="comment1"><span>(** A framework of guessing properties via φ-LPR **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simplify_guessing_reasoning</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Simplifier.simplify</span></span><span> </span><span class="main"><span>(</span></span><span>Simplifier.clear_simpset</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span>
      </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise_norm|fact"><span>Premise_norm</span></a><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/ISABELLE_HOME/src/HOL/Eisbach/eisbach_rule_insts.ML.html#Eisbach.where|attribute"><span class="operator"><span>where</span></span></a><span> mode</span><span class="main"><span class="main"><span>=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.default|const"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.default|const"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.default|const"><span>default</span></a></a></a><span>›</span></span></span></span><span class="main"><span>]</span></span><span>
              </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise_norm|fact"><span>Premise_norm</span></a><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/ISABELLE_HOME/src/HOL/Eisbach/eisbach_rule_insts.ML.html#Eisbach.where|attribute"><span class="operator"><span>where</span></span></a><span> mode</span><span class="main"><span class="main"><span>=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.MODE_GUARD|const"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.MODE_GUARD|const"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.MODE_GUARD|const"><span>MODE_GUARD</span></a></a></a><span>›</span></span></span></span><span class="main"><span>]</span></span><span>
              </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Ant_Seq_reduct|fact"><span>Ant_Seq_reduct</span></a><span>
              </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.imp_conjR|fact"><span>HOL.imp_conjR</span></a><span class="main"><span>[</span></span><span class="operator"><span>folded</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Ant_Seq_def|fact"><span>Ant_Seq_def</span></a><span class="main"><span>]</span></span><span>
              </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.all_conj_distrib|fact"><span>HOL.all_conj_distrib</span></a><span class="main"><span>[</span></span><span class="operator"><span>folded</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Ant_Seq_def|fact"><span>Ant_Seq_def</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>unfolding_idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> </span><span class="comment1"><span>(*the reversed index of the parameter for unfolded φ-type definition expression*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoning_goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*the proposition of the reasoning goal*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>parse_result</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="comment1"><span>(*parses the result of the reasoning*)</span></span><span>
        </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*conclusion of the guessed property*)</span></span><span> *
               </span><span class="entity"><span>induct_inst_params</span></span><span> *
               </span><span>term</span><span> </span><span class="comment1"><span>(*conditions augmenting the antecedents*)</span></span><span> *
               </span><span>term</span><span> </span><span class="comment1"><span>(*(conjuncted) antecedents*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prepend_Trueprop</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>term</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>prop</span><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>term</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.Trueprop</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>term</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Not a proposition"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>term</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>Guess_Framework</span></span><span> </span><span class="entity"><span>mk_goal_term_and_parse_result</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi0</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal_term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>parse_result</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>mk_goal_term_and_parse_result</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prepend_Trueprop</span></span><span> </span><span class="entity"><span>goal_term</span></span><span>
    </span><span class="comment1"><span>(*fun repeat_abs_conv cv ctxt ctm =
            case Thm.term_of ctm
              of Abs _ =&gt; Conv.abs_conv (repeat_abs_conv cv o snd) ctxt ctm
               | _ =&gt; cv ctxt ctm*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoner.reason</span></span><span> </span><span>NONE</span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span> </span><span>Config.map</span><span> </span><span class="entity"><span>Phi_Reasoner.trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>=&gt;</span></span><span class="entity"><span>i</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                                                </span><span>|&gt;</span><span> </span><span class="entity"><span>Expansion.map'</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>equations </span><span class="entity"><span>phi0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(*fun reason thm = thm
            |&gt; Conv.gconv_rule (HOLogic.Trueprop_conv (funpow unfold_place Conv.fun_conv (Conv.arg1_conv (
                  repeat_abs_conv (fn ctxt =&gt;
                      Conv.try_conv (Conv.rewrs_conv (map (fn th =&gt; th RS' (ctxt, @{thm' HOL.eq_reflection}))
                                                     (#equations phi)))) ctxt
                  )))) 1
            |&gt; Phi_Reasoner.reason NONE NONE (Config.map Phi_Reasoner.trace (fn i=&gt;i-1) ctxt)*)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Phi_Help.reason_tracing_tyinst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="entity"><span>goal_term</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simplify_guessing_reasoning</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ret0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_refine</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.refine_sorts_of_tms</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>ret0</span></span><span class="main"><span>]</span></span><span>
                         </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.certify_tyvars</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_refine</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.empty</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ret0</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ants</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_result</span></span><span> </span><span class="entity"><span>ret</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ants</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>constrain_antecedents</span></span><span> </span><span class="entity"><span>conds</span></span><span> </span><span class="entity"><span>ants</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst'2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import_inst</span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ants</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ants</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Term_Subst.instantiate</span><span> </span><span class="entity"><span>inst'2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ants</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>Term_Subst.instantiate</span><span> </span><span class="entity"><span>inst'2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ants</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span>
                        </span><span class="entity"><span>phi</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>instantiate_phi</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst0</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.empty</span><span class="main"><span>)</span></span><span>
                            </span><span>|&gt;</span><span> </span><span class="entity"><span>instantiate_phi</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_refine</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.empty</span><span class="main"><span>)</span></span><span>
                            </span><span>|&gt;</span><span> </span><span class="entity"><span>instantiate_phi</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.certify_vars</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inst'2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                        </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>guess_fail</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
            </span><span class="main"><span>[</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"Fail to guess the property expression"</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>Guess_Framework'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal_template</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>insts_of</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>parsing_rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Guess_Framework</span></span><span> </span><span class="main"><span>(</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>insts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>insts_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>Term.maxidx_term</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal_template</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.incr_indexes</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goal_template</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.maxidx_term</span><span> </span><span class="entity"><span>goal_template</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_vars</span><span> </span><span class="entity"><span>goal_template</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>redex</span></span><span class="main"><span>,</span></span><span class="entity"><span>residue</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>redex</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>residue</span></span><span class="main"><span>)</span></span><span>
                            </span><span>|&gt;</span><span> </span><span>apply2</span><span> </span><span>Logic.mk_term</span><span> </span><span class="comment1"><span>(*Unify.smash_unifiers requires that the terms to be unified already have the same type*)</span></span><span>
                     </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>insts</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span>Unify.smash_unifiers</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.empty</span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>env</span></span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"No unifier to the goal template"</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span>Envir.Envir</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>tyenv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tenv</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.norm_env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyenv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tenv</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.certify_vars</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.norm_term</span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>goal_template</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>instantiate_phi</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>phi</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>redex</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>residues</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.strip_tuple</span></span><span> </span><span class="entity"><span>parsing_rule</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_result</span></span><span> </span><span class="entity"><span>result</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Pattern_Translation.rewrites</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prepend_Trueprop</span></span><span> </span><span class="entity"><span>redex</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>residues</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>result</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tx_term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ants</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>prepend_Trueprop</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>parse_inst_params_from_phi_term</span></span><span> </span><span class="entity"><span>Tx_term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ants</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Bad parsing_rule"</span></span><span>

       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>goal_term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>parse_result</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>



</span><span class="comment1"><span>(** Deriver Framework **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>hint_mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ACCEPT_NO_HINT</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ACCEPT_ONE_HINT</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ACCEPT_ANY_HINTS</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>REQUIRE_EXACT_ONE_HINT</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>REQUIRE_HINTS</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>multiple_call</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ONLY_ONCE</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ONLY_ONCE_IF_NO_HINT</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>MULTIPLE_TIMES</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>quiet</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>bool</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>deriver_framework</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hint_mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>multiple_call</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deriver</span></span><span>
                      </span><span class="main"><span>(</span></span><span class="entity"><span>quiet</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriving_instructions0</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>local_theory</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deriving_instructions'1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>DI</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>DI</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> 
                                                         </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>is_some</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>4</span></span><span> </span><span class="entity"><span>DI</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                               </span><span class="entity"><span>deriving_instructions0</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_derived_properties</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriving_instructions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>just_dep</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>deriving_instructions'1</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>get_first</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>deriving_instructions0</span></span><span class="main"><span>,</span></span><span>
                              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>deriving_instructions0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pos</span></span><span>
                                                           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                              </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hint_terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>deriving_instructions</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>multiple_call</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>ONLY_ONCE</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>just_dep</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>
                  </span><span>paragraph</span><span> </span><span class="main"><span>(</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"deriver "</span></span><span> </span><span>::</span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>::</span><span> </span><span>str</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>::</span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>::</span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"can only be invoked once"</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ONLY_ONCE_IF_NO_HINT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>just_dep</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>hint_terms</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>
                  </span><span>paragraph</span><span> </span><span class="main"><span>(</span></span><span>str</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>::</span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>::</span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"has already derived the hint-less case.\
                             \ Please provide the desired form of the rule if you want to derive more."</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>hint_mode</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>ACCEPT_NO_HINT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>just_dep</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>hint_terms</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span>paragraph</span><span> </span><span class="main"><span>(</span></span><span>str</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>::</span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>::</span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"accepts no hint, but given"</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
                  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>item</span><span> </span><span class="main"><span>[</span></span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="entity"><span>hint_terms</span></span><span>
                </span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ACCEPT_ONE_HINT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>just_dep</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>hint_terms</span></span><span> </span><span>&lt;=</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span>paragraph</span><span> </span><span class="main"><span>(</span></span><span>str</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>::</span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>::</span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"accepts at most one hint, but more hints are given"</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
                  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>item</span><span> </span><span class="main"><span>[</span></span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="entity"><span>hint_terms</span></span><span>
                </span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>REQUIRE_EXACT_ONE_HINT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>just_dep</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>hint_terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>hint_terms</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>
                  </span><span>paragraph</span><span> </span><span class="main"><span>(</span></span><span>str</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>::</span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>::</span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"requires exact one hint, but no hint is given"</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span>paragraph</span><span> </span><span class="main"><span>(</span></span><span>str</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>::</span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>::</span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"requires exact one hint, but more hints are given"</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
                  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>item</span><span> </span><span class="main"><span>[</span></span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="entity"><span>hint_terms</span></span><span>
                </span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>REQUIRE_HINTS</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>just_dep</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>hint_terms</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>
                  </span><span>paragraph</span><span> </span><span class="main"><span>(</span></span><span>str</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>::</span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>::</span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"requires some hint(s), but no hint is given"</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>deriving_instructions</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invoke</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>H</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>suffix_name_by_index</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="entity"><span>ind</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>derv_thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thy</span></span><span>
                        </span><span>|&gt;</span><span> </span><span class="entity"><span>num</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>?</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>Local_Theory.begin_nested</span><span>
                        </span><span>|&gt;</span><span> </span><span>Context_Position.set_visible</span><span> </span><span>false</span><span>
                        </span><span>|&gt;</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>Proof_Context.note_thms</span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.empty_atts</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>5</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>)</span></span><span>
                        </span><span>|&gt;</span><span> </span><span class="entity"><span>Bundle.includes</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>6</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>deriver</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="entity"><span>ind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iname</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>derv_thy</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>num</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>?</span><span> </span><span>Local_Theory.end_nested_result</span><span> </span><span>Morphism.fact</span><span>
         </span><span>|-&gt;</span><span> </span><span class="entity"><span>register_derived_properties</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span>+</span><span class="entity"><span>ind</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold_index</span><span> </span><span class="entity"><span>invoke</span></span><span> </span><span class="entity"><span>deriving_instructions</span></span><span> </span><span class="entity"><span>thy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ex</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>quiet</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Exn.reraise</span><span> </span><span class="entity"><span>ex</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>deriver_framework_no_hints</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mcall</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deriver</span></span><span> </span><span class="entity"><span>quiet</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>deriver_framework</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ACCEPT_NO_HINT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mcall</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>deriver</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>quiet</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="comment1"><span>(*
fun accept gen [] phityp thy = gen NONE phityp thy
  | accept gen Hs phityp thy = fold (fn H =&gt; gen (SOME H) phityp) Hs thy

fun accept_one _ gen [] phityp thy = gen NONE phityp thy
  | accept_one _ gen [H] phityp thy = gen (SOME H) phityp thy
  | accept_one prop_name _ hints _ thy =
      let open Pretty
       in error (string_of (chunks (
            block [str prop_name, str " only derives one reasoning rule, but multiple hints are given"] ::
            map (fn H =&gt; item [Context.cases Syntax.pretty_term_global Syntax.pretty_term thy H]) hints)))
      end*)</span></span><span>

</span><span class="comment1"><span>(*deprecated:*)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_the_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_the_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_the_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_the_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_the_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.head_of</span><span> </span><span class="entity"><span>X</span></span><span>
                                 </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="entity"><span>N'</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>N'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prop_name</span></span><span>
                                  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_deriving_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.term</span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="entity"><span>N'</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prop_name</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_deriving_hint</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err_derive</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Fail to derive the property "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>prop_name</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err_prove</span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Fail to derive the given property:\n"</span></span><span> </span><span>^</span><span>
      </span><span>Context.cases</span><span> </span><span>Syntax.string_of_term_global</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>hint</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>select_one_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_the_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_deriving_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hints</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>hint</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="main"><span>(</span></span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_the_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_deriving_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span>
           </span><span class="entity"><span>action</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>hint</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err_prove</span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="main"><span>(</span></span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_the_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_deriving_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span>
           </span><span class="entity"><span>action</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
          </span><span class="comment1"><span>(* handle Automation_Fail =&gt; err_derive prop_name *)</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"More than one hint of "</span></span><span>^</span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" are given!"</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>select_hints</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_the_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_deriving_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hints</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="main"><span>(</span></span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_the_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_deriving_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span>
           </span><span class="entity"><span>action</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err_derive</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"It is enough to just give me one hint to derive "</span></span><span>^</span><span> </span><span class="entity"><span>prop_name</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_the_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_deriving_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span>
          </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>hint</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err_prove</span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span>
               </span><span class="entity"><span>hints</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_no_hints</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_the_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_deriving_hint</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hints</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Property "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" is not supported on the φ-type."</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*** Reasoning Framework ***)</span></span><span>

</span><span class="comment1"><span>(* Default Obligation Solver *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>solver</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span> * </span><span>thm</span><span> * </span><span class="entity"><span>Method.text</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>oblg_solver</span></span><span> </span><span class="entity"><span>proof_id</span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="comment1"><span>(*case Thm.major_prem_of sequent
    of Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹Trueprop›, _) $ (
          Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹Premise›, _) $ Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹MODE_COLLECT›, _) $ _) =&gt;*)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.declare_term</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
               </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Envir.freeze_dynamic_lemmas</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Expansion.equip</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                 </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.del_cong</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.conj_cong|fact"><span>HOL.conj_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nprems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>sequent</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent'1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Timeout.apply</span><span> </span><span class="main"><span>(</span></span><span>Time.fromSeconds</span><span> </span><span class="inner_numeral"><span>3</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.hd</span><span>
                         </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Reasoners.asm_lr_simp_tac</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Timeout.TIMEOUT</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="inner_quoted"><span>"Simplification timeouts!"</span></span><span> </span><span class="main"><span>;</span></span><span>
                           </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="comment1"><span>(*|&gt; @{print}*)</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent'2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>text'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span>Seq.the_result</span><span> </span><span class="inner_quoted"><span>"Fail to apply the hinted tactic"</span></span><span> </span><span class="main"><span>(</span></span><span>
                        </span><span class="entity"><span>Method.evaluate</span></span><span> </span><span class="entity"><span>text'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise_I|fact"><span>Premise_I</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sequent'1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent'1</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>nprems'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>sequent'2</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rulex</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Expansion.simp_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>rulex</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Phi_Help.ntimes</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>nprems'</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>nprems</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Phi_Sledgehammer_Solver.auto</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>proof_id</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"⇩"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sequent'2</span></span><span>
        </span><span class="comment1"><span>(*|&gt; (fn th =&gt; case Thm.major_prem_of th
                         of <span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span>‹Trueprop› $ (<span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span>‹Premise› $ _ $ <span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span>‹True›) =&gt;
                              @{thm' Premise_True} RS th
                          | <span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span>‹Trueprop› $ <span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span>‹True› =&gt;
                              @{thm' TrueI} RS th
                          | _ =&gt; th) *)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
     </span><span class="comment1"><span>(*| _ =&gt; sequent*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>oblg_solver'</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oblg_solver</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.full_name</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"/"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* default_ind_inst *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_ind_inst</span></span><span> </span><span class="entity"><span>inst_by_bound_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>focus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>tl</span><span> </span><span class="entity"><span>params</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_infos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parameters_of</span></span><span> </span><span class="entity"><span>phi</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>param_infos</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
              </span><span>error</span><span> </span><span class="inner_quoted"><span>"BUG aSnZDU/wS5SF1qsu18+tkg"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="inner_quoted"><span>"A"</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>name </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_infos</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params_overwrite</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>Phi_Help.split_last</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst_by_bound_var</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>params </span><span class="entity"><span>focus</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>overwrite</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>overwrite</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span>::</span><span class="entity"><span>Names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span>::</span><span class="entity"><span>Tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>overwrite</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>Names</span></span><span> </span><span class="entity"><span>Tys</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>overwrite</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span>::</span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span>::</span><span class="entity"><span>Names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span>::</span><span class="entity"><span>Tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>overwrite</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>Names</span></span><span> </span><span class="entity"><span>Tys</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>overwrite</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span>::</span><span class="entity"><span>Names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span>::</span><span class="entity"><span>Tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>overwrite</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>Names</span></span><span> </span><span class="entity"><span>Tys</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>overwrite</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span>::</span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span>::</span><span class="entity"><span>Names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span>::</span><span class="entity"><span>Tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Free</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>overwrite</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>Names</span></span><span> </span><span class="entity"><span>Tys</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>overwrite</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>some</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span>::</span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span>::</span><span class="entity"><span>Names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span>::</span><span class="entity"><span>Tys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>some</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>overwrite</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>Names</span></span><span> </span><span class="entity"><span>Tys</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>overwrite</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"BUG TAd2J2CtRa+oY2ZqyMN0ow"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>overwrite</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>params_overwrite</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>param_names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>param_infos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params'</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* The Framework *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>deriving_framework</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>parse_hint</span></span><span class="main"><span>,</span></span><span class="entity"><span>extract_oprs_from_hint</span></span><span class="main"><span>,</span></span><span class="entity"><span>guess_property</span></span><span class="main"><span>,</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span>
                        </span><span class="entity"><span>subgoal_reasonings</span></span><span class="main"><span>,</span></span><span class="entity"><span>solver</span></span><span class="main"><span>,</span></span><span class="entity"><span>simp_before_induct</span></span><span class="main"><span>,</span></span><span class="entity"><span>simp</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>(</span></span><span class="entity"><span>phi0</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instruction</span></span><span class="main"><span>:</span></span><span class="entity"><span>deriving_instruction</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="comment1"><span>(*val (inst,inst',phi,ctxt01) = fix_phi_type true phi0 ctxt0*)</span></span><span>
      </span><span class="comment1"><span>(*val ((x_term0, T_term0), ctxt01) = fix_phi_term_params (#term phi0) ctxt0*)</span></span><span>
      </span><span class="comment1"><span>(*val property_const = Term.head_of (HOLogic.dest_Trueprop (Thm.concl_of rule))*)</span></span><span>
      </span><span class="comment1"><span>(*lame! DO NOT REMOVE!
        val hint' = case hint of NONE =&gt; guess_entire_property ctxt0 phi0 property_const
                             | some =&gt; some*)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>instruction</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>H0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aia0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="comment1"><span>(*val idx = Phi_Type.maxidx_of_phi phi0 ~1 + 1
                  val H = Logic.incr_indexes ([],[],idx) H0*)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt0</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>typ_of_phi0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>parameters0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>H01</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_hint</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>phi0</span></span><span> </span><span class="entity"><span>H0</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import_inst</span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>H01</span></span><span>::</span><span class="entity"><span>aia0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typ_of_phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term_Subst.instantiateT</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>inst0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>typ_of_phi0</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parameters</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>Term_Subst.instantiate</span><span> </span><span class="entity"><span>inst0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>parameters0</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term_Subst.instantiate</span><span> </span><span class="entity"><span>inst0</span></span><span> </span><span class="entity"><span>H01</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aia</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Term_Subst.instantiate</span><span> </span><span class="entity"><span>inst0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>aia0</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Sign.typ_match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of</span><span> </span><span class="main"><span>(</span></span><span>Term.head_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>typ_of_phi</span></span><span class="main"><span>)</span></span><span> </span><span>Vartab.empty</span><span>
                              </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Type.TYPE_MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                                          </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Invalid Hint"</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>]</span></span><span>
                                        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                          </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.subst_tyenv</span></span><span>
                          </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.certify_tyvars</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Type.instantiate_phi</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.empty</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi0</span></span><span>

                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>oprs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>extract_oprs_from_hint</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extract_hhf</span></span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>load_simpset</span></span><span> </span><span class="entity"><span>oprs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

               </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aia</span></span><span class="main"><span>,</span></span><span> </span><span>Logic.strip_imp_prems</span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>,</span></span><span> </span><span>Logic.strip_imp_concl</span><span> </span><span class="entity"><span>H</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>parameters</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>guess_property</span></span><span> </span><span class="entity"><span>phi0</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span>
               </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ants</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>parameters</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoner.info_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>chunks</span><span> </span><span class="main"><span>[</span></span><span>
                                    </span><span>para</span><span> </span><span class="inner_quoted"><span>"Guess the property"</span></span><span class="main"><span>,</span></span><span>
                                    </span><span>block</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Antecedents: "</span></span><span class="main"><span>,</span></span><span> </span><span>chunks</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ants</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                                    </span><span>block</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Property: "</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>]</span></span><span>
                              </span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ants</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>parameters</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
            </span><span class="comment1"><span>(* |&gt; Seq.map (fn (ants, property, parameters, phi, ctxt) =&gt;
                    let val (rev_params_tys, x_ty, model_ty) = dest_parameterized_phi_ty (Term.fastype_of (#term phi))
                        fun recover_assertion _ [] [] = #term phi 
                          | recover_assertion i (param_ty :: Tys) (NONE :: params)
                              = recover_assertion (i+1) Tys params $ Var(("𝔭", i), param_ty)
                                (*parameters should contain no variable, though I am not very sure*)
                          | recover_assertion i (_ :: Tys) (SOME param :: params)
                              = recover_assertion (i+1) Tys params $ param
                          | recover_assertion _ _ _ = error "BUG: length of parameters is incorrect"
                        val assertion = case recover_assertion 0 (x_ty :: rev_params_tys) parameters
                                          of T $ x =&gt; <span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span>‹φType x_ty model_ty› $ x $ T
                                           | _ =&gt; error "BUG"
                        val ants' = guess_conditions (*(Expansion.equip*) ctxt phi property_const assertion ants
                     in (ants', property, parameters, phi, ctxt)
                    end ) *)</span></span><span> </span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Seq.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aia</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ants01</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property01</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi_typ_parameters01</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi01</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt01</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ants</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi_typ_parameters'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_phi_type_fixed</span></span><span> </span><span class="entity"><span>phi01</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ants01</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property01</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi_typ_parameters01</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi01</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt01</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fix_phi_type</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>phi01</span></span><span> </span><span class="entity"><span>ctxt01</span></span><span>
                 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term_Subst.instantiate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.uncertify_vars</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>ants01</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="entity"><span>property01</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="entity"><span>subst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi_typ_parameters01</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phityp_arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>params </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi_typ_parameters</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>phityp_arity</span></span><span> </span><span>&lt;=</span><span> </span><span>length</span><span> </span><span class="entity"><span>phi_typ_parameters'</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>List.take</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi_typ_parameters'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phityp_arity</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Bad Argument: phi_typ_parameters"</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ant</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Conv.atomize_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ants</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>PLPR_Syntax.mk_ant_sequence</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ant_var</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>
                               </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ant</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_ANT|const"><span>φTA_ANT</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                    </span><span>SOME</span><span> </span><span class="entity"><span>ant</span></span><span>
                             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
                           </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Bad Rule, msut contain a boolean antecedent part tagged by ‹φTA_ANT›"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Pattern.match</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>)</span></span><span>
                                     </span><span class="main"><span>(</span></span><span>Vartab.empty</span><span class="main"><span>,</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Pattern.MATCH</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                  </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"The given property does not match the reasoning rule"</span></span><span class="main"><span>,</span></span><span>
                                   </span><span>item</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"property: "</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                                   </span><span>item</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"rule: "</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Vartab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ant_var</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ant</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.subst_env</span></span><span>
                   </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.certify_vars</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="entity"><span>inst_rule</span></span><span> </span><span class="entity"><span>rule</span></span><span>
               </span><span>|&gt;</span><span> </span><span class="entity"><span>simp_before_induct</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
               </span><span class="comment1"><span>(*TODO: rename this variable to 'sequent'*)</span></span><span>
      

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ind_conv</span></span><span> </span><span class="entity"><span>rule'</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule't</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt't</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import</span><span> </span><span>true</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule'</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>rule't</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>ind_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>phi</span></span><span>
         </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt't</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_induction</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>rule'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>apply_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>rule'</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>apply_induction</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ind_inst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>aia_config</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ind_conv</span></span><span> </span><span class="entity"><span>rule'</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>#</span></span><span>ind </span><span class="entity"><span>phi</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ind_rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>focus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Subgoal.focus</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>rule'</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt01</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>context </span><span class="entity"><span>focus</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>insts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ind_inst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>focus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi_typ_parameters</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt01</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Tactic.rule_by_tactic</span><span> </span><span class="entity"><span>ctxt1</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="entity"><span>Induct.induct_tac</span></span><span> </span><span class="entity"><span>ctxt1</span></span><span> </span><span>true</span><span> </span><span class="comment1"><span>(*rethink this simplification flag*)</span></span><span>
                            </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>aia_config</span></span><span> </span><span class="entity"><span>focus</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Term.dest_Free</span><span> </span><span class="entity"><span>aia</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                            </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ind_rule</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="entity"><span>sequent1</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sequent2</span></span><span>
                            </span><span>|&gt;</span><span> </span><span class="entity"><span>ind_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>phi</span></span><span>
                            </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt1</span></span><span> </span><span class="entity"><span>ctxt01</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Subgoal.retrofit</span></span><span> </span><span class="entity"><span>ctxt01</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>params </span><span class="entity"><span>focus</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>asms </span><span class="entity"><span>focus</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>sequent3</span></span><span> </span><span class="entity"><span>rule'</span></span><span>
             </span><span>|&gt;</span><span> </span><span>Seq.hd</span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>apply_conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ind_conv</span></span><span> </span><span class="entity"><span>rule'</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule'3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ind_inst</span></span><span class="main"><span>,</span></span><span class="entity"><span>conv</span></span><span class="main"><span>,</span></span><span class="entity"><span>reasoning</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>reasoning</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>apply_induction</span></span><span> </span><span class="entity"><span>ind_inst</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>rule'</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>subgoal_reasonings</span></span><span> </span><span class="entity"><span>rule'</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule'4</span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>solver</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule'3</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>4</span></span><span> </span><span class="entity"><span>instruction</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ret</span></span><span>
                      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>oblg_solver</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.full_name</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"/"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
                                            </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>4</span></span><span> </span><span class="entity"><span>instruction</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule'3</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>Simplifier.rewrite_rule</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag_def|fact"><span>Action_Tag_def</span></a><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/ISABELLE_HOME/src/HOL/Eisbach/eisbach_rule_insts.ML.html#Eisbach.where|attribute"><span class="operator"><span>where</span></span></a><span> A</span><span class="main"><span class="main"><span>=</span></span></span><span class="quoted"><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_ANT|const"><span>φTA_ANT</span></a></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>
                </span><span>|&gt;</span><span> </span><span class="entity"><span>simp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>PLPR_Rule_Gen.Rule_Gen_SS.enhance</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>PLPR_Syntax.rulify_antecedents</span></span><span> </span><span>false</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                </span><span>|&gt;</span><span> </span><span class="entity"><span>PLPR_Syntax.merge_conditions</span></span><span>
                </span><span>|&gt;</span><span> </span><span class="entity"><span>PLPR_Syntax.merge_guards</span></span><span> </span><span class="main"><span>{</span></span><span>merge_cond</span><span class="main"><span>=</span></span><span>true</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.export</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span>

   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>rule'4</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Thm.solve_constraints</span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.unique_flexflex</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Drule.zero_var_indexes</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Default Hint Parser *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>malformed_hint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Malformed Hint"</span></span><span class="main"><span>,</span></span><span>
           </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>hint</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
          </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>parse_hint</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="comment1"><span>(*of the phi-typ const*)</span></span><span> * </span><span class="entity"><span>induct_inst_params</span></span><span> * </span><span class="entity"><span>hint</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_hint</span></span><span> </span><span class="entity"><span>extract_phityp</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>extract_phityp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extract_hhf</span></span><span> </span><span class="entity"><span>hint</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>φType</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span>
                      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Match</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>malformed_hint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phiconst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span>Term.dummy</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Term.binder_types</span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of</span><span> </span><span class="entity"><span>phity</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phity</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract_term</span></span><span>
           </span><span>|&gt;</span><span> </span><span>Term.strip_comb</span><span>
           </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span>#&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.dummy</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_term_of_phi</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>phiconst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>malformed_hint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="main"><span>[</span></span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"It specifies a irrelavent φ-type"</span></span><span> </span><span>@</span><span>
                          </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>phiconst</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
                          </span><span>text</span><span> </span><span class="inner_quoted"><span>"instead of the defining φ-type."</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of</span><span> </span><span class="entity"><span>phiconst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hint</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(* Default Conversion of the Induction Rule *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ind_conv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_ind_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conv_IH</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>conv_CL</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>:</span></span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Conv.hhf_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Logic.strip_assums_concl</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_subgoal|const"><span>φTA_subgoal</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="entity"><span>Phi_Conv.hhf_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Conv.hhf_concl_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_subgoal|const"><span>φTA_subgoal</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>conv_IH</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>
            </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_subgoal|const"><span>φTA_subgoal</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>conv_CL</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>
            </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>Conv.all_conv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Abstract Constraint Guided Reasoning *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_TA_IH_ToA</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_conditioned_ToA_template|const"><span>φTA_conditioned_ToA_template</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_TA_IH_ToA</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>timed_chop</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>xq</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;=</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>int</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xq</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Timeout.apply</span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span>Seq.pull</span><span> </span><span class="entity"><span>xq</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
      </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xq</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xq'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Basics.cons</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>timed_chop</span></span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>xq'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Timeout.TIMEOUT</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>Seq.empty</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate_ToA</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pure_info</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ToA</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>ToA</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_conditioned_ToA_template|const"><span>φTA_conditioned_ToA_template</span></a><span>›</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>target_prem</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>get_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>PLPR_Syntax.is_action_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_pure_facts|const"><span>φTA_pure_facts</span></a><span>›</span></span><span>
                           </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ctm</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>(</span></span><span>Thm.cprems_of</span><span> </span><span class="entity"><span>ToA</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>xx</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>xx</span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Bad Configuration: an induction hypothesis is declared with φTA_conditioned_ToA_template\
                                   \ but has no antecedent tagged with φTA_pure_facts"</span></span><span>
          </span><span class="comment1"><span>(* Gosh, I forget why I trace those instantiations...
          val vars = Drule.add_vars_cterm target_prem Cterms.empty
          val prem' = Cterms.fold ( curry Conjunction.mk_conjunction
                                  o Thm.cprop_of o Drule.mk_term
                                  o fst) vars target_prem*)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>elim_conj</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.conjunction</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conjunction.elim</span><span> </span><span class="entity"><span>thm</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>elim_conj</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>L</span></span><span>::</span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>R</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simplify_distinct</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>elim_conj</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ths</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>thsa</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>thsb</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                  </span><span>eq_list</span><span> </span><span class="main"><span>(</span></span><span>Thm.equiv_thm</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thsa</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thsb</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>snd</span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>insts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.init</span><span> </span><span class="entity"><span>target_prem</span></span><span>
                  </span><span>|&gt;</span><span class="main"><span>(</span></span><span class="comment1"><span>(*REPEAT_DETERM_N (Cterms.size vars) (
                        resolve_tac ctxt [Conjunction.conjunctionI] 1 THEN
                        resolve_tac ctxt [Drule.termI] 1)
                     THEN*)</span></span><span> </span><span>resolve_tac</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag_I|fact"><span>Action_Tag_I</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
                     </span><span>THEN</span><span> </span><span class="entity"><span>Method.insert_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pure_info</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Seq.hd</span><span>
                  </span><span class="comment1"><span>(*|&gt; @{print}
                  |&gt; Simplifier.full_simp_tac (Expansion.equip ctxt') 1 |&gt; Seq.hd
                  |&gt; @{print} *)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span class="entity"><span>Clasimp.fast_force_tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Expansion.equip</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
                  </span><span>|&gt;</span><span> </span><span class="entity"><span>timed_chop</span></span><span> </span><span class="main"><span>(</span></span><span>Time.fromMilliseconds</span><span> </span><span class="inner_numeral"><span>50</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>21</span></span><span> </span><span>|&gt;</span><span> </span><span>fst</span><span>
                  </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>Goal.conclude</span><span>
                  </span><span>|&gt;</span><span> </span><span class="entity"><span>simplify_distinct</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>RSN</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span class="entity"><span>ToA</span></span><span class="main"><span>)</span></span><span>
                                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag_D|fact"><span>Action_Tag_D</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
                                        </span><span class="comment1"><span>(*fun rewr_pat (<span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span>‹Trueprop› $ (<span class="hidden">\&lt;^</span><span class="control">Const_</span><span class="hidden">&gt;</span>‹Transformation ty› $ X $ Y $ _)) =
                                              (<span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span>‹Trueprop› $ (<span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span>‹Transformation ty› $ X $ Y
                                                  $ Var(("P", Term.maxidx_term X (Term.maxidx_term Y ~1) + 1), <span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span>‹bool›))) *)</span></span><span>
                                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ToA1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>th2</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.mk_ToA_rule|fact"><span>mk_ToA_rule</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
                                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ToA2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>th2</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.mk_ToA_rule&apos;|fact"><span>mk_ToA_rule'</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
                                     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>ToA1</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ToA2</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>insts</span></span><span> 
                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Phi_Reasoners.report_failure_reason1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span>
                          </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>chunks</span><span> </span><span class="main"><span>[</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"I fail to derive any instantiation of the induction-hypothetic reasoning rule"</span></span><span class="main"><span>,</span></span><span>
                                           </span><span>indent</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ToA</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                           </span><span>para</span><span> </span><span class="inner_quoted"><span>"because I fail to derive its premise"</span></span><span class="main"><span>,</span></span><span>
                                           </span><span>indent</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>target_prem</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                           </span><span>para</span><span> </span><span class="inner_quoted"><span>"from the contextual condition"</span></span><span class="main"><span>,</span></span><span>
                                           </span><span>indent</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pure_info</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                           </span><span>para</span><span> </span><span class="inner_quoted"><span>"Perhaps, the propositions are not sufficiently simplified. You may\
                                                \ need to add necessary rules by declaring [φderiver_simps], or \
                                                \even configure the BNF settings by ML ‹BNF_FP_Sugar_More.add_fp_more› "</span></span><span class="main"><span>]</span></span><span>
                       </span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>insts</span></span><span> </span><span>&gt;</span><span> </span><span class="inner_numeral"><span>20</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="inner_quoted"><span>"I find more than 20 instantiations which is very abnormal.\
                               \ I only take the first 20 instantiations."</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>insts</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_rewr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise|const"><span>Premise</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span>
          </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="entity"><span>Ty</span></span><span> </span><span class="main"><span>_</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>Phi_Syntax.dest_phi_type_ty</span></span><span> </span><span class="entity"><span>Ty</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise_D|fact"><span>Premise_D</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq_reflection|fact"><span>eq_reflection</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varify_subgoal</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>focus</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>LHS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.major_prem_of</span><span> </span><span class="entity"><span>sequent</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>focus</span></span><span> </span><span class="entity"><span>LHS</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LHSS</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_RHSS</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_schm_LHSS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>Vars.exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span>aconv</span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>focus</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>LHSS</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>real_LHSS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_schm_LHSS</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>LHSS</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rvar_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.invent</span><span> </span><span class="main"><span>(</span></span><span>Variable.names_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"schm"</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>real_LHSS</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_fixes_direct</span><span> </span><span class="entity"><span>rvar_names</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rvars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rvar_names</span></span><span> </span><span class="entity"><span>real_LHSS</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_fake_rvars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span>::</span><span class="entity"><span>bs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>o2</span></span><span>::</span><span class="entity"><span>l2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>hd</span><span> </span><span class="entity"><span>l1</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>mk_fake_rvars</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>(</span></span><span>tl</span><span> </span><span class="entity"><span>l1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>l2</span></span><span>
                                                       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>    </span><span class="entity"><span>o2</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>mk_fake_rvars</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>l1</span></span><span> </span><span class="entity"><span>l2</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_fake_rvars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fake_rvars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_fake_rvars</span></span><span> </span><span class="entity"><span>is_schm_LHSS</span></span><span> </span><span class="entity"><span>rvars</span></span><span> </span><span class="entity"><span>LHSS</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>l</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span> </span><span class="quoted"><span>‹</span><span>Term.fastype_of</span><span> </span><span class="entity"><span class="entity"><span>r</span></span></span><span>›</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>l</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>real_LHSS</span></span><span> </span><span class="entity"><span>rvars</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>gen_RHSS</span></span><span> </span><span class="entity"><span>fake_rvars</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>LHS</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>eq</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Goal.init</span><span>
                  </span><span>|&gt;</span><span> </span><span>Raw_Simplifier.rewrite_goals_rule</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Thm.assumption</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>Seq.hd</span><span>
                  </span><span>|&gt;</span><span> </span><span>Goal.conclude</span><span>
                  </span><span>|&gt;</span><span> </span><span>Thm.permute_prems</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
                  </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Goal.protect</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Goal.protect</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>sequent</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>varify_subgoal_finale0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Goal.conclude</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varify_subgoal_finale</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Phi_Help.repeat</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><span>Pure.reflexive</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sequent</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varify_all_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>focus</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vars.dest</span><span> </span><span class="entity"><span>vars</span></span><span>
               </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>frees</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>frees'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span>Term_Subst.instantiate_frees</span><span> </span><span class="main"><span>(</span></span><span>TFrees.empty</span><span class="main"><span>,</span></span><span>
                                            </span><span>Frees.make</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Free</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="entity"><span>frees'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Reasoning Configuration - setup local LPR rules, local premises, and rewrites **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoning</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ind_insts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span>option</span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>bool</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>list</span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ind_inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Subgoal.focus</span></span><span>
              * </span><span>term</span><span> </span><span>option</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*parameters of phi-type, if fixed*)</span></span><span>
              * </span><span class="entity"><span>phi_type</span></span><span>
              * </span><span>thm</span><span> </span><span class="comment1"><span>(*local sequent*)</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>ind_insts</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arbitrary_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Subgoal.focus</span></span><span>
                   </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*user hints*)</span></span><span>
                   </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*user hints*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>subgoal_configure</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ind_inst</span></span><span> * </span><span class="entity"><span>arbitrary_args</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*If not given, no induction will be applied*)</span></span><span>
                       * </span><span class="entity"><span>ind_conv</span></span><span>
                       * </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Type.phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoning</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>varifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cterm</span><span> </span><span>Vars.table</span><span> * </span><span class="entity"><span>Subgoal.focus</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>extract_pure_prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoning_configure</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> * </span><span class="entity"><span>Subgoal.focus</span></span><span> * </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span>
                        </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoning_configure_ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span>thm</span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.context</span></span><span>

</span><span class="comment1"><span>(* pass make ToA *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pass_make_ToA_i</span></span><span> </span><span class="entity"><span>mk_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ToA</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gp</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>ToA'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ToA'</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>gp</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PLPR_Syntax.dest_action_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_ToA_elim|const"><span>φTA_ToA_elim</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>ToA</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ToA</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag_D|fact"><span>Action_Tag_D</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mk_rules</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Syntax.dest_transformation</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>ToA</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>φType</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../IDE_CP_Applications1.html#IDE_CP_Applications1.MAKE|const"><span>MAKE</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>ToA</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mk_rules</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>ToA</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gp</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pass_make_ToA</span></span><span> </span><span class="entity"><span>mk_rules</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules_a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rules_b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>LPR_rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>rules_a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rules_b</span></span><span class="main"><span>,</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pass_make_ToA_i</span></span><span> </span><span class="entity"><span>mk_rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>LPR_rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pass_make_ToA_default</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pass_make_ToA</span></span><span>
      </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>deriving_local_rules</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.mk_ToA_rule|fact"><span>mk_ToA_rule</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>deriving_local_rules</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.mk_ToA_rule&apos;|fact"><span>mk_ToA_rule'</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>deriving_local_rules</span><span class="main"><span>-</span></span><span>10</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.mk_ToA_rule_varified|fact"><span>mk_ToA_rule_varified</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
       </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>deriving_local_rules</span><span class="main"><span>-</span></span><span>10</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.mk_ToA_rule&apos;_varified|fact"><span>mk_ToA_rule'_varified</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

</span><span class="comment1"><span>(* Loosen transformation relfexivity relaxing mutating parameters *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_loosen_ToA_refl</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>meq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_mutating_param_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.MODE_GUARD|const"><span>MODE_GUARD</span></a><span>›</span></span><span> </span><span class="entity"><span>phi</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>meq</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span>Config.put</span><span> </span><span>Pattern.unify_trace_failure</span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>ToA_unified_refl</span><span class="main"><span>+</span></span><span>1</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.ToA_refls_by_T_eq|fact"><span>ToA_refls_by_T_eq</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  
   


</span><span class="comment1"><span>(* the default reasoning configuration - extract implied pure facts from every LPR rule *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_reasoning_configure</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>focus</span></span><span class="main"><span>:</span></span><span class="entity"><span>Subgoal.focus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lsequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>local_prems</span></span><span class="main"><span>,</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_pure_fact</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Syntax.is_action_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_pure_facts|const"><span>φTA_pure_facts</span></a><span>›</span></span><span> </span><span>o</span><span> </span><span>Thm.concl_of</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_ToA_template</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Syntax.is_action_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_conditioned_ToA_template|const"><span>φTA_conditioned_ToA_template</span></a><span>›</span></span><span> </span><span>o</span><span> </span><span>Thm.concl_of</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pure_facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="entity"><span>is_pure_fact</span></span><span> </span><span class="entity"><span>local_prems</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag_D|fact"><span>Action_Tag_D</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ToAs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="entity"><span>is_ToA_template</span></span><span> </span><span class="entity"><span>local_prems</span></span><span>
              </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instantiate_ToA</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.conj_intros</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pure_facts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>holds_fact'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise_I|fact"><span>Premise_I</span></a><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/ISABELLE_HOME/src/HOL/Eisbach/eisbach_rule_insts.ML.html#Eisbach.where|attribute"><span class="operator"><span>where</span></span></a><span> mode</span><span class="main"><span class="main"><span>=</span></span></span><span class="quoted"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.MODE_GUARD|const"><span>MODE_GUARD</span></a></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pure_facts</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>local_prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>holds_fact'</span></span><span> </span><span>@</span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>is_pure_fact</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>is_ToA_template</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>local_prems</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prem_ants</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Reasoners.extract_implied_fact</span></span><span> </span><span class="main"><span>{</span></span><span>wrap_all</span><span class="main"><span>=</span></span><span>true</span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>local_prems</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>flat</span><span>
                 </span><span class="comment1"><span>(*|&gt; map (Conv.fconv_rule (HOLogic.Trueprop_conv (
                            Conv.rewr_conv @{thm' Premise_def[where mode=‹MODE_GUARD›, symmetric]})))*)</span></span><span>
</span><span class="comment1"><span>(*maps (fn th =&gt;
            case extract_prems ctxt th
              of [] =&gt; if is_real_Premise (Thm.concl_of th) then [th] else []
               | some =&gt; some
            ) local_prems*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extract_rewr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>local_prems</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ants</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter_out</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Reasoners.is_syntactic_premise</span></span><span> </span><span>o</span><span> </span><span>Thm.concl_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>local_prems</span></span><span>
              </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>loosen_ToA_refls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>may_has_mutating_params</span></span><span> </span><span class="entity"><span>phi</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mk_loosen_ToA_refl</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prem_ants</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rewrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>loosen_ToA_refls</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ToAs</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>ants</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** The major reasoning procedure **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_reasoning</span></span><span> </span><span class="entity"><span>always_diverge_disj</span></span><span> </span><span class="entity"><span>configure</span></span><span> </span><span class="entity"><span>varify</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>:</span></span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>elim_TA_ANT</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.strip_meta_hhf</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>get_index</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PLPR_Syntax.dest_action_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_ANT|const"><span>φTA_ANT</span></a><span>›</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ANT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exists_ANT</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.strip_meta_hhf</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
                           </span><span>|&gt;</span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PLPR_Syntax.dest_action_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_ANT|const"><span>φTA_ANT</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span>
                                                 </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ant</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ant</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>ANT</span></span><span>
                                                  </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>move_ANT_to_top</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Conv.meta_all_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>move_ANT_to_top</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>then_conv</span><span>
                   </span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><span>norm_hhf_eq</span><span class="main"><span>[</span></span><span class="operator"><span>symmetric</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>ANT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><span>swap_prems_eq</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>ctm</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"elim_TA_ANT.move_ANT_to_top"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ctm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>
                    </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_ANT|const"><span>φTA_ANT</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span>
                  </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span>
                  </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>exists_ANT</span></span><span> </span><span class="entity"><span>A</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>Conv.implies_concl_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>then_conv</span><span>
                           </span><span class="main"><span>(</span></span><span>Conv.implies_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>move_ANT_to_top</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>Conv.all_conv</span><span> </span><span>then_conv</span><span>
                            </span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.elim_TA_ANT|fact"><span>elim_TA_ANT</span></a><span class="antiquote"><span>}</span></span></span></span><span>
                            </span><span>else_conv</span><span>
                            </span><span class="entity"><span>Phi_Conv.hhf_conv</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Conv.try_conv</span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag_def|fact"><span>Action_Tag_def</span></a><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/ISABELLE_HOME/src/HOL/Eisbach/eisbach_rule_insts.ML.html#Eisbach.where|attribute"><span class="operator"><span>where</span></span></a><span> A</span><span class="main"><span class="main"><span>=</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_ANT|const"><span>φTA_ANT</span></a><span>›</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                              </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>Conv.all_conv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>then_conv</span><span>
                            </span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><span>swap_prems_eq</span><span class="antiquote"><span>}</span></span></span></span><span>
                           </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>Conv.implies_concl_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>then_conv</span><span>
                           </span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><span>swap_prems_eq</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Conv.meta_all_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conv</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>then_conv</span><span>
                   </span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><span>norm_hhf_eq</span><span class="main"><span>[</span></span><span class="operator"><span>symmetric</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"elim_TA_ANT.conv"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>ctm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>elim_TA_ANT'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Conv.hhf_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Conv.meta_alls_conv</span></span><span> </span><span class="entity"><span>elim_TA_ANT</span></span><span class="main"><span>)</span></span><span>
                                             </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>Conv.all_conv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_erule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>no_schematic_in_concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maxidx_of_term</span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="entity"><span>X</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.disj|const"><span>HOL.disj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>always_diverge_disj</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>no_schematic_in_concl</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.disjE|fact"><span>disjE</span></a><span class="antiquote"><span>}</span></span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Orelse_shortcut|const"><span>Orelse_shortcut</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>always_diverge_disj</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>no_schematic_in_concl</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.disjE|fact"><span>disjE</span></a><span class="main"><span>[</span></span><span class="operator"><span>folded</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Orelse_shortcut_def|fact"><span>Orelse_shortcut_def</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.conj|const"><span>HOL.conj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.conjE|fact"><span>conjE</span></a><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Ant_Seq|const"><span>Ant_Seq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.conjE|fact"><span>conjE</span></a><span class="main"><span>[</span></span><span class="operator"><span>folded</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Ant_Seq_def|fact"><span>Ant_Seq_def</span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_ANT|const"><span>φTA_ANT</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span>SOME</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag_E|fact"><span>Action_Tag_E</span></a><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/ISABELLE_HOME/src/HOL/Eisbach/eisbach_rule_insts.ML.html#Eisbach.where|attribute"><span class="operator"><span>where</span></span></a><span> A</span><span class="main"><span class="main"><span>=</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_ANT|const"><span>φTA_ANT</span></a><span>›</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;r&gt;Guard|const"><span>𝗋Guard</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;r&gt;Guard_E|fact"><span>𝗋Guard_E</span></a><span class="antiquote"><span>}</span></span></span></span><span>
            </span><span class="comment1"><span>(* | Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹HOL.conj›, _) $ _ $ _ =&gt;
                  let val (A,B) = (Thm.dest_arg1 ctm, Thm.dest_arg ctm)
                   in case check (Thm.dest_arg1 ctm)
                   of SOME tha =&gt;
                        SOME (tha COMP_INCR <span class="hidden">\&lt;^</span><span class="control">instantiate</span><span class="hidden">&gt;</span>‹B in
                                  lemma ‹⋀P X Y C. (P ⟹ (X ⟹ C) ⟹ (Y ⟹ C) ⟹ C)
                                                ⟹ (P ∧ B ⟹ (X ∧ B ⟹ C) ⟹ (Y ∧ B ⟹ C) ⟹ C)›
                                     by blast›)
                    | NONE =&gt;
                  (case check (Thm.dest_arg ctm)
                     of SOME thb =&gt;
                        SOME (thb COMP_INCR <span class="hidden">\&lt;^</span><span class="control">instantiate</span><span class="hidden">&gt;</span>‹A in
                                  lemma ‹⋀P X Y C. (P ⟹ (X ⟹ C) ⟹ (Y ⟹ C) ⟹ C)
                                                ⟹ (A ∧ P ⟹ (A ∧ X ⟹ C) ⟹ (A ∧ Y ⟹ C) ⟹ C)›
                                     by blast›)
                      | NONE =&gt; NONE)
                  end
               | Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹Ant_Seq›, _) $ _ $ _ =&gt;
                  let val (A,B) = (Thm.dest_arg1 ctm, Thm.dest_arg ctm)
                   in case check (Thm.dest_arg1 ctm)
                   of SOME tha =&gt;
                        SOME (tha COMP_INCR <span class="hidden">\&lt;^</span><span class="control">instantiate</span><span class="hidden">&gt;</span>‹B in
                                  lemma ‹⋀P X Y C. (P ⟹ (X ⟹ C) ⟹ (Y ⟹ C) ⟹ C)
                                                ⟹ (P ∧<span class="hidden">⇩</span><sub>𝗋</sub> B ⟹ (X ∧<span class="hidden">⇩</span><sub>𝗋</sub> B ⟹ C) ⟹ (Y ∧<span class="hidden">⇩</span><sub>𝗋</sub> B ⟹ C) ⟹ C)›
                                     by (unfold Ant_Seq_def, blast)›)
                    | NONE =&gt;
                  (case check (Thm.dest_arg ctm)
                     of SOME thb =&gt;
                        SOME (thb COMP_INCR <span class="hidden">\&lt;^</span><span class="control">instantiate</span><span class="hidden">&gt;</span>‹A in
                                  lemma ‹⋀P X Y C. (P ⟹ (X ⟹ C) ⟹ (Y ⟹ C) ⟹ C)
                                                ⟹ (A ∧<span class="hidden">⇩</span><sub>𝗋</sub> P ⟹ (A ∧<span class="hidden">⇩</span><sub>𝗋</sub> X ⟹ C) ⟹ (A ∧<span class="hidden">⇩</span><sub>𝗋</sub> Y ⟹ C) ⟹ C)›
                                     by (unfold Ant_Seq_def, blast)›)
                      | NONE =&gt; NONE)
                  end
               | Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹Action_Tag›, _) $ _ $ _ =&gt;
                  check (Thm.dest_arg1 ctm)
                    |&gt; Option.map (fn rule =&gt;
                        let val X = Thm.dest_arg ctm
                         in rule COMP_INCR
                            <span class="hidden">\&lt;^</span><span class="control">instantiate</span><span class="hidden">&gt;</span>‹X in lemma ‹⋀P A C B. (P ⟹ (A ⟹ C) ⟹ (B ⟹ C) ⟹ C)
                                                ⟹ (P @tag X ⟹ (A @tag X ⟹ C) ⟹ (B @tag X ⟹ C) ⟹ C) ›
                                              by (unfold Action_Tag_def, blast)›
                        end) *)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>get_first</span><span> </span><span class="entity"><span>check</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.leading_antecedent</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

    </span><span class="comment1"><span>(*‹Rule (T params)› ⟹ (guard condition params = vars ⟹ Rule (T vars) )
      so that the rule can be matched even when the parameter varies.
     *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varify_phi_type_parameter</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoner.the_default_pattern_of</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_param</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=</span></span><span>
               </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.strip_comb</span><span> </span><span class="entity"><span>X</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_term_of_phi</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>head</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_Var</span><span> </span><span class="main"><span>(</span></span><span>Term.head_of</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span>
                              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>X'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="entity"><span>X</span></span><span>
                                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X'</span></span><span>
                                   </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>ret</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>filter_param</span></span><span> </span><span class="entity"><span>bvs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>filter_param</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>filter_param</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span>::</span><span class="entity"><span>bvs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="entity"><span>ret</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>filter_param</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ret</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>filter_param</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.invent</span><span> </span><span class="main"><span>(</span></span><span>Variable.names_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"𝗏"</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt't</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq0_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.Trueprop</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;r&gt;Guard|const"><span>𝗋Guard</span></a><span>›</span></span><span> </span><span>$</span><span>
                          </span><span class="entity"><span>PLPR_Syntax.mk_ant_sequence</span></span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>N'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                              </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise|const"><span>Premise</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.MODE_GUARD|const"><span>MODE_GUARD</span></a><span>›</span></span><span> </span><span>$</span><span>
                                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>tm</span></span><span>
                                 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="entity"><span class="entity"><span>T</span></span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>tm</span></span><span> </span><span>$</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N'</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                       </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt't</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>inst</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>rule1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt't1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import</span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt't</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq0_term1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.instantiate_cterm</span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>eq0_term</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>eq0</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Assumption.add_assms</span><span> </span><span>Assumption.presume_export</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq0_term1</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt't1</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise_def|fact"><span>Premise_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span>then_conv</span><span>
                                          </span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.atomize_eq|fact"><span>atomize_eq</span></a><span class="main"><span>[</span></span><span class="operator"><span>symmetric</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="entity"><span>PLPR_Syntax.elim_ant_sequence</span></span><span>
                            </span><span class="main"><span>(</span></span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;r&gt;Guard_def|fact"><span>𝗋Guard_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eq0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.concl_conv</span><span> </span><span class="main"><span>(</span></span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>rule1</span></span><span class="main"><span>)</span></span><span>
                                                       </span><span class="main"><span>(</span></span><span>Conv.top_rewrs_conv</span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule1</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>Assumption.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt't1</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt't1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>PLPR_Syntax.merge_guards</span></span><span> </span><span class="main"><span>{</span></span><span>merge_cond</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule'</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reasoning</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>sequent0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.major_prem_of</span><span> </span><span class="entity"><span>sequent0</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="comment1"><span>(*Trueprop*)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.TrueI|fact"><span>TrueI</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sequent0</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="comment1"><span>(*Trueprop*)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;r&gt;Success|const"><span>𝗋Success</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;r&gt;Success_I|fact"><span>𝗋Success_I</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sequent0</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="comment1"><span>(*Trueprop*)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.All|const"><span>HOL.All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>reasoning</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.allI|fact"><span>allI</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sequent0</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>parse_erule</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>sequent0</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>erule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
       </span><span>Seq.hd</span><span> </span><span class="main"><span>(</span></span><span>Thm.biresolution</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>erule</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>sequent0</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>reasoning</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="comment1"><span>(*val _ = if Term.is_schematic (Phi_Help.leading_antecedent' sequent0)
              then raise THM("Bad Reasoning: the leading antecedent of the sequent containing varaibles!", 1, [sequent0])
              else ()*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unknown_vars</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt01</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import</span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>sequent0</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span>
                 </span><span class="comment1"><span>(*|&gt; (fn th =&gt; @{thm' impI} RS th
                              handle THM _ =&gt; Method.insert_tac ctxt0 [Thm.transfer' ctxt0 @{thm' TrueI}] 1 th
                                           |&gt; Seq.hd)*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>focus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lsequent'0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Subgoal.focus</span></span><span> </span><span class="entity"><span>ctxt01</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>sequent</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>context </span><span class="entity"><span>focus</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lsequent</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>varify_subgoal</span></span><span> </span><span class="entity"><span>varify</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>unknown_vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>focus</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lsequent'0</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_out_ant</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Syntax.is_action_of</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_ANT|const"><span>φTA_ANT</span></a><span>›</span></span><span> </span><span>o</span><span> </span><span>Thm.concl_of</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>out_ants</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="entity"><span>is_out_ant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>prems </span><span class="entity"><span>focus</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>local_prems'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter_out</span><span> </span><span class="entity"><span>is_out_ant</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>prems </span><span class="entity"><span>focus</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>elim_out_ants</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>get_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span>aconv</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>out_ants</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.hd</span><span> </span><span class="main"><span>(</span></span><span>Thm.biresolution</span><span> </span><span>NONE</span><span> </span><span>true</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
                              </span><span>|&gt;</span><span> </span><span class="entity"><span>elim_out_ants</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>
                                      </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_ANT|const"><span>φTA_ANT</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
                                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>i</span></span><span>  </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.gconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag_def|fact"><span>Action_Tag_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th</span></span><span>
             </span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>local_prems'1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>elim_out_ants</span></span><span> </span><span class="entity"><span>local_prems'</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pass_out_ant</span></span><span> </span><span class="entity"><span>ant</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ant</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag_D|fact"><span>Action_Tag_D</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>PLPR_Syntax.elim_ant_sequence_or_HOL_conj</span></span><span>
            </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span> </span><span>Thm.forall_elim_vars</span><span> </span><span class="main"><span>(</span></span><span>Thm.maxidx_of</span><span> </span><span class="entity"><span>lsequent</span></span><span class="main"><span>)</span></span><span>
                   </span><span>o</span><span> </span><span class="entity"><span>Phi_Help.repeat</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.spec|fact"><span>spec</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pass_prem</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.conjunction</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span>maps</span><span> </span><span class="entity"><span>pass_prem</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><span>Pure.conjunctionD1</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                              </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><span>Pure.conjunctionD2</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>local_prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="entity"><span>pass_out_ant</span></span><span> </span><span class="entity"><span>out_ants</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>local_prems'1</span></span><span class="main"><span>)</span></span><span>
                     </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="entity"><span>pass_prem</span></span><span>
                     </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>PLPR_Syntax.rulify_antecedents</span></span><span> </span><span>false</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                          </span><span>#&gt;</span><span> </span><span class="entity"><span>PLPR_Syntax.merge_guards</span></span><span> </span><span class="main"><span>{</span></span><span>merge_cond</span><span class="main"><span>=</span></span><span>true</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                          </span><span>#&gt;</span><span> </span><span class="entity"><span>PLPR_Syntax.elim_leading_All</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prem_ants</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rewrs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reasoner_ants'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>configure</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>focus</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lsequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>local_prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reasoner_ants</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reasoner_ants'</span></span><span>
            </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Simplifier.rewrite_rule</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rewrs</span></span><span>
                        </span><span>#&gt;</span><span> </span><span class="entity"><span>Phi_Help.instantiate_higher_order_schematic_var_for_rule_guess</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                        </span><span>#&gt;</span><span> </span><span class="entity"><span>has_mutating_params</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>varify_phi_type_parameter</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>Phi_Syntax.chk_source_val</span></span><span> </span><span>false</span><span>
            </span><span>|&gt;</span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Reasoner.add_rules</span></span><span> </span><span class="main"><span>(</span></span><span>
                  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                            </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Phi_Reasoner.TO_BE_OVERRIDE'</span></span><span class="main"><span>,</span></span><span>
                             </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>deriving_local_rules</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                             </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reasoner_ants</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>Useful_Thms.add_thm</span></span><span> </span><span class="entity"><span>prem_ants</span></span><span class="main"><span>)</span></span><span>
            </span><span class="comment1"><span>(* #&gt; Phi_Reasoner.add_rules (map (fn (pat,rule) =&gt;
                    ([rule], Position.none, Phi_Reasoner.NORMAL, 200, [(pat,NONE)], [], NONE)) ToAs) *)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lsequent'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lsequent</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>Simplifier.rewrite_goals_rule</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rewrs</span></span><span>
                    </span><span class="comment1"><span>(*|&gt; ALLGOALS (Method.insert_tac ctxt'' prem_ants)
                    |&gt; Seq.hd*)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span>
                    </span><span>|&gt;</span><span> </span><span class="entity"><span>varify_subgoal_finale0</span></span><span>
                    </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Reasoners.augment_conditions</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Useful_Thms.get</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span>

      </span><span class="comment1"><span>(*val lsequent'' = fold PLPR_Syntax.provide_premise_condition prem_ants lsequent'*)</span></span><span>

   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Subgoal.retrofit</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span> </span><span class="entity"><span>ctxt01</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>params </span><span class="entity"><span>focus</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>asms </span><span class="entity"><span>focus</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>lsequent'</span></span><span> </span><span class="entity"><span>sequent</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Seq.hd</span><span>
   </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt01</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Reasoners.defer_obligation_tac</span></span><span> </span><span class="main"><span>{</span></span><span>can_inst</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>,</span></span><span> fix_level</span><span class="main"><span>=</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Seq.hd</span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>varify_subgoal_finale</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>reasoning</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Simplifier.norm_hhf</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>elim_TA_ANT'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Conv.gconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.full_rewrite</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span>clear_simpset</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span>
            </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.simp_thms|fact"><span>HOL.simp_thms</span></a><span class="main"><span>(</span></span><span>31</span><span class="main"><span>)</span></span><span class="main"><span>[</span></span><span class="operator"><span>folded</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.atomize_eq|fact"><span>atomize_eq</span></a><span class="main"><span>]</span></span><span>
                     </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.simp_thms|fact"><span>HOL.simp_thms</span></a><span class="main"><span>(</span></span><span>31</span><span class="main"><span>)</span></span><span class="main"><span>[</span></span><span class="operator"><span>folded</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.atomize_eq|fact"><span>atomize_eq</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Orelse_shortcut_def|fact"><span>Orelse_shortcut_def</span></a><span class="main"><span>]</span></span><span>
                     </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;r&gt;Guard_def|fact"><span>𝗋Guard_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>
           </span><span>@</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>‹</span><span class="free"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.FAIL|const"><span>FAIL</span></a><span> </span><span class="free"><span>text</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span>P</span></span><span>›</span></span><span> </span><span class="quoted"><span>‹</span><span class="free"><span>P</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Orelse_shortcut|const"><span>∨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>t</sub></span></a></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.FAIL|const"><span>FAIL</span></a><span> </span><span class="free"><span>text</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span>P</span></span><span>›</span></span><span>
                     </span><span class="quoted"><span>‹</span><span class="free"><span>P</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.disj|const"><span>∨</span></a></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.TRACE_FAIL|const"><span>TRACE_FAIL</span></a><span> </span><span class="free"><span>text</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span>P</span></span><span>›</span></span><span> </span><span class="quoted"><span>‹</span><span class="free"><span>P</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Orelse_shortcut|const"><span>∨<span class="hidden">⇩</span><sub>c</sub><span class="hidden">⇩</span><sub>u</sub><span class="hidden">⇩</span><sub>t</sub></span></a></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.TRACE_FAIL|const"><span>TRACE_FAIL</span></a><span> </span><span class="free"><span>text</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span>P</span></span><span>›</span></span><span>
                  </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>unfold</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.FAIL_def|fact"><span>FAIL_def</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Orelse_shortcut_def|fact"><span>Orelse_shortcut_def</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.TRACE_FAIL_def|fact"><span>TRACE_FAIL_def</span></a><span class="main"><span class="keyword3"><span>,</span></span></span><span> </span><span class="operator"><span>simp_all</span></span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>reasoning</span></span><span> </span><span class="main"><span>(</span></span><span>Config.map</span><span> </span><span class="entity"><span>Phi_Reasoner.trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>=&gt;</span></span><span class="entity"><span>i</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_unfolded</span></span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_atom</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_atom</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_atom</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_atom</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>aconv</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>X</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../IDE_CP_Applications1.html#IDE_CP_Applications1.Bubbling|const"><span>Bubbling</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>C</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../IDE_CP_Applications1.html#IDE_CP_Applications1.Bubbling|const"><span>Bubbling</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>B</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../IDE_CP_Applications1.html#IDE_CP_Applications1.Bubbling|const"><span>Bubbling</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>A</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>X</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span> </span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists_subterm</span><span> </span><span class="main"><span>(</span></span><span>
           </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>φType</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>is_atom</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
                </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>bads</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>exists_Const</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bads</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
          </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>term</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Phi_Reasoners.report_failure_reason1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
              </span><span>chunks</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"The phi-type is not unfolded by simplification and inductive destruction."</span></span><span class="main"><span>,</span></span><span>
                      </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>]</span></span><span>
            </span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>conv_chk_unfolded</span></span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>chk_unfolded</span></span><span> </span><span class="entity"><span>bads</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pure_PLPR_reasoning</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Phi_Reasoner.reason</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>num</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sequent</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"φ-LPR reasoning fails"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pure_PLPR_reasoner</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>sequent</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cprop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="keyword1"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Proof_Obligation|const"><span>𝗈𝖻𝗅𝗂𝗀𝖺𝗍𝗂𝗈𝗇</span></a></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span></span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cprop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;r&gt;Success|const"><span>𝗋Success</span></a><span>›</span></span></span></span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.permute_prems</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Reasoner.reason</span></span><span> </span><span>NONE</span><span> </span><span>NONE</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"φ-LPR reasoning fails"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exhaustive_PLPR_reasoner</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>chk_unfolds</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.strip_comb</span><span> </span><span class="entity"><span>X</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>app_index</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>app_index</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chk_unfolds</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>app_index</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>app_index</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>args</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.major_prem_of</span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>PLPR_Exhaustive.reason_exhaustively</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"φ-LPR reasoning fails"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exhaustive_PLPR_reasoner_by_rule</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>chk_unfolds</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>exhaustive_PLPR_reasoner</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>chk_unfolds</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                           </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Simplifier *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>simplifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_simplifier</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule'1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt't1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import</span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lprems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Assumption.add_assms</span><span> </span><span>Assumption.presume_export</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprems_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt't1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pures</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Reasoners.extract_implied_fact</span></span><span> </span><span class="main"><span>{</span></span><span>wrap_all</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lprems</span></span><span>
               </span><span>|&gt;</span><span> </span><span>flat</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule'2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lp</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.implies_elim</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>lp</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lprems</span></span><span> </span><span class="entity"><span>rule'1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule'3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pures</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule'2</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>rule'3</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Assumption.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt't1</span></span><span>
   </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt't1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_simplifier'</span></span><span> </span><span class="entity"><span>gen_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>default_simplifier</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lprems</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.special_Ex_def|fact"><span>special_Ex_def</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>::</span><span> </span><span class="entity"><span>lprems</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.add_cong</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.disj_cong|fact"><span>HOL.disj_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.add_cong</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.conj_cong|fact"><span>HOL.conj_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simplifier_by_cong</span></span><span> </span><span class="entity"><span>congs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>default_simplifier'</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rewr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rewr</span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>Simplifier.add_cong</span></span><span> </span><span class="entity"><span>congs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simplifier_by_LPR</span></span><span> </span><span class="entity"><span>configure</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>default_simplifier</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi_facts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoner.info_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>str</span><span> </span><span class="inner_quoted"><span>"φ-LPR based simplification"</span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Phi_Reasoner.reason</span></span><span> </span><span>NONE</span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>configure</span></span><span> </span><span class="entity"><span>phi_facts</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sequent</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ret</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"φ-LPR based simplification fails"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simplifier_by_LPR'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simplifier_by_LPR</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.special_Ex_def|fact"><span>special_Ex_def</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>::</span><span> </span><span class="entity"><span>facts</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.add_cong</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.disj_cong|fact"><span>HOL.disj_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.add_cong</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.conj_cong|fact"><span>HOL.conj_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Pre-Simplifier *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pre_simplifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_pre_simplifier</span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Conv.hhf_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Logic.strip_assums_concl</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_subgoal|const"><span>φTA_subgoal</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="entity"><span>conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>Conv.all_conv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(*** Other Tools ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_forall_quantified_property</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rev_args_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m_ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_parameterized_phi_ty</span></span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>rev_args_ty</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rev_args_ty</span></span><span> </span><span class="entity"><span>phi</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.all_const</span></span><span> </span><span class="entity"><span>x_ty</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m_ty</span></span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.all_const</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"a"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rev_args_ty</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>make_forall_quantified_property_for_parameters_of_a_phi_type</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>F</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>try</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>make_forall_quantified_property</span></span><span> </span><span class="entity"><span>mk</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>make_forall_quantified_property_for_parameters_of_a_phi_type</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>F</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>make_forall_quantified_property_for_parameters_of_a_phi_type</span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>F</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>make_forall_quantified_property_for_parameters_of_a_phi_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_abstract_object_quantified</span></span><span> </span><span class="entity"><span>get_x</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_x'</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_x'</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_x'</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_x'</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_x'</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_x'</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_x'</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.All|const"><span>HOL.All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_x'</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_x'</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_x'</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_x'</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_x</span></span><span> </span><span class="entity"><span>X</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Logic.strip_assums_concl</span><span> </span><span class="entity"><span>hint</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="main"><span>[</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"The abstract object must be universally quantified, e.g.,"</span></span><span class="main"><span>,</span></span><span>
                     </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span>
                        </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.all_const</span></span><span> </span><span class="entity"><span>Ty</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Phi_Help.abstract_over</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"The abstract object must be universally quantified"</span></span><span class="main"><span>]</span></span><span>
          </span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                 
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_x'</span></span><span> </span><span class="entity"><span>hint</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hint</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hint</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>hint</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>hint</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* (** Misc **)

fun conv_eq_imp ctxt ctm =
  (Conv.rewr_conv @{thm imp_ex[folded atomize_eq]} then_conv
   Phi_Conv.hol_all_conv (conv_eq_imp o snd) ctxt) ctm
  handle CTERM _ =&gt; Conv.all_conv ctm
       | THM _ =&gt; Conv.all_conv ctm *)</span></span><span>

</span><span class="comment1"><span>(* fun gen_identity_element is_left hints phi thy =
  case hints of [] =&gt; gen_id_ele is_left phi NONE thy

fun gen_identity_element is_left phi hints_thy =
  select_one_hint (if is_left then <span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹Identity_Element<span class="hidden">⇩</span><sub>I</sub>›
                              else <span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹Identity_Element<span class="hidden">⇩</span><sub>E</sub>›)
                  (gen_id_ele is_left phi)
                  hints_thy *)</span></span><span>

</span><span class="comment1"><span>(*
(*** Install Automation ***)

val _ = Theory.setup (
  Phi_Type.define_deriver_global <span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span>‹Identity_Element<span class="hidden">⇩</span><sub>I</sub>› {
      priority = 100,
      dependences = [],
      derive = accept_one "Identity_Element<span class="hidden">⇩</span><sub>I</sub>" (gen_id_ele true)
    } #-&gt; (fn name =&gt; Context.theory_map (
      Phi_Type.bind_derivers_on_patterns [(<span class="hidden">\&lt;^</span><span class="control">pattern_prop</span><span class="hidden">&gt;</span>‹Identity_Element<span class="hidden">⇩</span><sub>I</sub> _ _›, name)]))
)*)</span></span><span>

</span><span class="comment1"><span>(* val _ = Theory.setup (Context.theory_map (
   Phi_Type.add_automation_on_def 100 (gen_identity_element true)
#&gt; Phi_Type.add_automation_on_def 101 (gen_identity_element false)
#&gt; Phi_Type.add_automation_on_def 105 gen_obj_equal
#&gt; Phi_Type.add_automation_on_def 110 gen_TF
#&gt; Phi_Type.add_automation_on_def 120 (gen_SH true)
#&gt; Phi_Type.add_automation_on_def 121 (gen_SH false)
)) *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>wrap_ind_target</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Phi_Conv.hhf_concl_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
   </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Syntax.transformation_conv</span></span><span>
      </span><span>Conv.all_conv</span><span>
      </span><span class="main"><span>(</span></span><span>Conv.top_sweep_conv</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_term_of_phi</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span>Term.head_of</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;TA_IND_TARGET_def|fact"><span>φTA_IND_TARGET_def</span></a><span class="main"><span>[</span></span><span class="operator"><span>folded</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.atomize_eq|fact"><span>atomize_eq</span></a><span class="main"><span>,</span></span><span> </span><span class="operator"><span>symmetric</span></span><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>ctm</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Conv.no_conv</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span>Conv.all_conv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span></pre>
</body>

</html>