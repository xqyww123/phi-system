<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/system/toplevel.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/system/toplevel.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(* FILE: library/system/toplevel.ML
   AUTHOR: Qiyuan Xu

   Definition of Isar commands for IDE-CP.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PHI_TOPLEVEL</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>include</span></span></span><span> </span><span class="entity"><span>PHI_TOPLEVEL</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>cond_kind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Premise</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Assumption</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span>'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Mod_by_Rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 'a </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Mod_by_Attr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 'b

  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Finishing_Modifier_Hooks </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>HOOKS</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Finishing_Construction_Hooks </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>HOOKS</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Begining_Procedures </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>HOOKS</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Infer_Requirements </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>HOOKS</span></span><span>

  </span><span class="comment1"><span>(*val is_interactive : bool Config.T
  exception Schematic*)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> name_of_the_building_procedure </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> free_fixed_outside </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Name.context</span><span> </span><span>option</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> begin_proc_cmd </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*whether to define a new constant*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Attrib.binding</span></span><span> </span><span class="comment1"><span>(*name*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span>xstring</span><span> </span><span class="comment1"><span>(*input*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span>xstring</span><span> </span><span class="comment1"><span>(*output*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span>xstring</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*throws*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>string</span><span> </span><span>option</span><span> * </span><span>mixfix</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*for fixes*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>xstring</span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*includes*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.binding</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*local definitions*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cond_kind</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.binding</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*preconditions*)</span></span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span>option</span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Facts.ref</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modifier</span></span><span> </span><span>list</span><span>
        </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span>

</span><span class="comment1"><span>(*
  val begin_rec_proc_cmd : bool (*whether to define a new constant*)
        -&gt; Attrib.binding
        -&gt; xstring (*input*)
        -&gt; xstring (*output*)
        -&gt; xstring option (*throws*)
        -&gt; ((binding * string option * mixfix) list * (*variants*)
            (binding * string option * mixfix) list   (*for fixes*))
        -&gt; (xstring * Position.T) list (*includes*)
        -&gt; (Attrib.binding * (string * string list)) list (*local definitions*)
        -&gt; (cond_kind * (Attrib.binding * (string * string list))) list (*preconditions*)
        -&gt; string option
        -&gt; bool -&gt; local_theory -&gt; Proof.state *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> statement_clean_values </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span> </span><span class="comment1"><span>(*controls whether the statement command <span class="hidden">❙</span><b>;</b>
        cleans all values at its beginning.*)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> prove_prem </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.eval_cfg</span></span><span> * </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span class="entity"><span>Proof.state</span></span><span>

  </span><span class="comment1"><span>(*val export_LLVM : theory -&gt; theory *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Phi_Toplevel</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PHI_TOPLEVEL</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Phi_Toplevel</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v_proc_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"𝗉𝗋𝗈𝖼"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* Library *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_results</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof_Display.print_results</span></span><span>
                            </span><span class="main"><span>{</span></span><span>interactive</span><span class="main"><span>=</span></span><span class="entity"><span>int</span></span><span class="main"><span>,</span></span><span> pos</span><span class="main"><span>=</span></span><span>Position.thread_data</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> proof_state</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_decls</span></span><span> </span><span class="entity"><span>prep_var</span></span><span> </span><span class="entity"><span>raw_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span class="entity"><span>prep_var</span></span><span> </span><span class="entity"><span>raw_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span>
      </span><span>|&gt;</span><span> </span><span>Context_Position.set_visible</span><span> </span><span>false</span><span>
      </span><span>|&gt;</span><span> </span><span>Proof_Context.add_fixes</span><span> </span><span class="entity"><span>vars</span></span><span>
      </span><span>||&gt;</span><span> </span><span>Context_Position.restore_visible</span><span> </span><span class="entity"><span>ctxt'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt''</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>cond_kind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Premise</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Assumption</span></span><span>



</span><span class="comment1"><span>(** Programming Block **)</span></span><span>

</span><span class="comment1"><span>(** Statement **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_prem</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cfg</span></span><span class="main"><span>,</span></span><span class="entity"><span>int</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>after_qed''</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Envir.the_state_sequent</span></span><span> </span><span class="entity"><span>stat</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>stat</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Envir.set_state_sequent</span></span><span> </span><span class="entity"><span>sequent</span></span><span>
               </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_CP_IDE.call_of_state_sequent</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Config.put</span><span> </span><span class="entity"><span>Phi_Reasoner.auto_level</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_CP_IDE.Post_App.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cfg</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span> </span><span>Config.restore</span><span> </span><span class="entity"><span>Phi_Reasoner.auto_level</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>)</span></span><span>
               </span><span>|&gt;</span><span> </span><span class="entity"><span>after_qed''</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>stat</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Sys.obligation_proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_results</span></span><span> </span><span class="entity"><span>int</span></span><span class="main"><span>)</span></span><span> </span><span>Proof_Context.mode_schematic</span><span> </span><span class="inner_quoted"><span>""</span></span><span>
        </span><span>NONE</span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>sequent</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
 </span><span class="comment1"><span>(*let open Proof
    val sequent = Phi_Envir.the_state_sequent stat
    val goal = Thm.prop_of sequent
                |&gt; Logic.dest_implies |&gt; #1 (* |&gt; dest_premise_tag |&gt; mk_Trueprop *)
    fun after_qed (ctxt',[[th]]) stat =
      let
        val [th] = Proof_Context.export ctxt' (context_of stat) [th]
        val original_auto_level = Config.get (Proof.context_of stat) Phi_Reasoner.auto_level
      in
        stat |&gt; Proof.map_context_result
                  (Config.put Phi_Reasoner.auto_level 0
                    #&gt; (fn ctxt =&gt; Phi_Processor.process_no_input (ctxt, th RS specthm))
                    #&gt; apfst (Config.put Phi_Reasoner.auto_level original_auto_level)
                    #&gt; swap)
             |-&gt; Phi_Envir.set_state_sequent
      end
  in
    stat |&gt; Phi_Sys.setup_proof (print_results int) Proof_Context.mode_schematic ""
              NONE after_qed [] [] [[(goal,[])]]
         |&gt; apsnd (
              Proof.map_context (Proof_Context.set_mode Proof_Context.mode_default)
           #&gt; Proof.refine (Method.Basic (fn ctxt =&gt; Method.SIMPLE_METHOD (
                HEADGOAL (resolve_tac ctxt @{thms Premise_I})
              ))) #&gt; Seq.the_result "should never fail"
            )
  end*)</span></span><span>


</span><span class="comment1"><span>(** Header of Procedure **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="main"><span>(</span></span><span>'a</span><span class="main"><span>,</span></span><span>'b</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>modifier</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Mod_by_Rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 'a </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Mod_by_Attr</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 'b

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Finishing_Modifier_Hooks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hooks</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unit</span><span>
                                            </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>context_state</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Finishing_Construction_Hooks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hooks</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unit</span><span>
                                                </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>context_state</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Begining_Procedures</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hooks</span></span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
    includes</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    assms</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span class="main"><span>,</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Element.ctxt</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
    concls</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>typ</span><span class="main"><span>,</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>Element.stmt</span></span><span class="main"><span>,</span></span><span>
    after_qed</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>,</span></span><span>
    lthy</span><span class="main"><span>:</span></span><span> </span><span>local_theory</span><span>
  </span><span class="main"><span>}</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Infer_Requirements</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hooks</span></span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
      arg</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
      ret</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
      throw</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
      existing_requirements</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
    </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
    parse_ctxt</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>,</span></span><span>
    new_requirements</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span> </span><span>list</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*inferred premises / requirements*)</span></span><span>
  </span><span class="main"><span>}</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>enable_infer_requirements</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="IDE_CP_Core.\&lt;phi&gt;infer_requirements|attribute"><span>φinfer_requirements</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Procedure_Envir</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> binding</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span class="main"><span>,</span></span><span>
             free_fixed_outside</span><span class="main"><span>:</span></span><span> </span><span>Name.context</span><span> </span><span class="main"><span>}</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name_of_the_building_procedure</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>#</span></span><span>binding </span><span>o</span><span> </span><span>Procedure_Envir.get</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>free_fixed_outside</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>#</span></span><span>free_fixed_outside </span><span>o</span><span> </span><span>Procedure_Envir.get</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>infer_requirements</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>enable_infer_requirements</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Infer_Requirements.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>{</span></span><span>
                parse_ctxt </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span>
                new_requirements </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>}</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>{</span></span><span>new_requirements</span><span class="main"><span>=</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>existing_requirements </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>new_requirements</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>parse_ctxt</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
              </span><span class="entity"><span>Phi_Reasoner.warn_pretty</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>parse_ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span>chunks</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"Several comonly useful premises are inferred and added to the specification"</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
                    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>prem</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span>item</span><span> </span><span class="main"><span>[</span></span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>parse_ctxt</span></span><span> </span><span class="entity"><span>prem</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>new_requirements</span></span><span> </span><span>@</span><span>
                    </span><span class="main"><span>[</span></span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"If they are too aggressive, you may disable this automation by ‹declare [[φinfer_requirements = false]]›"</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>parse_ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>existing_requirements </span><span class="entity"><span>arg</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>new_requirements</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>existing_requirements </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_begin_proc</span></span><span> </span><span class="entity"><span>prep_term</span></span><span> </span><span class="entity"><span>prep_prop</span></span><span> </span><span class="entity"><span>prep_var</span></span><span> </span><span class="entity"><span>prep_attr</span></span><span> </span><span class="entity"><span>def_const</span></span><span>
      </span><span class="entity"><span>binding</span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="entity"><span>throws</span></span><span> </span><span class="entity"><span>rawfixes</span></span><span> </span><span class="entity"><span>includes</span></span><span> </span><span class="entity"><span>raw_defines</span></span><span> </span><span class="entity"><span>raw_preconds</span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="entity"><span>raw_modifiers</span></span><span>
      </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>free_fixed_outside</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.names_of</span><span> </span><span class="entity"><span>lthy</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>includes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>includes</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bundle.check</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span class="entity"><span>var_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
                                       </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>includes</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>Bundle.includes</span></span><span> </span><span class="entity"><span>includes</span></span><span>
                                       </span><span>|&gt;</span><span> </span><span class="entity"><span>prep_decls</span></span><span> </span><span class="entity"><span>prep_var</span></span><span> </span><span class="entity"><span>rawfixes</span></span><span>
                                       </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_schematic</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.check_src</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_term</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_prop</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_modifier</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>Mod_by_Rule</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span class="entity"><span>Phi_Modifier.by_rule</span></span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.eval_thms</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Mod_by_Attr</span></span><span> </span><span class="entity"><span>attr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Modifier.apply_wrapped_attribute</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>prep_attr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>attr</span></span><span>
               </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_modifiers</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>Finishing_Modifier_Hooks.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_attrterm</span></span><span> </span><span class="entity"><span>prep</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.check_src</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_precond</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Premise</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>prep_attrterm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_prop</span></span><span> </span><span>#&gt;</span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>term</span></span><span> </span><span class="quoted"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Normal_Premise|const"><span>Normal_Premise</span></a></span><span class="antiquote"><span>}</span></span></span><span> </span><span>$</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Premise must be atomic HOL assertion (meaning you cannot use \
                                 \meta connectivities like ‹⟹› or ‹⋀›). You may want to \
                                 \use keyword ‹assume› for introducing advanced arbitrary \
                                 \antecedents."</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>c</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prep_precond</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Assumption</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_attrterm</span></span><span> </span><span class="entity"><span>parse_prop</span></span><span> </span><span class="entity"><span>c</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preconds0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>prep_precond</span></span><span> </span><span class="entity"><span>raw_preconds</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Procedure_Syntax.translate_arg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Procedure_Syntax.translate_ret</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>v_proc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v_proc_var</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>throws</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>throws</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thr</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>thr</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Groups.html#Groups.zero_class.zero|const"><span>Groups.zero_class.zero</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="antiquote"><span>@{</span></span><span class="operator"><span>const_name</span></span><span> </span><a class="entity_ref" href="../../../../../../Spec_Framework.html#Spec_Framework.\&lt;phi&gt;Procedure|const"><span>φProcedure</span></a><span class="antiquote"><span>}</span></span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v_proc</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>arg</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>ret</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>throws</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.Trueprop</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>goal0</span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.Trueprop</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>goal0</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>parse_term</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preconds0'1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preconds0</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg</span></span><span>::</span><span class="entity"><span>ret</span></span><span>::</span><span class="entity"><span>throws</span></span><span>::</span><span class="entity"><span>goal0</span></span><span>::</span><span class="entity"><span>preconds0'1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>Syntax.check_terms</span><span> </span><span class="entity"><span>ctxt_parse</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg</span></span><span>::</span><span class="entity"><span>ret</span></span><span>::</span><span class="entity"><span>throws</span></span><span>::</span><span class="entity"><span>goal0</span></span><span>::</span><span class="entity"><span>preconds0'1</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>preconds0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preconds0</span></span><span> </span><span class="entity"><span>preconds0'1</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt_parse</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>preconds</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>infer_requirements</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span>
                        </span><span class="main"><span>{</span></span><span>arg</span><span class="main"><span>=</span></span><span class="entity"><span>arg</span></span><span class="main"><span>,</span></span><span> ret</span><span class="main"><span>=</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> throw</span><span class="main"><span>=</span></span><span class="entity"><span>throws</span></span><span class="main"><span>,</span></span><span> existing_requirements</span><span class="main"><span>=</span></span><span class="entity"><span>preconds0</span></span><span class="main"><span>}</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>goal0</span></span><span>
            </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preconds</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>post_process'</span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Finishing_Construction_Hooks.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Procedure.define</span></span><span> </span><span class="entity"><span>def_const</span></span><span> </span><span class="entity"><span>binding</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lthy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="entity"><span>Proof_Display.print_results</span></span><span> </span><span class="main"><span>{</span></span><span>interactive </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>int</span></span><span class="main"><span>,</span></span><span>
                                            pos </span><span class="main"><span>=</span></span><span> </span><span>Binding.pos_of</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                            proof_state </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
                </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"φprocedure"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>defines</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_attrterm</span></span><span> </span><span class="entity"><span>parse_prop</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_defines</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Element.Fixes</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Element.Defines</span></span><span> </span><span class="entity"><span>defines</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Element.Shows</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>Binding.empty_atts</span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>goal</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>post_process'</span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>th</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>includes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>assms</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concls</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>after_qed</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>Begining_Procedures.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>{</span></span><span>
              includes</span><span class="main"><span>=</span></span><span class="entity"><span>includes</span></span><span class="main"><span>,</span></span><span> assms</span><span class="main"><span>=</span></span><span class="entity"><span>assms</span></span><span class="main"><span>,</span></span><span> concls</span><span class="main"><span>=</span></span><span class="entity"><span>concls</span></span><span class="main"><span>,</span></span><span> after_qed</span><span class="main"><span>=</span></span><span class="entity"><span>after_qed</span></span><span class="main"><span>,</span></span><span> lthy</span><span class="main"><span>=</span></span><span class="entity"><span>lthy</span></span><span>
            </span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Specification.schematic_theorem</span></span><span> </span><span>false</span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>after_qed</span></span><span> </span><span>Binding.empty_atts</span><span>
              </span><span class="entity"><span>includes</span></span><span> </span><span class="entity"><span>assms</span></span><span> </span><span class="entity"><span>concls</span></span><span> </span><span class="entity"><span>int</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.map_context</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>Context_Position.set_visible</span><span> </span><span>false</span><span>
                 </span><span class="comment1"><span>(* |&gt; (fn ctxt =&gt; ctxt addsimprocs [Semantic_Type_Tools.unfold_typeof_simproc]) *)</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>Context_Position.restore_visible</span><span> </span><span class="entity"><span>ctxt</span></span><span>
                   </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_ID.set_construct</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Named_Theorems.clear</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">named_theorems</span><span class="hidden">&gt;</span></span></span><span>‹φlemmata›</span></span><span class="main"><span>)</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>Procedure_Envir.put</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>{</span></span><span>binding</span><span class="main"><span>=</span></span><span>fst</span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>,</span></span><span> free_fixed_outside</span><span class="main"><span>=</span></span><span class="entity"><span>free_fixed_outside</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span>
                   </span><span>|&gt;</span><span> </span><span class="entity"><span>PLPR_Statistics.setup_semantic_operation_recording</span></span><span>
            </span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.refine</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Method.Basic</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>Named_Premises.bind_sequent_assms</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>preconds</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>apply_modifier</span></span><span>
              </span><span>|&gt;</span><span> </span><span>Seq.single</span><span> </span><span>o</span><span> </span><span>Seq.Result</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span>Seq.the_result</span><span> </span><span class="inner_quoted"><span>"should never fail #gn9[q3"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>begin_proc</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>gen_begin_proc</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span>Proof_Context.cert_var</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>begin_proc_cmd</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>gen_begin_proc</span></span><span> </span><span>Syntax.parse_term</span><span> </span><span>Syntax.parse_prop</span><span> </span><span>Proof_Context.read_var</span><span>
                     </span><span class="entity"><span>Attrib.attribute_cmd</span></span><span>



</span><span class="comment1"><span>(** Statement **)</span></span><span>

</span><span class="comment1"><span>(*Whether to remove all values at the beginning of the command <span class="hidden">❙</span><b>;</b>*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>statement_clean_values</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="IDE_CP_Core.\&lt;phi&gt;statement_clean_values|attribute"><span>φstatement_clean_values</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clean_values</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>Phi_Syntax.dest_CurrentConstruction</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>statement_clean_values</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Generic_Variable_Access.extract_values</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
fun statement_line_cmd auto_lev = Phi_CP_IDE.eval_line

  Phi_Processor.powerful_process_p auto_lev (fn expr_id =&gt;
                        Phi_Envir.map_state_sequent (fn (ctxt,sequent) =&gt;
                            End_of_Line.invoke (Context.Proof ctxt) expr_id (ctxt,sequent)))
    &gt;&gt; (fn expr_id =&gt; fn process =&gt;
              Phi_Envir.map_state_sequent (fn (ctxt,sequent) =&gt;
                    Begin_of_Line.invoke (Context.Proof ctxt) expr_id (ctxt,sequent))
           #&gt; process
     (*the return of the process doesn't mean the end of the construction because the construction
       can be interrupted and suspended by inserted proofs.*)
  )


fun statement_cmd_first_line auto_lev =
  statement_line_cmd auto_lev &gt;&gt; (fn f =&gt;
       Proof.map_context (Config.put previous_statement_completes' false)
    #&gt; f)

fun statement_cmd_tail auto_lev toks =
  (statement_line_cmd auto_lev &gt;&gt; (fn f =&gt; fn s =&gt;
      if Phi_Envir.under_programming_environ (Proof.context_of s)
      then f s
      else if null toks orelse Token.is_eof (hd toks)
           then s
           else error "The construction has ended but a statement is given")) toks
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>

   </span><span class="entity"><span>Phi_Opr_Stack.Begin_of_Statement.add</span></span><span> </span><span class="inner_numeral"><span>50</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Phi_Opr_Stack.is_the_first_statement</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>apsnd</span><span> </span><span class="entity"><span>clean_values</span></span><span> </span><span class="entity"><span>opr_ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span>#&gt;</span><span> </span><span class="entity"><span>Phi_Opr_Stack.End_of_Line.add</span></span><span> </span><span class="inner_numeral"><span>100</span></span><span>
      </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="entity"><span>Phi_Envir.freeze_dynamic_lemmas</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(*val is_interactive = Config.declare_bool ("φSys.interactive", ⌂) (K true)
exception Schematic*)</span></span><span>

</span><span class="comment1"><span>(* fun export_LLVM thy =
  let
    fun eval code = ML_Context.exec (fn () =&gt;
                      ML_Context.eval_source ML_Compiler.flags (Input.string code))

    val base = Path.expand (Resources.master_directory thy)
    val path = File.full_path base (Path.basic (Context.theory_name thy ^ ".ll"))

    val codegen = eval ("NuCG.codegen NuCG_" ^ Context.theory_name thy ^ ".gen"
                    ^ "(" ^ ML_Syntax.print_path path ^ ")" )
    val _ = tracing("generating LLVM IR: " ^ Path.print path)
  in
    thy |&gt; Context.theory_map (eval (NuCompilation.compile thy(* |&gt; (fn s =&gt; (tracing s; s))*)))
        |&gt; Context.theory_map codegen
  end *)</span></span><span>



</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Scan</span><span> </span><span>Phi_Sys</span><span> </span><span>Parse</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_props</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.repeat1</span><span> </span><span class="main"><span>(</span></span><span>$$$</span><span> </span><span class="inner_quoted"><span>"is"</span></span><span> </span><span>|--</span><span> </span><span>prop</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ppats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span>$$$</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>|--</span><span> </span><span>!!!</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_props</span></span><span> </span><span>--|</span><span> </span><span>$$$</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attrib</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>token</span><span> </span><span>liberal_name</span><span> </span><span>:::</span><span> </span><span>!!!</span><span> </span><span>args</span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>[</span></span><span>›</span></span></span><span> </span><span>--</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>]</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>Attrib.internal</span></span><span> </span><span>Position.none</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
           </span><span>||</span><span> </span><span class="main"><span>(</span></span><span>$$$</span><span> </span><span class="inner_quoted"><span>"["</span></span><span> </span><span>|--</span><span> </span><span>list</span><span> </span><span class="entity"><span>attrib</span></span><span> </span><span>--|</span><span> </span><span>$$$</span><span> </span><span class="inner_quoted"><span>"]"</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opt_attribs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>opt_thm_name</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.optional</span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Parse.binding</span><span> </span><span>--</span><span> </span><span class="entity"><span>opt_attribs</span></span><span> </span><span>||</span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>pair</span><span> </span><span>Binding.empty</span><span class="main"><span>)</span></span><span> </span><span>--|</span><span> </span><span>Parse.$$$</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
    </span><span>Binding.empty_atts</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>statement1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.and_list1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>opt_thm_name</span></span><span> </span><span class="inner_quoted"><span>":"</span></span><span> </span><span>--</span><span> </span><span>Parse.propp</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>requires_statement</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>assumes</span></span><span>›</span></span></span><span> </span><span>||</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>requires</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="entity"><span>statement1</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>premises_statement</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>premises</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="entity"><span>statement1</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>precond_statements</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>premises_statement</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>Premise</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span>||</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>requires_statement</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>Assumption</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>flat</span><span class="main"><span>;</span></span><span>
</span><span class="comment1"><span>(* val requires_opt1 = Scan.option (<span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span>‹assumes› |-- Parse.term); *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>where_statement</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>where</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.!!!</span><span> </span><span class="entity"><span>statement1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>@tag</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.term</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>includes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="entity"><span>Parse_Spec.includes</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>input</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>input</span></span><span>›</span></span></span><span>  </span><span>|--</span><span> </span><span>Parse.term</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>output</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>output</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.term</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>throws</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>throws</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.term</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rec_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>var</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>!!!</span><span> </span><span>vars</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_const_flag</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>Phi_Parse.$$$</span></span><span> </span><span class="inner_quoted"><span>"nodef"</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>true</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>modifier</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Parse.attribs</span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Mod_by_Attr</span></span><span class="main"><span>)</span></span><span> </span><span>||</span><span> </span><span class="main"><span>(</span></span><span>Parse.thm</span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Mod_by_Rule</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>modifiers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>repeat</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>is</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>and_list</span><span> </span><span class="entity"><span>modifier</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>flat</span><span>

</span><span class="comment1"><span>(*
fun phi_proof step_in prf tr =
  let (*val pos = Toplevel.pos_of tr*)
      (*val doc_id = case Position.id_of (Toplevel.pos_of tr)
                     of SOME id =&gt; @{print} id
                      | _ =&gt; Exn.error "internal bug #vcj4i[10th;ji"*)
   in Toplevel.proof' (fn int =&gt; fn stat =&gt;
        stat |&gt; Proof.map_context step_in (*(fn ctxt =&gt;
                  let val ctxt' = step_in ctxt
                   in Phi_Cache_DB.check_cache doc_id ctxt';
                      ctxt'
                  end)*)
             |&gt; prf int ) tr end *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.local_theory_to_proof'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>proc</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"begin a procedure construction"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>def_const_flag</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>Parse_Spec.opt_thm_name</span></span><span> </span><span class="inner_quoted"><span>":"</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>includes</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>precond_statements</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>input</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>precond_statements</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>output</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>throws</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>goal</span></span><span>
      </span><span>--</span><span> </span><span class="entity"><span>where_statement</span></span><span>
      </span><span>--</span><span> </span><span>Parse.for_fixes</span><span>
      </span><span>--</span><span> </span><span class="entity"><span>modifiers</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>def_const</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>includes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>prec1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>prec2</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>throws</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>G</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>defs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>mods</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>begin_proc_cmd</span></span><span> </span><span class="entity"><span>def_const</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="entity"><span>throws</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>includes</span></span><span> </span><span class="entity"><span>defs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prec1</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>prec2</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>mods</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
val _ =
  Outer_Syntax.local_theory_to_proof' <span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span>‹rec_proc›
    "begin a recursive procedure construction"
    ((def_const_flag -- Parse_Spec.opt_thm_name ":"
      -- includes
      -- precond_statements
      -- input
      -- rec_vars
      -- precond_statements
      -- output
      -- throws
      -- goal
      -- where_statement
      -- Parse.for_fixes
     ) &gt;&gt; (
     fn (((((((((((def_const,b),includes),prec1),arg),vars),prec2),ret),throws),G),defs),fixes) =&gt;
        begin_rec_proc_cmd def_const b arg ret throws (vars,fixes) includes defs (prec1 @ prec2) G))
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_eof_toks</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_eof_toks</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Token.is_eof</span><span> </span><span class="entity"><span>h</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>;;</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"Leading a statement of φ programs"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Toplevel.proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_CP_IDE.eval_line</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.empty</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="inner_numeral"><span>3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>toks</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>Token.eof</span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span>rpair</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_eof_toks</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span>Token.eof</span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>；</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"Leading a statement of φ programs"</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Toplevel.proof</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_CP_IDE.eval_line</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.empty</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="inner_numeral"><span>3</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>toks</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>Token.eof</span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span>rpair</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_eof_toks</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span>Token.eof</span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>statement_cmd_no_auto</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_CP_IDE.eval_line</span></span><span> </span><span class="main"><span>(</span></span><span>Symtab.empty</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>toks</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>Token.eof</span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_eof_toks</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span>Token.eof</span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>❴</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"Begin a φ program block"</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>  </span><span>optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>for</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>list1</span><span> </span><span>Parse.binding</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
     </span><span>--</span><span> </span><span>optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>premises</span></span><span>›</span></span></span><span> </span><span>|--</span><span>
            </span><span>and_list</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>binding</span><span> </span><span>--</span><span> </span><span class="entity"><span>opt_attribs</span></span><span> </span><span>||</span><span> </span><span class="entity"><span>attribs</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>pair</span><span> </span><span>Binding.empty</span><span class="main"><span>)</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>ppats</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>begin_block_cmd</span></span><span class="main"><span>)</span></span><span>
   </span><span>--</span><span> </span><span class="entity"><span>statement_cmd_no_auto</span></span><span class="main"><span>)</span></span><span>
   </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>blk</span></span><span class="main"><span>,</span></span><span class="entity"><span>prcs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Toplevel.proof'</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>print</span></span><span class="antiquote"><span>}</span></span></span></span></span></span></span></span></span><span> </span><span>o</span><span> </span><span class="entity"><span>prcs</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>blk</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>Proof.map_context</span></span><span> </span><span class="entity"><span>Phi_ID.next</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>end_blk_action</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Enter_Proof_Mode</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Transparent_Proof</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>Proof.state </span><span class="main"><span>-&gt;</span></span><span> Proof.state</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>❵</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"End a φ program block"</span></span><span>
    </span><span class="main"><span>(</span></span><span>option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>for</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>--</span><span>
     </span><span>option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>subj</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>--</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>certified</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>Enter_Proof_Mode</span></span><span> </span><span>||</span><span>
        </span><span class="entity"><span>statement_cmd_no_auto</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Transparent_Proof</span></span><span>
  </span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>spec_subj</span></span><span class="main"><span>,</span></span><span class="entity"><span>act</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Toplevel.proof'</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>spec</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>spec_subj</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                      </span><span>Exn.error</span><span> </span><span class="inner_quoted"><span>"keyword 'for' and 'subj' should not be given simutaneously."</span></span><span>
                                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Spec_Annot</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
                                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Subj_Annot</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
                                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>stat</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.map_context</span></span><span> </span><span class="entity"><span>Phi_ID.next</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>act</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Enter_Proof_Mode</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>end_block_cmd</span></span><span> </span><span class="entity"><span>spec</span></span><span> </span><span class="entity"><span>int</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Transparent_Proof</span></span><span> </span><span class="entity"><span>tail_statement</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>end_block_auto_proof_cmd</span></span><span> </span><span class="entity"><span>spec</span></span><span> </span><span class="entity"><span>int</span></span><span>
                                             </span><span>#&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>s</span></span><span>
                                             </span><span>|&gt;</span><span> </span><span class="entity"><span>Proof.map_context</span></span><span> </span><span class="entity"><span>Phi_ID.next</span></span><span>
                                             </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Envir.under_programming_environ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context_of</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>tail_statement</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="comment1"><span>(*
val _ =
  Outer_Syntax.command <span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span>‹❵.› "End a φ program block using default tactic"
    (((option (<span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span>‹for› |-- term) &gt;&gt; (fn cast =&gt; fn int =&gt; fn stat =&gt;
       stat
    |&gt; end_block_auto_proof_cmd cast int ))
   -- statement_cmd_tail (3,1))
   &gt;&gt; (fn (blk,tail_statement) =&gt; Toplevel.proof' (fn int =&gt;
        tail_statement o Proof.map_context Phi_ID.next o blk int o Proof.map_context Phi_ID.next)))
*)</span></span><span>
</span><span class="comment1"><span>(* val _ =
  Outer_Syntax.command <span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span>‹φinterface› "declare φinterface"
      (Parse.binding --| $$$ "=" -- Parse.const -- option ($$$ ":" |-- Parse.typ --| $$$ "⟼" -- Parse.typ)
        &gt;&gt; (Toplevel.theory o Phi_Procedure.add_interface_command))

val _ =
  Outer_Syntax.command <span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span>‹φexport_llvm› "export LLVM target"
      (Scan.succeed (Toplevel.theory (Phi_Toplevel.export_LLVM))) *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>