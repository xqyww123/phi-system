<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/phi_type_algebra/commutativity.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/phi_type_algebra/commutativity.ML›</h1>
</div>

<pre class="source"><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PHI_TYPE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>include</span></span></span><span> </span><span class="entity"><span>PHI_TYPE</span></span><span>

</span><span class="comment1"><span>(** distinguish commutative φ-type operators from its lambda application **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*Gs, its length is the arity of F, its elements are the arities of each G*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_comm_F_Gs_from_appl </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span>
        </span><span class="entity"><span>bvs</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*lambda combination of F(G(T))*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="comment1"><span>(*F*)</span></span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*Gs*)</span></span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="comment1"><span>(*G'*)</span></span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*Fs'*)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> register_comm_tyoprs </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>arity</span></span><span> * </span><span class="entity"><span>arity</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>Pattern_Translation.redex_residues</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span>
        </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
     </span><span class="comment1"><span>(*redex: F (G<span class="hidden">⇩</span><sub>1</sub> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>)</sub>) … (G<span class="hidden">⇩</span><sub>m</sub> T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>)</sub>)
       residues: F,   G<span class="hidden">⇩</span><sub>1</sub>, T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>1</sub>, …, T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>)</sub>,       …,  G<span class="hidden">⇩</span><sub>m</sub>, T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>1</sub>, …, T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>)</sub>,       a(i) gives the arity of G<span class="hidden">⇩</span><sub>i</sub>
                 G',  F<span class="hidden">⇩</span><sub>1</sub>',T<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>)</sub>, …, T<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>)</sub><span class="hidden">⇩</span><sub>)</sub>,   …,  F<span class="hidden">⇩</span><sub>n</sub>', T<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>)</sub>, …, T<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>)</sub><span class="hidden">⇩</span><sub>)</sub>  b(j) gives the arity of F'<span class="hidden">⇩</span><sub>j</sub>
       where the commutativity transforms F (G<span class="hidden">⇩</span><sub>1</sub> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>)</sub>) … (G<span class="hidden">⇩</span><sub>m</sub> T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>a</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>)</sub>) to
                                          G' (F'<span class="hidden">⇩</span><sub>1</sub> T<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>)</sub> … T<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>)</sub><span class="hidden">⇩</span><sub>)</sub>) … (F<span class="hidden">⇩</span><sub>n</sub>' T<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>)</sub> … T<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>,</sub><span class="hidden">⇩</span><sub>b</sub><span class="hidden">⇩</span><sub>(</sub><span class="hidden">⇩</span><sub>n</sub><span class="hidden">⇩</span><sub>)</sub><span class="hidden">⇩</span><sub>)</sub>)*)</span></span><span>
     </span><span class="comment1"><span>(*automatically invoked when any φ-LPR rule is registered*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> register_comm_tyoprs_rule_pass </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity</span></span><span> * </span><span class="entity"><span>arity</span></span><span class="main"><span>)</span></span><span> * </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
      </span><span class="comment1"><span>(*see the examples in the file*)</span></span><span>


</span><span class="comment1"><span>(** Control of Swap Normalization **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>assoc_direction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AD_INTRO</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>AD_ELIM</span></span><span>
  </span><span class="comment1"><span>(* AD_INTRO: ‹F<span class="hidden">⇩</span><sub>s</sub> (F<span class="hidden">⇩</span><sub>t</sub> T) → F<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>+</sub><span class="hidden">⇩</span><sub>t</sub> T›
     AD_ELIM : ‹F<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>+</sub><span class="hidden">⇩</span><sub>t</sub> T → F<span class="hidden">⇩</span><sub>s</sub> (F<span class="hidden">⇩</span><sub>t</sub> T)› *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>whether_swap_norm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*F*)</span></span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*Gs*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span>option</span><span>
      </span><span class="comment1"><span>(*whether to invoke the normalization swapping ‹F› into ‹Gs›,
        return None to leave the control to the settings of lower priority*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>whether_assoc_norm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.generic</span><span> * </span><span class="entity"><span>assoc_direction</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*F_G_T*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>swap_direction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>S_In</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>S_Out</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> control_swap_normalizations_on </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>swap_direction</span></span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="comment1"><span>(*F*)</span></span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*Gs*)</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>whether_swap_norm</span></span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
                                 </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
    </span><span class="comment1"><span>(*if S_In, swap ‹F› into all of the operands ‹Gs›, ‹F(Gs(T)) → G(Fs(T))›
      if S_Out, ‹Gs› can only have 1 element, and it swaps ‹F› out of the ‹G›, ‹G(F(T)) → F(G(T))›*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> whether_to_swap_normalize  </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> whether_to_assoc_normalize </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>assoc_direction</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> whether_to_SA_normalize </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>assoc_direction</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>

</span><span class="comment1"><span>(*
val commutative_rules : Context.generic -&gt; term (*F*) * term list (*Gs*) -&gt; (Position.T * thm) list

val are_commutative : Context.generic -&gt; term * term list -&gt; bool
val is_commutative : Context.generic -&gt; term (*F*) -&gt; int list (*available arities of F. empty means non-commutative*)

val comm_patterns : ((term (*pattern*) * term (*F*) * term list (*Gs*)) * int (*arity of F*)) list Unsynchronized.ref
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> whether_swap_norm__sender </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>whether_swap_norm</span></span><span> </span><span>option</span><span> </span><span>Unsynchronized.ref</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> whether_assoc_norm__sender </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>whether_assoc_norm</span></span><span> </span><span>option</span><span> </span><span>Unsynchronized.ref</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> phi_simp_trigger_id </span><span class="main"><span>:</span></span><span> </span><span>serial</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Phi_Type</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PHI_TYPE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Phi_Type</span><span>


</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*Gs, its length is the arity of F, its elements are the arity of each G,
                        F (G<span class="hidden">⇩</span><sub>1</sub> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>n</sub>) … (G<span class="hidden">⇩</span><sub>m</sub> T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>n</sub>)*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>direction_of_assoc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>DA_INTRO</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>DA_ELIM</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>comm_tyoprs_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>eq_pair</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eq_pair</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eq_list</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>comm_tyoprs_eq'</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>eq_pair</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eq_pair</span><span> </span><span class="main"><span>(</span></span><span>Pattern.equiv</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eq_list</span><span> </span><span class="main"><span>(</span></span><span>Pattern.equiv</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Comm_Tyoprs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>arity</span></span><span> * </span><span class="entity"><span>arity</span></span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>Pattern_Translation.redex_residues</span></span><span class="main"><span>)</span></span><span> </span><span>iNet.net</span><span>
           </span><span class="comment1"><span>(*first arity: Gs, its length is the arity of F, its elements are the arity of each G,
                          F (G<span class="hidden">⇩</span><sub>1</sub> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>n</sub>) … (G<span class="hidden">⇩</span><sub>m</sub> T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>n</sub>)
             second arity: Fs, its length is the arity of G', its elements are the arities of each F',
                           G' (F<span class="hidden">⇩</span><sub>1</sub>' T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>n</sub>) … (F<span class="hidden">⇩</span><sub>m</sub>' T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>n</sub>)
             redex: F (G<span class="hidden">⇩</span><sub>1</sub> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>n</sub>) … (G<span class="hidden">⇩</span><sub>m</sub> T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>n</sub>) ⟶
             residues: F, G<span class="hidden">⇩</span><sub>1</sub>, T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>, …, T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>n</sub>, …, G<span class="hidden">⇩</span><sub>m</sub>, T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>1</sub>, …, T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>n</sub>*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>iNet.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>iNet.merge</span><span> </span><span class="entity"><span>comm_tyoprs_eq</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assoc_tyoprs_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_pair3</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eq_pair</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eq_list</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assoc_tyoprs_eq'</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_pair3</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eq_pair</span><span> </span><span class="main"><span>(</span></span><span>Pattern.equiv</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eq_list</span><span> </span><span class="main"><span>(</span></span><span>Pattern.equiv</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Assoc_Tyops</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity</span></span><span> * </span><span class="entity"><span>Pattern_Translation.redex_residues</span></span><span> * </span><span class="entity"><span>direction_of_assoc</span></span><span class="main"><span>)</span></span><span> </span><span>iNet.net</span><span>
           </span><span class="comment1"><span>(* redex: F (G<span class="hidden">⇩</span><sub>1</sub> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>n</sub>) … (G<span class="hidden">⇩</span><sub>m</sub> T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>n</sub>)
              residues: FG', F, G<span class="hidden">⇩</span><sub>1</sub>, T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>n</sub>, … G<span class="hidden">⇩</span><sub>m</sub>, T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>1</sub>, … T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>n</sub>,
              for F (G<span class="hidden">⇩</span><sub>1</sub> T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>n</sub>) … (G<span class="hidden">⇩</span><sub>m</sub> T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>1</sub> … T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>n</sub>) ⟶ FG' T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>1</sub>, …, T<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>n</sub>, …, G<span class="hidden">⇩</span><sub>m</sub>, T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>1</sub>, …, T<span class="hidden">⇩</span><sub>m</sub><span class="hidden">⇩</span><sub>n</sub>*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>iNet.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>iNet.merge</span><span> </span><span class="entity"><span>assoc_tyoprs_eq</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>encoding_assoc</span></span><span> </span><span class="entity"><span>DA_INTRO</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"X"</span></span><span class="main"><span>,</span></span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"I"</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>encoding_assoc</span></span><span> </span><span class="entity"><span>DA_ELIM</span></span><span>  </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"X"</span></span><span class="main"><span>,</span></span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"E"</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>tm</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>encoding_assoc'</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>encoding_assoc</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>tm</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>encoding_assoc'</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"X"</span></span><span class="main"><span>,</span></span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Var</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"$DI"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>tm</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>select_direction</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>d'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>d'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>select_direction</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>


</span><span class="comment1"><span>(*fun sum L = fold (fn x =&gt; fn y =&gt; x + y) L 0*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sum_1</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>y</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>::</span><span class="entity"><span>N</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span>::</span><span class="entity"><span>Lg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>(</span></span><span>drop</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>Lg</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"BUG: bad patterns"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split'</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>F</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>F</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_comm_F_Gs_from_appl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewrites</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Comm_Tyoprs.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>iNet.match_term</span><span> </span><span class="entity"><span>rewrites</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span>
   </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>arities_F</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arities_G'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>redex_residues</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>Pattern_Translation.rewrites</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="entity"><span>redex_residues</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span>
     </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>len</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sum_1</span></span><span> </span><span class="entity"><span>arities_F</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>split'</span></span><span> </span><span class="entity"><span>arities_F</span></span><span> </span><span class="main"><span>(</span></span><span>List.take</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>len</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split'</span></span><span> </span><span class="entity"><span>arities_G'</span></span><span> </span><span class="main"><span>(</span></span><span>List.drop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>len</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span>eq_pair</span><span> </span><span class="main"><span>(</span></span><span>eq_pair</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eq_list</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>(</span></span><span>eq_pair</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eq_list</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_assoc_F_Gs_from_appl</span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewrites</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Assoc_Tyops.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>iNet.match_term</span><span> </span><span class="entity"><span>rewrites</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>encoding_assoc'</span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arities</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>redex_residues</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>IE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>Pattern_Translation.rewrites</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="entity"><span>redex_residues</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span>
     </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>FG'</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>select_direction</span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="entity"><span>IE</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>len</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sum_1</span></span><span> </span><span class="entity"><span>arities</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
                   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>F</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split'</span></span><span> </span><span class="entity"><span>arities</span></span><span> </span><span class="entity"><span>L</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>IE</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>FG'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>F</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq_pair3</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eq_pair</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eq_list</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_assoc_appl</span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewrites</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Assoc_Tyops.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>iNet.match_term</span><span> </span><span class="entity"><span>rewrites</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>encoding_assoc'</span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>IE</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>select_direction</span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="entity"><span>IE</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
              </span><span class="entity"><span>PLPR_Pattern.does_smatch</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_comm_tyoprs</span></span><span> </span><span class="entity"><span>arity_redex_residues</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Comm_Tyoprs.map</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>a_r_r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>comb</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>iNet.insert_term_safe</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comm_tyoprs_eq'</span></span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comb</span></span><span class="main"><span>,</span></span><span class="entity"><span>a_r_r</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arity_redex_residues</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_assoc_tyoprs</span></span><span> </span><span class="entity"><span>arity_redex_residues</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Assoc_Tyops.map</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>a_r_r</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>comb</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>iNet.insert_term_safe</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assoc_tyoprs_eq'</span></span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>comb</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a_r_r</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arity_redex_residues</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pass_id_head</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"tyopr_comm_pass"</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_comm_tyoprs_rule_pass</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity</span></span><span class="main"><span>,</span></span><span class="entity"><span>rewr</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>property</span></span><span>::</span><span class="entity"><span>redex_residues</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.dest_conjunction_list</span><span> </span><span class="entity"><span>rewr</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>redex_residues'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Logic.dest_term</span><span> </span><span class="entity"><span>redex_residues</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>redex_residues'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sum_1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>arity</span></span><span class="main"><span>)</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>3</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>sum_1</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>arity</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Bad redex_residues'"</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Phi_Reasoner.add_pass</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pass_id_head</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rewr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>,</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prio</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pattern.match</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>property</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Vartab.empty</span><span class="main"><span>,</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>redex</span></span><span>::</span><span class="entity"><span>residues</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Envir.subst_term</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>redex_residues'</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>redex</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>residues</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>register_comm_tyoprs</span></span><span> </span><span class="entity"><span>rewr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prio</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pass_id_head</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"tyopr_assoc_pass"</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_assoc_tyoprs_rule_pass</span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity</span></span><span class="main"><span>,</span></span><span class="entity"><span>rewr</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>property</span></span><span>::</span><span class="entity"><span>redex_residues</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.dest_conjunction_list</span><span> </span><span class="entity"><span>rewr</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>redex_residues'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Logic.dest_term</span><span> </span><span class="entity"><span>redex_residues</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>redex_residues'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sum_1</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>3</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Bad redex_residues'"</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Phi_Reasoner.add_pass</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pass_id_head</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rewr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>,</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prio</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rewr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pattern.match</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>property</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Vartab.empty</span><span class="main"><span>,</span></span><span> </span><span>Vartab.empty</span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>redex</span></span><span>::</span><span class="entity"><span>residues</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Envir.subst_term</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>redex_residues'</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>redex</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>residues</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>direction</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>register_assoc_tyoprs</span></span><span> </span><span class="entity"><span>rewr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prio</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span>fold</span><span> </span><span class="entity"><span>register_comm_tyoprs_rule_pass</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">pattern_prop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.Tyops_Commute|const"><span>Tyops_Commute</span></a><span> </span><span class="var"><span>?F</span></span><span> </span><span class="var"><span>?F'</span></span><span> </span><span class="var"><span>?G</span></span><span> </span><span class="var"><span>?G'</span></span><span> </span><span class="var"><span>?T</span></span><span> </span><span class="var"><span>?D</span></span><span> </span><span class="var"><span>?r</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span>
              </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?F</span></span><span> </span><span class="main"><span>(</span></span><span class="var"><span>?G</span></span><span> </span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?F</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?G</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?G'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?F'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">pattern_prop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.Tyops_Commute\&lt;^sub&gt;1\&lt;^sub&gt;_\&lt;^sub&gt;2|const"><span>Tyops_Commute<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>2</sub></span></a><span> </span><span class="var"><span>?F</span></span><span> </span><span class="var"><span>?F'<span class="hidden">⇩</span><sub>T</sub></span></span><span> </span><span class="var"><span>?F'<span class="hidden">⇩</span><sub>U</sub></span></span><span> </span><span class="var"><span>?G</span></span><span> </span><span class="var"><span>?G'</span></span><span> </span><span class="var"><span>?T</span></span><span> </span><span class="var"><span>?U</span></span><span> </span><span class="var"><span>?D</span></span><span> </span><span class="var"><span>?r</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span>
              </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?F</span></span><span> </span><span class="main"><span>(</span></span><span class="var"><span>?G</span></span><span> </span><span class="var"><span>?T</span></span><span> </span><span class="var"><span>?U</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?F</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?G</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?U</span></span><span class="main"><span>)</span></span><span>
                                  </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?G'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?F'<span class="hidden">⇩</span><sub>T</sub></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?F'<span class="hidden">⇩</span><sub>U</sub></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?U</span></span><span class="main"><span>)</span></span><span> ›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="inner_numeral"><span>2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">pattern_prop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.Tyops_Commute\&lt;^sub&gt;2\&lt;^sub&gt;_\&lt;^sub&gt;1|const"><span>Tyops_Commute<span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>1</sub></span></a><span> </span><span class="var"><span>?F</span></span><span> </span><span class="var"><span>?F'<span class="hidden">⇩</span><sub>T</sub></span></span><span> </span><span class="var"><span>?F'<span class="hidden">⇩</span><sub>U</sub></span></span><span> </span><span class="var"><span>?G</span></span><span> </span><span class="var"><span>?G'</span></span><span> </span><span class="var"><span>?T</span></span><span> </span><span class="var"><span>?U</span></span><span> </span><span class="var"><span>?D</span></span><span> </span><span class="var"><span>?r</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span>
              </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?G'</span></span><span> </span><span class="main"><span>(</span></span><span class="var"><span>?F'<span class="hidden">⇩</span><sub>T</sub></span></span><span> </span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="var"><span>?F'<span class="hidden">⇩</span><sub>U</sub></span></span><span> </span><span class="var"><span>?U</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?G'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?F'<span class="hidden">⇩</span><sub>T</sub></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?F'<span class="hidden">⇩</span><sub>U</sub></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?U</span></span><span class="main"><span>)</span></span><span>
                                           </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?F</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?G</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?U</span></span><span class="main"><span>)</span></span><span> ›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
</span><span>#&gt;</span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>register_assoc_tyoprs_rule_pass</span></span><span> </span><span class="entity"><span>DA_INTRO</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">pattern_prop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.Module_Assoc\&lt;^sub&gt;I|const"><span>Module_Assoc<span class="hidden">⇩</span><sub>I</sub></span></a><span> </span><span class="var"><span>?Fs</span></span><span> </span><span class="var"><span>?Ft</span></span><span> </span><span class="var"><span>?Fc</span></span><span> </span><span class="var"><span>?T</span></span><span> </span><span class="var"><span>?Ds</span></span><span> </span><span class="var"><span>?Dt</span></span><span> </span><span class="var"><span>?Dx</span></span><span> </span><span class="var"><span>?smul</span></span><span> </span><span class="var"><span>?f</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span>
              </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Fs</span></span><span> </span><span class="var"><span>?s</span></span><span> </span><span class="main"><span>(</span></span><span class="var"><span>?Ft</span></span><span> </span><span class="var"><span>?t</span></span><span> </span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Fc</span></span><span> </span><span class="main"><span>(</span></span><span class="var"><span>?smul</span></span><span> </span><span class="var"><span>?s</span></span><span> </span><span class="var"><span>?t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                       </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Fs</span></span><span> </span><span class="var"><span>?s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Ft</span></span><span> </span><span class="var"><span>?t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span> ›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">pattern_prop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.Module_Assoc\&lt;^sub&gt;\&lt;Lambda&gt;\&lt;^sub&gt;I|const"><span>Module_Assoc<span class="hidden">⇩</span><sub>Λ</sub><span class="hidden">⇩</span><sub>I</sub></span></a><span> </span><span class="var"><span>?Fs</span></span><span> </span><span class="var"><span>?Ft</span></span><span> </span><span class="var"><span>?Fc</span></span><span> </span><span class="var"><span>?T</span></span><span> </span><span class="var"><span>?Ds</span></span><span> </span><span class="var"><span>?Dt</span></span><span> </span><span class="var"><span>?Dx</span></span><span> </span><span class="var"><span>?smul</span></span><span> </span><span class="var"><span>?f</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span>
              </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Fs</span></span><span> </span><span class="var"><span>?s</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>p</span></span><span class="main"><span>.</span></span><span> </span><span class="var"><span>?Ft</span></span><span> </span><span class="var"><span>?t</span></span><span> </span><span class="main"><span>(</span></span><span class="var"><span>?T</span></span><span> </span><span class="bound"><span>p</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Fc</span></span><span> </span><span class="main"><span>(</span></span><span class="var"><span>?smul</span></span><span> </span><span class="var"><span>?s</span></span><span> </span><span class="var"><span>?t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Fs</span></span><span> </span><span class="var"><span>?s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Ft</span></span><span> </span><span class="var"><span>?t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span> ›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
</span><span>#&gt;</span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>register_assoc_tyoprs_rule_pass</span></span><span> </span><span class="entity"><span>DA_ELIM</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">pattern_prop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.Module_Assoc\&lt;^sub&gt;E|const"><span>Module_Assoc<span class="hidden">⇩</span><sub>E</sub></span></a><span> </span><span class="var"><span>?Fs</span></span><span> </span><span class="var"><span>?Ft</span></span><span> </span><span class="var"><span>?Fc</span></span><span> </span><span class="var"><span>?T</span></span><span> </span><span class="var"><span>?Ds</span></span><span> </span><span class="var"><span>?Dt</span></span><span> </span><span class="var"><span>?Dx</span></span><span> </span><span class="var"><span>?smul</span></span><span> </span><span class="var"><span>?f</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span>
              </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Fc</span></span><span> </span><span class="main"><span>(</span></span><span class="var"><span>?smul</span></span><span> </span><span class="var"><span>?s</span></span><span> </span><span class="var"><span>?t</span></span><span class="main"><span>)</span></span><span> </span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Fs</span></span><span> </span><span class="var"><span>?s</span></span><span> </span><span class="main"><span>(</span></span><span class="var"><span>?Ft</span></span><span> </span><span class="var"><span>?t</span></span><span> </span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                         </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Fs</span></span><span> </span><span class="var"><span>?s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Ft</span></span><span> </span><span class="var"><span>?t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span> ›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
     </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">pattern_prop</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.Module_Assoc\&lt;^sub&gt;\&lt;Lambda&gt;\&lt;^sub&gt;E|const"><span>Module_Assoc<span class="hidden">⇩</span><sub>Λ</sub><span class="hidden">⇩</span><sub>E</sub></span></a><span> </span><span class="var"><span>?Fs</span></span><span> </span><span class="var"><span>?Ft</span></span><span> </span><span class="var"><span>?Fc</span></span><span> </span><span class="var"><span>?T</span></span><span> </span><span class="var"><span>?Ds</span></span><span> </span><span class="var"><span>?Dt</span></span><span> </span><span class="var"><span>?Dx</span></span><span> </span><span class="var"><span>?smul</span></span><span> </span><span class="var"><span>?f</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span>
              </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Fc</span></span><span> </span><span class="main"><span>(</span></span><span class="var"><span>?smul</span></span><span> </span><span class="var"><span>?s</span></span><span> </span><span class="var"><span>?t</span></span><span class="main"><span>)</span></span><span> </span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Fs</span></span><span> </span><span class="var"><span>?s</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>p<span class="hidden">⇩</span><sub>s</sub></span></span><span class="main"><span>.</span></span><span> </span><span class="var"><span>?Ft</span></span><span> </span><span class="var"><span>?t</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>λ</span></span><span class="bound"><span>p<span class="hidden">⇩</span><sub>t</sub></span></span><span class="main"><span>.</span></span><span> </span><span class="var"><span>?T</span></span><span> </span><span class="main"><span>(</span></span><span class="bound"><span>p<span class="hidden">⇩</span><sub>s</sub></span></span><span class="main"><span>,</span></span><span> </span><span class="bound"><span>p<span class="hidden">⇩</span><sub>t</sub></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                         </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Fs</span></span><span> </span><span class="var"><span>?s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?Ft</span></span><span> </span><span class="var"><span>?t</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>&amp;&amp;&amp;</span></span><span> </span><span class="keyword1"><span>TERM</span></span><span class="main"><span>(</span></span><span class="var"><span>?T</span></span><span class="main"><span>)</span></span><span> ›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(*** Triggers of Normalization ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>whether_swap_norm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*F*)</span></span><span> * </span><span>term</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*Gs*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span>option</span><span>
      </span><span class="comment1"><span>(*whether to invoke the normalization swapping ‹F› over ‹Gs›*)</span></span><span>

</span><span class="comment1"><span>(** Swap Norm **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>F_Gs_encoding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>G_F_encoding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>encoding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*either F_Gs_encoding or G_F_encoding*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>swap_direction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>S_In</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>S_Out</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>encoding_F_Gs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>F</span></span><span class="main"><span>,</span></span><span class="entity"><span>Gs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_dddot</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Auto_Bind.dddot</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_dddot</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pass_dddot</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="comment1"><span>(*disabled: (*with the tailing unit, dddot can match zero or any terms*)*)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pass_dddot</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>X</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_dddot</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span>Auto_Bind.dddot</span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span>prop</span><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>X</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pass_dddot</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_dddot</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"‹…› should only be seen at the last"</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Logic.mk_term</span><span> </span><span class="entity"><span>X</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>pass_dddot</span></span><span> </span><span class="entity"><span>L</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Logic.mk_conjunction_list</span><span> </span><span class="main"><span>(</span></span><span>Logic.mk_term</span><span> </span><span class="entity"><span>F</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>pass_dddot</span></span><span> </span><span class="entity"><span>Gs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>encoding_G_F</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span class="entity"><span>F</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.mk_prod</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span class="entity"><span>F</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>encoding</span></span><span> </span><span class="entity"><span>S_In</span></span><span>  </span><span class="entity"><span>F_Gs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>encoding_F_Gs</span></span><span> </span><span class="entity"><span>F_Gs</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>encoding</span></span><span> </span><span class="entity"><span>S_Out</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>F</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="entity"><span>G</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>encoding_G_F</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span class="main"><span>,</span></span><span class="entity"><span>F</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>encoding</span></span><span> </span><span class="entity"><span>S_Out</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>Gs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Gs must be of single element in S_Out mode"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gs</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>NS_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_pair4</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span>pointer_eq</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Norm_Swaps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>swap_direction</span></span><span> * </span><span class="entity"><span>encoding</span></span><span> * </span><span class="entity"><span>whether_swap_norm</span></span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.merge</span><span> </span><span class="entity"><span>NS_eq</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>control_swap_normalizations_on</span></span><span> </span><span class="entity"><span>settings</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Norm_Swaps.map</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>direction</span></span><span class="main"><span>,</span></span><span class="entity"><span>terms</span></span><span class="main"><span>,</span></span><span class="entity"><span>chk</span></span><span class="main"><span>,</span></span><span class="entity"><span>prio</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>encoding</span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="entity"><span>terms</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Net.insert_term</span><span> </span><span class="entity"><span>NS_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>enc</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>direction</span></span><span class="main"><span>,</span></span><span class="entity"><span>enc</span></span><span class="main"><span>,</span></span><span class="entity"><span>chk</span></span><span class="main"><span>,</span></span><span class="entity"><span>prio</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>settings</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>whether_to_swap_normalize_internal</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>norm_swaps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Norm_Swaps.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>F_Gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>G_Fs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_enc</span></span><span> </span><span class="entity"><span>enc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.match_term</span><span> </span><span class="entity"><span>norm_swaps</span></span><span> </span><span class="entity"><span>enc</span></span><span>
           </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>enc'</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>PLPR_Pattern.matches</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>enc'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>enc</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>4</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>chk</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>prio</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>prio</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>F_Gs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>check_In</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_enc</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>encoding_F_Gs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>check_Out1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_enc</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>encoding_G_F</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_oprs</span></span><span> </span><span class="entity"><span>F_Gs</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>Phi_Help.max_of'</span></span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
                             </span><span class="main"><span>(</span></span><span class="entity"><span>check_In</span></span><span> </span><span class="entity"><span>F_Gs</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_Out1</span></span><span> </span><span>o</span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>F_Gs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>F_Gs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>chk_F_Gs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_oprs</span></span><span> </span><span class="entity"><span>F_Gs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>chk_G_Fs'</span></span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_oprs</span></span><span> </span><span class="entity"><span>G_Fs'</span></span><span>

   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chk_F_Gs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>chk_G_Fs'</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prio_a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>result_a</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prio_b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>result_b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>prio_a</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>prio_b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>result_a</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>result_b</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>result</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>result</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>result</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="entity"><span>result</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>whether_to_swap_normalize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>internal_check</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>whether_to_swap_normalize_internal</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_comm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_comm_F_Gs_from_appl</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>F_G_T_term</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>exists_Const</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../IDE_CP_Applications1.html#IDE_CP_Applications1.Bubbling|const"><span>Bubbling</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>F_G_T_term</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>internal_check</span></span><span> </span><span class="entity"><span>bvs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parse_comm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>F_G_T_term</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>swap_normalization_guard</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>goal</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.strip_meta_hhf_bvs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.leading_antecedent'</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ToA</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>direction</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>PLPR_Syntax.dest_action_of'</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;A&gt;simp&apos;|const"><span>𝒜simp'</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
                                             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>goal</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ToA</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>direction</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>ToA</span></span><span class="main"><span>,</span></span><span> 
                </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
                                </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.False|const"><span>False</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
                                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"the direction must be a literal"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"BUG"</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>F_G_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Phi_Syntax.dest_transformation</span></span><span> </span><span class="entity"><span>ToA</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Y</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>direction</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Syntax.dest_phi_type_assertion</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Y</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.ExBI|const"><span>ExBI</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span>
                                </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.Subjection|const"><span>Subjection</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>Y'</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="main"><span>=&gt;</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Syntax.dest_phi_type_assertion</span></span><span> </span><span class="entity"><span>Y'</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Syntax.dest_phi_type_assertion</span></span><span> </span><span class="entity"><span>Y</span></span><span> </span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"swap_normalization_guard"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="comment1"><span>(*(Config.get ctxt enable_swap_normalization_in_CoP_simp orelse
       Config.get ctxt under_NToA_ctxt) andalso*)</span></span><span>
      </span><span class="entity"><span>whether_to_swap_normalize</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Assoc Norm **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>assoc_direction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>AD_INTRO</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>AD_ELIM</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>NA_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_pair3</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span>pointer_eq</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>NA_eq'</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_pair3</span></span><span> </span><span class="main"><span>(</span></span><span>Pattern.equiv</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span>pointer_eq</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>

  </span><span class="comment1"><span>(* AD_INTRO: ‹F<span class="hidden">⇩</span><sub>s</sub> (F<span class="hidden">⇩</span><sub>t</sub> T) → F<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>+</sub><span class="hidden">⇩</span><sub>t</sub> T›
     AD_ELIM : ‹F<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>+</sub><span class="hidden">⇩</span><sub>t</sub> T → F<span class="hidden">⇩</span><sub>s</sub> (F<span class="hidden">⇩</span><sub>t</sub> T)› *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>whether_assoc_norm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.generic</span><span> * </span><span class="entity"><span>assoc_direction</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*F_G_T*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Norm_Assoc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>spattern</span></span><span> * </span><span class="entity"><span>whether_assoc_norm</span></span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.merge</span><span> </span><span class="entity"><span>NA_eq</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>control_assoc_normalizations_on</span></span><span> </span><span class="entity"><span>settings</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Norm_Assoc.map</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span class="entity"><span>chk</span></span><span class="main"><span>,</span></span><span class="entity"><span>prio</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Net.insert_term</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NA_eq'</span></span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span class="entity"><span>chk</span></span><span class="main"><span>,</span></span><span class="entity"><span>prio</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>settings</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>whether_to_assoc_normalize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>norm_assoc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Norm_Assoc.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>F_G_T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Net.match_term</span><span> </span><span class="entity"><span>norm_assoc</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span>
           </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term'</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>PLPR_Pattern.does_smatch</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>chk</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>direction</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
                </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>whether_to_SA_normalize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>swap</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>whether_to_swap_normalize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assoc</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>whether_to_assoc_normalize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>F_G_T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>swap</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>assoc</span></span><span> </span><span class="entity"><span>direction</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="entity"><span>F_G_T</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>




</span><span class="comment1"><span>(*** Toplevel ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> 'a </span><span class="entity"><span>whether_norm_synt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Literal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> 'a </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ML_Code</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Input.source

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>S_direction_synt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"into"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>S_In</span></span><span>
                    </span><span>||</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"out"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>S_Out</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>to_normalize_synt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>is</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="main"><span>(</span></span><span>  </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"false"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Literal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                     </span><span>||</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"true"</span></span><span>  </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Literal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                     </span><span>||</span><span> </span><span>Parse.ML_source</span><span>  </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>ML_Code</span></span><span> </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>Literal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>whether_norm_synt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>is</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="main"><span>(</span></span><span>  </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"false"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Literal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                     </span><span>||</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"true"</span></span><span>  </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Literal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                     </span><span>||</span><span> </span><span>Parse.ML_source</span><span>  </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>ML_Code</span></span><span> </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>Literal</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>whether_swap_norm__sender</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>whether_swap_norm</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>whether_assoc_norm__sender</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>whether_assoc_norm</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>whether_swap_norm__parse_locker</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.var</span><span> </span><span class="inner_quoted"><span>"to_normalize__parse_locker"</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_whether_swap_norm_synt</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ML_Code</span></span><span> </span><span class="entity"><span>src</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span>Synchronized.change_result</span><span> </span><span class="entity"><span>whether_swap_norm__parse_locker</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>ML_Context.expression</span><span> </span><span class="main"><span>(</span></span><span>Input.pos_of</span><span> </span><span class="entity"><span>src</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>(</span></span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>"Phi_Type.whether_swap_norm__sender := SOME (("</span></span><span> </span><span>@</span><span>
                       </span><span>ML_Lex.read_source</span><span> </span><span class="entity"><span>src</span></span><span> </span><span>@</span><span>
                       </span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>") : Phi_Type.whether_swap_norm)"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>whether_swap_norm__sender</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>whether_swap_norm__sender</span></span><span> </span><span>:=</span><span> </span><span>NONE</span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_whether_swap_norm_synt</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Literal</span></span><span> </span><span class="entity"><span>tn</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tn</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_whether_assoc_norm_synt</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ML_Code</span></span><span> </span><span class="entity"><span>src</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> 
      </span><span>Synchronized.change_result</span><span> </span><span class="entity"><span>whether_swap_norm__parse_locker</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>ML_Context.expression</span><span> </span><span class="main"><span>(</span></span><span>Input.pos_of</span><span> </span><span class="entity"><span>src</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>(</span></span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>"Phi_Type.whether_assoc_norm__sender := SOME (("</span></span><span> </span><span>@</span><span>
                       </span><span>ML_Lex.read_source</span><span> </span><span class="entity"><span>src</span></span><span> </span><span>@</span><span>
                       </span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>") : Phi_Type.whether_assoc_norm)"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>whether_assoc_norm__sender</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>whether_swap_norm__sender</span></span><span> </span><span>:=</span><span> </span><span>NONE</span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_whether_assoc_norm_synt</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Literal</span></span><span> </span><span class="entity"><span>tn</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tn</span></span><span>



</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi_simp_trigger_id'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi_backward_simp_trigger_id'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="inner_numeral"><span>0</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>

  </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Phi_Type.\&lt;phi&gt;ToA_swap_normalization|attribute"><span>φToA_swap_normalization</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>
    </span><span>Parse.and_list1'</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span>Args.term_pattern</span><span> </span><span>--</span><span> </span><span>Scan.lift</span><span> </span><span class="entity"><span>S_direction_synt</span></span><span> </span><span>--</span><span> </span><span>Parse.and_list1'</span><span> </span><span>Args.term_pattern</span><span> </span><span>--</span><span>
        </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>Reasoner_Group.parser</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>--</span><span>
        </span><span>Scan.lift</span><span> </span><span class="entity"><span>to_normalize_synt</span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>raw_controls</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>controls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>F</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>direction</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>to_normalize_synt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                </span><span class="main"><span>(</span></span><span class="entity"><span>direction</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>F</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Gs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                 </span><span class="entity"><span>check_whether_swap_norm_synt</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>to_normalize_synt</span></span><span class="main"><span>,</span></span><span>
                                 </span><span class="entity"><span>Reasoner_Group.check_group</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_controls</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>control_swap_normalizations_on</span></span><span> </span><span class="entity"><span>controls</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"controls whether should the ToA nroamlziation swap a φ-type operator over certain operators or not"</span></span><span>

</span><span>#&gt;</span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Phi_Type.\&lt;phi&gt;ToA_assoc_normalization|attribute"><span>φToA_assoc_normalization</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>
    </span><span>Parse.and_list1'</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span>Args.term_pattern</span><span> </span><span>--</span><span>
        </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>Reasoner_Group.parser</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span>--</span><span>
        </span><span>Scan.lift</span><span> </span><span class="entity"><span>whether_norm_synt</span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>raw_controls</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>controls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>to_normalize_synt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span>
                                 </span><span class="entity"><span>check_whether_assoc_norm_synt</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>to_normalize_synt</span></span><span class="main"><span>,</span></span><span>
                                 </span><span class="entity"><span>Reasoner_Group.check_group</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_controls</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>control_assoc_normalizations_on</span></span><span> </span><span class="entity"><span>controls</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"controls whether should the ToA nroamlziation fuses by associatives φ-type operators ‹F<span class="hidden">⇩</span><sub>s</sub> (F<span class="hidden">⇩</span><sub>t</sub> T)› to ‹F<span class="hidden">⇩</span><sub>s</sub><span class="hidden">⇩</span><sub>+</sub><span class="hidden">⇩</span><sub>t</sub> T›"</span></span><span>


</span><span>#&gt;</span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Phi_Type.\&lt;phi&gt;ToA_SA_norm_simp|attribute"><span>φToA_SA_norm_simp</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="entity"><span>Phi_Reasoner.attr_syntax</span></span><span> </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>swap_normalization_guard</span></span><span> </span><span class="entity"><span>guard'</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
       </span><span>|&gt;</span><span> </span><span>Config.put_generic</span><span> </span><span class="entity"><span>Phi_CoP_Simp.extract_pattern_trigger</span></span><span> </span><span>false</span><span>
       </span><span>|&gt;</span><span> </span><span>Config.put_generic</span><span> </span><span class="entity"><span>Phi_CoP_Backward_Simp.extract_pattern_trigger</span></span><span> </span><span>false</span><span>

       </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Reasoner.add_rule</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>φToA_SA_derived</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                </span><span class="entity"><span>pats</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span>

       </span><span>|&gt;</span><span> </span><span>Config.restore_generic</span><span> </span><span class="entity"><span>Phi_CoP_Simp.extract_pattern_trigger</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
       </span><span>|&gt;</span><span> </span><span>Config.restore_generic</span><span> </span><span class="entity"><span>Phi_CoP_Backward_Simp.extract_pattern_trigger</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="inner_quoted"><span>"declares a φsimp rule which will be used in swapping &amp; assoc normalization.\
  \ Note the swap or the assoc still needs to be enabled by declaring φToA_swap_normalization or φToA_assoc_normalization"</span></span><span>

</span><span>#&gt;</span><span> </span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>
    </span><span class="entity"><span>Phi_CoP_Simp.add_simp_trigger</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">pattern</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>_</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>⦂</span></a></span><span> </span><span class="main"><span>_</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>φType</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="comment1"><span>(*(Config.get_generic ctxt enable_swap_normalization_in_CoP_simp orelse
         Config.get_generic ctxt under_NToA_ctxt) andalso*)</span></span><span>
        </span><span class="entity"><span>Phi_CoP_Simp.pass_recursively</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>whether_to_SA_normalize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>AD_INTRO</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="entity"><span>T</span></span><span>
      </span><span class="main"><span>)</span></span><span> </span><span>#-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>phi_simp_trigger_id'</span></span><span> </span><span>:=</span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>;</span></span><span>
        </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
 </span><span>#&gt;</span><span> </span><span class="entity"><span>Phi_CoP_Backward_Simp.add_simp_trigger</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">pattern</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><span class="main"><span>_</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>⦂</span></a></span><span> </span><span class="main"><span>_</span></span><span>›</span></span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>φType</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="comment1"><span>(*(Config.get_generic ctxt enable_swap_normalization_in_CoP_simp orelse
         Config.get_generic ctxt under_NToA_ctxt) andalso*)</span></span><span>
        </span><span class="entity"><span>Phi_CoP_Simp.pass_recursively</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>whether_to_SA_normalize</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>AD_ELIM</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="entity"><span>T</span></span><span>
      </span><span class="main"><span>)</span></span><span> </span><span>#-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>phi_backward_simp_trigger_id'</span></span><span> </span><span>:=</span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>;</span></span><span>
        </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span>

</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi_simp_trigger_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>!</span><span> </span><span class="entity"><span>phi_simp_trigger_id'</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi_backward_simp_trigger_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>!</span><span> </span><span class="entity"><span>phi_backward_simp_trigger_id'</span></span><span>






</span><span class="comment1"><span>(*
fun parse_raw_pattern raw =
  let val (pat::F::G) = Logic.dest_conjunction_list raw
   in (pat, F, G)
  end

val comm_patterns = Unsynchronized.ref (map (apfst parse_raw_pattern)
      [(<span class="hidden">\&lt;^</span><span class="control">pattern_prop</span><span class="hidden">&gt;</span>‹Tyops_Commute ?F ?F' ?G ?G' ?T ?D ?r &amp;&amp;&amp; TERM ?F &amp;&amp;&amp; TERM ?G›, 1),
       (<span class="hidden">\&lt;^</span><span class="control">pattern_prop</span><span class="hidden">&gt;</span>‹Tyops_Commute<span class="hidden">⇩</span><sub>1</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>2</sub> ?F ?F'<span class="hidden">⇩</span><sub>T</sub> ?F'<span class="hidden">⇩</span><sub>U</sub> ?G ?G' ?T ?U ?D ?r &amp;&amp;&amp; TERM ?F &amp;&amp;&amp; TERM ?G›, 1),
       (<span class="hidden">\&lt;^</span><span class="control">pattern_prop</span><span class="hidden">&gt;</span>‹Tyops_Commute<span class="hidden">⇩</span><sub>2</sub><span class="hidden">⇩</span><sub>_</sub><span class="hidden">⇩</span><sub>1</sub> ?F ?F'<span class="hidden">⇩</span><sub>T</sub> ?F'<span class="hidden">⇩</span><sub>U</sub> ?G ?G' ?T ?U ?D ?r &amp;&amp;&amp; TERM ?G' &amp;&amp;&amp; TERM ?F'<span class="hidden">⇩</span><sub>T</sub> &amp;&amp;&amp; TERM ?F'<span class="hidden">⇩</span><sub>U</sub>›, 2)])

fun mk_comm_patterns thy (F,Gs) =
  map_filter (fn ((pat, F', Gs'),_) =&gt;
    let val envir = fold (Pattern.match thy) ((F',F)::(Gs' ~~ Gs)) (Vartab.empty, Vartab.empty)
     in SOME (Envir.subst_term envir pat)
    end handle Pattern.MATCH =&gt; NONE
  ) (!comm_patterns)

fun mk_comm_patterns_F thy F =
  map_filter (fn ((pat, F', _), arity) =&gt;
    let val envir = Pattern.match thy (F',F) (Vartab.empty, Vartab.empty)
     in SOME (Envir.subst_term envir pat, arity)
    end handle Pattern.MATCH =&gt; NONE
  ) (!comm_patterns)

fun commutative_rules ctxt =
  let val lookup = PLPR_Template_Properties.lookup_properties_match ctxt
      val chk_pat = PLPR_Template_Properties.assert_property_pattern (Context.theory_of ctxt)
   in fn (F,G) =&gt;
  let val patterns = mk_comm_patterns (Context.theory_of ctxt) (F,G)
   in maps (lookup o chk_pat) patterns
  end
  end

fun commutative_rules_of_F ctxt =
  let val lookup = PLPR_Template_Properties.lookup_properties_match ctxt
      val chk_pat = PLPR_Template_Properties.assert_property_pattern (Context.theory_of ctxt)
   in fn F =&gt;
  let val patterns = mk_comm_patterns_F (Context.theory_of ctxt) F
   in maps (fn (pat, arity) =&gt; lookup (chk_pat pat)
                            |&gt; map (rpair arity)) patterns
  end
  end

fun are_commutative ctxt =
  let val rules = commutative_rules ctxt
   in fn (F,G) =&gt; not (null (rules (F,G)))
  end

fun is_commutative ctxt =
  let val rules = commutative_rules_of_F ctxt
   in fn F =&gt; distinct (op =) (map snd (rules F))
  end
*)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>