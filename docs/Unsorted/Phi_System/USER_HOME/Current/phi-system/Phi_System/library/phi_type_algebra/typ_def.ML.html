<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/phi_type_algebra/typ_def.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/phi_type_algebra/typ_def.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*
FILE: Phi_System/library/tools/functor_detect.ML
AUTHOR: Qiyuan Xu

Given a term of a φ-type which is an application of a functor with an argument,
it is undecidable by higher-order lambda pattern match to get the functor and the argument from it.
The file provides ML code enabling users to register rewrites or ML codes to extract the functor
from terms matching certain patterns.

It also implements a simple fallback heuristic that works when the term is a sequence
of lambda applications ‹H $ A1 $ A2 $ A3› and the head is a constant, and it assumes the argument
is the last operand i.e. the A3.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PHI_TYPE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>include</span></span></span><span> </span><span class="entity"><span>PHI_TYPE</span></span><span>


</span><span class="comment1"><span>(** φ-Type Definition \&amp; Infos **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>DIRECT_DEF</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> thm </span><span class="comment1"><span>(*def*)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>WFREC_DEF</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Function.info
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>parameter_equality</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PE_Synt</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PE_Guard</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PE_Proof</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>parameter_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*not always given*)</span></span><span class="main"><span>,</span></span><span>
  mutating</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>option</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(*if the parameter mutates throughout the (recursive) definition.
                           we are not always able to check if a parameter mutates from definition*)</span></span><span>
  equality</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>parameter_equality</span></span><span> </span><span class="comment1"><span>(*Two φ-types ‹T a<span class="hidden">⇩</span><sub>1</sub> ⋯ a<span class="hidden">⇩</span><sub>n</sub>› and ‹T a<span class="hidden">⇩</span><sub>1</sub>' ⋯ a<span class="hidden">⇩</span><sub>n</sub>'› are *)</span></span><span>
</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  name</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span class="main"><span>,</span></span><span>
  term</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*of most general type and schematic variables*)</span></span><span class="main"><span>,</span></span><span>
  params</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>parameter_info</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*the default name of the parameters. note the abstract object is not considered as a parameter*)</span></span><span class="main"><span>,</span></span><span>
  cterm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="comment1"><span>(*TERM &lt;the_cterm&gt;*)</span></span><span class="main"><span>,</span></span><span>
  pos </span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span class="main"><span>,</span></span><span>
  equations</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*definitional equations, in HOL.eq*)</span></span><span class="main"><span>,</span></span><span>
  type_equations</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>option</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
                  </span><span class="comment1"><span>(*the equations are given between BI assertions, ‹x : T = y : U›.
                    Here the type equations are given between types, ‹T = U›.
                    However, depending on definitions, not all φ-types have such equations.*)</span></span><span>
  cases</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
  ind</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
    </span><span class="comment1"><span>(*inductively destructive transformation, of form
     has_R: ... ⟹ ?P.0 a b c x ⟶ (?R.0 * x : T a b c ⟶ ?Y.0 and ?Q.0)  (*only available for sep-magma*)
     full:  ... ⟹ ?P.0 a b c x ⟶ (x : T a b c ⟶ ?Y.0 a b c x and ?Q.0 a b c x)
     dom_only: ... ⟹ ?P.0 a b c x ⟶ (x : T a b c ⟶ ?Y.0 and ?Q.0) *)</span></span><span>
  intro_reasoning</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*introduction transformations*)</span></span><span class="main"><span>,</span></span><span>
  is_recursive</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
  is_impredicative</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*to be supported*)</span></span><span>
</span><span class="main"><span>}</span></span><span> </span><span class="comment1"><span>(*rules and terms inside must be zero-indexed*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> map_phi_type </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fold_phi_type </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> * </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> has_mutating_params </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> may_has_mutating_params </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parameters_of </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parameter_info</span></span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parameters_and_typs_of </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parameter_info</span></span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span>typ</span><span> </span><span class="comment1"><span>(*abstract typ*)</span></span><span> * </span><span>typ</span><span> </span><span class="comment1"><span>(*concrete typ*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> morphism_phi_type </span><span class="main"><span>:</span></span><span> </span><span>morphism</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> instantiate_phi </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>ctyp</span><span> </span><span>TVars.table</span><span> * </span><span>cterm</span><span> </span><span>Vars.table</span><span class="main"><span>)</span></span><span>
                   </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> phi_trim_context </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> phi_transfer </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> maxidx_of_phi </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_type_info </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span>option</span><span>

</span><span class="comment1"><span>(** Property Deriver from φ-Type Definition **)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>deriver_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>is_weak</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>bool</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>quiet</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*report nothing even when fail*)</span></span><span>
</span><span class="comment1"><span>(*type deriving_ctxt = Proof.context (*the context used for deriving rules, which may be prepared
                                     specially with user configurations*)*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>derive</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arbi_ind_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*free variables that will be generalized before induction,
                                           apply (induct arbitrary: &lt;NAMES OF THOSE VARIABLES&gt;) *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hint</span></span><span> * </span><span class="entity"><span>arbi_ind_args</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
                          * </span><span class="entity"><span>Reasoner_Group.group</span></span><span> </span><span>option</span><span>
                          * </span><span>Position.T</span><span>
                          * </span><span class="entity"><span>Method.text</span></span><span> </span><span>option</span><span>               </span><span class="comment1"><span>(*tactic hints*)</span></span><span>
                          * </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span>list</span><span> * </span><span>attribute</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*notes*)</span></span><span>
                          * </span><span class="entity"><span>Bundle.name</span></span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>deriver</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  priority</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span>
  dependences</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriver_name</span></span><span> * </span><span class="entity"><span>is_weak</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
      </span><span class="comment1"><span>(*a weak dependency is invoked in quiet mode, meaning no error will be reported on failure,
        and not activated when any hint is given to the deriver depending on the weak dependency.
        Once users give an annotation, every implicit behavior is revoked, and this is the only
        way to revoke the implicit behavior.
        Users may declare a weak dependency by append a question mark after the dependency name.*)</span></span><span>
  derive</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>quiet</span></span><span> * </span><span>Position.T</span><span> </span><span class="comment1"><span>(*where does the deriving happen*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derive</span></span><span>
</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_deriver </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriver_name</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriver</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> check_deriver </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>xstring</span><span> * </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriver_name</span></span><span> * </span><span class="entity"><span>deriver</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> deriver_name_space </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriver</span></span><span> </span><span>Name_Space.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> define_deriver </span><span class="main"><span>:</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriver</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span>local_theory</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> define_deriver_global </span><span class="main"><span>:</span></span><span> </span><span>binding</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriver</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span>theory</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> bind_derivers_on_patterns </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>deriver_name</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> match_deriver </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriver_name</span></span><span> * </span><span class="entity"><span>deriver</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> Unknown_Hint </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> match_deriver1 </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriver_name</span></span><span> * </span><span class="entity"><span>deriver</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Derivings </span><span class="main"><span>:</span></span><span> </span><span>TABLE</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>derivings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriving_instruction</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>deriver</span></span><span> * </span><span class="entity"><span>is_weak</span></span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span> </span><span>Derivings.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_deriving </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span> </span><span>list</span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>deriver_name</span></span><span> * </span><span class="entity"><span>deriver</span></span><span class="main"><span>)</span></span><span> * </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derivings</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derivings</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_deriving_from_hint </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derivings</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derivings</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_deriver_dependences </span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriver_name</span></span><span> * </span><span class="entity"><span>is_weak</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derivings</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derivings</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> complete_deriver_dependences </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derivings</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derivings</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> derive_properties </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>derivings</span></span><span> * </span><span class="entity"><span>Bundle.name</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
    </span><span class="comment1"><span>(*no need to call it manually. It is invoked by `add_type` *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> under_deriving_ctxt </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Deriving_Hooks </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>HOOKS</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>deriving_hook</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derivings</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derivings</span></span><span> * </span><span>local_theory</span><span>

</span><span class="comment1"><span>(* Derived Properties *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lookup_derived_properties </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="comment1"><span>(*name*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span>list</span><span>
      </span><span class="comment1"><span>(*the name is not necessarily the name of the deriver as a deriver can derive multiple
        properties. It is the name that is sent by the deriver when it calls `register_derived_properties`.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> register_derived_properties </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span>int</span><span> * </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
      </span><span class="comment1"><span>(*It will also bind in Isabelle the properties to names &lt;phi_type_name.property_names<span class="hidden">⇩</span><sub>i</sub>&gt;
        for the i-th property each.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> print_derived_properties </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span>int</span><span> * </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> note_properties' </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*true for no_atp*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> note_properties  </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*true for no_atp*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> note_properties_s</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*true for no_atp*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>bstring</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> local_note_properties' </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> local_note_properties  </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>binding</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> local_note_properties_s</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>bstring</span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> suffix_name_by_index </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span>

</span><span class="comment1"><span>(* Syntax *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>deriving_ast</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> deriving_parser </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>deriving_ast</span></span><span> </span><span>list</span><span> </span><span>parser</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> check_deriving_ast </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriving_ast</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derivings</span></span><span>


</span><span class="comment1"><span>(** Define φ-Type and invoke derivings **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Defining_Phi_Type </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>HOOKS</span></span><span> </span><span class="comment1"><span>(*invoked before any deriving*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_type </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span>no_auto</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span>
            </span><span class="main"><span>-&gt;</span></span><span> </span><span>binding</span><span> * </span><span>term</span><span> * </span><span class="entity"><span>def</span></span><span> * </span><span>Position.T</span><span>
             * </span><span class="entity"><span>derivings</span></span><span>
             * </span><span class="entity"><span>Bundle.name</span></span><span> </span><span>list</span><span>
             * </span><span class="entity"><span>parameter_equality</span></span><span> </span><span>option</span><span> </span><span>list</span><span> </span><span>option</span><span>
            </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> * </span><span>local_theory</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> override_ind_rule </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> * </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>

</span><span class="comment1"><span>(** Tools **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_term_of_phi </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*ignores type*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> assert_Type_Opr </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> assert_first_parameter_is_type </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
    </span><span class="comment1"><span>(*note the T below is a φ-type parameter*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> separate_tyopr_and_its_typ_param </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>bv_typs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*F(T)*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="comment1"><span>(*T*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*F*)</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> separate_tyopr_and_its_non_parameterized_typ_param </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>bv_typs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*F(T)*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="comment1"><span>(*T*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*F*)</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> separate_tyopr_and_its_non_parameterized_typ_param_safe </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>bv_typs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*F(T)*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="comment1"><span>(*T*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*F*)</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> separate_tyopr_and_its_non_parameterized_typ_params </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*F(T<span class="hidden">⇩</span><sub>1</sub>,T<span class="hidden">⇩</span><sub>2</sub>,...)*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*T<span class="hidden">⇩</span><sub>1</sub>,T<span class="hidden">⇩</span><sub>2</sub>,...*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*F*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> separate_tyopr_and_its_typ_params </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*F(T<span class="hidden">⇩</span><sub>1</sub>,T<span class="hidden">⇩</span><sub>2</sub>,...)*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*T<span class="hidden">⇩</span><sub>1</sub>,T<span class="hidden">⇩</span><sub>2</sub>,...*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*F*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> separate_tyopr_and_its_typ_param_safe </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>bv_typs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*F(T)*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="comment1"><span>(*T*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*F*)</span></span><span class="main"><span>)</span></span><span> </span><span>Seq.seq</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> separate_module_tyopr </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>bv_typs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*F<span class="hidden">⇩</span><sub>c</sub>(T)*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="comment1"><span>(*T*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*c*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*F*)</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> separate_scalar_tyopr </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>bv_typs</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*F<span class="hidden">⇩</span><sub>c</sub>(T)*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*T*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*c*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*F*)</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> def_contains_satisfaction </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>

</span><span class="comment1"><span>(*make inductively destruction rule.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_ind_dest_ToA </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="comment1"><span>(*x*)</span></span><span> * </span><span>term</span><span> </span><span class="comment1"><span>(*T*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_ind_dest_ToA_internal </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> is_phi_type_fixed </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fix_phi_type </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
        </span><span class="main"><span>(</span></span><span>ctyp</span><span> </span><span>TVars.table</span><span> * </span><span>cterm</span><span> </span><span>Vars.table</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>phi_type</span></span><span> *
        </span><span class="entity"><span>Proof.context</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> fix_phi_term_params </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span>
        </span><span class="comment1"><span>(*only fix the terms but no types*)</span></span><span>

</span><span class="comment1"><span>(* Auxiliaries *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> open_proof_ctxt </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Bundle.name</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>

</span><span class="comment1"><span>(*for mutating params {p<span class="hidden">⇩</span><sub>i</sub>}
 ‹  condition p<span class="hidden">⇩</span><sub>1</sub> = p<span class="hidden">⇩</span><sub>1</sub>'
⟹ condition p<span class="hidden">⇩</span><sub>2</sub> = p<span class="hidden">⇩</span><sub>2</sub>'
⟹ …
⟹ condition p<span class="hidden">⇩</span><sub>n</sub> = p<span class="hidden">⇩</span><sub>n</sub>'
⟹ T p<span class="hidden">⇩</span><sub>1</sub> p<span class="hidden">⇩</span><sub>2</sub> … p<span class="hidden">⇩</span><sub>n</sub> = T p<span class="hidden">⇩</span><sub>1</sub>' p<span class="hidden">⇩</span><sub>2</sub>' … p<span class="hidden">⇩</span><sub>n</sub>' ›
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> mk_mutating_param_eq </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*mode of condition equation*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

</span><span class="comment1"><span>(* Internal Technical stuffs *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ML_sender </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quiet</span></span><span> * </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derive</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>Unsynchronized.ref</span><span>

</span><span class="comment1"><span>(* Suggest some property should be derived *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> chk_deriving_or_derived </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> * </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derivings</span></span><span> * </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> suggest_property_should_be_derived </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>string</span><span class="main"><span>)</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span>
                                      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span class="main"><span>)</span></span><span>
                                      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriving_hook</span></span><span>

</span><span class="comment1"><span>(** Controllers **)</span></span><span>

</span><span class="comment1"><span>(*val search_CSTR_rules : bool Config.T*)</span></span><span>
  </span><span class="comment1"><span>(*if to enable branched searching in the reasoning of MAKE and OPEN for different definition equantions
    used to construct or destruct φ-types*)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(**** Implementation ****)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Phi_Type</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PHI_TYPE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Phi_Type</span><span>

</span><span class="comment1"><span>(** Library **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>open_proof_ctxt</span></span><span> </span><span class="entity"><span>bundles</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>bundles</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="main"><span>(</span></span><span>
          </span><span>Config.put</span><span> </span><span class="entity"><span>Phi_Reasoner.ignore_dup_reasoner</span></span><span> </span><span>true</span><span>
       </span><span>#&gt;</span><span> </span><span class="entity"><span>Bundle.includes</span></span><span> </span><span class="entity"><span>bundles</span></span><span>
       </span><span>#&gt;</span><span> </span><span>Config.restore</span><span> </span><span class="entity"><span>Phi_Reasoner.ignore_dup_reasoner</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>augment_ToA_by_implication</span></span><span> </span><span>true</span><span>

</span><span class="comment1"><span>(*** φ-Type Definition \&amp; Infos ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>introN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"intro"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intro_reasoningN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"intro_reasoning"</span></span><span> </span><span class="comment1"><span>(*rules for reasoning*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intro_reasoning_R_N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"intro_reasoning<span class="hidden">⇩</span><sub>R</sub>"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intro_mapN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"intro_map"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elimN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"elim"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elim_reasoningN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"elim_reasoning"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elim_mapN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"elim_map"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfoldN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"unfold"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfold_valN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"unfold_val"</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expansionN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"expansion"</span></span><span>
</span><span class="comment1"><span>(* val open_abstractionN = "open_abstraction" *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>DIRECT_DEF</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> thm </span><span class="comment1"><span>(*def*)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>WFREC_DEF</span></span><span>  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Function.info

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>parameter_equality</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PE_Synt</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PE_Guard</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>PE_Proof</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>parameter_info</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  name</span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
  mutating</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>option</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(*if the parameter mutates throughout the (recursive) definition.
                           we are not always able to check if a parameter mutates from definition*)</span></span><span>
  equality</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>parameter_equality</span></span><span>
</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  name</span><span class="main"><span>:</span></span><span> </span><span>binding</span><span class="main"><span>,</span></span><span>
  term</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*of most general type*)</span></span><span class="main"><span>,</span></span><span>
  params</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>parameter_info</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span class="comment1"><span>(*the abstract object is not considered a parameter*)</span></span><span>
  cterm</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span class="main"><span>,</span></span><span>
  pos </span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span class="main"><span>,</span></span><span>
  equations</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*unfolding the term*)</span></span><span class="main"><span>,</span></span><span>
  type_equations</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>option</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  ind</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
  cases</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>option</span><span class="main"><span>,</span></span><span>
  intro_reasoning</span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*introduction transformations*)</span></span><span class="main"><span>,</span></span><span>
  is_recursive</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
  is_impredicative</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*to be supported*)</span></span><span>
</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_mutating_params</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>mutating</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>params </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>may_has_mutating_params</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span>false</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>mutating</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>params </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>map_phi_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mb</span></span><span class="main"><span>,</span></span><span class="entity"><span>mtm</span></span><span class="main"><span>,</span></span><span class="entity"><span>mth</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>
    name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mb</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mtm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    params </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>params </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span>
    cterm </span><span class="main"><span>=</span></span><span> </span><span>singleton</span><span> </span><span class="entity"><span>mth</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>cterm </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    pos </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>pos </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span>
    equations </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mth</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>equations </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    type_equations </span><span class="main"><span>=</span></span><span> </span><span>burrow_options</span><span> </span><span class="entity"><span>mth</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>type_equations </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    ind </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="entity"><span>mth</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ind </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    cases </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="entity"><span>mth</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>cases </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    intro_reasoning </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mth</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>intro_reasoning </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
    is_recursive </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>is_recursive </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span>
    is_impredicative </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>is_impredicative </span><span class="entity"><span>phi</span></span><span>
  </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_ind</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>{</span></span><span>
    name </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>name </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span>
    term </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span>
    params </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>params </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span>
    cterm </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>cterm </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span>
    pos </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>pos </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span>
    equations </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>equations </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span>
    type_equations </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>type_equations </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span>
    ind </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>,</span></span><span>
    cases </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>cases </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span>
    intro_reasoning </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>intro_reasoning </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span>
    is_recursive </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>is_recursive </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span>
    is_impredicative </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>is_impredicative </span><span class="entity"><span>phi</span></span><span>
  </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_phi_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fold_tm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fold_thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>fold_tm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>fold_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>equations </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>#</span></span><span>ind </span><span class="entity"><span>phi</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fold_thm</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>fold_thm</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>intro_reasoning </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>morphism_phi_type</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_phi_type</span></span><span> </span><span class="main"><span>(</span></span><span>Morphism.binding</span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span>Morphism.fact</span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi_trim_context</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_phi_type</span></span><span> </span><span class="main"><span>(</span></span><span>I</span><span class="main"><span>,</span></span><span> </span><span>I</span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.trim_context</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>phi_transfer</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map_phi_type</span></span><span> </span><span class="main"><span>(</span></span><span>I</span><span class="main"><span>,</span></span><span> </span><span>I</span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>maxidx_of_phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_phi_type</span></span><span> </span><span class="main"><span>(</span></span><span>Term.maxidx_term</span><span class="main"><span>,</span></span><span> </span><span>Thm.maxidx_thm</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>hint</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>phi_typ_binding_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>name </span><span class="entity"><span>phi1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>name </span><span class="entity"><span>phi2</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>phi_typ_term_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi2</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>phi_typ_term_equiv</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Pattern.equiv</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Phi_Types</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span>Net.net</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.merge</span><span> </span><span class="entity"><span>phi_typ_binding_eq</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_type_info</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi_transfer</span></span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>(</span></span><span>Net.match_term</span><span> </span><span class="main"><span>(</span></span><span>Phi_Types.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>term</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span>Pattern.equiv</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>term</span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>try</span><span> </span><span>hd</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>override_ind_rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Phi_Types.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phis</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.match_term</span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="entity"><span>term</span></span><span>
                </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span>Pattern.equiv</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>term</span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phis'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_ind</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.trim_context</span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phis</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>net</span></span><span>
     </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Net.delete_term</span><span> </span><span class="entity"><span>phi_typ_term_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phis</span></span><span>
     </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Net.insert_term</span><span> </span><span class="entity"><span>phi_typ_term_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phis</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="comment1"><span>(*
fun add_automation_on_def priority automation ctxt =
  Automation_on_Def.map (PriorityTab.update_new (
      (priority, Context.theory_long_name (Context.theory_of ctxt)), automation)) ctxt

fun invoke_automations_on_def (phi,hints) ctxt =
  case PriorityTab.fold (fn (_,s) =&gt; s phi) (Automation_on_Def.get ctxt) (hints, ctxt)
    of ([], ctxt') =&gt; ctxt'
     | (hints, ctxt') =&gt; let open Pretty in
          error (string_of (chunks (
            (str "Do not know how to derive the properties:") ::
            map (fn H =&gt;
              item [Context.cases Syntax.pretty_term_global Syntax.pretty_term ctxt' H]
            ) hints)))
       end
*)</span></span><span>

</span><span class="comment1"><span>(** Pretty Printer **)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_parameter_equality</span></span><span> </span><span class="entity"><span>PE_Synt</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>keyword2</span><span> </span><span class="inner_quoted"><span>"id"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_parameter_equality</span></span><span> </span><span class="entity"><span>PE_Guard</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>keyword2</span><span> </span><span class="inner_quoted"><span>"guard"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pretty_parameter_equality</span></span><span> </span><span class="entity"><span>PE_Proof</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>keyword2</span><span> </span><span class="inner_quoted"><span>"obligation"</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Impl of Basic Conversions **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>add_premise_tag</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Conv.recursive_premises_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.Transformation|const"><span>Transformation</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.head_of</span><span> </span><span class="entity"><span>X</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PLPR_Syntax.add_premise_tag_conv</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">cterm</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.default|const"><span>default</span></a><span>›</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* fun mk_parameterized (arg_tys, x_ty) (name,T) =
  let val arity = length arg_tys
   in (fold_index (fn (i,_) =&gt; fn X =&gt; X $ Bound (arity-i)) arg_tys
          (Var ((name,0), rev arg_tys ---&gt; x_ty --&gt; T)))
       $ Bound 0
  end

  fun bool_term name = Var((name,0), HOLogic.boolT)
  fun BI_term name = Var((name,0),<span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span>‹set model_ty›)
  fun parameterized_BI name = mk_parameterized name <span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span>‹set model_ty›
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>raw_term_name_typ</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="entity"><span>N_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N_T</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>raw_term_name_typ</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="entity"><span>N_T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N_T</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>raw_term_name_typ</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Not a Const nor Free"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>X</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>raw_term_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>raw_term_name_typ</span></span><span> </span><span>o</span><span> </span><span>Term.head_of</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ind_dest_ToA_internal</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prop0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="quoted"><span>‹</span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.BI|type"><span>BI</span></a><span> </span><span class="entity"><span>a</span></span><span>›</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>r</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span>::</span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Internal bug"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rev_arg_tys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>typ</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prop0</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span class="entity"><span>x_ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rev_arg_tys</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.head_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ind </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Var</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span>
                         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Bad induction rule"</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span>Vars.make</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>prop_var</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ind </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_ind_dest_ToA</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>gen_prop</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="quoted"><span>‹</span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.BI|type"><span>BI</span></a><span> </span><span class="entity"><span>a</span></span><span>›</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>r</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span>::</span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Internal bug"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rev_arg_tys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_typ</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>typ</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>rev_arg_tys</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity</span></span><span>-</span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rev_arg_tys</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_prop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x_term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_term</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span class="entity"><span>x_ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rev_arg_tys</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.maxidx_of_term</span><span> </span><span class="entity"><span>prop</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.incr_indexes</span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>ind </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop_var</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.head_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.dest_Trueprop</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span>
                         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Bad induction rule"</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Drule.infer_instantiate</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>prop_var</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ind</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Tools **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>def_contains_satisfaction</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>contains_sat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.exists_subterm</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.Satisfaction|const"><span>Satisfaction</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
                                               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>phi_contains_sat</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.ExBI|const"><span>ExBI</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi_contains_sat</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>phi_contains_sat</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi_contains_sat</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>phi_contains_sat</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.Subjection|const"><span>Subjection</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>contains_sat</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>phi_contains_sat</span></span><span> </span><span class="entity"><span>A</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>phi_contains_sat</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_contains_sat</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_contains_sat</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_contains_sat</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi_contains_sat</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_contains_sat</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi_contains_sat</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_contains_sat</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_contains_sat</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eq_contains_sat</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"def_contains_satisfaction"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>X</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq_contains_sat</span></span><span> </span><span>o</span><span> </span><span>Thm.prop_of</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>equations </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parameters_of</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>params </span><span class="entity"><span>phi</span></span><span> </span><span>~~</span><span> </span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dest_parameterized_phi_ty</span></span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parameters_and_typs_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span class="main"><span>:</span></span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rev_atys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m_ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_parameterized_phi_ty</span></span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>params </span><span class="entity"><span>phi</span></span><span> </span><span>~~</span><span> </span><span>rev</span><span> </span><span class="entity"><span>rev_atys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m_ty</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fix_phi_term_params</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parameters_and_typs_of</span></span><span> </span><span class="entity"><span>phi</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x_name</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>param_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>(</span></span><span>
                  </span><span class="inner_quoted"><span>"x"</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="inner_quoted"><span>"A"</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>name </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Free</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_names</span></span><span> </span><span class="entity"><span>params</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span class="main"><span>(</span></span><span class="entity"><span>x_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x_ty</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_terms</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>x_term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T_term</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*** Deriving Properties ***)</span></span><span>

</span><span class="comment1"><span>(** Data Types **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>deriver_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>derive</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arbi_ind_args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*free variables that will be generalized before induction*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hint</span></span><span> * </span><span class="entity"><span>arbi_ind_args</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
                          * </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Reasoner.priority</span></span><span> * </span><span class="entity"><span>Reasoner_Group.name</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
                          * </span><span>Position.T</span><span>
                          * </span><span class="entity"><span>Method.text</span></span><span> </span><span>option</span><span>
                          * </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span>list</span><span> * </span><span>attribute</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*notes*)</span></span><span>
                          * </span><span class="entity"><span>Bundle.name</span></span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>is_weak</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>bool</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>quiet</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>bool</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>deriver</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
  priority</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span>
  dependences</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriver_name</span></span><span> * </span><span class="entity"><span>is_weak</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
  derive</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>quiet</span></span><span> * </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derive</span></span><span>
</span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Derivers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deriver</span></span><span> </span><span>Name_Space.table</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.empty_table</span><span> </span><span class="inner_quoted"><span>"φderiver"</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.merge_tables</span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Derivings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Table</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>priority</span></span><span> * </span><span class="entity"><span>deriver_name</span></span><span class="main"><span>;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>prod_ord</span><span> </span><span>int_ord</span><span> </span><span>string_ord</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>derivings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriving_instruction</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>deriver</span></span><span> * </span><span class="entity"><span>is_weak</span></span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span> </span><span>Derivings.table</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Deriver_Bindings</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>deriver_name</span></span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.merge</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>deriving_hook</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derivings</span></span><span> * </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derivings</span></span><span> * </span><span>local_theory</span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Deriving_Hooks</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hooks</span></span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi_type</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>derivings</span></span><span> * </span><span>local_theory</span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_deriver</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>derv</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>deriver</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Derivers.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>#</span></span><span>dependences </span><span class="entity"><span>derv</span></span><span>
   </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Name_Space.get</span><span> </span><span class="entity"><span>names</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>der'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>#</span></span><span>priority </span><span class="entity"><span>derv</span></span><span> </span><span>&gt;</span><span> </span><span class="main"><span>#</span></span><span>priority </span><span class="entity"><span>der'</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>true</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>derv</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>false</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"The priority of the deriver must be larger than its dependences."</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deriver_name_space</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Derivers.get</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>get_deriver</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.get</span><span> </span><span>o</span><span> </span><span>Derivers.get</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deriver_ops</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span> get_data </span><span class="main"><span>=</span></span><span> </span><span>Derivers.get</span><span class="main"><span>,</span></span><span> put_data </span><span class="main"><span>=</span></span><span> </span><span>Derivers.put</span><span> </span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_deriver</span></span><span> </span><span class="entity"><span>bind</span></span><span> </span><span class="entity"><span>derv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Entity.define</span><span> </span><span class="entity"><span>deriver_ops</span></span><span> </span><span class="entity"><span>bind</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chk_deriver</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>derv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>define_deriver_global</span></span><span> </span><span class="entity"><span>bind</span></span><span> </span><span class="entity"><span>derv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span>Entity.define_global</span><span> </span><span class="entity"><span>deriver_ops</span></span><span> </span><span class="entity"><span>bind</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chk_deriver</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Theory</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>derv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_deriver</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.check</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Derivers.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bind_derivers_on_patterns</span></span><span> </span><span class="entity"><span>pat_derivers</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Deriver_Bindings.map</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriver</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.beta_eta_contract</span><span> </span><span class="entity"><span>pat</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Net.insert_term</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriver</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat_derivers</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_deriver</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Deriver_Bindings.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Net.match_term</span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="entity"><span>term</span></span><span>
   </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriver</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Pattern.matches</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriver</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>get_deriver</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>deriver</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>priority </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>priority </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Unknown_Hint</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_deriver1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>match_deriver</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ret</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Unknown_Hint</span></span><span> </span><span class="entity"><span>term</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_deriving</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hints</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>derv_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>derv</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dervs</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>derivings</span></span><span class="main"><span>)</span></span><span class="main"><span>=</span></span><span>
  </span><span>Derivings.map_default</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>priority </span><span class="entity"><span>derv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>derv_name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>derv</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hints'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>der'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hints</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>hints'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>der'</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dervs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_deriving_from_hint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>derv_instr</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hint</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ders</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>derivings</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>add_deriving</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>derv_instr</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>match_deriver1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_imp_concl</span><span> </span><span class="entity"><span>hint</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ders</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_deriver_dependences</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>dervs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dervs</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_deriver_dependences</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>count_weak</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="entity"><span>dervs</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>derivers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deriver_name_space</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>dervs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dervs</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>dep</span></span><span class="main"><span>,</span></span><span class="entity"><span>is_weak</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>remain_deps</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dervs</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_weak</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="entity"><span>count_weak</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>dervs</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>derv</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name_Space.get</span><span> </span><span class="entity"><span>derivers</span></span><span> </span><span class="entity"><span>dep</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>priority </span><span class="entity"><span>derv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dep</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Derivings.lookup</span><span> </span><span class="entity"><span>dervs</span></span><span> </span><span class="entity"><span>key</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriver</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_weak'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_weak'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_weak'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_weak</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>dervs</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Derivings.update</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriver</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_weak'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_weak</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dervs</span></span><span>
                                    </span><span>|&gt;</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>dependences </span><span class="entity"><span>derv</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Derivings.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>derv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>is_weak</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dervs</span></span><span>
                                    </span><span>|&gt;</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>dependences </span><span class="entity"><span>derv</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>remain_deps</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="entity"><span>dervs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>complete_deriver_dependences</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>dervs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Derivings.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span class="entity"><span>derv</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>add_deriver_dependences</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span>forall</span><span> </span><span class="main"><span>(</span></span><span>is_none</span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hints</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>dependences </span><span class="entity"><span>derv</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dervs</span></span><span> </span><span class="entity"><span>dervs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span>ML_Antiquotation.value</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>φderiver</span><span>›</span></span></span><span>
    </span><span class="main"><span>(</span></span><span>Scan.peek</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Parse.name_position</span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>check_deriver</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span>
          </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>#</span></span><span>priority
          </span><span>|&gt;</span><span> </span><span>ML_Syntax.print_pair</span><span> </span><span>ML_Syntax.print_string</span><span> </span><span>ML_Syntax.print_int</span><span> </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(** Deriving **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>under_deriving_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Phi_Type.under_\&lt;phi&gt;deriving|attribute"><span>under_φderiving</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err_derive</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prop_name</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="entity"><span>hints</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>string_of</span><span> </span><span class="main"><span>(</span></span><span>chunks</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span>block</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Fail to derive the property "</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="entity"><span>prop_name</span></span><span class="main"><span>]</span></span><span> </span><span>::</span><span>
        </span><span class="entity"><span>msg</span></span><span> </span><span>@</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>hints</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"The guessed property may be wrong, and you may provide the \
                    \desired property form by ‹deriving ‹the property you want››."</span></span><span class="main"><span>]</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Phi_Reasoners.failure_reasons_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>para</span><span> </span><span class="inner_quoted"><span>"There are some potential reasons for the failure"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>derive_properties</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dervs</span></span><span class="main"><span>:</span></span><span class="entity"><span>derivings</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bundles</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phityp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy</span></span><span class="main"><span>:</span></span><span>local_theory</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.level</span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dervs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>complete_deriver_dependences</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dervs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span>
                  </span><span class="entity"><span>Phi_Reasoner.start_collecting_reasoners</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>all_derived_rules</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Context_Position.set_visible</span><span> </span><span>false</span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>open_proof_ctxt</span></span><span> </span><span class="entity"><span>bundles</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>under_deriving_ctxt</span></span><span> </span><span>true</span><span>
            </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Reasoners.report_failure_reason</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>thy</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Local_Theory.map_contexts</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>level</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>setup</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>dervs</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>Deriving_Hooks.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phityp</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dervs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dervs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>complete_deriver_dependences</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dervs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>thy</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Derivings.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>hints</span></span><span class="main"><span>,</span></span><span class="entity"><span>derv</span></span><span class="main"><span>,</span></span><span class="entity"><span>is_weak</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>Local_Theory.begin_nested</span><span>
               </span><span>|&gt;</span><span> </span><span>Context_Position.set_visible</span><span> </span><span>false</span><span>
               </span><span>|&gt;</span><span> </span><span class="main"><span>#</span></span><span>derive </span><span class="entity"><span>derv</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_weak</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hints</span></span><span> </span><span class="entity"><span>phityp</span></span><span>
               </span><span>|&gt;</span><span> </span><span>Local_Theory.end_nested</span><span>
          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err_derive</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>hints</span></span><span>
       </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dervs</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
</span><span class="comment1"><span>(*TODO: un-setup*)</span></span><span>
    </span><span class="comment1"><span>(*|&gt; Context.proof_map (
          Phi_Reasoner.stop_collecting_reasoners (the (snd @{reasoner_group %all_derived_rules})))*)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Derived Properties **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dp_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_pair3</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>eq_list</span><span> </span><span>pointer_eq</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Derived_Properties</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="comment1"><span>(*phityp*)</span></span><span> * </span><span>int</span><span> </span><span class="comment1"><span>(*index*)</span></span><span> * </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.merge</span><span> </span><span class="entity"><span>dp_eq</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_derived_properties</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Net.match_term</span><span> </span><span class="main"><span>(</span></span><span>Derived_Properties.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Pattern.equiv</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>th</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>short_name_of_tyop</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>short_name_of_tyop</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>short_name_of_tyop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>short_name_of_tyop</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>short_name_of_tyop</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>N</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>short_name_of_tyop</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>short_name_of_tyop</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Not a φ-type term"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>X</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>no_atp_attrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.attribute_global</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span><span class="hidden">\&lt;^</span><span class="control">theory</span><span class="hidden">&gt;</span></span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.no_atp|attribute"><span class="operator"><span>no_atp</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>note_properties'</span></span><span> </span><span class="entity"><span>no_atp</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>prefix</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>Th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>snd</span><span> </span><span>o</span><span> </span><span>Local_Theory.note</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_atp</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>attributes</span></span><span> </span><span class="main"><span>[</span></span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.no_atp|attribute"><span class="operator"><span>no_atp</span></span></a><span class="main"><span>]</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Th</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>notes</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>local_note_properties'</span></span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.cases</span><span> </span><span>Global_Theory.facts_of</span><span> </span><span>Proof_Context.facts_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varify_binding</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Binding.suffix_name</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.cases</span><span> </span><span>Sign.full_name</span><span> </span><span>Proof_Context.full_name</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b'</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Facts.defined</span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>iname</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>varify_binding</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>b</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>notes'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b'</span></span><span class="main"><span>,</span></span><span class="entity"><span>rules'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>varify_binding</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="entity"><span>prefix</span></span><span> </span><span class="entity"><span>b'</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>rules'</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>notes</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Context.mapping</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>oo</span><span> </span><span>Global_Theory.note_thms</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>notes'</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>oo</span><span> </span><span>Proof_Context.note_thms</span><span> </span><span class="inner_quoted"><span>""</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>notes'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>note_properties</span></span><span> </span><span class="entity"><span>no_atp</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>note_properties'</span></span><span> </span><span class="entity"><span>no_atp</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>note_properties_s</span></span><span> </span><span class="entity"><span>no_atp</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>note_properties</span></span><span> </span><span class="entity"><span>no_atp</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>pos </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>notes</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>local_note_properties</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>local_note_properties'</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>local_note_properties_s</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>notes</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>local_note_properties</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Binding.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>pos </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>notes</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>suffix_name_by_index</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>suffix</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"⇩"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_derived_properties</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_derived_properties</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Derived_Properties.map</span><span> </span><span class="main"><span>(</span></span><span>Net.insert_term</span><span> </span><span class="entity"><span>dp_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_derived_properties</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pps</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Phi_Reasoner.info_pretty_generic</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>block</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>suffix_name_by_index</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
               </span><span>chunks</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>item</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>p</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pps</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>register_derived_properties</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ind'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_derived_properties</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ind'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Bad Index"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>print_derived_properties</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
                                       </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ths</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>,</span></span><span>pervasive</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>,</span></span><span> pos</span><span class="main"><span>=</span></span><span class="entity"><span>pos</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>key</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Morphism.term</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ths'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.fact</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>ths</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Derived_Properties.map</span><span> </span><span class="main"><span>(</span></span><span>Net.insert_term</span><span> </span><span class="entity"><span>dp_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>key</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ths'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Phi_Type.\&lt;phi&gt;type_property|attribute"><span>φtype_property</span></span><span>›</span></span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Reasoner.attr_syntax</span></span><span>
    </span><span class="main"><span>(</span></span><span>Args.const</span><span> </span><span class="main"><span>{</span></span><span>proper </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> strict </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span> </span><span>--</span><span> </span><span>Scan.lift</span><span> </span><span>Parse.name</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_group</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop_name</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>group</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>φTA_property</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>raw_group</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.read_term_pattern</span><span> </span><span class="entity"><span>ctxt_parse</span></span><span> </span><span class="entity"><span>const</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_type_info</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>phi</span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No φ-type named "</span></span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt_parse</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" found"</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>add_derived_properties</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Reasoner.add_rule</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>group</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="inner_quoted"><span>"declares φtype properties"</span></span><span>

</span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(** Simple Checkers **)</span></span><span>

</span><span class="comment1"><span>(* Suggest some property should be derived *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_deriving_or_derived</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriver_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop_name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>derving</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriver_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriver</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_deriver</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriver_name</span></span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Derivings.defined</span><span> </span><span class="entity"><span>derving</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>priority </span><span class="entity"><span>deriver</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>deriver_name</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_derived_properties</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="entity"><span>prop_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>suggest_property_should_be_derived</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>warn</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>derving</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>phi_type</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriver_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop_name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>chk_deriving_or_derived</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriver_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>derving</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>warn</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>;</span></span><span>
        </span><span class="main"><span>(</span></span><span class="entity"><span>derving</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>derving</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(** Syntax **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>deriving_ast'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Derv_By_Name</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> xstring * Position.T
                       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Derv_By_Term</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>string * Position.T</span><span class="main"><span>)</span></span><span> * string list </span><span class="comment1"><span>(*arbi_ind_args*)</span></span><span class="main"><span>)</span></span><span> * Reasoner_Group.priority_syntax option
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>deriving_ast</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deriving_ast'</span></span><span>
                  * </span><span class="main"><span>(</span></span><span>Facts.ref</span><span> * </span><span>Token.src</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*notes*)</span></span><span>
                  * </span><span class="main"><span>(</span></span><span>xstring</span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*bundles used only in the deriving*)</span></span><span>
                  * </span><span class="entity"><span>Method.text_range</span></span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*tactic hint*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deriving_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.position</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span>Parse.group</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"name"</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Parse.short_ident</span><span> </span><span>||</span><span> </span><span>Parse.long_ident</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>one_deriving</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>deriving_name</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>Derv_By_Name</span></span><span>
                </span><span>||</span><span> </span><span class="main"><span>(</span></span><span>Parse.position</span><span> </span><span>Parse.term</span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>Reasoner_Group.parser</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span>
                      </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Derv_By_Term</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>set_ast_aia</span></span><span> </span><span class="entity"><span>aia</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Derv_By_Name</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>aia</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>Derv_By_Name</span></span><span> </span><span class="entity"><span>x</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"bad 'arbitrary' clause: no term annotation is given"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>set_ast_aia</span></span><span> </span><span class="entity"><span>aia</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Derv_By_Term</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gp</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Derv_By_Term</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span class="main"><span>,</span></span><span class="entity"><span>aia</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gp</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deriving_parser</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>deriving_ast</span></span><span> </span><span>list</span><span> </span><span>parser</span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>deriving</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.and_list</span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="entity"><span>one_deriving</span></span><span> </span><span>--</span><span>
            </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>notes</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.thms1</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>--</span><span>
            </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>opening</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Parse.name_position</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>--</span><span>
            </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"arbitrary"</span></span><span> </span><span>|--</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>:</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Parse.term</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>--</span><span>
            </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"tactic"</span></span><span> </span><span>|--</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>:</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>Method.parser</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span class="main"><span>)</span></span><span>
        </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set_ast_aia</span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>e</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>flat</span><span>

</span><span class="comment1"><span>(*
fun check_property_hint ctxt phi_typ_const hint =
  let val ctxt'0 = Proof_Context.set_mode Proof_Context.mode_pattern ctxt
      val ((x_term, T_term'), ctxt'1) = fix_phi_term_params phi_typ_const ctxt'0
      val ctxt' = fold Variable.declare_constraints [x_term,T_term'] ctxt'1
      val T_term = singleton (Variable.export_terms ctxt' ctxt) T_term'
                |&gt; Term.map_types (K Term.dummyT)
      fun get_arity ret <span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span>‹fun a T› = get_arity (a::ret) T
        | get_arity ret <span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span>‹bool› = ret
        | get_arity _ _ = error "The given hint is not an algebraic property."
      fun head_of (Const("_type_constraint_", _) $ X) = head_of X
        | head_of (Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹Trueprop›, _) $ X) = head_of X
        | head_of (Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹Pure.imp›, _) $ _ $ X) = head_of X
        | head_of (X $ _) = head_of X
        | head_of X = X
      val hint_arity = get_arity [] (Sign.the_const_type (Proof_Context.theory_of ctxt')
                                    (fst (raw_term_name_typ (head_of hint))))
      fun pad_term arity ((H as Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹Pure.imp›, _) $ _) $ X) =
            H $ pad_term arity X
        | pad_term arity (Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹Trueprop›, _) $ X) =
            pad_term arity X
        | pad_term arity term =
            let val i = Term.maxidx_of_term term + 1
                val k = Term.maxidx_of_term T_term + 1
                fun trim <span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span>‹fun _ ‹T as <span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span>‹fun _ _››› (X $ _) = trim T X
                  | trim _ X = X
                fun pad _ [] X = X
                  | pad j (T::tys) X =
                      pad (i+1) tys X $ trim T (Logic.incr_indexes ([],[], i+j*k) T_term)
                fun pass ar (X as (Const("_type_constraint_", _) $ _)) = pad 0 ar X
                  | pass (_::ar) (X $ Y) = pass ar X $ Y
                  | pass ar X = pad 0 ar X                
             in <span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span>‹Trueprop› $ pass arity term
            end
      val props = Syntax.check_props ctxt'0 [pad_term hint_arity hint]
      val ctxt'1 = fold Variable.add_fixes_implicit props (Variable.set_body false ctxt'0)
   in hd (Variable.export_terms ctxt'1 ctxt props)
  end*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_deriving_ast</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>derv_ast</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>deriving_ast</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_pattern</span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_text</span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span> </span><span class="entity"><span>Method.report</span></span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>Method.check_text</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>chk_bundles</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bundle.check</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>chk_notes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.get_fact</span><span> </span><span class="entity"><span>ctxt_parse</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span>
                           </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.attribute_cmd</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Derivings.empty</span><span>
   </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Derv_By_Name</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>notes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bundle</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>add_deriving</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>Option.map</span><span> </span><span class="entity"><span>chk_text</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>chk_notes</span></span><span> </span><span class="entity"><span>notes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>chk_bundles</span></span><span> </span><span class="entity"><span>bundle</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                          </span><span class="entity"><span>check_deriver</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Derv_By_Term</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arbi_ind_args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_group</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>notes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bundle</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.parse_prop</span><span> </span><span class="entity"><span>ctxt_parse</span></span><span> </span><span class="entity"><span>term</span></span><span>
                         </span><span>|&gt;</span><span> </span><span>Syntax.check_prop</span><span> </span><span class="entity"><span>ctxt_parse</span></span><span>
                         </span><span>|&gt;</span><span> </span><span>Envir.beta_eta_contract</span><span>
                         </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.refine_sorts_of_tm</span></span><span> </span><span class="entity"><span>thy</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.add_fixes_implicit</span><span> </span><span class="entity"><span>term'</span></span><span> </span><span class="main"><span>(</span></span><span>Variable.set_body</span><span> </span><span>false</span><span> </span><span class="entity"><span>ctxt_parse</span></span><span class="main"><span>)</span></span><span>
                          </span><span>|&gt;</span><span> </span><span>Variable.declare_term</span><span> </span><span class="entity"><span>term'</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>aia'0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.parse_term</span><span> </span><span class="entity"><span>ctxt'1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arbi_ind_args</span></span><span>
                       </span><span>|&gt;</span><span> </span><span>Syntax.check_terms</span><span> </span><span class="entity"><span>ctxt'1</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term'1</span></span><span>::</span><span class="entity"><span>aia'1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.export_terms</span><span> </span><span class="entity"><span>ctxt'1</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term'</span></span><span>::</span><span class="entity"><span>aia'0</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>group</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Reasoner_Group.check_group</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt'1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_group</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_deriving_from_hint</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term'1</span></span><span class="main"><span>,</span></span><span class="entity"><span>aia'1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span>Option.map</span><span> </span><span class="entity"><span>chk_text</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>,</span></span><span>
                                             </span><span class="entity"><span>chk_notes</span></span><span> </span><span class="entity"><span>notes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>chk_bundles</span></span><span> </span><span class="entity"><span>bundle</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
       </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>derv_ast</span></span><span>
   </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Unknown_Hint</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.chunks</span><span> </span><span class="main"><span>[</span></span><span>
          </span><span>Pretty.para</span><span> </span><span class="inner_quoted"><span>"Do not know how to derive from the given hint. There is no known deriver for it."</span></span><span class="main"><span>,</span></span><span>
          </span><span>Context.cases</span><span> </span><span>Syntax.pretty_term_global</span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span>
        </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Interfaces for Derivers **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ML_sender_locker</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.var</span><span> </span><span class="inner_quoted"><span>"φTA.ML_sender_locker"</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ML_sender</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>quiet</span></span><span> * </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>derive</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>Unsynchronized.ref</span><span>
  </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dependences_parse</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>requires</span></span><span>›</span></span></span><span> </span><span>|--</span><span>
                            </span><span>Parse.and_list</span><span> </span><span class="main"><span>(</span></span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>deriving_name</span></span><span> </span><span>--</span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>?</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>flat</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>patterns_parse</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>for</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.enum</span><span> </span><span class="inner_quoted"><span>"|"</span></span><span> </span><span>Parse.term</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span> </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>φproperty_deriver</span></span><span>›</span></span></span><span>
          </span><span class="inner_quoted"><span>"declare deriver deriving properties when defining a φ-type"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Parse.binding</span><span> </span><span>--</span><span> </span><span>Parse.int</span><span> </span><span>--</span><span> </span><span class="entity"><span>patterns_parse</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>dependences_parse</span></span><span>--</span><span> </span><span class="main"><span>(</span></span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>=</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.ML_source</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
 </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>raw_binding_terms</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>deps</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>ML'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Toplevel.theory</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> 
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>derive</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ML'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ML</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>"Phi_Type.ML_sender := SOME ("</span></span><span> </span><span>@</span><span>
                               </span><span>ML_Lex.read_source</span><span> </span><span class="entity"><span>ML</span></span><span> </span><span>@</span><span>
                               </span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Synchronized.change_result</span><span> </span><span class="entity"><span>ML_sender_locker</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>ML_Context.expression</span><span> </span><span class="main"><span>(</span></span><span>Input.pos_of</span><span> </span><span class="entity"><span>ML</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>expr</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Theory</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>ML_sender</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ML_sender</span></span><span> </span><span>:=</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>deriver</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
          priority </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span>
          dependences </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span class="entity"><span>check_deriver</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Theory</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deps</span></span><span class="main"><span>,</span></span><span>
          derive </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>derive</span></span><span>
        </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>deriver</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_pattern</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.init_global</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binding_props</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.parse_prop</span><span> </span><span class="entity"><span>ctxt_parser</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_binding_terms</span></span><span>
                        </span><span>|&gt;</span><span> </span><span>Syntax.check_props</span><span> </span><span class="entity"><span>ctxt_parser</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>define_deriver_global</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>deriver</span></span><span> </span><span class="entity"><span>thy</span></span><span>
    </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>der_name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>
              </span><span class="entity"><span>bind_derivers_on_patterns</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="entity"><span>der_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>binding_props</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
   </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(** Parameter Equality **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Default_Equality</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Type_Pattern_Store</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parameter_equality</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>export</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_eq_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Default_Equality.get_uniq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>typ</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Phi_Syntax.is_phi_type_ty</span></span><span> </span><span class="entity"><span>typ</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>PE_Synt</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>PE_Guard</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span>  </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>4</span></span><span> </span><span class="entity"><span>ret</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parameter_equality</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"guard"</span></span><span>  </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>PE_Guard</span></span><span>
                      </span><span>||</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"id"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>PE_Synt</span></span><span>
                      </span><span>||</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"obligation"</span></span><span>  </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>PE_Proof</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parameter_equality'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>parameter_equality</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>(</span></span><span>›</span></span></span><span> </span><span>|--</span><span>
        </span><span>Parse.list1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>parameter_equality</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>SOME</span><span> </span><span>||</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span>  </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>)</span></span><span>›</span></span></span><span> </span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="entity"><span>Default_Equality.setup_decl_attr</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="Phi_Type.\&lt;phi&gt;parameter_default_equality|attribute"><span>φparameter_default_equality</span></span><span>›</span></span></span><span>
          </span><span class="entity"><span>parameter_equality</span></span><span> </span><span class="entity"><span>parameter_equality</span></span><span>
          </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span>o</span><span> </span><span>Syntax.read_typ</span><span class="main"><span>)</span></span><span>
          </span><span class="inner_quoted"><span>"declaring the default equality of φ-type parameters under a certain type"</span></span><span>
</span><span class="comment1"><span>(*
   #&gt; Default_Equality.setup_decl_ML_attr <span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span>‹φparameter_default_equality_ML›
          Syntax.read_typ
          "declaring the default equality of φ-type parameters under a certain type" *)</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(** Ad-hoc derivation **)</span></span><span>

</span><span class="comment1"><span>(*
val to_cond_rewr = @{lemma ‹
        (A ≡ B) ≡ Trueprop (𝖼𝗈𝗇𝖽𝗂𝗍𝗂𝗈𝗇 A = B)
  › by (simp add: atomize_eq Premise_def) }
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule_refl1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>‹
        </span><span class="free"><span>T</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span>U</span></span><span>
    </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>⦂</span></a></span><span> </span><span class="free"><span>T</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.SimpleTransformation|const"><span>𝗍𝗋𝖺𝗇𝗌𝖿𝗈𝗋𝗆𝗌</span></a></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>⦂</span></a></span><span> </span><span class="free"><span>U</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>@tag</span></a></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;T&gt;\&lt;P&gt;|const"><span>𝒯𝒫</span></a><span>
  ›</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span>:</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag_def|fact"><span>Action_Tag_def</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.transformation_refl|fact"><span>transformation_refl</span></a><span class="main"><span>)</span></span><span> </span><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule_refl_WR</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>‹
        </span><span class="free"><span>T</span></span><span> </span><span class="main"><span>≡</span></span><span> </span><span class="free"><span>T'</span></span><span>
    </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>⦂</span></a></span><span> </span><span class="free"><span>T</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Prod&apos;|const"><span>✼</span></a></span><span> </span><span class="free"><span>U</span></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.SimpleTransformation|const"><span>𝗍𝗋𝖺𝗇𝗌𝖿𝗈𝗋𝗆𝗌</span></a></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>x</span></span><span class="main"><span>,</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_Preliminary.html#Phi_Preliminary.unspec|const"><span>unspec</span></a><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>⦂</span></a></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>T'</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Prod|const"><span>∗</span></a></span><span> </span><span class="free"><span>U</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Prod&apos;|const"><span>✼</span></a></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;None|const"><span>○</span></a></span><span> </span><span class="keyword1"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>@tag</span></a></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;T&gt;\&lt;P&gt;&apos;|const"><span>𝒯𝒫'</span></a><span>
  ›</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><span class="operator"><span>simp</span></span><span> </span><span class="quasi_keyword"><span>add</span></span><span class="main"><span>:</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag_def|fact"><span>Action_Tag_def</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.transformation_refl|fact"><span>transformation_refl</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Prod&apos;_def|fact"><span>φProd'_def</span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Prod_expn&apos;|fact"><span>φProd_expn'</span></a><span class="main"><span>)</span></span><span> </span><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_refl_Tr</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cong</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.no_prems</span><span> </span><span class="entity"><span>cong</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rev_param_tys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m_ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Syntax.dest_parameterized_phi_ty</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="entity"><span>rev_param_tys</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maxidx_of_term</span><span> </span><span class="entity"><span>term</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>idx</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span>Var</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"A"</span></span><span class="main"><span>,</span></span><span class="entity"><span>idx</span></span><span>+</span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="entity"><span>param_tys</span></span><span> </span><span class="entity"><span>term</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span>+</span><span> </span><span>length</span><span> </span><span class="entity"><span>rev_param_tys</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span>Var</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"A"</span></span><span class="main"><span>,</span></span><span class="entity"><span>idx</span></span><span>+</span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="entity"><span>param_tys</span></span><span> </span><span class="entity"><span>term</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span>+</span><span> </span><span>length</span><span> </span><span class="entity"><span>rev_param_tys</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"a"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Algebras.html#Algebras.sep_magma|class"><span>sep_magma</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>TVar</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"b"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">sort</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Algebras.html#Algebras.sep_magma|class"><span>sep_magma</span></a><span>›</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cong</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cong</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_pat</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span>
            </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.Transformation|const"><span>Transformation</span></a><span> </span><span class="entity"><span class="entity"><span>m_ty</span></span></span><span>›</span></span><span>
                </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>φType</span></a><span> </span><span class="entity"><span class="entity"><span>x</span></span></span><span> </span><span class="entity"><span class="entity"><span>m_ty</span></span></span><span>›</span></span><span> </span><span>$</span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"x"</span></span><span class="main"><span>,</span></span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
                </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>φType</span></a><span> </span><span class="entity"><span class="entity"><span>y</span></span></span><span> </span><span class="entity"><span class="entity"><span>m_ty</span></span></span><span>›</span></span><span> </span><span>$</span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"var_y"</span></span><span class="main"><span>,</span></span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>U</span></span><span class="main"><span>)</span></span><span>
                </span><span>$</span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"P"</span></span><span class="main"><span>,</span></span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>)</span></span><span>
            </span><span>$</span><span> </span><span class="entity"><span>tag</span></span><span class="main"><span>)</span></span><span>

   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>ToA_derv_unify_refl</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
       </span><span class="entity"><span>mk_pat</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>U</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;T&gt;\&lt;P&gt;|const"><span>𝒯𝒫</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
       </span><span class="entity"><span>cong</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule_refl1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
      </span><span class="main"><span>(</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>ToA_derv_unify_refl</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span>
          </span><span class="entity"><span>mk_pat</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>a</span></span><span>›</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Prod&apos;|const"><span>φProd'</span></a><span> </span><span class="entity"><span class="entity"><span>x</span></span></span><span> </span><span class="entity"><span class="entity"><span class="entity"><span>m_ty</span></span></span></span><span> </span><span class="entity"><span class="entity"><span>a</span></span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span>
                                    </span><span>$</span><span> </span><span>Var</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"W"</span></span><span class="main"><span>,</span></span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Phi_Syntax.mk_phi_type_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod|type"><span>prod</span></a><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>b</span></span><span>›</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Prod&apos;|const"><span>φProd'</span></a><span> </span><span class="entity"><span class="entity"><span>x</span></span></span><span> </span><span class="entity"><span class="entity"><span class="entity"><span>m_ty</span></span></span></span><span> </span><span class="entity"><span class="entity"><span>b</span></span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>U</span></span><span>
                                    </span><span>$</span><span> </span><span>Var</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"R"</span></span><span class="main"><span>,</span></span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Phi_Syntax.mk_phi_type_ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>m_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;T&gt;\&lt;P&gt;&apos;|const"><span>𝒯𝒫'</span></a><span>›</span></span><span class="main"><span>,</span></span><span>
         </span><span class="entity"><span>cong</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule_refl_WR</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*** φ-Type Definition ***)</span></span><span>

</span><span class="comment1"><span>(** Tools **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>identical_name</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="entity"><span>N'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>identical_name</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span class="main"><span>(</span></span><span class="entity"><span>N'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>identical_name</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Var</span><span class="main"><span>(</span></span><span class="entity"><span>N'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>identical_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>identical_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>identical_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A'</span></span><span class="main"><span>,</span></span><span class="entity"><span>B'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>identical_name</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>identical_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>identical_name</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>i'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>i'</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>identical_name</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_term_of_phi</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>identical_name</span></span><span> </span><span class="main"><span>(</span></span><span>Term.head_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assert_Type_Opr</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Phi_Syntax.is_nonnull_Type_Opr</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Not a φ-type operator!"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_first_parameter_a_type</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>dest_parameterized_phi_ty</span></span><span> </span><span class="entity"><span>ty</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty'</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>dest_parameterized_phi_ty</span></span><span> </span><span class="entity"><span>ty'</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TYPE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assert_first_parameter_is_type</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_first_parameter_a_type</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Not a φ-type operator!"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>prev</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Arg</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> term </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Abst</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> string * typ
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assemble</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Arg</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>a</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>assemble</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Abst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>name_of</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name_of</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>name_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"A"</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="comment1"><span>(*in the reversed order*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_separate_tyopr_and_its_typ_param</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>FT_term</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prevs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bvtys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>F</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvtys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                 </span><span class="entity"><span>F</span></span><span>
              </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>prevs</span></span><span class="main"><span>)</span></span><span> </span><span>?</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>F</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="main"><span>(</span></span><span class="entity"><span>F</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="entity"><span>lv</span></span><span class="main"><span>)</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="entity"><span>assemble</span></span><span> </span><span class="entity"><span>prevs</span></span><span> 
                   </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"T"</span></span><span class="main"><span>,</span></span><span> </span><span>Term.fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvtys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Arg</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>prevs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bvtys</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>F</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Arg</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>prevs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bvtys</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>F</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prevs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bvtys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lv</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>prevs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span>::</span><span class="entity"><span>bvtys</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.empty</span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bvtys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Help.beta_eta_contract_term</span></span><span> </span><span class="entity"><span>FT_term</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_separate_tyopr_and_its_typ_params</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prevs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>F</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lv</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name_of</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Arg</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lv</span></span><span> </span><span>+</span><span> </span><span>length</span><span> </span><span class="entity"><span>bvs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>prevs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>F</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Arg</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>prevs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>F</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prevs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lv</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Abst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>prevs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prevs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>assemble</span></span><span> </span><span class="entity"><span>prevs</span></span><span> </span><span class="entity"><span>X</span></span><span>
                                     </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvs</span></span><span>
                                     </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract_term</span></span><span>
                                     </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>Ts</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>split</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>separate_tyopr_and_its_typ_param_safe</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>gen_separate_tyopr_and_its_typ_param</span></span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span class="entity"><span>dest_parameterized_phi_ty</span></span><span> </span><span>o</span><span> </span><span>Term.fastype_of1</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>separate_tyopr_and_its_non_parameterized_typ_params</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>gen_separate_tyopr_and_its_typ_params</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Syntax.is_non_parameterized_phityp</span></span><span> </span><span>o</span><span> </span><span>Term.fastype_of1</span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>separate_tyopr_and_its_typ_params</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>gen_separate_tyopr_and_its_typ_params</span></span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span class="entity"><span>dest_parameterized_phi_ty</span></span><span> </span><span>o</span><span> </span><span>Term.fastype_of1</span><span> </span><span>o</span><span> </span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>separate_tyopr_and_its_non_parameterized_typ_param_safe</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>gen_separate_tyopr_and_its_typ_param</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Syntax.is_non_parameterized_phityp</span></span><span> </span><span>o</span><span> </span><span>Term.fastype_of1</span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>separate_module_tyopr</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>F</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>c</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>dest_parameterized_phi_ty</span></span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvtys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                             </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span class="entity"><span>dest_parameterized_phi_ty</span></span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvtys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>F</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>separate_scalar_tyopr</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>F</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>c</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvtys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvtys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>dest_parameterized_phi_ty</span></span><span> </span><span class="entity"><span>ty_T</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
                     </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span class="entity"><span>dest_parameterized_phi_ty</span></span><span> </span><span class="entity"><span>ty_c</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract_term</span></span><span> </span><span class="main"><span>(</span></span><span>
                                  </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"𝗌"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty_c</span></span><span class="main"><span>,</span></span><span> </span><span>Term.incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>F</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>$</span><span> </span><span>Term.incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>F</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>can</span><span> </span><span class="entity"><span>dest_parameterized_phi_ty</span></span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvtys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
                      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>F</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

</span><span class="comment1"><span>(*
fun separate_tyop_semimodule_and_its_non_parameterized bvtys tm =
     gen_separate_tyopr_and_its_typ_param (Phi_Syntax.is_non_parameterized_phityp o Term.fastype_of1) bvtys tm
  |&gt; maps (fn (T, Fc) =&gt;
        gen_separate_tyopr_and_its_typ_param (K true) bvtys Fc
          |&gt; map (fn (c, F) =&gt; (T, c, F)))
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>warn_separate_type_operator</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>FT_term</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>FT_term</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                  </span><span class="main"><span>[</span></span><span>block</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Fail to parse"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                          </span><span>str</span><span> </span><span class="main"><span>(</span></span><span>Term.term_name</span><span> </span><span class="main"><span>(</span></span><span>Term.head_of</span><span> </span><span class="entity"><span>FT_term</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                          </span><span>str</span><span> </span><span class="inner_quoted"><span>"as a type operator."</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.cons</span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>L</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>separate_tyopr_and_its_typ_param</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>warn_separate_type_operator</span></span><span> </span><span class="entity"><span>separate_tyopr_and_its_typ_param_safe</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>separate_tyopr_and_its_non_parameterized_typ_param</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>warn_separate_type_operator</span></span><span> </span><span class="entity"><span>separate_tyopr_and_its_non_parameterized_typ_param_safe</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_zero_index_thm</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.maxidx_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>&lt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Internal bug: not zero-indexed!"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_zero_index_term</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.maxidx_of_term</span><span> </span><span class="entity"><span>term</span></span><span> </span><span>&lt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>term</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Internal bug: not zero-indexed!"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normalize</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Drule.zero_var_indexes</span><span>



   





</span><span class="comment1"><span>(*val search_CSTR_rules = Config.declare_bool ("search_CSTR_rules", ⌂) (K false)*)</span></span><span>

</span><span class="comment1"><span>(** Main **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Defining_Phi_Type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hooks</span></span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>phi_type</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>local_theory</span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>refine_typeq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma</span></span><span> </span><span class="quoted"><span>‹</span><span class="main"><span>(</span></span><span class="main"><span>⋀</span></span><span class="bound"><span>x</span></span><span class="main"><span>.</span></span><span> </span><span class="main"><span>(</span></span><span class="bound"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>⦂</span></a></span><span> </span><span class="free"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="main"><span>(</span></span><span class="bound"><span>x</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>⦂</span></a></span><span> </span><span class="free"><span>U</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>T</span></span><span> </span><span class="main"><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>=</span></a></span><span> </span><span class="free"><span>U</span></span><span>›</span></span><span> </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="main"><span>(</span></span><a class="entity_ref" href="../../../../../../../../HOL/HOL/ISABELLE_HOME/src/Provers/classical.ML.html#HOL.rule|method"><span class="operator"><span>rule</span></span></a><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type_eqI|fact"><span>φType_eqI</span></a><span class="main"><span class="keyword3"><span>,</span></span></span><span> </span><span class="operator"><span>simp</span></span><span class="main"><span>)</span></span><span class="antiquote"><span>}</span></span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>LHS_of</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>LHS</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LHS</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>LHS_of</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>LHS</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LHS</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>LHS_of</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LHS_of</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>LHS_of</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.implies|const"><span>HOL.implies</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LHS_of</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>LHS_of</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Not an equation"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>X</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*for mutating params {p<span class="hidden">⇩</span><sub>i</sub>}
 ‹  condition p<span class="hidden">⇩</span><sub>1</sub> = p<span class="hidden">⇩</span><sub>1</sub>'
⟹ condition p<span class="hidden">⇩</span><sub>2</sub> = p<span class="hidden">⇩</span><sub>2</sub>'
⟹ …
⟹ condition p<span class="hidden">⇩</span><sub>n</sub> = p<span class="hidden">⇩</span><sub>n</sub>'
⟹ T p<span class="hidden">⇩</span><sub>1</sub> p<span class="hidden">⇩</span><sub>2</sub> … p<span class="hidden">⇩</span><sub>n</sub> = T p<span class="hidden">⇩</span><sub>1</sub>' p<span class="hidden">⇩</span><sub>2</sub>' … p<span class="hidden">⇩</span><sub>n</sub>' ›
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_mutating_param_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>params </span><span class="entity"><span>phi</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rev_param_tys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m_ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>dest_parameterized_phi_ty</span></span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="entity"><span>rev_param_tys</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maxidx_of_term</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pp's</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>param</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="inner_quoted"><span>"A"</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>param</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>can_be_mutating</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>#</span></span><span>mutating </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>param</span></span><span class="main"><span>)</span></span><span>
                                              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span>false</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span>
                                               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
                   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span>+</span><span class="entity"><span>d</span></span><span>+</span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>param</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>can_be_mutating</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Var</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span>+</span><span class="entity"><span>d</span></span><span>+</span><span class="entity"><span>d</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>param</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>param_tys</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>pp's</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>=</span></span><span> </span><span>list_comb</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pp's</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>base_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="quoted"><span>‹</span><span class="entity"><span class="entity"><span>mk_phi_type_ty</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span class="entity"><span>m_ty</span></span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span class="entity"><span>x_ty</span></span></span><span class="main"><span>)</span></span><span>›</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prem_eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>p'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>
                              </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise|const"><span>Premise</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>mode</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>
                                </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="quoted"><span>‹</span><span>Term.fastype_of</span><span> </span><span class="entity"><span class="entity"><span>p</span></span></span><span>›</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>p</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>p'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pp's</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>P</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prem_eqs</span></span><span> </span><span class="entity"><span>base_eq</span></span><span>
              </span><span>|&gt;</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span>|&gt;</span><span> </span><span>Goal.init</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>goal'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import</span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>goal</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.safe_asm_lr_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>
                        </span><span>Simplifier.clear_simpset</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms'</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise_def|fact"><span>Premise_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>goal'</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.no_prems</span><span> </span><span class="entity"><span>ret</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Goal.conclude</span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"BUG OOcP1KyCRTmJj4WTzbQWrA"</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"BUG OOcP1KyCRTmJj4WTzbQWrA"</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*ctxt: the context used to derive properties*)</span></span><span>
</span><span class="comment1"><span>(*term: the term of the phi type, can be parameterized by fixed free variables like those in locales *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_type</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>no_auto</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dervs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bundles</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>equality</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>open_proof_ctxt</span></span><span> </span><span class="entity"><span>bundles</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span>delsimps</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms'</span></span><span> </span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Nat.html#Nat.One_nat_def|fact"><span>One_nat_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_zero_index_term</span></span><span> </span><span class="entity"><span>term</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_head</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.aconv_untyped</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>match_head</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="entity"><span>f</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>match_head</span></span><span> </span><span class="entity"><span>head</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.aconv_untyped</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_idx_in_def_eqs</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>φType</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>match_head</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>match_head</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lhs</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"The given term "</span></span><span> </span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" \
                              \is not defined inside the given definition"</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>i</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx_in_def_eqs</span></span><span> </span><span class="main"><span>=</span></span><span>
           </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>DIRECT_DEF</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>get_idx_in_def_eqs</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>LHS_of</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>WFREC_DEF</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>get_idx_in_def_eqs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fs </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter_relevant_eqs</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>match_head</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>LHS_of</span></span><span> </span><span>o</span><span> </span><span>Thm.concl_of</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>DIRECT_DEF</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>eq</span></span><span class="main"><span>]</span></span><span>
                    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>WFREC_DEF</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>#</span></span><span>simps </span><span class="entity"><span>info</span></span><span>
                           </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>filter_relevant_eqs</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>eqs</span></span><span>
                            </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="inner_quoted"><span>"Termination of the definition is not proven. \
                                               \Use partial simplification and induction rules."</span></span><span class="main"><span>;</span></span><span>
                                       </span><span class="entity"><span>filter_relevant_eqs</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>psimps </span><span class="entity"><span>info</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>conv_def_to_equation</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                   </span><span>#&gt;</span><span> </span><span class="entity"><span>normalize</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"At least one definitional equation has to be given"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tagged_eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_premise_tag</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typeqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>refine_typeq</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fixed_num</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>strip_comb</span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>LHS_of</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>φType</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                  </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>N</span></span><span>
                                        </span><span class="main"><span>|</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>N</span></span><span>
                                        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
                                      </span><span class="main"><span>(</span></span><span>List.drop</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span>strip_comb</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixed_num</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"BUG"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span>
                      </span><span>|&gt;</span><span> </span><span>foldl1</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span>map2</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>merge_options</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rev_param_tys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x_ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m_ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Syntax.dest_parameterized_phi_ty</span></span><span> </span><span class="main"><span>(</span></span><span>fastype_of</span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span>
            </span><span class="comment1"><span>(*case LHS_of (Thm.concl_of (hd eqs))
               of Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹φType›, <span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span>‹fun _ <span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span>‹fun ty _››) $ _ $ _
                    =&gt; Phi_Syntax.dest_parameterized_phi_ty ty
                | _ =&gt; error "BUG" *)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_tys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>rev</span><span> </span><span class="entity"><span>rev_param_tys</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tagged_eqs_in_type</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Conv.hhf_concl_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>Phi_Conv.embed_BI_assertion_into_phi_type</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctms</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
                </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.chunks</span><span> </span><span class="main"><span>(</span></span><span>
                    </span><span>Pretty.str</span><span> </span><span class="entity"><span>s</span></span><span> </span><span>::</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Thm.term_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctms</span></span><span>
                    </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"As a consequence, fail to generate some of the ‹open_abstraction›\
                                  \ ‹make_abstraction› ‹elim_SE› rules"</span></span><span class="main"><span>]</span></span><span>
                  </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctms</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tagged_eqs</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_recursive</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>eq</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>RHS</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>=&gt;</span></span><span> </span><span>exists_subterm</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>match_head</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RHS</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Internal bug #fc2042c3-0c46-4ae5-a66e-9697639068a0"</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mutating_params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_names</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>eq</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>LHS</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>RHS</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>LHS</span></span><span>
                                                </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>φType</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.strip_comb</span><span> </span><span class="entity"><span>T</span></span><span>
                                                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"BUG"</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.drop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixed_num</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.strip_comb</span><span> </span><span class="entity"><span>X</span></span><span>
                                  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>params'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rets</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
                                        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>param</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>param'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span>:=</span><span> </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="main"><span>;</span></span><span>
                                        </span><span class="entity"><span>chk_eq</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>params'</span></span><span> </span><span class="entity"><span>rets</span></span><span>
                                      </span><span class="main"><span>)</span></span><span>
                                    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_eq</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                                    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rets</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
                                        </span><span class="entity"><span>ret</span></span><span> </span><span>:=</span><span> </span><span>NONE</span><span> </span><span class="main"><span>;</span></span><span>
                                        </span><span class="entity"><span>chk_eq</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>rets</span></span><span>
                                      </span><span class="main"><span>)</span></span><span>
                               </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>identical_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>head</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>head'</span></span><span class="main"><span>)</span></span><span>
                                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.drop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>params'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixed_num</span></span><span class="main"><span>)</span></span><span>
                                        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chk_eq</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>params'</span></span><span> </span><span class="entity"><span>mutating_params</span></span><span> </span><span class="main"><span>;</span></span><span> </span><span>List.app</span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>params'</span></span><span class="main"><span>)</span></span><span>
                                       </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>List.app</span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>params'</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>X</span></span><span>
                           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>RHS</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Internal bug #fc2042c3-0c46-4ae5-a66e-9697639068a0"</span></span><span>
            </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eqs</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mutating_params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>!</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mutating_params</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span>true</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mutating_params</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.para</span><span>
                     </span><span class="inner_quoted"><span>"You are defining a recursive φ-type of mutating parameters : \
                     \the parameters varify throughout the recursion. The current version of \
                     \φtype derivers supports it poorly. When the parameters vary, computations\
                     \ on the parameters are introduced inevitably, bringing various syntactic \
                     \expressions of the parameters. However, parameter is a \
                     \part of φ-type where syntactic form is significant in guiding the reasoning,\
                     \ so no simplification will be applied to evaluate the computation and to\
                     \ relate two different syntactical forms of an identical φ-type, may causing\
                     \ the deriver fails to apply the correct rule as it fails to recognize syntacitc\
                     \ variants of the φ-type. \
                     \ Instead, we suggest to split the mutating-parameterized definition into\
                     \ two where the first one is recursive with all the parameters in the object\
                     \ side and the second is non-recursive and moves the parameters from the object\
                     \ side to the right place."</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>equality</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>length</span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>param_tys</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Incorrect number of parameter variabilities, which must equal the number of the φ-type parameters"</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_eq_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>default_eq_of</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>equality</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>equality</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                   </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>K</span><span> </span><span class="entity"><span>v</span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>default_eq_of</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>param_tys</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>default_eq_of</span></span><span> </span><span class="entity"><span>param_tys</span></span><span>
                          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoner.info_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                                    </span><span>block</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Inferred"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>keyword1</span><span> </span><span class="inner_quoted"><span>"parameter_equality"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="inner_quoted"><span>"("</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
                                           </span><span>commas</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>pretty_parameter_equality</span></span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>eqs</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>map3</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>mut</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                     </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>=</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> mutating</span><span class="main"><span>=</span></span><span class="entity"><span>mut</span></span><span class="main"><span>,</span></span><span> equality</span><span class="main"><span>=</span></span><span class="entity"><span>var</span></span><span class="main"><span>}</span></span><span>
                   </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param_names</span></span><span> </span><span class="entity"><span>mutating_params</span></span><span> </span><span class="entity"><span>equality</span></span><span>
      
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cong</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="inner_quoted"><span>"A"</span></span><span> </span><span>o</span><span> </span><span class="main"><span>#</span></span><span>name</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PE_Synt</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>names</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>names</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_names'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>equality</span></span><span> </span><span class="entity"><span>param_names</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>burrow</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>burrow</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PE_Synt</span></span><span>  </span><span>::</span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>names'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span>  </span><span>::</span><span> </span><span class="entity"><span>burrow</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>names'</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>burrow</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>names'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>burrow</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>names</span></span><span> </span><span class="entity"><span>names'</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>param_names'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>burrow</span></span><span> </span><span class="entity"><span>equality</span></span><span> </span><span class="entity"><span>param_names</span></span><span> </span><span class="entity"><span>param_names'</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_names</span></span><span>  </span><span>~~</span><span> </span><span class="entity"><span>param_tys</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>params'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param_names'</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>param_tys</span></span><span class="main"><span>)</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_conds</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_conds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PE_Guard</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>params'</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.Trueprop</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>
                      </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise|const"><span>Premise</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.MODE_GUARD|const"><span>MODE_GUARD</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="quoted"><span>‹</span><span>fastype_of</span><span> </span><span class="entity"><span class="entity"><span>param</span></span></span><span>›</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>param</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>param'</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>mk_conds</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>params'</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_conds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PE_Proof</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param'</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>params'</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.Trueprop</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>
                      </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise|const"><span>Premise</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.default|const"><span>default</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span> </span><span class="quoted"><span>‹</span><span>fastype_of</span><span> </span><span class="entity"><span class="entity"><span>param</span></span></span><span>›</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>param</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>param'</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>mk_conds</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>params'</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_conds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PE_Synt</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>params'</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_conds</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>params'</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>conds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_conds</span></span><span> </span><span class="entity"><span>equality</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>params'</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>LHS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>param</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>param</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span>  </span><span class="entity"><span>term</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>RHS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>param</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>param</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params'</span></span><span> </span><span class="entity"><span>term</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span> </span><span class="quoted"><span>‹</span><span>fastype_of</span><span> </span><span class="entity"><span class="entity"><span>LHS</span></span></span><span>›</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>LHS</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>RHS</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>goal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>cond</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>cond</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>conds</span></span><span> </span><span class="entity"><span>concl</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>goal</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import_terms</span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>goal</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>goal</span></span><span>
         </span><span>|&gt;</span><span> </span><span>Goal.init</span><span>
         </span><span>|&gt;</span><span> </span><span>Conv.gconv_rule</span><span> </span><span class="main"><span>(</span></span><span>
              </span><span class="entity"><span>Phi_Conv.hhf_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>HOLogic.Trueprop_conv</span></span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise_def|fact"><span>Premise_def</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>Conv.all_conv</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
         </span><span>|&gt;</span><span> </span><span>SINGLE</span><span> </span><span class="main"><span>(</span></span><span>SOLVED'</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.asm_simp_tac</span></span><span> </span><span class="main"><span>(</span></span><span>Simplifier.clear_simpset</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Goal.conclude</span><span> </span><span class="entity"><span>ret</span></span><span>
                         </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"BUG"</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>refl_Tr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_refl_Tr</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>cong</span></span><span>


      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ind</span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>def</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>DIRECT_DEF</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>WFREC_DEF</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>#</span></span><span>inducts </span><span class="entity"><span>info</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>List.nth</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx_in_def_eqs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>List.nth</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pinducts </span><span class="entity"><span>info</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx_in_def_eqs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
               </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_premise_tag</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                            </span><span>#&gt;</span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract</span></span><span>
                            </span><span>#&gt;</span><span> </span><span>Drule.zero_var_indexes</span><span> </span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cases</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>def</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>DIRECT_DEF</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>WFREC_DEF</span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>List.nth</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>cases </span><span class="entity"><span>info</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>idx_in_def_eqs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(*I am a fool
      val cases_ToA = mk_cases_rule eqs mk_cases_ToA cases_origin term ctxt
      val cases_VS = SOME (mk_cases_rule eqs mk_cases_shift cases_origin term ctxt)
                     handle Unavailable =&gt; NONE*)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idxes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.tabulate</span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>tagged_eqs_in_type</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_number</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/Nat.html#Nat.nat|type"><span>nat</span></a><span>›</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tagged_eqs_in_type_idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span>I</span><span> </span><span class="entity"><span>tagged_eqs_in_type</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_from_eqs</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                       </span><span>|&gt;</span><span> </span><span class="entity"><span>f</span></span><span>
                       </span><span>|&gt;</span><span> </span><span class="entity"><span>normalize</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eq</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_from_tagged_eq_in_type</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                            </span><span>|&gt;</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>i</span></span><span>
                            </span><span>|&gt;</span><span> </span><span class="entity"><span>normalize</span></span><span>
                            </span><span>|&gt;</span><span> </span><span>SOME</span><span>
                         </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tagged_eqs_in_type_idx</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_from_tagged_2eq_in_type</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                            </span><span>|&gt;</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>i</span></span><span>
                            </span><span>|&gt;</span><span> </span><span class="entity"><span>normalize</span></span><span>
                            </span><span>|&gt;</span><span> </span><span>SOME</span><span>
                         </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tagged_eqs_in_type_idx</span></span><span>

    </span><span class="comment1"><span>(*fun LHS_obj_is_var thm =
        case Thm.concl_of thm
          of <span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span>‹Trueprop› $ (Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹HOL.eq›, _) $ (Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹φType›, _) $ x $ _) $ _) =&gt; is_Var x
           | _ =&gt; error ("BUG: the generated equations is malformed")*)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intro_ToA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>gen_from_eqs</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;intro_transformation|fact"><span>φintro_transformation</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>I</span><span> </span><span class="entity"><span>tagged_eqs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intro_reasoning</span></span><span>   </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>gen_from_eqs</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;intro_reasoning_transformation|fact"><span>φintro_reasoning_transformation</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>I</span><span> </span><span class="entity"><span>tagged_eqs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intro_reasoning_R</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>gen_from_eqs</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;intro&apos;_reasoning_transformation|fact"><span>φintro'_reasoning_transformation</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>I</span><span> </span><span class="entity"><span>tagged_eqs</span></span><span>
                                                      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="comment1"><span>(*in case of not a separation magma*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intro'R_reasoning</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
            </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>normalize</span></span><span> </span><span>oo</span><span> </span><span class="main"><span>(</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>tyeq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tyeq</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;intro&apos;_reasoning_transformation_ty|fact"><span>φintro'_reasoning_transformation_ty</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span>      </span><span class="main"><span>=&gt;</span></span><span>   </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;intro&apos;_reasoning_transformation|fact"><span>φintro'_reasoning_transformation</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tagged_eqs</span></span><span> </span><span class="entity"><span>tagged_eqs_in_type</span></span><span>
            </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="comment1"><span>(*in case of not a separation magma*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>intro_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>gen_from_tagged_2eq_in_type</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;intro_ToA_Mapper_template_SE|fact"><span>φintro_ToA_Mapper_template_SE</span></a><span class="antiquote"><span>}</span></span></span></span><span>
                                           </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Conv.gconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elim_ToA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>gen_from_eqs</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;elim_transformation|fact"><span>φelim_transformation</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>I</span><span> </span><span class="entity"><span>tagged_eqs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elim_reasoning</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>gen_from_eqs</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;elim_reasoning_transformation|fact"><span>φelim_reasoning_transformation</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>I</span><span> </span><span class="entity"><span>tagged_eqs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elim'SE_ToA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>gen_from_tagged_eq_in_type</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;elim&apos;SEi_transformation|fact"><span>φelim'SEi_transformation</span></a><span class="antiquote"><span>}</span></span></span></span><span>
                                             </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Conv.gconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elim_map</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>gen_from_tagged_2eq_in_type</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;elim_ToA_Mapper_template_SE|fact"><span>φelim_ToA_Mapper_template_SE</span></a><span class="antiquote"><span>}</span></span></span></span><span>
                                          </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Conv.gconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expansions</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_from_eqs</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;gen_expansion|fact"><span>φgen_expansion</span></a><span class="antiquote"><span>}</span></span></span></span><span>
                           </span><span class="main"><span>(</span></span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Conv.hhf_concl_conv</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                  </span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="main"><span>(</span></span><span>
                                      </span><span class="entity"><span>Phi_Expansions.enhance</span></span><span> </span><span class="main"><span>(</span></span><span>Simplifier.clear_simpset</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tagged_eqs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>unfold_vals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>gen_from_tagged_eq_in_type</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;unfold_val|fact"><span>φunfold_val</span></a><span class="antiquote"><span>}</span></span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_open_abstraction</span></span><span> </span><span class="entity"><span>inst_i</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>gen_from_tagged_eq_in_type</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>inst_i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Drule.infer_instantiate</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"i"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>idxes</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
                </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
                </span><span class="comment1"><span>(*(K (Conv.fconv_rule (Phi_Conv.hhf_concl_conv (fn ctxt =&gt;
                  HOLogic.Trueprop_conv (Phi_Conv.action_tag_conv (
                      Phi_Syntax.transformation_conv Conv.all_conv
                          (fn ctm =&gt; Simplifier.rewrite (Gen_Open_Abstraction_SS.equip ctxt) ctm)
                          Conv.all_conv))) ctxt)))*)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_from_eqs_set_idx</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>eq</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="main"><span>(</span></span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>Drule.infer_instantiate</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"i"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>idxes</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span>|&gt;</span><span> </span><span class="entity"><span>f</span></span><span>
                   </span><span>|&gt;</span><span> </span><span class="entity"><span>normalize</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>eq</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gen_from_tagged_eq_in_type_set_idx</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>gen_from_tagged_eq_in_type</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Drule.infer_instantiate</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"i"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>idxes</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                                       </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>open_abstraction_ToA</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                                  </span><span class="entity"><span>gen_from_eqs</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;open_abstraction_infer|fact"><span>φopen_abstraction_infer</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>I</span><span> </span><span class="entity"><span>tagged_eqs</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>open_abstraction_ToA_sp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                                  </span><span class="entity"><span>gen_from_eqs_set_idx</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;open_abstraction_specified|fact"><span>φopen_abstraction_specified</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>I</span><span> </span><span class="entity"><span>tagged_eqs</span></span><span>
                               </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_from_tagged_eq_in_type_set_idx</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;open_abstraction_ty|fact"><span>φopen_abstraction_ty</span></a><span class="antiquote"><span>}</span></span></span></span><span>
                                    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Conv.gconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>make_abstraction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                              </span><span class="entity"><span>gen_from_eqs</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;make_abstraction_infer|fact"><span>φmake_abstraction_infer</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>I</span><span> </span><span class="entity"><span>tagged_eqs</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>make_abstraction_sp</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
                                 </span><span class="entity"><span>gen_from_eqs_set_idx</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;make_abstraction_specified|fact"><span>φmake_abstraction_specified</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>I</span><span> </span><span class="entity"><span>tagged_eqs</span></span><span>
                               </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_from_tagged_eq_in_type_set_idx</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../Phi_Type.html#Phi_Type.\&lt;phi&gt;make_abstraction_ty|fact"><span>φmake_abstraction_ty</span></a><span class="antiquote"><span>}</span></span></span></span><span>
                                    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Conv.gconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="comment1"><span>(*val make_Identity_Element_E = if no_auto then [] else
                                    (gen_from_eqs @{thm' φmake_Identity_Element<span class="hidden">⇩</span><sub>E</sub>} I tagged_eqs
                                     handle THM _ =&gt; [] (*the concrete algebra can be non-unital*))*)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>
            name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>,</span></span><span>
            term </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span>
            params </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span>
            cterm </span><span class="main"><span>=</span></span><span> </span><span>Drule.mk_term</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
            pos </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span>
            equations </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>chk_zero_index_thm</span></span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>,</span></span><span>
            type_equations </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>typeqs</span></span><span class="main"><span>,</span></span><span>
            ind </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="entity"><span>chk_zero_index_thm</span></span><span> </span><span class="entity"><span>ind</span></span><span class="main"><span>,</span></span><span>
            cases </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cases</span></span><span class="main"><span>,</span></span><span>
            intro_reasoning </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>chk_zero_index_thm</span></span><span> </span><span class="entity"><span>intro_reasoning</span></span><span class="main"><span>,</span></span><span>
            is_recursive </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_recursive</span></span><span class="main"><span>,</span></span><span>
            is_impredicative </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
          </span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>thy</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>Phi_Reasoner.start_collecting_reasoners</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>all_derived_rules</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>,</span></span><span> pervasive</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>,</span></span><span> pos</span><span class="main"><span>=</span></span><span class="entity"><span>pos</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>morphism_phi_type</span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi_trim_context</span></span><span> </span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
         </span><span>|&gt;</span><span> </span><span>Phi_Types.map</span><span> </span><span class="main"><span>(</span></span><span>Net.insert_term</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi_typ_term_equiv</span></span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                           </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>,</span></span><span> pervasive</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>,</span></span><span> pos</span><span class="main"><span>=</span></span><span class="entity"><span>pos</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>expns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Morphism.fact</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>expansions</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_rules</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="entity"><span>Phi_Reasoner.add_rules</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span>
          </span><span class="comment1"><span>(*fun add_rules_G mode priority G rules =
                  Phi_Reasoner.add_rules (map (fn rule =&gt;
                      ([Morphism.thm m rule], pos, mode, SOME priority, [], [], SOME G)) rules)*)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
         </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span>?</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
             </span><span>|&gt;</span><span> </span><span>Config.map_generic</span><span> </span><span class="entity"><span>Phi_Reasoner.trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>=&gt;</span></span><span class="entity"><span>i</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>add_rules</span></span><span> </span><span class="entity"><span>Phi_Reasoner.TO_BE_OVERRIDE'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>ToA_Make</span><span class="main"><span>-</span></span><span>10</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>make_abstraction</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>add_rules</span></span><span> </span><span class="entity"><span>Phi_Reasoner.TO_BE_OVERRIDE'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>ToA_Make</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>make_abstraction_sp</span></span><span>
           </span><span class="comment1"><span>(*|&gt; not (null make_Identity_Element_E) ?
                add_rules Phi_Reasoner.TO_BE_OVERRIDE' @{reasoner_group %derived_identity_element} make_Identity_Element_E *)</span></span><span>
             </span><span>|&gt;</span><span> </span><span>Config.put_generic</span><span> </span><span class="entity"><span>phi_allow_source_object_to_be_not_variable</span></span><span> </span><span>true</span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>add_rules</span></span><span> </span><span class="entity"><span>Phi_Reasoner.TO_BE_OVERRIDE'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>ToA_open</span><span class="main"><span>-</span></span><span>10</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>open_abstraction_ToA</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>add_rules</span></span><span> </span><span class="entity"><span>Phi_Reasoner.TO_BE_OVERRIDE'</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>ToA_open</span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="entity"><span>open_abstraction_ToA_sp</span></span><span>
                              </span><span class="comment1"><span>(*(fn (ctxt, _) =&gt; Config.get ctxt search_CSTR_rules)*)</span></span><span>
             </span><span>|&gt;</span><span> </span><span>Config.restore_generic</span><span> </span><span class="entity"><span>phi_allow_source_object_to_be_not_variable</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
             </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Reasoner.add_rules</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>group</span></span><span class="main"><span>,</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="entity"><span>refl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>Morphism.thm</span><span> </span><span class="entity"><span>m</span></span><span> </span><span class="entity"><span>refl</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Phi_Reasoner.TO_BE_OVERRIDE'</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>refl_Tr</span></span><span class="main"><span>)</span></span><span>
             </span><span>|&gt;</span><span> </span><span>Config.map_generic</span><span> </span><span class="entity"><span>Phi_Reasoner.trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>=&gt;</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Expansions.add_simps</span></span><span> </span><span class="entity"><span>expns</span></span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.map_ss</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>expns</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>note_properties_s</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="comment1"><span>(* (case open_abstraction of SOME x =&gt; [(open_abstractionN, x)] | _ =&gt; []) @ *)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>unfold_vals</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>unfold_valN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>unfold_vals</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>unfoldN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>eqs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>expansionN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>expansions</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>I</span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>note_properties_s</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>phi_type</span></span><span> 
            </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>introN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>intro_ToA</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intro_reasoningN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>intro_reasoning</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>intro'R_reasoning</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>intro_reasoning_R_N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>intro_reasoning_R</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span class="main"><span>(</span></span><span class="entity"><span>elimN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>elim_ToA</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>elim_reasoningN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>elim_reasoning</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>elim'SE_ToA</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
             </span><span class="main"><span>(</span></span><span class="entity"><span>intro_mapN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>intro_map</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>elim_mapN</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>elim_map</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>not</span><span> </span><span class="entity"><span>no_auto</span></span><span> </span><span>?</span><span> </span><span class="main"><span>(</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thy'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thy'</span></span><span>
       </span><span>|&gt;</span><span> </span><span>Context_Position.set_visible</span><span> </span><span>false</span><span>
       </span><span>|&gt;</span><span> </span><span class="entity"><span>Defining_Phi_Type.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>thy'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi_type</span></span><span>
       </span><span>|&gt;</span><span> </span><span class="entity"><span>derive_properties</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dervs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bundles</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi_type</span></span><span>
       </span><span>|&gt;</span><span> </span><span>Context_Position.restore_visible</span><span> </span><span class="entity"><span>thy</span></span><span>
 </span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>Phi_Reasoner.stop_collecting_reasoners</span></span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>reasoner_group</span></span><span> </span><span class="main"><span>%</span></span><span>all_derived_rules</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
 </span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="entity"><span>phi_type</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prep_deriving_and_bundles</span></span><span> </span><span class="entity"><span>raw_bundles</span></span><span> </span><span class="entity"><span>raw_derv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bundles</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Bundle.check</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_bundles</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>open_proof_ctxt</span></span><span> </span><span class="entity"><span>bundles</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dervs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_deriving_ast</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt'1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_derv</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dervs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bundles</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_type_i</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>no_auto</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_derv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_bundles</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>variabilities</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>dervs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bundles</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>prep_deriving_and_bundles</span></span><span> </span><span class="entity"><span>raw_bundles</span></span><span> </span><span class="entity"><span>raw_derv</span></span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>DIRECT_DEF</span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cterm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.mk_term</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cterm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.zero_var_indexes_list</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>cterm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>]</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="main"><span>(</span></span><span>Drule.dest_term</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>DIRECT_DEF</span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>def</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Local_Theory.level</span><span> </span><span class="entity"><span>thy</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>thy</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Local_Theory.map_contexts</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>level</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Config.map</span><span> </span><span class="entity"><span>Phi_Reasoner.trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>=&gt;</span></span><span class="entity"><span>i</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>add_type</span></span><span> </span><span class="main"><span>{</span></span><span>no_auto</span><span class="main"><span>=</span></span><span class="entity"><span>no_auto</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dervs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bundles</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>variabilities</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Local_Theory.map_contexts</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&gt;=</span><span> </span><span class="entity"><span>level</span></span><span> </span><span>-</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Config.map</span><span> </span><span class="entity"><span>Phi_Reasoner.trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>=&gt;</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Interface **)</span></span><span>

</span><span class="comment1"><span>(*fun theory_map_result f = apsnd Context.the_theory o f o Context.Theory;*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate_phi</span></span><span> </span><span class="entity"><span>inst'</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>TVars.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>Thm.typ_of</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>inst'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                  </span><span>Vars.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>Thm.term_of</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>inst'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>map_phi_type</span></span><span> </span><span class="main"><span>(</span></span><span>I</span><span class="main"><span>,</span></span><span> </span><span>Term_Subst.instantiate</span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.instantiate</span><span> </span><span class="entity"><span>inst'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_phi_type_fixed</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>null</span><span> </span><span class="main"><span>(</span></span><span>Term.add_tvars</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fix_phi_type</span></span><span> </span><span class="entity"><span>is_open</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>phi0</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>phi_type</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import_inst</span><span> </span><span class="entity"><span>is_open</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>#</span></span><span>term </span><span class="entity"><span>phi0</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>TVars.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span>Vars.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>instantiate_phi</span></span><span> </span><span class="entity"><span>inst'</span></span><span> </span><span class="entity"><span>phi0</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>inst'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bundle_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>opening</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat1</span><span> </span><span>Parse.name_position</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>



</span><span class="comment1"><span>(*make (x : T) ≡ ...  to T x ≡ ...*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dirty_syntax_hack</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>L</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>H</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>L</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>R</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>H</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>φType</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>H</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>R</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.\&lt;phi&gt;Type|const"><span>φType</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>H</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>R</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>rewrite</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>X</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map</span><span> </span><span class="entity"><span>rewrite</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Function_Lib</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Function_Common</span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Function_Fun</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_phi_type</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="quoted"><span>‹</span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_BI.Phi_BI.html#Phi_BI.BI|type"><span>BI</span></a><span> </span><span class="main"><span>_</span></span><span>›</span></span><span>›</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_phi_type</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>T</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_phi_type</span></span><span> </span><span class="entity"><span>T</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_phi_type</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_add_fun</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>raw_derv</span></span><span> </span><span class="entity"><span>raw_bundles</span></span><span> </span><span class="entity"><span>variabilities</span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span>local_theory</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pat_completeness_auto</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Pat_Completeness.pat_completeness_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span>THEN</span><span> </span><span class="entity"><span>auto_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>prove_termination</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>Function.prove_termination</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Function_Common.termination_prover_tac</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>ERROR</span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="main"><span>(</span></span><span>ERROR</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\n\
          \Fail to show the termination automatically. \
          \May use command ‹φtype_definition› to prove the termination manually"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>thy</span></span><span>
   </span><span>|&gt;</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>Local_Theory.begin_nested</span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>pat_completeness_auto</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>prove_termination</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Local_Theory.end_nested_result</span><span> </span><span class="entity"><span>Function_Common.transform_function_data</span></span><span>
   </span><span>|-&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>info</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_phi_type</span></span><span> </span><span>o</span><span> </span><span>Term.fastype_of</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>fs </span><span class="entity"><span>info</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"No φ-type is defined."</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_type_i</span></span><span> </span><span class="main"><span>{</span></span><span>no_auto</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>}</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>const</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>WFREC_DEF</span></span><span> </span><span class="entity"><span>info</span></span><span class="main"><span>,</span></span><span> </span><span>Binding.pos_of</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_derv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_bundles</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>variabilities</span></span><span class="main"><span>)</span></span><span> </span><span>#&gt;</span><span> </span><span>snd</span><span>
     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_function_cmd</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span>Syntax_Phases.term_check</span><span> </span><span class="inner_numeral"><span>99</span></span><span> </span><span class="inner_quoted"><span>"a dirty hack for rewriting the non-standard φ-type definition"</span></span><span>
          </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>dirty_syntax_hack</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>Function.add_function_cmd</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>int</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="comment1"><span>(* fun add_fun a b c = gen_add_fun (Function.add_function a b c) *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_fun_cmd</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>raw_derv</span></span><span> </span><span class="entity"><span>raw_bundles</span></span><span> </span><span class="entity"><span>var</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>generic</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>gen_add_fun</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_derv</span></span><span> </span><span class="entity"><span>raw_bundles</span></span><span> </span><span class="entity"><span>var</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>add_function_cmd</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="entity"><span>int</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>generic</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>let_phityp_deriving_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>raw_const_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_bundles</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_derv</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.read_term_pattern</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>raw_const_name</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_type_info</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>term</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>phi</span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No φ-type named "</span></span><span>^</span><span> </span><span>Syntax.string_of_term</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" found"</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>derive_properties</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prep_deriving_and_bundles</span></span><span> </span><span class="entity"><span>raw_bundles</span></span><span> </span><span class="entity"><span>raw_derv</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>thy</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_by_fun</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Function_Common.function_parser</span></span><span> </span><span class="entity"><span>Function_Fun.fun_config</span></span><span>
               </span><span>--</span><span> </span><span class="entity"><span>parameter_equality'</span></span><span>
               </span><span>--</span><span> </span><span class="entity"><span>bundle_parser</span></span><span>
               </span><span>--</span><span> </span><span class="entity"><span>deriving_parser</span></span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>config</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>specs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_bundles</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_dervs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>add_fun_cmd</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="entity"><span>config</span></span><span> </span><span class="entity"><span>raw_dervs</span></span><span> </span><span class="entity"><span>raw_bundles</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_by_function</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Function_Common.function_parser</span></span><span> </span><span class="entity"><span>Function_Common.default_config</span></span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>config</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>specs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Function.function_cmd</span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="entity"><span>specs</span></span><span> </span><span class="entity"><span>config</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>my_definition</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>spec</span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span>Syntax_Phases.term_check</span><span> </span><span class="inner_numeral"><span>99</span></span><span> </span><span class="inner_quoted"><span>"a dirty hack for rewriting the non-standard φ-type definition"</span></span><span>
          </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="entity"><span>dirty_syntax_hack</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>Specification.definition_cmd</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>spec</span></span><span> </span><span class="entity"><span>int</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>Drule.mk_term</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lthy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_direct</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Scan.option</span><span> </span><span class="entity"><span>Parse_Spec.constdecl</span></span><span> </span><span>--</span><span> </span><span>Parse.position</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Parse_Spec.opt_thm_name</span></span><span> </span><span class="inner_quoted"><span>":"</span></span><span> </span><span>--</span><span> </span><span>Parse.prop</span><span class="main"><span>)</span></span><span> </span><span>--</span><span>
      </span><span class="entity"><span>Parse_Spec.if_assumes</span></span><span> </span><span>--</span><span> </span><span>Parse.for_fixes</span><span>
        </span><span>--</span><span> </span><span class="entity"><span>parameter_equality'</span></span><span>
        </span><span>--</span><span> </span><span class="entity"><span>bundle_parser</span></span><span>
        </span><span>--</span><span> </span><span class="entity"><span>deriving_parser</span></span><span>
        </span><span>--</span><span> </span><span class="main"><span>(</span></span><span>Scan.option</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>|</span></span><span>›</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Scan.fail</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*to distinguish with the `def_by_fun` syntax*)</span></span><span>
   </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>decl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>spec</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_bundles</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_dervs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>int</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>lthy</span></span><span>
         </span><span>|&gt;</span><span> </span><span>snd</span><span> </span><span>o</span><span> </span><span>Local_Theory.begin_nested</span><span>
         </span><span>|&gt;</span><span> </span><span class="entity"><span>my_definition</span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>spec</span></span><span> </span><span class="entity"><span>int</span></span><span>
         </span><span>|&gt;</span><span> </span><span>Local_Theory.end_nested_result</span><span> </span><span>Morphism.fact</span><span>
         </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>def_term'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def_eq</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>generic</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>def_term</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="main"><span>(</span></span><span>Drule.dest_term</span><span> </span><span class="entity"><span>def_term'</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>decl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>name</span></span><span>
                                        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Binding.make</span><span> </span><span class="main"><span>(</span></span><span>Term.term_name</span><span> </span><span class="entity"><span>def_term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_type_i</span></span><span> </span><span class="main"><span>{</span></span><span>no_auto</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>def_term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>DIRECT_DEF</span></span><span> </span><span class="entity"><span>def_eq</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span>
                                              </span><span class="entity"><span>raw_dervs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_bundles</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>generic</span></span><span> </span><span>|&gt;</span><span> </span><span>snd</span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>φtype_def</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"define φ-types"</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>def_direct</span></span><span> </span><span>||</span><span> </span><span class="entity"><span>def_by_fun</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>f</span></span><span> </span><span>false</span><span>
            </span><span class="comment1"><span>(*Context.mapping
                  (  Sign.new_group
                  #&gt; Context.theory_map (f false)
                  #&gt; Sign.reset_group)
                  (  Context.proof_map (f false) ) *)</span></span><span>
            </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword1"><span>let_φtype</span></span><span>›</span></span></span><span> </span><span class="inner_quoted"><span>"derive properties of existing φ-types"</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Parse.position</span><span> </span><span>Parse.const</span><span> </span><span>--</span><span> </span><span class="entity"><span>bundle_parser</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>deriving_parser</span></span><span class="main"><span>)</span></span><span>
            </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>let_phityp_deriving_cmd</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PHI_TYPE_ALGEBRA_DERIVERS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>include</span></span></span><span> </span><span class="entity"><span>PHI_TYPE_ALGEBRA_DERIVERS</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Type.deriving_instruction</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> constrain_antecedents </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*condition*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*antecedents*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*enhanced*)</span></span><span>
      </span><span class="comment1"><span>(*provides conditions to the given antecedents, e.g,
        cond, ant, to ‹cond ⟶ ant›,
        ‹condition C›, ‹condition Ant›, to ‹condition (C ⟶ Ant)›
        ‹condition C›, ‹∀x. condition Ant x›, to ‹∀x. condition (C ⟶ Ant x)›*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> constrain_antecedents_by_boolean </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> forall_qualify </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> exists_qualify </span><span class="main"><span>:</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> simplified_forall_qualify </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> simplified_exists_qualify </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Phi_Type_Derivers</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PHI_TYPE_ALGEBRA_DERIVERS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Phi_Type_Algebra_Derivers</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>deriving_instruction</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Type.deriving_instruction</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>constrain_antecedents</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Syntax.dest_ant_sequence_or_HOL_conj</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constrain_antecedents</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise|const"><span>Premise</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.MODE_GUARD|const"><span>MODE_GUARD</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Syntax.dest_ant_sequence_or_HOL_conj</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constrain_antecedents</span></span><span> </span><span class="entity"><span>cond</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_premise_tag</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.default|const"><span>default</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_premise_tag</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.MODE_GUARD|const"><span>MODE_GUARD</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_premise_tag</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>constrain</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.All|const"><span>HOL.All</span></a><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.All|const"><span>HOL.All</span></a><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constrain</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constrain</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.All|const"><span>HOL.All</span></a><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.All|const"><span>HOL.All</span></a><span> </span><span class="entity"><span>t</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"_"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>constrain</span></span><span> </span><span class="main"><span>(</span></span><span>Term.incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constrain</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>H</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise|const"><span>Premise</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>tag</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>cond</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise|const"><span>Premise</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>tag'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>is_premise_tag</span></span><span> </span><span class="entity"><span>tag</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>is_premise_tag</span></span><span> </span><span class="entity"><span>tag'</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>H</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.implies|const"><span>HOL.implies</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>C</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.implies|const"><span>HOL.implies</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>cond</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span>
                            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.implies|const"><span>HOL.implies</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>cond</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>constrain</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.implies|const"><span>HOL.implies</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>cond</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map</span><span> </span><span class="entity"><span>constrain</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>PLPR_Syntax.dest_ant_sequence_or_HOL_conj</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>constrain_antecedents_by_boolean</span></span><span> </span><span class="entity"><span>cond</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>constrain_antecedents</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Premise|const"><span>Premise</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../Phi_Semantics_Framework/Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.MODE_GUARD|const"><span>MODE_GUARD</span></a><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>cond</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>forall_qualify</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.loose_bvar1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>B</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.All|const"><span>HOL.All</span></a><span> </span><span class="entity"><span>ty</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Term.incr_boundvars</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>B</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>forall_qualify</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.All|const"><span>HOL.All</span></a><span> </span><span class="entity"><span>ty</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>exists_qualify</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.loose_bvar1</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>B</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Ex|const"><span>HOL.Ex</span></a><span> </span><span class="entity"><span>ty</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Term.incr_boundvars</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="entity"><span>B</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>exists_qualify</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../../HOL/HOL/HOL.html#HOL.Ex|const"><span>HOL.Ex</span></a><span> </span><span class="entity"><span>ty</span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simp_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Drule.mk_term</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.simplify</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Drule.dest_term</span><span>
    </span><span>|&gt;</span><span> </span><span>Thm.term_of</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simplified_forall_qualify</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simp_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>forall_qualify</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simplified_exists_qualify</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>simp_term</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>exists_qualify</span></span><span> </span><span class="entity"><span>ty</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>phi_type</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Type.phi_type</span></span><span>

</span></pre>
</body>

</html>