<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/system/opr_stack2.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/system/opr_stack2.ML›</h1>
</div>

<pre class="source"><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PHI_OPR_STACK</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>include</span></span></span><span> </span><span class="entity"><span>PHI_OPR_STACK</span></span><span>

</span><span class="comment1"><span>(* Operator Stack *)</span></span><span>


</span><span class="comment1"><span>(** Operations **)</span></span><span>

</span><span class="comment1"><span>(* Function Application *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> begin_apply </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.eval_cfg</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> meta_apply </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.eval_cfg</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>arg_name</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_CP_IDE.eval_cfg</span></span><span> * </span><span class="entity"><span>named_arg</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>free_param</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>


</span><span class="comment1"><span>(* Block, Parenthesis *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> begin_block </span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> close_parenthesis </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.eval_cfg</span></span><span> * </span><span class="entity"><span>free_param</span></span><span> </span><span>option</span><span> * </span><span>bool</span><span>
                     </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> open_parenthesis </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>arg_name</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> comma </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.eval_cfg</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>arg_name</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>

</span><span class="comment1"><span>(* Operator *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> push_operator </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.eval_cfg</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>operator_info</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span> * </span><span>thm</span><span> </span><span>list</span><span>
                 </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>meta_operator</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>operator_info</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>free_param</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>meta_opr</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> push_meta_operator </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.eval_cfg</span></span><span>
                      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>meta_operator</span></span><span>
                      </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span>

</span><span class="comment1"><span>(* End of Expression *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> end_expression </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.eval_cfg</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="comment1"><span>(*precedence*)</span></span><span>
                  </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context</span></span><span> </span><span class="comment1"><span>(*evaluate until the peak precedence in the stacked operators
                                          is less than the given argument*)</span></span><span>

</span><span class="comment1"><span>(* Misc. *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> inside_calling_stack </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>opr_stack</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>operation_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span> </span><span>string</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*title of the operation, e.g. operator or function*)</span></span><span>
                      * </span><span>Markup.T</span><span> </span><span class="comment1"><span>(*used in pretty printing*)</span></span><span>
                      * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*name and position*)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> eval_until </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> * </span><span>int</span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Working_Mode.working_mode</span></span><span>
               * </span><span>bool</span><span>
               * </span><span class="entity"><span>Phi_CP_IDE.eval_cfg</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>operation_name</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>opr_frame</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> * </span><span class="entity"><span>operation_name</span></span><span> * </span><span class="entity"><span>opr_frame</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>context_state</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> eval_one_step </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span>
                 </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Working_Mode.working_mode</span></span><span> * </span><span>int</span><span> * </span><span>bool</span><span> * </span><span class="entity"><span>Phi_CP_IDE.eval_cfg</span></span><span>
                 </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>operation_name</span></span><span> * </span><span class="entity"><span>context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>operation_name</span></span><span> * </span><span class="entity"><span>context</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> end_of_input </span><span class="main"><span>:</span></span><span> </span><span>unit</span><span> </span><span>parser</span><span>

</span><span class="comment1"><span>(*val eval_tokens : context_state -&gt; context_state parser*)</span></span><span>

</span><span class="comment1"><span>(* declaring operators *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> error_arity_opr </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> * </span><span>int</span><span> * </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_operands </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> * </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> * </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span class="entity"><span>context_state</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> check_meta_apply_balance </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Phi_Opr_Stack.opr_frame</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Phi_Opr_Stack</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PHI_OPR_STACK</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Phi_Opr_Stack</span><span>

</span><span class="comment1"><span>(*** Library * **)</span></span><span>

</span><span class="comment1"><span>(*** Operator Stack ***)</span></span><span>


</span><span class="comment1"><span>(** Tools **)</span></span><span>

</span><span class="comment1"><span>(* fun invoke_delayed_action (Apply (_, rules)) s = Phi_Apply.apply rules s
  | invoke_delayed_action End_Block s =
      raise Phi_Processor.Process_State_Call (s,
             Phi_Toplevel.end_block_auto_proof_cmd NONE false
          #&gt; Proof.map_context (Opr_Stack.map tl)) *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_arity_constraint</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_arity_constraint</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>actual</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Generic_Variable_Access.number_of_values</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>spec_of </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>actual</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>VAR_ARITY_IN_SEQUENT</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>VAR_ARITY_IN_OPSTACK</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>
                  </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>actual</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_quoted"><span>"Less "</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="inner_quoted"><span>"More "</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                  </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"arguments are given to the operator \""</span></span><span class="main"><span>,</span></span><span>
                  </span><span>Pretty.str</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span>
                  </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"\" than its expected arity "</span></span><span>
                </span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span>Pretty.here</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_no_name</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>get_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Named arguement is not supported here! "</span></span><span> </span><span>^</span><span> </span><span>Position.here</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>  </span><span>maps</span><span> </span><span>snd</span><span> </span><span class="entity"><span>vs</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>operation_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> </span><span>option</span><span> * </span><span>Markup.T</span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bad_syntax</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>title</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>string_of</span><span> </span><span class="main"><span>(</span></span><span>
    </span><span>block</span><span> </span><span class="main"><span>(</span></span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"Bad Syntax:"</span></span><span>
          </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>title</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
          </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>mark_str</span><span> </span><span class="main"><span>(</span></span><span>Position.markup</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_complete_eval</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>title</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>#</span></span><span>constr_is_ready </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>string_of</span><span> </span><span class="main"><span>(</span></span><span>
         </span><span>chunks</span><span> </span><span class="main"><span>[</span></span><span>block</span><span> </span><span class="main"><span>(</span></span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"Evaluation of"</span></span><span>
                       </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>title</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                       </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>mark_str</span><span> </span><span class="main"><span>(</span></span><span>Position.markup</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>m</span></span><span class="main"><span>,</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                       </span><span>@</span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"fails. There are unsolved antecedents or proof obligations"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                 </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>]</span></span><span>
       </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>end_of_input</span></span><span> </span><span class="entity"><span>toks</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>string_of</span><span> </span><span class="main"><span>(</span></span><span>
                     </span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"End of line expects"</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span>here</span><span> </span><span class="main"><span>(</span></span><span>Token.pos_of</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>toks</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tok</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Token.is_eof</span><span> </span><span class="entity"><span>tok</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*fun chk_complete_eval' mode (ctxt, sequent) =
  if #constr_is_ready mode (Thm.prop_of sequent) then (ctxt, sequent)
  else error (let open Pretty in string_of (
         chunks [para "Evaluation fails. There are unsolved antecedents or proof obligations",
                 Thm.pretty_thm ctxt sequent]
       ) end)*)</span></span><span>

</span><span class="comment1"><span>(*num: to be evaluated at most, negative to be unlimited
  returns: number of operations not evaluated yet*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eval_until</span></span><span> </span><span class="entity"><span>gen_ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>limit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>num</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>complete_eval</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cfg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>post_app</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.Post_App.invoke</span></span><span> </span><span class="entity"><span>gen_ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>prev_name</span></span><span> </span><span class="entity"><span>acts</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prev_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>prev_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Apply</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prev_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>prev_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Begin_Block</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prev_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>prev_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Opr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arity</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>expr_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>aR</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pr</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prev_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>bad_syntax</span></span><span> </span><span class="entity"><span>prev_name</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"operator"</span></span><span class="main"><span>,</span></span><span> </span><span>Markup.operator</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>chk_arity_constraint</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                   </span><span class="entity"><span>chk_complete_eval</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>prev_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
                   </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
                     </span><span>|&gt;</span><span> </span><span class="entity"><span>Generic_Variable_Access.push_values</span></span><span> </span><span class="entity"><span>vals</span></span><span>
                     </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Reasoners.wrap''</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Apply.apply1</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span>
                     </span><span>|&gt;</span><span> </span><span class="entity"><span>post_app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_CP_IDE.set_expr_id</span></span><span> </span><span class="entity"><span>expr_id</span></span><span> </span><span class="entity"><span>cfg</span></span><span class="main"><span>)</span></span><span>
                     </span><span>|&gt;</span><span> </span><span class="entity"><span>complete_eval</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>chk_complete_eval</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"operator"</span></span><span class="main"><span>,</span></span><span> </span><span>Markup.operator</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
                     </span><span>|&gt;</span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="entity"><span>aR</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>prev_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Meta_Opr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arity</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>expr_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>param</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>meta</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>aR</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span>
            </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pr</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prev_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>limit</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>bad_syntax</span></span><span> </span><span class="entity"><span>prev_name</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_arity_constraint</span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chk_complete_eval</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>prev_name</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"operator"</span></span><span class="main"><span>,</span></span><span> </span><span>Markup.operator</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acts'</span></span><span class="main"><span>,</span></span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>meta</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cfg</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>param</span></span><span class="main"><span>,</span></span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>aR</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
                                     </span><span>|&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
                                          </span><span>|&gt;</span><span> </span><span class="entity"><span>post_app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_CP_IDE.set_expr_id</span></span><span> </span><span class="entity"><span>expr_id</span></span><span> </span><span class="entity"><span>cfg</span></span><span class="main"><span>)</span></span><span>
                                          </span><span>|&gt;</span><span> </span><span class="entity"><span>complete_eval</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>chk_complete_eval</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>name'</span></span><span>
                                        </span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="entity"><span>acts'</span></span><span> </span><span class="entity"><span>s'</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>prev_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Left_Parenthesis</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prev_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>prev_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Meta_Apply</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prev_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>prev_name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acts</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Comma</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prev_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>prev_name</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prev_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="entity"><span>num</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eval_one_step</span></span><span> </span><span class="entity"><span>gen_ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eval_gen</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eval_until</span></span><span> </span><span class="entity"><span>gen_ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>work</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>precedence</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>complete_eval</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cfg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eval_gen</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>precedence</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>complete_eval</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cfg</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>one_step</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prev_name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>opr</span></span><span class="main"><span>,</span></span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num</span></span><span class="main"><span>,</span></span><span class="entity"><span>prev_name'</span></span><span class="main"><span>,</span></span><span class="entity"><span>opr'</span></span><span class="main"><span>,</span></span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eval</span></span><span> </span><span class="entity"><span>prev_name</span></span><span> </span><span class="entity"><span>opr</span></span><span> </span><span class="entity"><span>s</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prev_name'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>opr'</span></span><span class="main"><span>,</span></span><span class="entity"><span>names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>one_step</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>work</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** open \&amp; close parenthesis **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>close_parenthesis</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cfg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>meta_arg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>complete_eval</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>post_app</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_CP_IDE.Post_App.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>s0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Working_Mode.mode1</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>s0</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>actions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_name</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>oprs</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>close</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>expr_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals_before</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>acts</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Generic_Variable_Access.push_values</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vals_before</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>chk_no_name</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Reasoners.wrap''</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Apply.apply1</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>post_app</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_CP_IDE.set_expr_id</span></span><span> </span><span class="entity"><span>expr_id</span></span><span> </span><span class="entity"><span>cfg</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>complete_eval</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>chk_complete_eval</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"function"</span></span><span class="main"><span>,</span></span><span> </span><span>Markup.plain_text</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span>

        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>close</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Begin_Block</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>s</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>Generic_Variable_Access.push_values</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chk_no_name</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_CP_IDE.proof_state_call</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Toplevel.end_block_auto_proof_cmd</span></span><span> </span><span>NONE</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
              </span><span>|&gt;</span><span> </span><span>pair</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span>

        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>close</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Opr</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"internal bug #91066fd2-8881-422f-bf54-4b3f69879042"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>close</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Meta_Opr</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"internal bug #10cc33ab-de95-48fb-8b8c-103f2c0110fd"</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>close</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Left_Parenthesis</span></span><span> </span><span class="entity"><span>vals_before</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Generic_Variable_Access.push_values</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vals_before</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>chk_no_name</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>close</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Meta_Apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals_before</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cfg</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals_before</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>meta_arg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>close</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Comma</span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>close</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>acts</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>close</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"parenthesis is inbalanced!"</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>eval_until</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>s0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cfg</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>Markup.error</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"&lt;internal bug&gt;"</span></span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>actions</span></span><span> </span><span class="entity"><span>s0</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Generic_Variable_Access.extract_values</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>close</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>arg_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>open_parenthesis</span></span><span> </span><span class="entity"><span>arg_name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Generic_Variable_Access.extract_values</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Left_Parenthesis</span></span><span> </span><span class="entity"><span>vals</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>oprs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_name</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Operator **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>error_arity_opr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>left_or_right</span></span><span class="main"><span>,</span></span><span class="entity"><span>arity</span></span><span class="main"><span>,</span></span><span class="entity"><span>actual</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span>
          </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>string_of</span><span> </span><span class="main"><span>(</span></span><span>block</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Operator"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>keyword2</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
              </span><span>str</span><span> </span><span class="inner_quoted"><span>"requires"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>arity</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
              </span><span>str</span><span> </span><span class="entity"><span>left_or_right</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="inner_quoted"><span>"operands,"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="inner_quoted"><span>"but given"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
              </span><span>str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>actual</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span>Pretty.here</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_operands</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>left_or_right</span></span><span class="main"><span>,</span></span><span class="entity"><span>arity</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span class="entity"><span>stat'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>VAR_ARITY_IN_SEQUENT</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Generic_Variable_Access.extract_values</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>stat</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>VAR_ARITY_IN_SEQUENT</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
         </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>VAR_ARITY_IN_OPSTACK</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
         </span><span>length</span><span> </span><span class="entity"><span>vals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>arity</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span class="entity"><span>stat'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>error_arity_opr</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>left_or_right</span></span><span class="main"><span>,</span></span><span class="entity"><span>arity</span></span><span class="main"><span>,</span></span><span>length</span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>push_opr'</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>left_prec</span></span><span class="main"><span>,</span></span><span class="entity"><span>prec</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>arityL</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arityR</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>actions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Working_Mode.mode1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>eval_until</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>left_prec</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cfg</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"operator"</span></span><span class="main"><span>,</span></span><span> </span><span>Markup.operator</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>actions</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_operands</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"left"</span></span><span class="main"><span>,</span></span><span class="entity"><span>arityL</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity_constraint</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>arityR</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_constraint</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>push_operator</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>opr</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_constraint</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>push_opr'</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>opr</span></span><span> </span><span class="entity"><span>s</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Opr</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>opr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arity_constraint</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>id </span><span class="entity"><span>cfg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>meta_operator</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>operator_info</span></span><span> * </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>free_param</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>meta_opr</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>push_meta_operator</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>opr</span></span><span class="main"><span>,</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>param</span></span><span class="main"><span>,</span></span><span class="entity"><span>meta</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arity_constraint</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>push_opr'</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>opr</span></span><span> </span><span class="entity"><span>s</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Meta_Opr</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>opr</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arity_constraint</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>id </span><span class="entity"><span>cfg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>param</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>meta</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** End of Expression **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>end_expression</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="entity"><span>precedence</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>actions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Working_Mode.mode1</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="entity"><span>eval_until</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>precedence</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cfg</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>Markup.plain_text</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"&lt;end-of-expr&gt;"</span></span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>actions</span></span><span> </span><span class="entity"><span>s</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s'</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Comma **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>comma</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="entity"><span>next_arg_name</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>actions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_name</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Working_Mode.mode1</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>opr_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"operator"</span></span><span class="main"><span>,</span></span><span> </span><span>Markup.operator</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>","</span></span><span class="main"><span>,</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>next_arg_name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_actions</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Left_Parenthesis</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_actions</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Meta_Apply</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_actions</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Apply</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_actions</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Begin_Block</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bad_syntax</span></span><span> </span><span class="entity"><span>opr_name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_actions</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Comma</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_actions</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_actions</span></span><span> </span><span class="entity"><span>L</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_actions</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>bad_syntax</span></span><span> </span><span class="entity"><span>opr_name</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_actions</span></span><span> </span><span class="entity"><span>actions</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="entity"><span>eval_until</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cfg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>opr_name</span></span><span> </span><span class="entity"><span>actions</span></span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Generic_Variable_Access.extract_values</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Comma</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>arg_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>next_arg_name</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Function Application **)</span></span><span>

</span><span class="comment1"><span>(*
fun do_application (cfg, complete_eval) rules stat =
      stat
   |&gt; end_expression cfg @{priority %φlang_app}
   |&gt; apsnd (fn s =&gt; s
              |&gt; Phi_Reasoners.wrap'' (Phi_Apply.apply rules)
              |&gt; Phi_CP_IDE.Post_App.invoke (Context.Proof (fst s)) cfg
              |&gt; complete_eval ? chk_complete_eval mode (SOME "function", Markup.plain_text, name))
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>begin_apply</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>actions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Working_Mode.mode1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"function"</span></span><span class="main"><span>,</span></span><span> </span><span>Markup.plain_text</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>eval_until</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>priority</span></span><span> </span><span class="main"><span>%</span></span><span>φlang_app</span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cfg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="entity"><span>actions</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt''</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent''</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Generic_Variable_Access.extract_values</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>id </span><span class="entity"><span>cfg</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent''</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>meta_apply</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>arg_name</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>left_precedence</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>actions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Working_Mode.mode1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_quoted"><span>"function"</span></span><span class="main"><span>,</span></span><span> </span><span>Markup.plain_text</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="entity"><span>eval_until</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>left_precedence</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cfg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fun_name</span></span><span> </span><span class="entity"><span>actions</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt''</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent''</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Generic_Variable_Access.extract_values</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Meta_Apply</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>vals</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>actions'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_name</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent''</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>begin_block</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>actions</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Begin_Block</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>actions</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>arg_names</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(** Misc. Tools **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inside_calling_stack</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>actions</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_during</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Apply</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_during</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Meta_Apply</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_during</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Begin_Block</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_during</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Comma</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_during</span></span><span> </span><span class="entity"><span>L</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_during</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Opr</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_during</span></span><span> </span><span class="entity"><span>L</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_during</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Meta_Opr</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_during</span></span><span> </span><span class="entity"><span>L</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_during</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Left_Parenthesis</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>is_during</span></span><span> </span><span class="entity"><span>L</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_during</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>is_during</span></span><span> </span><span class="entity"><span>actions</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_meta_apply_balance</span></span><span> </span><span class="entity"><span>opr</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unbalanced "</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>opr</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" "</span></span><span> </span><span>^</span><span> </span><span>Position.here</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span>  
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_stack</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Left_Parenthesis</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_stack</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Apply</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_stack</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Meta_Apply</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>opr'</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>opr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>opr'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_stack</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Begin_Block</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_stack</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_stack</span></span><span> </span><span class="entity"><span>L</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_stack</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>chk_stack</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(*** Prefix, Infix, Postfix operators  ***)</span></span><span>



</span><span class="comment1"><span>(*** Hooks, Control of Lines and Statements ***)</span></span><span>









</span><span class="keyword2"><span class="keyword"><span>end</span></span></span></pre>
</body>

</html>