<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/rule_generation.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/rule_generation.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(* AUTHOR: Qiyuan Xu

This file provides a framework of template instantiation of reasoning rules, where a template is
a rule with antecedents as the template parameters and argument rules can be given from which
we compose instances by resolution between the arguments and the parameters.
Instance rules can be declared as a φ-LPR reasoning rule or with any attributes as indicated by the
template.

The file provides an attribute ‹φreason_generator› declaring a template of a single parameter as its
leading antecedent. Later, when the system of property database is built, property-based template
as an instance of multi-parameter template will be provided (carried out by attribute ‹φreason_template›)
which supports multi-properties as its parameters and instantiating the template once
sufficient properties are registered to the database.
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PLPR_RULE_GEN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> Generation_Fail </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Phi_Reasoner.info_level</span></span><span> * </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Rule_Gen_SS </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>SIMPSET</span></span><span> </span><span class="comment1"><span>(*simpset for generating reasoning rules*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Template_Inst_SS_Post_Merging </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>HOOKS</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>instantiation_action</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>Reasonig_Rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>Phi_Reasoner.mode' * Reasoner_Group.group option</span><span class="main"><span>)</span></span><span> * Phi_Reasoner.patterns_and_excepts
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Attributes</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Token.src list
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>No_Action</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>binding_template</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>indexname</span><span> </span><span>list</span><span> * </span><span>binding</span><span>
                       </span><span class="comment1"><span>(*^ variables that will be instantiated to certain lambda terms, and the binding will
                      by qualified by the short-names of the heading constants of the lambda terms, which
                      comprises the final binding of the instance lemma.*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rule_generation_pass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>Position.T</span><span> * </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Position.T</span><span> * </span><span>thm</span><span> </span><span class="comment1"><span>(*template*)</span></span><span class="main"><span>)</span></span><span>
              * </span><span class="main"><span>(</span></span><span class="entity"><span>rule_generation_pass</span></span><span> * </span><span class="entity"><span>Phi_Reasoner.rule_pass</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
              * </span><span class="entity"><span>instantiation_action</span></span><span>
              * </span><span class="entity"><span>binding_template</span></span><span> </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trim_action </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>instantiation_action</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>instantiation_action</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pattern_of </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>instantiation_action</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> invoke_action </span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span> </span><span class="comment1"><span>(*the position where the instantiation happens*)</span></span><span> *
                    </span><span class="entity"><span>Phi_Reasoner.rule_pass</span></span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*only effective for actions of Reasonig_Rule*)</span></span><span>
                </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>instantiation_action</span></span><span>
                </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pass_generated_rule </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span>simp</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>,</span></span><span>
                           masks</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>IN_Arg.mask</span></span><span> </span><span>list</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*can be None by default*)</span></span><span class="main"><span>,</span></span><span>
                           rule_pos</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>Position.T</span><span> </span><span class="comment1"><span>(*template position*)</span></span><span> *
                                      </span><span>Position.T</span><span> </span><span class="comment1"><span>(*position of instantiation*)</span></span><span> *
                                      </span><span>binding</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*name of the instantiation*)</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>
                       </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>instantiation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Position.T</span><span> </span><span class="comment1"><span>(*where the instantiation happens*)</span></span><span>
                   * </span><span>Envir.env</span><span>  </span><span class="comment1"><span>(*unifiers between parameters and arguments*)</span></span><span>
                   * </span><span class="main"><span>(</span></span><span>Position.T</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>list</span><span>

</span><span class="comment1"><span>(* Controller *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> enable_reason_generator </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trace </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>

</span><span class="comment1"><span>(* Controlling Simplification of Generated Rules *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> simp_timeout </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span> </span><span class="comment1"><span>(*in milliseconds*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Simp_Reorient </span><span class="main"><span>:</span></span><span> </span><span>PROOF_DATA</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_reorient </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_mk_eq_True </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_mk_sym </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> asm_lr_simplify </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>{</span></span><span>simp_concl</span><span class="main"><span>:</span></span><span> </span><span>bool</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

</span><span class="comment1"><span>(* Main Entry *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> invoke_generation </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>instantiation</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>

</span><span class="comment1"><span>(* Syntax Parsers *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_pass </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Input.source</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule_generation_pass</span></span><span> * </span><span class="entity"><span>Phi_Reasoner.rule_pass</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_action </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Phi_Reasoner.mode'</span></span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>Phi_Reasoner.patterns_and_excepts</span></span><span> * </span><span>Token.src</span><span> </span><span>list</span><span> </span><span>option</span><span>
                </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>instantiation_action</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> parse_binding_template </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>Position.T</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>binding_template</span></span><span> </span><span>option</span><span>

</span><span class="comment1"><span>(* Internal Interfaces *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> rule_template_pass__sender </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule_generation_pass</span></span><span> * </span><span class="entity"><span>Phi_Reasoner.rule_pass</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>Unsynchronized.ref</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>PLPR_Rule_Gen</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PLPR_RULE_GEN</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Template_Inst_SS_Post_Merging</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Hooks</span></span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>state</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>TT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoner.pattern</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Rule_Gen_SS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Simpset</span></span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>initial_ss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Simpset_Configure.Empty_SS</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="PLPR.\&lt;phi&gt;generation_simp|attribute"><span class="entity_def" id="PLPR.\&lt;phi&gt;generation_simp|fact"><span>φgeneration_simp</span></span></span><span>›</span></span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>comment</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"simplifying the reasoning rules instantiated from templates."</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attribute</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>post_merging</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.del_cong</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.if_weak_cong|fact"><span>if_weak_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Simplifier.add_cong</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.if_cong|fact"><span>if_cong</span></a><span class="antiquote"><span>}</span></span></span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Template_Inst_SS_Post_Merging.invoke</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>instantiation_action</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>Reasonig_Rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>Phi_Reasoner.mode' * Reasoner_Group.group option</span><span class="main"><span>)</span></span><span> *
                             </span><span class="main"><span>(</span></span><span> </span><span class="main"><span>(</span></span><span>Phi_Reasoner.pattern * priority option</span><span class="main"><span>)</span></span><span> list * Phi_Reasoner.pattern list </span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Attributes</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> Token.src list
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>No_Action</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rule_generation_pass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>Position.T</span><span> * </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>binding_template</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>indexname</span><span> </span><span>list</span><span> * </span><span>binding</span><span>
                       </span><span class="comment1"><span>(*^ variables that will be instantiated to certain lambda terms, and the binding will
                      by qualified by the short-names of the heading constants of the lambda terms, which
                      comprises the final binding of the instance lemma.*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Position.T</span><span> * </span><span>thm</span><span> </span><span class="comment1"><span>(*template*)</span></span><span class="main"><span>)</span></span><span>
              * </span><span class="main"><span>(</span></span><span class="entity"><span>rule_generation_pass</span></span><span> * </span><span class="entity"><span>Phi_Reasoner.rule_pass</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
              * </span><span class="entity"><span>instantiation_action</span></span><span>
              * </span><span class="entity"><span>binding_template</span></span><span> </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>instantiation</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Position.T</span><span> </span><span class="comment1"><span>(*where the instantiation happens*)</span></span><span>
                   * </span><span>Envir.env</span><span>  </span><span class="comment1"><span>(*unifiers between parameters and arguments*)</span></span><span>
                   * </span><span class="main"><span>(</span></span><span>Position.T</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>list</span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trim_action</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="entity"><span>Reasonig_Rule</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>trim_action</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attributes</span></span><span> </span><span class="entity"><span>srcs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attributes</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Token.trim_context</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>srcs</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>trim_action</span></span><span> </span><span class="entity"><span>No_Action</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>No_Action</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trim_template</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>tem</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>pass</span></span><span class="main"><span>,</span></span><span class="entity"><span>act</span></span><span class="main"><span>,</span></span><span class="entity"><span>bind</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.trim_context</span><span> </span><span class="entity"><span>tem</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pass</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trim_action</span></span><span> </span><span class="entity"><span>act</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bind</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>enable_reason_generator</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="PLPR.\&lt;phi&gt;reason_enable_generator|attribute"><span>φreason_enable_generator</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pattern_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Reasonig_Rule</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pattern_of</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attributes</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>pattern_of</span></span><span> </span><span class="entity"><span>No_Action</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invoke_action</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>template_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pass</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="entity"><span>rules'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>action</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Reasonig_Rule</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blacklists</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>priority'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pats'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blacklists'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pass</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ps</span></span><span> </span><span class="entity"><span>template_pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blacklists</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blacklists</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Phi_Reasoner.add_rules</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>template_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>priority'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blacklists'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attributes</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="entity"><span>attr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span>Thm.apply_attribute</span><span> </span><span class="main"><span>(</span></span><span>
                              </span><span>Context.cases</span><span> </span><span class="entity"><span>Attrib.attribute_global</span></span><span> </span><span class="entity"><span>Attrib.attribute</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>attr</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>fold</span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="entity"><span>attrs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>No_Action</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Generation_Fail</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Phi_Reasoner.info_level</span></span><span> * </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>list</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normalize</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Drule.zero_var_indexes</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="PLPR.\&lt;phi&gt;trace_template_inst|attribute"><span>φtrace_template_inst</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>SIMP_conv</span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.SIMP|const"><span>SIMP</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.arg_conv</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>C</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Conv.sub_conv</span><span> </span><span class="entity"><span>conv</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>conv</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_simp_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rule</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.All|const"><span>HOL.All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>  
                </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.spec|fact"><span>spec</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*TODO: names of the variables*)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>Thm.forall_elim_vars</span><span> </span><span class="main"><span>(</span></span><span>Thm.maxidx_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Simplifier.norm_hhf</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
                  </span><span>|&gt;</span><span> </span><span class="entity"><span>mk</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/Product_Type.html#Product_Type.prod.case_prod|const"><span>case_prod</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_Var</span><span> </span><span class="main"><span>(</span></span><span>Term.head_of</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>lemma'</span></span><span> </span><span class="quoted"><span>‹ </span><span class="main"><span>(</span></span><span class="keyword1"><span>case</span></span><span> </span><span class="main"><span>(</span></span><span class="free"><span>x</span></span><span class="main"><span>,</span></span><span class="free"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span>of</span></span><span> </span><span class="main"><span>(</span></span><span class="bound"><span>a</span></span><span class="main"><span>,</span></span><span class="bound"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>⇒</span></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="bound"><span>a</span></span><span> </span><span class="bound"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>⟹</span></span><span> </span><span class="free"><span>P</span></span><span> </span><span class="free"><span>x</span></span><span> </span><span class="free"><span>y</span></span><span>›</span></span><span>
                                           </span><span class="quasi_keyword"><span>by</span></span><span> </span><span class="operator"><span>simp</span></span><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*TODO: names of the variables*)</span></span><span class="main"><span>)</span></span><span>
                       </span><span>|&gt;</span><span> </span><span class="entity"><span>mk</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span> </span><span class="comment1"><span>(*TODO: case split*)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/Set.html#Set.Ball|const"><span>Ball</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/Set.html#Set.bspec|fact"><span>bspec</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*TODO: names of the variables*)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.conj|const"><span>conj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.conjunct1|fact"><span>conjunct1</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.conjunct2|fact"><span>conjunct2</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>mk</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Simplification stolen from Isabelle *)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_rule_extra_vars</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>elhs</span></span><span> </span><span class="entity"><span>erhs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elhss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>elhs</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>TVars.build</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>TVars.add_tvars</span><span> </span><span class="entity"><span>elhss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vars.build</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Vars.add_vars</span><span> </span><span class="entity"><span>elhss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>erhs</span></span><span> </span><span>|&gt;</span><span> </span><span>Term.exists_type</span><span> </span><span class="main"><span>(</span></span><span>Term.exists_subtype</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TVar</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>TVars.defined</span><span> </span><span class="entity"><span>tvars</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
    </span><span class="entity"><span>erhs</span></span><span> </span><span>|&gt;</span><span> </span><span>Term.exists_subterm</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Var</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Vars.defined</span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_reorient</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>rewrite_rule_extra_vars</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="entity"><span>rhs</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
  </span><span>is_Var</span><span> </span><span class="main"><span>(</span></span><span>head_of</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
</span><span class="comment1"><span>(* turns t = x around, which causes a headache if x is a local variable -
   usually it is very useful :-(
  is_Free rhs andalso not(is_Free lhs) andalso not(Logic.occs(rhs,lhs))
  andalso not(exists_subterm is_Var lhs)
    orelse
*)</span></span><span>
  </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Logic.occs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rhs</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
  </span><span>null</span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Pattern.matches</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span>
    </span><span class="comment1"><span>(*the condition "null prems" is necessary because conditional rewrites
      with extra variables in the conditions may terminate although
      the rhs is an instance of the lhs; example: ?m &lt; ?n ⟹ f ?n ≡ f ?m *)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
  </span><span>is_Const</span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>is_Const</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_mk_eq_True</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.mk_obj_eq</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span>RS</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Eq_TrueI|fact"><span>Eq_TrueI</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Thm.THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_mk_sym</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span>Drule.symmetric_thm</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Simp_Reorient</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span>
         * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span class="main"><span>)</span></span><span>
         * </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>default_reorient</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>default_mk_eq_True</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>default_mk_sym</span></span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars_set</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vars.build</span><span> </span><span>o</span><span> </span><span>Vars.add_vars</span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>vperm</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vperm</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vperm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vperm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vperm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u1</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>vperm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u2</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>vperm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>var_perm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>vperm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>Vars.eq_set</span><span> </span><span class="main"><span>(</span></span><span>apply2</span><span> </span><span class="entity"><span>vars_set</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>u</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>decomp_simp</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.strip_imp_prems</span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.strip_imp_concl</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_equals</span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Raw_Simplifier.SIMPLIFIER</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Rewrite rule not a meta-equality"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_arg</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="main"><span>(</span></span><span>Thm.eta_conversion</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>erhs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.eta_contract</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>perm</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>var_perm</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>elhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>erhs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
      </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>elhs</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>erhs</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
      </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>is_Var</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>elhs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>elhs</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>perm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_eq_True</span></span><span> </span><span class="entity"><span>mk_eq_True</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mk_eq_True</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>eq_True</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>elhs</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decomp_simp</span></span><span> </span><span class="entity"><span>eq_True</span></span><span class="main"><span>;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>{</span></span><span>thm </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_True</span></span><span class="main"><span>,</span></span><span> name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> lhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> elhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>elhs</span></span><span class="main"><span>,</span></span><span> perm </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rewrite_rule_extra_vars</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>elhs</span></span><span> </span><span class="entity"><span>erhs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>elhss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>elhs</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tvars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>TVars.build</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>TVars.add_tvars</span><span> </span><span class="entity"><span>elhss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vars.build</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span>Vars.add_vars</span><span> </span><span class="entity"><span>elhss</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>erhs</span></span><span> </span><span>|&gt;</span><span> </span><span>Term.exists_type</span><span> </span><span class="main"><span>(</span></span><span>Term.exists_subtype</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>TVar</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>TVars.defined</span><span> </span><span class="entity"><span>tvars</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
    </span><span class="entity"><span>erhs</span></span><span> </span><span>|&gt;</span><span> </span><span>Term.exists_subterm</span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>Var</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Vars.defined</span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rrule_eq_True</span></span><span> </span><span class="entity"><span>meT</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="entity"><span>elhs</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>thm2</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rrule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>thm </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> lhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> elhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>elhs</span></span><span class="main"><span>,</span></span><span> perm </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>rewrite_rule_extra_vars</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="entity"><span>mk_eq_True</span></span><span> </span><span class="entity"><span>meT</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rrule</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rrule</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>orient_rrule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reorient</span></span><span class="main"><span>,</span></span><span class="entity"><span>meT</span></span><span class="main"><span>,</span></span><span class="entity"><span>mk_sym</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prems</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>elhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>perm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decomp_simp</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>perm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>{</span></span><span>thm </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> lhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lhs</span></span><span class="main"><span>,</span></span><span> elhs </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>elhs</span></span><span class="main"><span>,</span></span><span> perm </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>reorient</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>reorient</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>lhs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>mk_eq_True</span></span><span> </span><span class="entity"><span>meT</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>mk_sym</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
          </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lhs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>elhs'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rhs'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>decomp_simp</span></span><span> </span><span class="entity"><span>thm'</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>rrule_eq_True</span></span><span> </span><span class="entity"><span>meT</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm'</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>lhs'</span></span><span> </span><span class="entity"><span>elhs'</span></span><span> </span><span class="entity"><span>rhs'</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>rrule_eq_True</span></span><span> </span><span class="entity"><span>meT</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>lhs</span></span><span> </span><span class="entity"><span>elhs</span></span><span> </span><span class="entity"><span>rhs</span></span><span> </span><span class="entity"><span>thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_rews</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mk</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Simplifier.mksimps</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="main"><span>(</span></span><span>Thm.get_name_hint</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thms</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>extract_safe_rrules</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span>thm </span><span>o</span><span> </span><span class="entity"><span>orient_rrule</span></span><span> </span><span class="entity"><span>cfg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extract_rews</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>simp_timeout</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.declare_int</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"φLPR.rule_gen.timeout"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>100</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>asm_lr_simplify</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>simp_concl</span></span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reorient_cfg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Simp_Reorient.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pass_premises</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.no_prems</span><span> </span><span class="entity"><span>rule</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>simp_concl</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.exists_Const</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.SIMP|const"><span>SIMP</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
                                                        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>SIMP_conv</span></span><span> </span><span class="entity"><span>Simplifier.rewrite</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span>
              </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule'1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Conv.gconv_rule</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Reasoners.asm_lr_rewrite</span></span><span> </span><span>false</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>rule</span></span><span>
                 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cprem</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cprem_of</span><span> </span><span class="entity"><span>rule'1</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>cprem</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>pass_premises</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span>Conv.fconv_rule</span><span> </span><span class="main"><span>(</span></span><span>Conv.rewr_conv</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.True_implies_equals|fact"><span>True_implies_equals</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule'1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>prem_tm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.exists_Const</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.SIMP|const"><span>SIMP</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span>
                                                </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prem_tm</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"SIMP tag can only occur in conclusion"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule0</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lprem</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.assume_hyps</span><span> </span><span class="entity"><span>cprem</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Reasoners.extract_implied_fact</span></span><span> </span><span class="main"><span>{</span></span><span>wrap_all</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lprem</span></span><span class="main"><span>)</span></span><span>
                          </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_simp_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                          </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>extract_safe_rrules</span></span><span> </span><span class="entity"><span>reorient_cfg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addsimps</span><span> </span><span class="entity"><span>facts</span></span><span>
                 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule'2</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.implies_elim</span><span> </span><span class="entity"><span>rule'1</span></span><span> </span><span class="entity"><span>lprem</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>pass_premises</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cprem</span></span><span>::</span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule'2</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule'</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import</span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule0</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>hyps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pass_premises</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span>Thm.implies_intr</span><span> </span><span class="entity"><span>hyps</span></span><span> </span><span class="entity"><span>rule</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>asm_lr_simplify'</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>simp_concl</span></span><span class="main"><span>,</span></span><span class="entity"><span>timeout</span></span><span class="main"><span>,</span></span><span>rule_pos</span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span class="entity"><span>template_pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>inst_pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Timeout.apply</span><span> </span><span class="entity"><span>timeout</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>asm_lr_simplify</span></span><span> </span><span class="main"><span>{</span></span><span>simp_concl</span><span class="main"><span>=</span></span><span class="entity"><span>simp_concl</span></span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule0</span></span><span>
  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Timeout.TIMEOUT</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Generation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span>block</span><span> </span><span class="main"><span>(</span></span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"Simplification for"</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span>
                 </span><span>@</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Binding.pretty</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"an instantiation"</span></span><span class="main"><span>)</span></span><span>
                 </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span>here</span><span> </span><span class="entity"><span>inst_pos</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span>
                 </span><span>@</span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"of template"</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span>here</span><span> </span><span class="entity"><span>template_pos</span></span><span>
                 </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"timeouts"</span></span><span> </span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*simplify the generated rule except the conclusion by default, unless a part of the conclusion has
  been annotated by ‹NO_SIMP› (i.e., ‹NO_SIMP› occurs in the conclusion)*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pass_generated_rule</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>simp</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>masks</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule_pos</span></span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="comment1"><span>(*val rule'1 = case Thm.concl_of rule
                     of Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹NO_SIMP'›, _) $ _ =&gt; rule
                      | Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹Trueprop›, _) $ (Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹NO_SIMP›, _) $ _) =&gt; rule
                      | X =&gt; if exists_Const (fn (<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹NO_SIMP›, _) =&gt; true | _ =&gt; false) X
                             then rule
                             else rule RS' (ctxt, @{thm' NO_SIMP'_I})*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule'1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt's</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Rule_Gen_SS.enhance</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trim_tag</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.NO_SIMP|const"><span>NO_SIMP</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trim_tag</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>trim_tag</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.NO_SIMP&apos;|const"><span>NO_SIMP'</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trim_tag</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>trim_tag</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trim_tag</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trim_tag</span></span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>B'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>A'</span></span><span> </span><span>$</span><span> </span><span>the_default</span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="entity"><span>B'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>trim_tag</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trim_tag</span></span><span> </span><span class="entity"><span>X</span></span><span>
                                 </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>trim_tag</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simplify'</span></span><span> </span><span class="entity"><span>rule'1</span></span><span> </span><span class="main"><span>=</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule'2</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import</span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule'1</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt's</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>rule'2</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>simp</span></span><span> </span><span>?</span><span> </span><span class="main"><span>(</span></span><span> </span><span class="entity"><span>Simplification_Protect.protect</span></span><span> </span><span class="entity"><span>ctxt'1</span></span><span>
                   </span><span>#&gt;</span><span> </span><span class="entity"><span>asm_lr_simplify'</span></span><span> </span><span class="main"><span>{</span></span><span>simp_concl</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>,</span></span><span>
                                        timeout</span><span class="main"><span>=</span></span><span>Time.fromMilliseconds</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt'1</span></span><span> </span><span class="entity"><span>simp_timeout</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                        rule_pos</span><span class="main"><span>=</span></span><span class="entity"><span>rule_pos</span></span><span class="main"><span>}</span></span><span>
                      </span><span class="entity"><span>ctxt'1</span></span><span>
                      </span><span class="comment1"><span>(*Phi_Reasoners.asm_lr_simplify true ctxt's*)</span></span><span>
                   </span><span>#&gt;</span><span> </span><span class="entity"><span>Simplification_Protect.unprotect</span></span><span> </span><span class="entity"><span>ctxt'1</span></span><span> </span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt'1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
          </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.unique_flexflex</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>simplify</span></span><span> </span><span class="entity"><span>rule'1</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule'3</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>simplify'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule'1</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PLPR_Syntax.strip_embedded_patterns</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rule'3</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trim_tag</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span>

            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>masks'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>masks</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>M</span></span><span>
                                                 </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>IN_Arg.default_mask_of</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl'</span></span><span>
                                                 </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>M</span></span><span>
                                     </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>IN_Arg.default_mask_of</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl'</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inargs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>IN_Arg.parse_mask</span></span><span> </span><span class="entity"><span>masks'</span></span><span> </span><span class="entity"><span>concl'</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>Phi_Help.instantiate_higher_order_schematic_var_for_rule'</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inargs</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule'3</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>simp</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>simplify</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>rule'3</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>simplify</span></span><span> </span><span class="entity"><span>rule'1</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Simplifier.rewrite_rule</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thms'</span></span><span> </span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.NO_SIMP_def|fact"><span>NO_SIMP_def</span></a><span> </span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.NO_SIMP&apos;_def|fact"><span>NO_SIMP'_def</span></a><span> </span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.SIMP_def|fact"><span>SIMP_def</span></a><span class="antiquote"><span>}</span></span></span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>PLPR_Syntax.merge_guards</span></span><span> </span><span class="main"><span>{</span></span><span>merge_cond</span><span class="main"><span>=</span></span><span>true</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>normalize</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>short_name_of_leading_const</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>short_name_of_leading_const</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>short_name_of_leading_const</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>short_name_of_leading_const</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>short_name_of_leading_const</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Long_Name.base_name</span><span> </span><span class="entity"><span>N</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>short_name_of_leading_const</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>short_name_of_leading_const</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Match</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invoke_generation</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>template_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pass</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>action</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bind</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>positioned_props</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
     </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>Phi_Reasoner_solve_obligation_and_no_defer</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>Config.put</span><span> </span><span class="entity"><span>Phi_Reasoner.trace</span></span><span> </span><span class="main"><span>(</span></span><span>Config.get_generic</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold_pad</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_pad</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_pad</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold_pad</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold_pad</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>bind</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"ToR_scala_assoc_right"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule'1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.transfer'</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span>
                    </span><span>|&gt;</span><span> </span><span class="entity"><span>fold_pad</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>positioned_prop''</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="comment1"><span>(*datatype mode = Reason | Oblg | Normal*)</span></span><span>
                            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>positioned_prop''</span></span><span>
                            
                            </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_position</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_position</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="entity"><span>data</span></span><span>
                              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_position</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span>
                                                  </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span>
                                                  </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;A&gt;_template_reason|const"><span>𝒜_template_reason</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                               </span><span class="entity"><span>data</span></span><span>
                                 </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>parse_position</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                      </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag_I|fact"><span>Action_Tag_I</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RSN</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>)</span></span><span>
                              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_position</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;r&gt;Guard|const"><span>𝗋Guard</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LPR</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
                                 </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>prop</span></span><span>
                                      </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>propx</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                          </span><span class="main"><span>(</span></span><span class="entity"><span>LPR</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PLPR_Syntax.guardize</span></span><span> </span><span class="main"><span>{</span></span><span>merge_cond</span><span class="main"><span>=</span></span><span>true</span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
                                                                           </span><span class="main"><span>(</span></span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>propx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>propx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                           </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;r&gt;Guard_I|fact"><span>𝗋Guard_I</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RSN</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LPR</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_position</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.term</span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>prop</span><span>›</span></span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span>
                                 </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>parse_position</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LPR</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                      </span><span class="main"><span>(</span></span><span class="entity"><span>LPR</span></span><span class="main"><span>,</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>Drule.mk_term</span><span> </span><span>o</span><span> </span><span>Thm.cconcl_of</span><span> </span><span>o</span><span> </span><span>Thm.transfer''</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>)</span></span><span>
                              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_position</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.term</span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span>
                                 </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>parse_position</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LPR</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                      </span><span class="main"><span>(</span></span><span class="entity"><span>LPR</span></span><span class="main"><span>,</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>Drule.mk_term</span><span> </span><span>o</span><span> </span><span class="entity"><span>Phi_Help.dest_Trueprop_c</span></span><span> </span><span>o</span><span> </span><span>Thm.cconcl_of</span><span> </span><span>o</span><span> </span><span>Thm.transfer''</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>)</span></span><span>
                              </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>parse_position</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>data</span></span><span>

                            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>is_reasoning_goal</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm'1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                                  </span><span class="entity"><span>parse_position</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.strip_assums_concl</span><span> </span><span class="main"><span>(</span></span><span>Logic.nth_prem</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                                 </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop''</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>

                            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>delt</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm'2</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>prop'</span></span><span>
                                                  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="entity"><span>RSN'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm'1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                                       </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                                                          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Generation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                                            </span><span class="main"><span>[</span></span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"unification fails in instantiating the"</span></span><span> </span><span>@</span><span>
                                                                   </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="inner_quoted"><span>"th"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
                                                                   </span><span>text</span><span> </span><span class="inner_quoted"><span>"antecedent of the template"</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span>here</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                                             </span><span>item</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"template:"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>thm'1</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                                                             </span><span>item</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"property:"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                                                        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                                                   </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm'1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm'3</span></span><span> </span><span class="main"><span>=</span></span><span>
                                 </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>is_reasoning_goal</span></span><span>
                                   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>err_term</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                      </span><span class="entity"><span>thm'2</span></span><span> </span><span>|&gt;</span><span> </span><span>Thm.permute_prems</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>i</span></span><span>
                                            </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Reasoner.reason</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>delt</span></span><span class="main"><span>)</span></span><span>
                                                                   </span><span class="main"><span>(</span></span><span>Config.map</span><span> </span><span class="entity"><span>Phi_Reasoner.trace</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>=&gt;</span></span><span class="entity"><span>i</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
                                            </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>th</span></span><span>
                                                 </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span>
                                                     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>err_term</span></span><span>
                                                     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/Option.html#Option.option.Some|const"><span>Some</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>text</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                                          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Generation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                                            </span><span class="main"><span>[</span></span><span class="entity"><span>Text_Encoding.decode_text_pretty</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                                                      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.undefined|const"><span>undefined</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                                          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Generation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
                                                            </span><span class="main"><span>[</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"fail to reason a compulsory antecedent"</span></span><span class="main"><span>,</span></span><span>
                                                             </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.nth_prem</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm'2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                                                      </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/Option.html#Option.option.None|const"><span>None</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                                          </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Generation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>3</span></span><span class="main"><span>,</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
                                                            </span><span class="main"><span>[</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"fail to reason a compulsory antecedent"</span></span><span class="main"><span>,</span></span><span>
                                                             </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.nth_prem</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm'2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                                                      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Unrecognizable error text"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>X</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                                                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                                            </span><span>|&gt;</span><span> </span><span>Thm.permute_prems</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span>~</span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
                                  </span><span class="comment1"><span>(*| Oblg =&gt; Conv.gconv_rule (
                                                Raw_Simplifier.rewrite ctxt' false @{thms' 𝒜_template_condition_def}
                                             ) (i+1) thm'2*)</span></span><span>
                                    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>thm'2</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_some</span><span> </span><span class="entity"><span>is_reasoning_goal</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>delt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm'3</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.nprems_of</span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>positioned_props</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>snd</span><span>
                    </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.cases</span><span> </span><span>Global_Theory.facts_of</span><span> </span><span>Proof_Context.facts_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>varify_binding</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Binding.suffix_name</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"⇩"</span></span><span> </span><span>^</span><span> </span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span>
                            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>iname</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.cases</span><span> </span><span>Sign.full_name</span><span> </span><span>Proof_Context.full_name</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>b'</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Facts.defined</span><span> </span><span class="entity"><span>facts</span></span><span> </span><span class="entity"><span>iname</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>varify_binding</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>b'</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>string_of</span><span> </span><span class="main"><span>(</span></span><span>chunks</span><span> </span><span class="main"><span>[</span></span><span>
                                    </span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"The binding target"</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
                                           </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="inner_quoted"><span>"/"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span> </span><span>@</span><span>
                                           </span><span>text</span><span> </span><span class="inner_quoted"><span>"is not instantaited to any constant φ-type,"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                                    </span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"in template"</span></span><span> </span><span>@</span><span>
                                           </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                                 </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span>Envir.Envir</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>tenv</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qualify</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Vartab.lookup</span><span> </span><span class="entity"><span>tenv</span></span><span> </span><span class="entity"><span>v</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Binding.qualify</span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>short_name_of_leading_const</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>Match</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vs</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>varify_binding</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qualify</span></span><span> </span><span class="entity"><span>b'</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bind</span></span><span>

          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pattern_of</span></span><span> </span><span class="entity"><span>action</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pass</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ps</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>ps</span></span><span> </span><span class="main"><span>(</span></span><span>single</span><span> </span><span>o</span><span> </span><span class="entity"><span>pass_generated_rule</span></span><span> </span><span class="main"><span>{</span></span><span>simp</span><span class="main"><span>=</span></span><span>true</span><span class="main"><span>,</span></span><span> masks</span><span class="main"><span>=</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> rule_pos</span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span class="entity"><span>template_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>
                                                 </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule'1</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pass_generated_rule</span></span><span> </span><span class="main"><span>{</span></span><span>simp</span><span class="main"><span>=</span></span><span>true</span><span class="main"><span>,</span></span><span> masks</span><span class="main"><span>=</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> rule_pos</span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span class="entity"><span>template_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>
                                            </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>rule'1</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span class="entity"><span>PLPR_Syntax.elim_embedded_patterns</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules'</span></span><span>

       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>rules'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>
       </span><span class="entity"><span>Phi_Reasoner.info_pretty_generic</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
         </span><span>chunks</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>paragraph</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"Instantiate reasoning template"</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
                             </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Binding.pretty</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
                             </span><span>here</span><span> </span><span class="entity"><span>template_pos</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
                 </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Reasonig_Rule</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Attributes</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>item</span><span> </span><span class="main"><span>[</span></span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules'</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>No_Action</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span>
       </span><span class="entity"><span>invoke_action</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>template_pos</span></span><span class="main"><span>,</span></span><span> </span><span>Option.map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>pass</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="entity"><span>rules'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span>
          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>perhaps</span><span> </span><span class="main"><span>(</span></span><span>try</span><span> </span><span class="main"><span>(</span></span><span>Context.mapping</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>Global_Theory.note_thms</span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>rules''</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                              </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>Proof_Context.note_thms</span><span> </span><span class="inner_quoted"><span>""</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>rules''</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="comment1"><span>(*It is not a Local_Theory.note here because the instantiation usually happens
                          inside an attribute and when a locale is interpreted, the attribute will be replayed.*)</span></span><span>
                        </span><span class="comment1"><span>(*I want to support lazy instantiation, but, to provide this, the Proof.context
                          has to be involved in the closure and that would consume a lot of memory.
                          Perhaps we could use the mechanism of dynamic fact, I am not sure which is better,
                          some test is required.*)</span></span><span>
      </span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Generation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lev</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>Phi_Reasoner.warn_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>chunks</span><span> </span><span class="main"><span>(</span></span><span>
              </span><span class="main"><span>[</span></span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"During instantiating"</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
                </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>bind</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>text</span><span> </span><span class="inner_quoted"><span>"a template"</span></span><span>
                            </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span>Binding.pretty</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span>here</span><span> </span><span class="entity"><span>template_pos</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>","</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
            </span><span>@</span><span> </span><span class="entity"><span>prt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span>
        </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule_template_pass__sender</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule_generation_pass</span></span><span> * </span><span class="entity"><span>Phi_Reasoner.rule_pass</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>Unsynchronized.ref</span><span>
      </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span>NONE</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule_template_pass__sender_locker</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.var</span><span> </span><span class="inner_quoted"><span>"rule_template_pass__sender_locker"</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(*
val parser = Scan.option (Scan.lift (Args.$$$ "pass" |-- <span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span>‹:› |-- Parse.ML_source))
          -- Scan.option Attrib.attribs*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_pass</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.change</span><span> </span><span class="entity"><span>rule_template_pass__sender_locker</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
                  </span><span>ML_Context.expression</span><span> </span><span class="main"><span>(</span></span><span>Input.pos_of</span><span> </span><span class="entity"><span>src</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>(</span></span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>"PLPR_Rule_Gen.rule_template_pass__sender := SOME ("</span></span><span> </span><span>@</span><span>
                     </span><span>ML_Lex.read_source</span><span> </span><span class="entity"><span>src</span></span><span> </span><span>@</span><span>
                     </span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="entity"><span>ctxt</span></span><span class="main"><span>;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>rule_template_pass__sender</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rule_template_pass__sender</span></span><span> </span><span>:=</span><span> </span><span>NONE</span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>pass</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_action</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prio_group</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attribs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>attribs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prio_group</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>attrs</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Attributes</span></span><span> </span><span class="entity"><span>attrs</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>No_Action</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>error</span><span> </span><span class="inner_quoted"><span>"Prioirty and binding patterns are senseless and not allowed to\
              \ be given once the attributes are given."</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>Reasonig_Rule</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prio_group</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>parse_binding_template</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="entity"><span>raw_binding</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import</span><span> </span><span>true</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>template</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>read_terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.export_terms</span><span> </span><span class="entity"><span>ctxt_parse</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>o</span><span> </span><span>Syntax.read_terms</span><span> </span><span class="entity"><span>ctxt_parse</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_binding_target</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_binding_target</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>string_of</span><span> </span><span class="main"><span>(</span></span><span>
                    </span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"The binding of the template instances must binds to a \
                                \variable in the template that will be instantaited to to φ-type.\
                                \ However, the given binding target is not a variable,"</span></span><span> </span><span>@</span><span>
                           </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Context.cases</span><span> </span><span>Syntax.pretty_term_global</span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>long_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.split_last</span></span><span> </span><span class="main"><span>(</span></span><span>Long_Name.explode</span><span> </span><span class="entity"><span>long_name</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>chk_binding_target</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>read_terms</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Binding.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                    </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_binding</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>binding</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_rule_generation_pass</span></span><span> </span><span class="entity"><span>template'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trim_template</span></span><span> </span><span class="entity"><span>template'</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pass_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rule</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qvars</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mprem</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.leading_antecedent</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maxidx_of_term</span><span> </span><span class="entity"><span>mprem</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>qfix</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Var</span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span>+</span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>qvars</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>qfix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mprem</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pidx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span>+</span><span> </span><span>length</span><span> </span><span class="entity"><span>qfix</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pass</span></span><span> </span><span class="entity"><span>ins_pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Phi_Reasoner.pass_data</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get_generic</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>enable_reason_generator</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.incr_indexes</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>pidx</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cidx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maxidx_of_term</span><span> </span><span class="entity"><span>concl</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.chop</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span>Unify.hounifiers</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span>Envir.empty</span><span> </span><span class="entity"><span>cidx</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pattern</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>env'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ins_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Phi_Reasoner.warn_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                                            </span><span>chunks</span><span> </span><span class="main"><span>[</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"Failed to instantiate a template due to multi-resolution"</span></span><span class="main"><span>,</span></span><span>
                                                    </span><span>block</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Template: "</span></span><span class="main"><span>,</span></span><span> </span><span>Context.cases</span><span> </span><span>Thm.pretty_thm_global</span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                                                    </span><span>block</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Argument: "</span></span><span class="main"><span>,</span></span><span> </span><span>Context.cases</span><span> </span><span>Thm.pretty_thm_global</span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
                                           </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>invoke_generation</span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ins_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>SOME</span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>data</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoner.info_pretty_generic</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                </span><span>chunks</span><span> </span><span class="main"><span>[</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"Registered φ-LPR generator binding on pattern"</span></span><span class="main"><span>,</span></span><span>
                        </span><span>item</span><span> </span><span class="main"><span>[</span></span><span>Context.cases</span><span> </span><span>Syntax.pretty_term_global</span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pattern</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Phi_Reasoner.add_pass</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pass_id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pass</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rule_attribute</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.is_free_dummy</span><span> </span><span class="entity"><span>th</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="PLPR.\&lt;phi&gt;simplify_reasoning_rule|attribute"><span>φsimplify_reasoning_rule</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule_attribute</span></span><span> </span><span class="main"><span>(</span></span><span>
          </span><span class="entity"><span>pass_generated_rule</span></span><span> </span><span class="main"><span>{</span></span><span>simp</span><span class="main"><span>=</span></span><span>true</span><span class="main"><span>,</span></span><span> masks</span><span class="main"><span>=</span></span><span>NONE</span><span class="main"><span>,</span></span><span> rule_pos</span><span class="main"><span>=</span></span><span class="main"><span>(</span></span><span>Position.none</span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>}</span></span><span>
        </span><span>o</span><span> </span><span>Context.proof_of</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="inner_quoted"><span>"Simplify a reasoning rule, using the same process as that in template instantiation.\n\
    \The conclusion of the rule is remained untouched and any antecedents are simplified and reduced\
    \if possible. ‹NO_SIMP› tag is recognized and supresses the simplification on the protected terms."</span></span><span>

   </span><span>#&gt;</span><span> </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="PLPR.\&lt;phi&gt;reason_generator|attribute"><span>φreason_generator</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="entity"><span>Phi_Reasoner.attr_syntax</span></span><span>
        </span><span class="main"><span>(</span></span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"name"</span></span><span> </span><span>|--</span><span> </span><span>Parse.position</span><span> </span><span>Parse.long_ident</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"pass"</span></span><span> </span><span>|--</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>:</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.ML_source</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span class="entity"><span>Attrib.attribs</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prio_group</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>raw_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pass_src</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attribs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_binding_template</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>raw_binding</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"No guard is allowed here"</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_pass</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pass_src</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parse_action</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prio_group</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attribs</span></span><span class="main"><span>)</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pass</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>action</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>binding</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>setup_rule_generation_pass</span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"declaring a template of a single parameter as its leading antecedent. \
        \The instantiation invokes any time a registered reasoning rule matching the first antecedent, \
        \yielding a new reasoning rule (or as declared by the given attribute) "</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="main"><span>)</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>end</span></span></span></pre>
</body>

</html>