<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/helpers0.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/helpers0.ML›</h1>
</div>

<pre class="source"><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>REQUIRE_LAMBDA_NORMLAIZTION</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PHI_HELP</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>include</span></span></span><span> </span><span class="entity"><span>PHI_HELP</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> warn_when_visible </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> take_last </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> last </span><span class="main"><span>:</span></span><span> 'a </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> front </span><span class="main"><span>:</span></span><span> 'a </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> split_last </span><span class="main"><span>:</span></span><span> 'a </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>list</span><span> * 'a
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> repeat </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ntimes </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span class="main"><span>-&gt;</span></span><span> 'a

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> max_of </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a * 'a </span><span class="main"><span>-&gt;</span></span><span> </span><span>order</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>option</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> min_of </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a * 'a </span><span class="main"><span>-&gt;</span></span><span> </span><span>order</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>option</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> max_of' </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a * 'a </span><span class="main"><span>-&gt;</span></span><span> </span><span>order</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>option</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>option</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> min_of' </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a * 'a </span><span class="main"><span>-&gt;</span></span><span> </span><span>order</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>option</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> binop_opt </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a * 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>option</span><span> * 'a </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>option</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> foldl_opt </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a * 'a </span><span class="main"><span>-&gt;</span></span><span> 'a</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>option</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>option</span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> leading_antecedent' </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> LHS_of </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> RHS_of </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pos_parser </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Position.T</span><span> </span><span>parser</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> beta_eta_conversion </span><span class="main"><span>:</span></span><span> </span><span>conv</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> beta_eta_contract </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> beta_eta_contract_cterm </span><span class="main"><span>:</span></span><span> </span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> beta_eta_contract_term </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> beta_eta_contract_leading_antecedent </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lambda_normalization_ctac </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>'a * </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'b</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>'a * </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'b</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lambda_normalization_conv </span><span class="main"><span>:</span></span><span> </span><span>conv</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>conv</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lambda_normalization_rule </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> unique_flexflex </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> list_mk_conj </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> list_mk_disj </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> conj_intros</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
</span><span class="comment1"><span>(*val conj_elim  : thm -&gt; thm * thm
val conj_elims : thm -&gt; thm list*)</span></span><span>


</span><span class="comment1"><span>(*For tyenv/tenv given from Pattern.match*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> subst_tyenv </span><span class="main"><span>:</span></span><span> </span><span>Type.tyenv</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>TVars.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> subst_tenv  </span><span class="main"><span>:</span></span><span> </span><span>Type.tyenv</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Envir.tenv</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>Vars.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> subst_env   </span><span class="main"><span>:</span></span><span> </span><span>Type.tyenv</span><span> * </span><span>Envir.tenv</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>TVars.table</span><span> * </span><span>term</span><span> </span><span>Vars.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> subst_env'  </span><span class="main"><span>:</span></span><span> </span><span>Envir.env</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>TVars.table</span><span> * </span><span>term</span><span> </span><span>Vars.table</span><span>

</span><span class="comment1"><span>(*For tyenv/tenv given from Pattern.unify*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> norm_tyenv </span><span class="main"><span>:</span></span><span> </span><span>Type.tyenv</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>TVars.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> norm_tenv  </span><span class="main"><span>:</span></span><span> </span><span>Type.tyenv</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Envir.tenv</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>Vars.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> norm_env </span><span class="main"><span>:</span></span><span> </span><span>Type.tyenv</span><span> * </span><span>Envir.tenv</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>TVars.table</span><span> * </span><span>term</span><span> </span><span>Vars.table</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> certify_tyvars </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>TVars.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>ctyp</span><span> </span><span>TVars.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> certify_tmvars </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>Vars.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span>Vars.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> certify_vars </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>TVars.table</span><span> * </span><span>term</span><span> </span><span>Vars.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>ctyp</span><span> </span><span>TVars.table</span><span> * </span><span>cterm</span><span> </span><span>Vars.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> uncertify_tyvars </span><span class="main"><span>:</span></span><span> </span><span>ctyp</span><span> </span><span>TVars.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>TVars.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> uncertify_tmvars </span><span class="main"><span>:</span></span><span> </span><span>cterm</span><span> </span><span>Vars.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>Vars.table</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> uncertify_vars   </span><span class="main"><span>:</span></span><span> </span><span>ctyp</span><span> </span><span>TVars.table</span><span> * </span><span>cterm</span><span> </span><span>Vars.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>typ</span><span> </span><span>TVars.table</span><span> * </span><span>term</span><span> </span><span>Vars.table</span><span>

</span><span class="comment1"><span>(*val tvars_table_to_tyenv : ctyp TVars.table -&gt; Type.tyenv
  val vars_table_to_tenv : cterm Vars.table -&gt; Envir.tenv*)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> instantiate_higher_order_var </span><span class="main"><span>:</span></span><span> </span><span>indexname</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*escape*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>Vars.table</span><span>
</span><span class="comment1"><span>(*Instantiate higher-order schematic variable whose all occurrences are applied to an argument
  containing no loose bound variable.*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> instantiate_higher_order_var_in_antecedents' </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="comment1"><span>(*N*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*returns none if no change*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> instantiate_higher_order_var_in_antecedents </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="comment1"><span>(*N*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
</span><span class="comment1"><span>(*For the leading N antecedents only, if there is any higher-order schematic variable
which is applied to an argument containing no loose bound variable,
instantiate the schematic variable to the constant function on that parameter, ‹λ_. ?var›.

Different with instantiate_higher_order_var, the instantiation works successively for each leading
antecedent in order. `instantiate_higher_order_var` requires *all occurrences* of a HO
variable *in the whole proposition* have an argument containing no loose bound,
whereas `instantiate_higher_order_var_in_antecedents'` only checks the occurrences *in the leading
antecedent* one-by-one in order. Once a such HO variable is seen in the leading antecedent, it is instantiated,
no matter how it is applied in the subsequent antecedents nor the conclusion. This is identical to the
way of how φ-LPR works, in the order of evaluating the antecedents.

N = ~1 means all antecedents

It assumes all variables can be instantiated arbitrarily.
However, for a reasoning rule, not all variables can be instantiated arbitrarily.
Some of them are IN-arguments which matches the input of a reasoning goal, so they should be considered
fixed, while others are OUT-arguments which assigns output to the reasoning goal, so they can be
instantiated arbitrarily.

Due to this issue, to simplify the higher order variables of a reasoning rule, the role of the
variables have to be given.

Also see Phi_Help.guess_IN_arguments_of_a_rule given latter
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> instantiate_higher_order_schematic_var_for_rule' </span><span class="main"><span>:</span></span><span>
        </span><span>int</span><span> </span><span class="comment1"><span>(*N*)</span></span><span> * </span><span>indexname</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*IN-arguments to be fixed*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
        </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*returns none if no change*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> instantiate_higher_order_schematic_var_for_rule  </span><span class="main"><span>:</span></span><span>
        </span><span>int</span><span> </span><span class="comment1"><span>(*N*)</span></span><span> * </span><span>indexname</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*IN-arguments to be fixed*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
        </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>





</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Phi_Help</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PHI_HELP</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>
</span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Phi_Help</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>warn_when_visible</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Context_Position.is_visible_generic</span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="entity"><span>msg</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>last</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"last"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>last</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>last</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span>::</span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>last</span></span><span> </span><span class="entity"><span>ls</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>front</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>Fail</span><span> </span><span class="inner_quoted"><span>"front"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>front</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>x</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>front</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span>::</span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>front</span></span><span> </span><span class="entity"><span>ls</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split_last</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>front</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>last</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>take_last</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.drop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>L</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>repeat</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>repeat</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ntimes_i</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ntimes_i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>x</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ntimes</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ntimes_i</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>x</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>max_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>max_of</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>foldl1</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ab</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>ab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LESS</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>ab</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>ab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>min_of</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>min_of</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>foldl1</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ab</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>ab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>GREATER</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>ab</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>ab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>binop_opt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>binop_opt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>a</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>binop_opt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>b</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>binop_opt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>foldl_opt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fold</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ret</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>fold</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>fold</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>binop_opt</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>L</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>fold</span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>max_of'</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>foldl_opt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ab</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>ab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LESS</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>ab</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>ab</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>min_of'</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>foldl_opt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ab</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="entity"><span>ab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>GREATER</span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>snd</span><span> </span><span class="entity"><span>ab</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>ab</span></span><span class="main"><span>)</span></span><span>



</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>leading_antecedent'</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Logic.dest_implies</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>RHS_of</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>RHS_of</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>RHS_of</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>RHS_of</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>RHS_of</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"LHS_of"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>X</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>LHS_of</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>LHS_of</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>LHS_of</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>LHS_of</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>LHS_of</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"LHS_of"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>X</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pos_parser</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>" Fail to capture the position of your rule \
                  \when no argument is given to the attribute.\n\
                  \Please use ‹"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span> </span><span>^</span><span class="inner_quoted"><span>" add› to address it.\n\
                  \The recorded position can be very helpful for debuging, albeit it \
                  \is not mandatory.\n\
                  \It is a technical limitation of Isar."</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Token.pos_of</span><span> </span><span class="main"><span>(</span></span><span>hd</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Position.none</span><span>
                          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="entity"><span>msg</span></span><span>
                           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>beta_eta_contract</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.could_beta_eta_contract</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Thm.equal_elim</span><span> </span><span class="main"><span>(</span></span><span>Drule.beta_eta_conversion</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>th</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>beta_eta_contract_cterm</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.could_beta_eta_contract</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Thm.dest_arg</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="main"><span>(</span></span><span>Drule.beta_eta_conversion</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>x</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>beta_eta_contract_term</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.could_beta_eta_contract</span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Envir.beta_eta_contract</span><span> </span><span class="entity"><span>x</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>x</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>beta_eta_conversion</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.could_beta_eta_contract</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Drule.beta_eta_conversion</span><span> </span><span class="entity"><span>ctm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Conv.all_conv</span><span> </span><span class="entity"><span>ctm</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>beta_eta_contract_leading_antecedent</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.could_beta_eta_contract</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>leading_antecedent'</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Thm.equal_elim</span><span> </span><span class="main"><span>(</span></span><span>Conv.implies_conv</span><span> </span><span>Drule.beta_eta_conversion</span><span>
                                         </span><span>Conv.all_conv</span><span> </span><span class="main"><span>(</span></span><span>Thm.cprop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>th</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lambda_normalization_ctac</span></span><span> </span><span class="entity"><span>S</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="entity"><span>exn</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.could_beta_eta_contract</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>S</span></span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="entity"><span>beta_eta_contract</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Exn.reraise</span><span> </span><span class="entity"><span>exn</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>S</span></span><span> </span><span class="entity"><span>s</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>REQUIRE_LAMBDA_NORMLAIZTION</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="main"><span>(</span></span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Internal Bug: is already normalized"</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="entity"><span>e</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span>  </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="entity"><span>e</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="entity"><span>e</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lambda_normalization_conv</span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="entity"><span>ctm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="entity"><span>exn</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.could_beta_eta_contract</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>ctm</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span>Drule.beta_eta_conversion</span><span> </span><span>then_conv</span><span> </span><span class="entity"><span>C</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Exn.reraise</span><span> </span><span class="entity"><span>exn</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>C</span></span><span> </span><span class="entity"><span>ctm</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>REQUIRE_LAMBDA_NORMLAIZTION</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="main"><span>(</span></span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Internal Bug: is already normalized"</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="entity"><span>e</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span>  </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="entity"><span>e</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="entity"><span>e</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lambda_normalization_rule</span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="entity"><span>exn</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.could_beta_eta_contract</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>beta_eta_contract</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Exn.reraise</span><span> </span><span class="entity"><span>exn</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>R</span></span><span> </span><span class="entity"><span>thm</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>REQUIRE_LAMBDA_NORMLAIZTION</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="main"><span>(</span></span><span>Fail</span><span> </span><span class="inner_quoted"><span>"Internal Bug: is already normalized"</span></span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>CTERM</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="entity"><span>e</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>_</span></span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="entity"><span>e</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>e</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>_</span></span><span>  </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>fallback</span></span><span> </span><span class="entity"><span>e</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*a naive but most general flex-flex solver, which works only when the structures are identical*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>flex_solver_for_type</span></span><span> </span><span class="main"><span>(</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>N'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>N'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>maps</span><span> </span><span class="entity"><span>flex_solver_for_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>args</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>args'</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"naive_flex_solver"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Type</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>N'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args'</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>flex_solver_for_type</span></span><span> </span><span class="main"><span>(</span></span><span>TFree</span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span> </span><span>TFree</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TYPE</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"naive_flex_solver"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>TFree</span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span> </span><span>TFree</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>flex_solver_for_type</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="entity"><span>Va</span></span><span class="main"><span>,</span></span><span> </span><span>TVar</span><span> </span><span class="entity"><span>Vb</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Va</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Vb</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Va</span></span><span class="main"><span>,</span></span><span> </span><span>TVar</span><span> </span><span class="entity"><span>Vb</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>flex_solver_for_type</span></span><span> </span><span class="main"><span>(</span></span><span>TVar</span><span> </span><span class="entity"><span>Va</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tb</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>Va</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tb</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>flex_solver</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>T'</span></span><span class="main"><span>,</span></span><span class="entity"><span>X'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>flex_solver</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span class="main"><span>,</span></span><span class="entity"><span>X'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flex_solver_for_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>T</span></span><span class="main"><span>,</span></span><span class="entity"><span>T'</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>flex_solver</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>A'</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>flex_solver</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span class="main"><span>,</span></span><span class="entity"><span>A'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flex_solver</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>B</span></span><span class="main"><span>,</span></span><span class="entity"><span>B'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>flex_solver</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Na</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ta</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Nb</span></span><span class="main"><span>,</span></span><span class="entity"><span>Tb</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Na</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nb</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flex_solver_for_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ta</span></span><span class="main"><span>,</span></span><span class="entity"><span>Tb</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"naive_flex_solver"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Na</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ta</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Nb</span></span><span class="main"><span>,</span></span><span class="entity"><span>Tb</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>flex_solver</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>inst</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"naive_flex_solver"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Bound</span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span>Bound</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>flex_solver</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Na</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ta</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Nb</span></span><span class="main"><span>,</span></span><span class="entity"><span>Tb</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Na</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nb</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flex_solver_for_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ta</span></span><span class="main"><span>,</span></span><span class="entity"><span>Tb</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"naive_flex_solver"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Na</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ta</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Nb</span></span><span class="main"><span>,</span></span><span class="entity"><span>Tb</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>flex_solver</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Na</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ta</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Nb</span></span><span class="main"><span>,</span></span><span class="entity"><span>Tb</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>Na</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Nb</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>Ta</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tb</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flex_solver_for_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ta</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Tb</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Na</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ta</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Nb</span></span><span class="main"><span>,</span></span><span class="entity"><span>Tb</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>flex_solver</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Na</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ta</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>flex_solver_for_type</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ta</span></span><span class="main"><span>,</span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>instT</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Na</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ta</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>naive_flex_solver</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tpairs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.tpairs_of</span><span> </span><span class="entity"><span>thm</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>tpairs</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>flex_solver</span></span><span> </span><span class="entity"><span>tpairs</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ty_add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>TVars.defined</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"naive_flex_solver"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>TVars.add</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tm_add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Vars.defined</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>TERM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"naive_flex_solver"</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Vars.add</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>instTy'</span></span><span class="main"><span>=</span></span><span> </span><span>TVars.build</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>ty_add</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>instTy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>TVars.build</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_add</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>instTm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vars.build</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>
                      </span><span class="entity"><span>tm_add</span></span><span> </span><span>o</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Term_Subst.instantiate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instTy'</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.empty</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thm1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instTy</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>instTm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.declare_term_frees</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span>Name.context</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.add_vars</span><span> </span><span class="entity"><span>a</span></span><span> </span><span>o</span><span> </span><span>Term.add_vars</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.tpairs_of</span><span> </span><span class="entity"><span>thm1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fix_names</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Name.invent</span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="inner_quoted"><span>"𝗑"</span></span><span> </span><span class="main"><span>(</span></span><span>length</span><span> </span><span class="entity"><span>vars</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fix_names</span></span><span> </span><span class="entity"><span>vars</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span>Vars.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>vars</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm1</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Thm.flexflex_rule</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Seq.pull</span><span>
   </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"BUG: naive_flex_solver"</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Thm.generalize</span><span> </span><span class="main"><span>(</span></span><span>Names.empty</span><span class="main"><span>,</span></span><span> </span><span>Names.make_set</span><span> </span><span class="entity"><span>fix_names</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.maxidx_of</span><span> </span><span class="entity"><span>thm1</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>unique_flexflex</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="main"><span>(</span></span><span>Thm.tpairs_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>thm</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="comment1"><span>(*case try (naive_flex_solver ctxt) thm (*disabled because of deficiencies in Isabelle kernel*)
    of SOME ret =&gt; ret
     | NONE =&gt;*)</span></span><span> </span><span>Drule.flexflex_unique</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>list_mk_conj</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>list_mk_conj</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_conj</span></span><span> </span><span class="entity"><span>L</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>list_mk_disj</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.True|const"><span>True</span></a><span>›</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>list_mk_disj</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>foldr1</span><span> </span><span class="entity"><span>HOLogic.mk_disj</span></span><span> </span><span class="entity"><span>L</span></span><span>

</span><span class="comment1"><span>(*
fun conj_elim thPQ =
  let
    val _ = case Thm.prop_of thPQ
              of Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹Trueprop›, _) $ (Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹HOL.conj›, _) $ _ $ _) =&gt; ()
               | _ =&gt; raise THM ("conj_elim", 0, [thPQ])
    val (P, Q) = Thm.dest_binop (Thm.dest_arg (Thm.cprop_of thPQ))
      handle CTERM (msg, _) =&gt; raise THM (msg, 0, [thPQ]);
    val thP =
      Thm.implies_elim <span class="hidden">\&lt;^</span><span class="control">instantiate</span><span class="hidden">&gt;</span>‹P and Q in lemma (open) ‹P ∧ Q ⟹ P› by (rule conjunct1)› thPQ;
    val thQ =
      Thm.implies_elim <span class="hidden">\&lt;^</span><span class="control">instantiate</span><span class="hidden">&gt;</span>‹P and Q in lemma (open) ‹P ∧ Q ⟹ Q› by (rule conjunct2)› thPQ;
  in (thP, thQ) end;

fun conj_elims th =
  case Thm.prop_of th
    of <span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span>‹Trueprop› $ <span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span>‹True› =&gt; []
     | _ =&gt; let fun elim th =
                  let val (th1, th2) = conj_elim th
                   in elim th1 @ elim th2
                  end handle THM _ =&gt; [th]
             in elim th
            end
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>conj_intros</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.TrueI|fact"><span>TrueI</span></a><span class="antiquote"><span>}</span></span></span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>conj_intros</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>foldr1</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>HOLogic.conj_intr</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>L</span></span><span>

</span><span class="comment1"><span>(* Substitution \&amp; Instantiation *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_tyenv</span></span><span> </span><span class="entity"><span>tyenv</span></span><span>
  </span><span class="main"><span>=</span></span><span> </span><span>TVars.build</span><span> </span><span class="main"><span>(</span></span><span>Vartab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TVars.add</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tyenv</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm_tyenv</span></span><span> </span><span class="entity"><span>tyenv</span></span><span>
  </span><span class="main"><span>=</span></span><span> </span><span>TVars.build</span><span> </span><span class="main"><span>(</span></span><span>Vartab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>TVars.add</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Envir.norm_type</span><span> </span><span class="entity"><span>tyenv</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tyenv</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_tenv</span></span><span> </span><span class="entity"><span>tyenv</span></span><span> </span><span class="entity"><span>tenv</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Vars.build</span><span> </span><span class="main"><span>(</span></span><span>Vartab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>TY</span></span><span class="main"><span>,</span></span><span class="entity"><span>TM</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Vars.add</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span>Envir.subst_type</span><span> </span><span class="entity"><span>tyenv</span></span><span> </span><span class="entity"><span>TY</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                </span><span class="comment1"><span>(*Envir.subst_term_types tyenv*)</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.eta_contract</span><span> </span><span class="entity"><span>TM</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tenv</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm_tenv</span></span><span> </span><span class="entity"><span>tyenv</span></span><span> </span><span class="entity"><span>tenv</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Vars.build</span><span> </span><span class="main"><span>(</span></span><span>Vartab.fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>TY</span></span><span class="main"><span>,</span></span><span class="entity"><span>TM</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Vars.add</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span>Envir.norm_type</span><span> </span><span class="entity"><span>tyenv</span></span><span> </span><span class="entity"><span>TY</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                    </span><span>Envir.norm_term</span><span> </span><span class="main"><span>(</span></span><span>Envir.Envir</span><span> </span><span class="main"><span>{</span></span><span>maxidx </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>,</span></span><span> tenv</span><span class="main"><span>=</span></span><span class="entity"><span>tenv</span></span><span class="main"><span>,</span></span><span>tyenv</span><span class="main"><span>=</span></span><span class="entity"><span>tyenv</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>TM</span></span><span>
                                </span><span>|&gt;</span><span> </span><span>Envir.eta_contract</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tenv</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TY</span></span><span class="main"><span>,</span></span><span class="entity"><span>TM</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst_tyenv</span></span><span> </span><span class="entity"><span>TY</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst_tenv</span></span><span> </span><span class="entity"><span>TY</span></span><span> </span><span class="entity"><span>TM</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst_env'</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.Envir</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>tyenv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tenv</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subst_env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tyenv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tenv</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>norm_env</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TY</span></span><span class="main"><span>,</span></span><span class="entity"><span>TM</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>norm_tyenv</span></span><span> </span><span class="entity"><span>TY</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>norm_tenv</span></span><span> </span><span class="entity"><span>TY</span></span><span> </span><span class="entity"><span>TM</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>certify_tyvars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>TVars.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Context.cases</span><span> </span><span>Thm.global_ctyp_of</span><span> </span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>certify_tmvars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vars.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span>Context.cases</span><span> </span><span>Thm.global_cterm_of</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>certify_vars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>certify_tyvars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>certify_tmvars</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uncertify_tyvars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>TVars.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>Thm.typ_of</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>uncertify_tmvars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vars.map</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>Thm.term_of</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>uncertify_vars</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>uncertify_tyvars</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>uncertify_tmvars</span></span><span> </span><span class="entity"><span>tm</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(* Instantiation of Higher Order Variables *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_HO_ins</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>escape</span></span><span class="main"><span>,</span></span><span class="entity"><span>ins0</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>escape</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq'</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a1</span></span><span class="main"><span>,</span></span><span class="entity"><span>b1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>a2</span></span><span class="main"><span>,</span></span><span class="entity"><span>b2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>a1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>a2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>b1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>b2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eqle</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a1</span></span><span class="main"><span>,</span></span><span class="entity"><span>b1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>a2</span></span><span class="main"><span>,</span></span><span class="entity"><span>b2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>a1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>a2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>b1</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>b2</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>sift</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="main"><span>=</span></span><span>
         </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>X</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>redex</span></span><span class="main"><span>,</span></span><span class="entity"><span>residue</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>redex</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>residue</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>redex</span></span><span class="main"><span>,</span></span><span class="entity"><span>residue</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>redex</span></span><span class="main"><span>,</span></span><span class="entity"><span>residue</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>B</span></span><span>
                                         </span><span class="main"><span>|</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ty</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span>Term.incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>redex</span></span><span class="main"><span>,</span></span><span> </span><span>Term.incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>residue</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>
                                         </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_dup</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_dup</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>subst</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A'</span></span><span class="main"><span>,</span></span><span> </span><span>Term.dummy</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X</span></span><span>
                      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_dup</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.is_open</span><span> </span><span class="entity"><span>A</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>visit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.is_open</span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>chk_dup</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>X</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>visit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sift</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="entity"><span>eq'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>N</span></span><span>-</span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>visit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sift</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X</span></span><span>
                      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>visit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>set</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>visit</span></span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span class="entity"><span>eqle</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>N</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>visit</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>visit</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sift</span></span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="entity"><span>set</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>A</span></span><span>
                      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>visit</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sift</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="entity"><span>set</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>visit</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sift</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sift</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="entity"><span>set</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sift</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>escape</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>set</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>insert</span><span> </span><span class="entity"><span>eqle</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>sift</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>set</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="entity"><span>sift</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="comment1"><span>(*for elements in this set, if the second projection is negative 'n',
      '~1-n' is the number of arguments applied to an occurrence of the variable;
      else if is non-negative 'n', i.e., if (v,n) occurs in the set,
      the nth argument of the variable contains bound variable and therefore cannot be trimmed.

      calc_arity calculates the minimally number of occurred arguments applied to the variable*)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>calc_arity</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>AList.defined</span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="entity"><span>v</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>calc_arity</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="entity"><span>L</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>calc_arity</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v'</span></span><span class="main"><span>,</span></span><span class="entity"><span>m</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>v'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fst</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>m</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>-</span><span class="entity"><span>m</span></span><span> </span><span>&lt;</span><span> </span><span class="entity"><span>n'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>-</span><span class="entity"><span>m</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>n'</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>~1</span></span><span>-</span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>L</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>calc_arity</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ret</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>arity</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>calc_arity</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>set</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>forall_num</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span>&lt;</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>forall_num</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>P</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ins</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>forall_num</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>member</span><span> </span><span class="entity"><span>eq'</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="comment1"><span>(*make the residue of the variable trimming upto the minimally number of
                     occurred arguments, leaving those argument containing loose bound untouched.*)</span></span><span>
                   </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="entity"><span>targs</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span>
                          </span><span>fold_rev</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bs</span></span><span>
                            </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>T</span></span><span>›</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>targs</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="entity"><span>targs</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>fun</span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="entity"><span>T</span></span><span>›</span></span><span> </span><span class="main"><span>=</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>set</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span>-</span><span class="entity"><span>i</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span>::</span><span class="entity"><span>targs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Bound</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="entity"><span>targs</span></span><span> </span><span class="entity"><span>bs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>T</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Internal bug #bb923326-bb1c-4ba6-9039-84963749ee92"</span></span><span>
                   </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mk_term</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>v</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term'</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
       </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arity</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>collect_var</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>insert</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="entity"><span>ret</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_var</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect_var</span></span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>collect_var</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_var</span></span><span> </span><span class="main"><span>(</span></span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>collect_var</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="entity"><span>ret</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>collect_var</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ret</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="entity"><span>collect_var</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="entity"><span>escape</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ins</span></span><span>@</span><span class="entity"><span>ins0</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate_higher_order_var</span></span><span> </span><span class="entity"><span>escape</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vars.make</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mk_HO_ins</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>escape</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate_higher_order_var_in_antecedents'</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_concl</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_concl</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_concl</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.all</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_concl</span></span><span> </span><span class="main"><span>(</span></span><span>Term.incr_boundvars</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span>Bound</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_concl</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.imp</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>get_concl</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_concl</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>X</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ins</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>prem</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mk_HO_ins</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>get_concl</span></span><span> </span><span class="entity"><span>prem</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.prems_of</span><span> </span><span class="entity"><span>thm</span></span><span>
                                     </span><span class="main"><span>|</span></span><span> </span><span class="inner_numeral"><span>~2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.prems_of</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>@</span><span>
                                             </span><span class="main"><span>[</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PLPR_Syntax.strip_embedded_patterns</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                                     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span>  </span><span class="main"><span>=&gt;</span></span><span> </span><span>List.take</span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>num</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>ins</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>certify_tmvars</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Vars.make</span><span> </span><span class="entity"><span>ins</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate_higher_order_var_in_antecedents</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>the_default</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instantiate_higher_order_var_in_antecedents'</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate_higher_order_schematic_var_for_rule'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Syntax.strip_embedded_patterns</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>vars0</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_vars</span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>typs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>AList.lookup</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>vars0</span></span><span> </span><span class="entity"><span>x</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ret</span></span><span>
                                 </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Not a variable occuring in the conclusion"</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>fixes</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.variant_fixes</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>fst</span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>o</span><span> </span><span>Free</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>names</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>typs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span>Vars.make</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>fixes</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>typs</span></span><span class="main"><span>)</span></span><span> </span><span>~~</span><span> </span><span class="entity"><span>frees</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>instantiate_higher_order_var_in_antecedents'</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule'</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Variable.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiate_higher_order_schematic_var_for_rule</span></span><span> </span><span class="entity"><span>num_fixes</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>the_default</span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>instantiate_higher_order_schematic_var_for_rule'</span></span><span> </span><span class="entity"><span>num_fixes</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span>







</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>infix</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> RS' RSN'

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tha</span></span><span> </span><span class="entity"><span>RSN'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thb</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.chop</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.biresolution</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tha</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>thb</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>th</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.solve_constraints</span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"RSN: no unifiers"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tha</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thb</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span>THM</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"RSN: multiple unifiers"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>tha</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thb</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="comment1"><span>(*Resolution: P ⟹ Q, Q ⟹ R gives P ⟹ R*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tha</span></span><span> </span><span class="entity"><span>RS'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>thb</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tha</span></span><span> </span><span class="entity"><span>RSN'</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span class="entity"><span>thb</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply3</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_pair3</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>a'</span></span><span class="main"><span>,</span></span><span class="entity"><span>b'</span></span><span class="main"><span>,</span></span><span class="entity"><span>c'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>a'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>b'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>c'</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>eq_pair4</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>a'</span></span><span class="main"><span>,</span></span><span class="entity"><span>b'</span></span><span class="main"><span>,</span></span><span class="entity"><span>c'</span></span><span class="main"><span>,</span></span><span class="entity"><span>d'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>a'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>g</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>b'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>c'</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span class="main"><span>,</span></span><span class="entity"><span>d'</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>select</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>infixr</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> ORELSE0

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="entity"><span>ORELSE0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>f</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span>
    </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>g</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>some</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>some</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>



</span></pre>
</body>

</html>