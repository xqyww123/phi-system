<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‚Äπlibrary/reasoner.ML‚Ä∫</title>
</head>


<body>
<div class="head">
<h1>File ‚Äπlibrary/reasoner.ML‚Ä∫</h1>
</div>

<pre class="source"><span class="comment1"><span>(*
The engine of the Phi Logic Programming Reasoner
Author: Qiyuan Xu
*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>NU_REASONER</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>
  </span><span class="comment1"><span>(* This file is the major hot point of the whole system.
     TODO: optimize it as much as possible! *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>patterns_and_excepts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>priority</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>pattern</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoners</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ML_guard</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cterm</span><span>

  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>cut_mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>NO_CUT</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>LOCAL_CUT</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>GLOBAL_CUT</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>backtrack_mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NO_BACKTRACK</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NO_EXPLORATIVE_BACKTRACK</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>mode</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cut_mode</span></span><span> * </span><span class="entity"><span>backtrack_mode</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>mode'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cut_mode</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>backtrack_mode</span></span><span>
  </span><span class="comment1"><span>(* declare by NO_BACKTRACK to disable applying the reasoner during backtracking.
        It causes the reasoner will not be applied once there is another reasoner of a higher priority,
        no matter if that reasoner's application succeeds.
        It is therefore useful to declare `default' rules which works when user does not give any
        specific rule and to be overrided once any rule is given.

     In exhaustive reasoning mode, in order to obtain all reachable solution of a reasoning goal,
     the reasoning will not terminate even when a success is reached. Instead, a special `explorative'
     backtrack is triggered to backtrack to other branches.
     NO_EXPLORATIVE_BACKTRACK disables the rule to be applied in this explorative backtracking.
     It can be for consideration of performance.
 *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> NORMAL_MODE </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mode</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> NORMAL_LOCAL_CUT </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mode</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> TO_BE_OVERRIDE </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mode</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> NORMAL_MODE' </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mode'</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> NORMAL_LOCAL_CUT' </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mode'</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> TO_BE_OVERRIDE' </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mode'</span></span><span>


  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>guarded</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*if has the ‚ÄπùóãGuard‚Ä∫ tag*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>backtracking</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>NO_BACKTRACKING</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>BACKTRACKING</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>EXPLORATIVE_BACKTRACKING</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>tactic</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tac_ML</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> backtracking * context_state </span><span class="main"><span>-&gt;</span></span><span> context_state Seq.seq
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Tac_Rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>guarded * thm</span><span class="main"><span>)</span></span><span> list

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
                   pos</span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span class="main"><span>,</span></span><span>
                   group</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Reasoner_Group.name</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
                   mode</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span>
                   pattern</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
                   blacklist</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
                   tactic</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>tactic</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> match_reasoner </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>


  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> trace </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span> </span><span class="comment1"><span>(*Prints the state of every reasoning step.*)</span></span><span>
                     </span><span class="comment1"><span>(*trace level: 0 - none; 1 - less info; 2 - more info; 3 - much more info*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> count_performance </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> step_limit </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span> </span><span class="comment1"><span>(*limit of the number of reasoning steps*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ignore_dup_reasoner </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>info_level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> info_print </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>info_level</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> info_pretty</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>info_level</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> info_pretty_generic </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>info_level</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> warn_pretty</span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>info_level</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> error </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> bad_config </span><span class="main"><span>:</span></span><span> </span><span>string</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty_mode </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty_mode_priority </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mode</span></span><span> * </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>

  </span><span class="comment1"><span>(*auto level: 2 - fully auto, 1 - partially auto, 0 - fully manual*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> auto_level </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span>Config.T</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reduce_auto_level </span><span class="main"><span>:</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> Success </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>context_state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> Global_Cut </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>context_state</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> Explorative_Backtrack

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>success_handler</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span>Seq.seq</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>global_cut_handler</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span>Seq.seq</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>success_handler</span></span><span> * </span><span class="entity"><span>global_cut_handler</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_success_handler </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>success_handler</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_global_cut_handler </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>global_cut_handler</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_handlers </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>handlers</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> adds </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_lthy </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>local_theory</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_reasoners</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*pattern*)</span></span><span>
                  </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*filter, returning true to delete one*)</span></span><span>
                  </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_reasoners_by_name</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*pattern matching the name*)</span></span><span>
                  </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> has_reasoner </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reasoners </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoners</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> content </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>reasoners</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span>list</span><span>
  </span><span class="comment1"><span>(*val call_reasoners : reasoners -&gt; Proof.context -&gt; *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_reasoners </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoners</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span>list</span><span>
  </span><span class="comment1"><span>(*a faster version but a bit dirty*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_reasoners' </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoners</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>bvs</span></span><span>
                    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span> * </span><span class="entity"><span>pattern</span></span><span> * </span><span>serial</span><span> </span><span class="comment1"><span>(*reasoner id*)</span></span><span> * </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
  </span><span class="comment1"><span>(*val call_reasoners : context_state -&gt; (Position.T * context_state Seq.seq) list*)</span></span><span>

  </span><span class="comment1"><span>(* Interfaces for Reasoning *)</span></span><span>
  </span><span class="comment1"><span>(*N: number of premises to be attacked at most, if it is positive;
       to attack all if it is None;
       to attack until a sequent remains at most |N| premises, if N is negative*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> internal_reason  </span><span class="main"><span>:</span></span><span>
                </span><span class="entity"><span>handlers</span></span><span> </span><span>option</span><span>
             </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*N*)</span></span><span>
             </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span>
             </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reason  </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span>option</span><span>
             </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*N*)</span></span><span>
             </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reason1 </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>unit</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>string</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*error message*)</span></span><span>
             </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span>option</span><span>
             </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*N*)</span></span><span>
             </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> internal_reason_s </span><span class="main"><span>:</span></span><span>
                 </span><span class="entity"><span>handlers</span></span><span> </span><span>option</span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="comment1"><span>(*the context for accessing reasoner db*)</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a * </span><span class="entity"><span>context_state</span></span><span> </span><span>Seq.seq</span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> 'a * </span><span class="entity"><span>context_state</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reason_sXXX </span><span class="main"><span>:</span></span><span> 
                 </span><span class="entity"><span>handlers</span></span><span> </span><span>option</span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="comment1"><span>(*the context for accessing reasoner db*)</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a * </span><span class="entity"><span>context_state</span></span><span> </span><span>Seq.seq</span><span class="main"><span>)</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> 'a * </span><span>thm</span><span> </span><span>option</span><span>
  </span><span class="comment1"><span>(*Note it returns at most one state in the returned sequence.*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reason_tac </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span>option</span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span>option</span><span> </span><span class="comment1"><span>(*N*)</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="comment1"><span>(*the context for accessing reasoner db*)</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_tactic</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_mode_of </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>cut_mode</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_rule </span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>mode'</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Reasoner_Group.group</span></span><span> </span><span>option</span><span>
                    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>priority</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>pattern</span></span><span> </span><span>list</span><span>
                    </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span>option</span><span>
                    </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>
                    </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>add_rule_param</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span>Position.T</span><span> * </span><span class="entity"><span>mode'</span></span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span> </span><span>option</span><span>
                      * </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>priority</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>pattern</span></span><span> </span><span>list</span><span>
                      * </span><span class="main"><span>(</span></span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_rules</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>add_rule_param</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_rules </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span>list</span><span> </span><span>option</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>

  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pass_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*rules*)</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>mode'</span></span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> *
                   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>priority</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>pattern</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>guard</span></span><span> </span><span>option</span><span> * </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rule_pass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pass_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pass_data</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pass_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*identifier*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> get_passes </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pass_id</span></span><span> * </span><span>term</span><span> * </span><span class="entity"><span>rule_pass</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> run_passes </span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pass_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pass_data</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_pass </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>pass_id</span></span><span> * </span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>rule_pass</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> del_pass </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>pass_id</span></span><span> * </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>

  </span><span class="comment1"><span>(*
  val setup_cmd : (((string (*name term*) * Position.T) * (mode * priority (*default priority*)))
                   * ((bool (*true for matching, false for not matching*)
                      * string (*pattern term*))
                      * priority option) list
                  ) * Input.source (* tactic source*)
        -&gt; local_theory -&gt; local_theory*)</span></span><span>

  </span><span class="comment1"><span>(* Default Pattern of Reasoning Rule *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> Default_Pattern </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PATTERN_REWRITE</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> the_default_pattern_of </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span>list</span><span>

  </span><span class="comment1"><span>(* Default Reasoner Group *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> the_default_group_of </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>bvs</span></span><span>
                          </span><span class="main"><span>-&gt;</span></span><span> </span><span>term</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Reasoner_Group.group</span></span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> assign_default_group </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span> * </span><span>term</span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
                          </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>

  </span><span class="comment1"><span>(* Helpful Tools *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> chop_seq_head' </span><span class="main"><span>:</span></span><span> 'a </span><span>Seq.seq</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> chop_seq_head  </span><span class="main"><span>:</span></span><span> 'a </span><span>Seq.seq</span><span> </span><span class="main"><span>-&gt;</span></span><span> 'a </span><span>Seq.seq</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> single_RS' </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="comment1"><span>(*rule*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>option</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> single_RS  </span><span class="main"><span>:</span></span><span> </span><span>thm</span><span> </span><span class="comment1"><span>(*rule*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>Seq.seq</span><span>
        </span><span class="comment1"><span>(*The resolution that returns at most one solution.*)</span></span><span>

  </span><span class="comment1"><span>(* Helper Syntax Parser *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ML_guard_parser_raw </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>context_parser</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> ML_guard_parser </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>context_parser</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> attr_syntax' </span><span class="main"><span>:</span></span><span>
      'ext </span><span>context_parser</span><span> </span><span class="comment1"><span>(*extension*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span>Position.T</span><span> * </span><span class="entity"><span>mode'</span></span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span> </span><span>option</span><span> * 'ext
       </span><span class="main"><span>-&gt;</span></span><span> </span><span>attribute</span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>-&gt;</span></span><span> </span><span>attribute</span><span> </span><span>context_parser</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> attr_syntax </span><span class="main"><span>:</span></span><span>
      'ext </span><span>context_parser</span><span> </span><span class="comment1"><span>(*extension*)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>
      </span><span class="main"><span>(</span></span><span>Position.T</span><span> * </span><span class="entity"><span>mode'</span></span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span> </span><span>option</span><span> * 'ext
        * </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>priority</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>pattern</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>ML_guard</span></span><span> </span><span>option</span><span>
       </span><span class="main"><span>-&gt;</span></span><span> </span><span>attribute</span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>-&gt;</span></span><span> </span><span>attribute</span><span> </span><span>context_parser</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> attr_rule_syntax </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span>list</span><span> * </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span>Context.generic</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span>  </span><span>attribute</span><span> </span><span>context_parser</span><span>

  </span><span class="comment1"><span>(* Statistics *)</span></span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> start_collecting_reasoners </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Reasoner_Group.name</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> stop_collecting_reasoners  </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Reasoner_Group.name</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> clear_utilization_statistics_of_group_P </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Reasoner_Group.name</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>PLPR_Statistics.group_name</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> clear_utilization_statistics_of_group </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Reasoner_Group.name</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>PLPR_Statistics.group_name</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> utilization_of_group_P </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Reasoner_Group.name</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>PLPR_Statistics.group_name</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> utilization_of_group_in_all_theories  </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Reasoner_Group.name</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>PLPR_Statistics.group_name</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> utilization_of_groups_in_all_theories </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Reasoner_Group.name</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>PLPR_Statistics.group_name</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> reasoners_of_group </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Reasoner_Group.name</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span>list</span><span>

  </span><span class="comment1"><span>(* Technical Internal *)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> default_pattern_ML_sender </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Default_Pattern.ML_rewr</span></span><span> </span><span>option</span><span> </span><span>Unsynchronized.ref</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*A special name to prevent someone overriding this structure, whose visibility is essential
  for parsing ML guard, see the ML_guard parser in declaring the œÜreason attribute*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>PLP_Reasoner_Guard_Parse_Sender</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>Unsynchronized.ref</span><span>
      </span><span class="main"><span>=</span></span><span> </span><span>Unsynchronized.ref</span><span> </span><span>NONE</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>PLP_Reasoner_Guard_Parse_Sender_locker</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.var</span><span> </span><span class="inner_quoted"><span>"PLP_Reasoner_Guard_Parse_Sender_locker"</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Phi_Reasoner</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>NU_REASONER</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="comment1"><span>(*** Preliminaries ***)</span></span><span>

</span><span class="comment1"><span>(* Types *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>patterns_and_excepts</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>priority</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>pattern</span></span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>ML_guard</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>cterm</span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>cut_mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>NO_CUT</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>LOCAL_CUT</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>GLOBAL_CUT</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>backtrack_mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NO_BACKTRACK</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NO_EXPLORATIVE_BACKTRACK</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cut_mode</span></span><span> * </span><span class="entity"><span>backtrack_mode</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>mode'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cut_mode</span></span><span> </span><span>option</span><span> * </span><span class="entity"><span>backtrack_mode</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>NORMAL_MODE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NO_CUT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>NORMAL_LOCAL_CUT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LOCAL_CUT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>TO_BE_OVERRIDE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NO_CUT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NO_BACKTRACK</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>NORMAL_MODE'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>NO_CUT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>NORMAL_LOCAL_CUT'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>LOCAL_CUT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>TO_BE_OVERRIDE'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>NO_CUT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NO_BACKTRACK</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* NO_CUT &lt; LOCAL_CUT &lt; GLOBAL_CUT *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cut_mode_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>GLOBAL_CUT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>GLOBAL_CUT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>EQUAL</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cut_mode_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LOCAL_CUT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>GLOBAL_CUT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LESS</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cut_mode_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LOCAL_CUT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>LOCAL_CUT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>EQUAL</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cut_mode_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NO_CUT</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NO_CUT</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>EQUAL</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cut_mode_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NO_CUT</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LESS</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cut_mode_ord</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>GREATER</span><span>

</span><span class="comment1"><span>(* ALLOW_BACKTRACK &lt; NO_EXPLORATIVE_BACKTRACK &lt; NO_BACKTRACK *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>backtrack_mode_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NO_BACKTRACK</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NO_BACKTRACK</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>EQUAL</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>backtrack_mode_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NO_EXPLORATIVE_BACKTRACK</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NO_BACKTRACK</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LESS</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>backtrack_mode_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>NO_EXPLORATIVE_BACKTRACK</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NO_EXPLORATIVE_BACKTRACK</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>EQUAL</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>backtrack_mode_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>EQUAL</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>backtrack_mode_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>LESS</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>backtrack_mode_ord</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>GREATER</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode_ord</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>prod_ord</span><span> </span><span class="entity"><span>cut_mode_ord</span></span><span> </span><span class="entity"><span>backtrack_mode_ord</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>backtracking</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>NO_BACKTRACKING</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>BACKTRACKING</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>EXPLORATIVE_BACKTRACKING</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>guarded</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>bool</span><span>
</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>tactic</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tac_ML</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> backtracking * context_state </span><span class="main"><span>-&gt;</span></span><span> context_state Seq.seq
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Tac_Rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>guarded * thm</span><span class="main"><span>)</span></span><span> list

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>:</span></span><span> </span><span>term</span><span class="main"><span>,</span></span><span>
                 pos</span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span class="main"><span>,</span></span><span>
                 group</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Reasoner_Group.name</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
                 mode</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span>
                 pattern</span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> * </span><span>int</span><span class="main"><span>)</span></span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
                 blacklist</span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span class="main"><span>,</span></span><span>
                 tactic</span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>tactic</span></span><span class="main"><span>}</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normalize_reasoner</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>group</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span class="entity"><span>blacklist</span></span><span class="main"><span>,</span></span><span class="entity"><span>tactic</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>=</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> pos</span><span class="main"><span>=</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> mode</span><span class="main"><span>=</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> group</span><span class="main"><span>=</span></span><span class="entity"><span>group</span></span><span class="main"><span>,</span></span><span>
    pattern </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PLPR_Pattern.mk_spattern</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.beta_eta_contract</span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span>
    blacklist </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PLPR_Pattern.mk_spattern</span></span><span> </span><span>o</span><span> </span><span>Envir.beta_eta_contract</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>blacklist</span></span><span class="main"><span>,</span></span><span>
    tactic </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tactic</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>transform_reasoner</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span class="entity"><span>group</span></span><span class="main"><span>,</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span class="entity"><span>blacklist</span></span><span class="main"><span>,</span></span><span class="entity"><span>tactic</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>=</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> pos</span><span class="main"><span>=</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> mode</span><span class="main"><span>=</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> group</span><span class="main"><span>=</span></span><span class="entity"><span>group</span></span><span class="main"><span>,</span></span><span>
    pattern </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apfst</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span>
    blacklist </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Morphism.term</span><span> </span><span class="entity"><span>phi</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>blacklist</span></span><span class="main"><span>,</span></span><span>
    tactic </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tactic</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_cut_mode_ML</span></span><span> </span><span class="entity"><span>NO_CUT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Phi_Reasoner.NO_CUT"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>print_cut_mode_ML</span></span><span> </span><span class="entity"><span>LOCAL_CUT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Phi_Reasoner.LOCAL_CUT"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>print_cut_mode_ML</span></span><span> </span><span class="entity"><span>GLOBAL_CUT</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Phi_Reasoner.GLOBAL_CUT"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>print_backtrack_mode_ML</span></span><span> </span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Phi_Reasoner.ALLOW_BACKTRACK"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>print_backtrack_mode_ML</span></span><span> </span><span class="entity"><span>NO_BACKTRACK</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Phi_Reasoner.NO_BACKTRACK"</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>print_backtrack_mode_ML</span></span><span> </span><span class="entity"><span>NO_EXPLORATIVE_BACKTRACK</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Phi_Reasoner.NO_EXPLORATIVE_BACKTRACK"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>print_mode_ML</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>ML_Syntax.print_pair</span><span> </span><span class="entity"><span>print_cut_mode_ML</span></span><span> </span><span class="entity"><span>print_backtrack_mode_ML</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>name_of_intro_reasoner</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.mk_conjunction_list</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_reasoner_name</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name_concls</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Logic.dest_conjunction_list</span><span> </span><span class="entity"><span>name</span></span><span>
                     </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>Logic.strip_assums_concl</span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>PLPR_Pattern.does_smatch</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name_concls</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>match_reasoner</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>match_reasoner_name</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Attributes *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>auto_level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="entity_def" id="PLPR.\&lt;phi&gt;auto_level|attribute"><span>œÜauto_level</span></span><span>‚Ä∫</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reduce_auto_level</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.map</span><span> </span><span class="entity"><span>auto_level</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Int.min</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="entity_def" id="PLPR.\&lt;phi&gt;trace_reasoning|attribute"><span>œÜtrace_reasoning</span></span><span>‚Ä∫</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>count_performance</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="entity_def" id="PLPR.\&lt;phi&gt;count_performance|attribute"><span>œÜcount_performance</span></span><span>‚Ä∫</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>step_limit</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_int</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="entity_def" id="PLPR.\&lt;phi&gt;reasoning_step_limit|attribute"><span>œÜreasoning_step_limit</span></span><span>‚Ä∫</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_numeral"><span>1000</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>


</span><span class="comment1"><span>(* Debug Info *)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>info_level</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>int</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>info_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span>&lt;=</span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>info_print</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>info_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span> </span><span>#&gt;</span><span> </span><span>Pretty.str</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>info_pretty_generic</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span>&lt;=</span><span> </span><span>Config.get_generic</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>warn_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>level</span></span><span> </span><span>&lt;=</span><span> </span><span>Config.get_generic</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>error</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Exn.error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\nReasoning Fail! You may turn on œÜtrace_reasoning or\
      \ œÜtrace_reasoning_candidates to debug."</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>bad_config</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Exn.error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>msg</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"\nSome rule is configured incorrectly!"</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(* Reasoning Frame *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Success</span></span><span>    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>context_state</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Global_Cut</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>context_state</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Explorative_Backtrack</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>success_handler</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span>Seq.seq</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>global_cut_handler</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span>Seq.seq</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>success_handler</span></span><span> * </span><span class="entity"><span>global_cut_handler</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>frame</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>handlers</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_success_handler</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Success</span></span><span> </span><span class="entity"><span>s</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_global_cut_handler</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Global_Cut</span></span><span> </span><span class="entity"><span>s</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_handlers</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>default_success_handler</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>default_global_cut_handler</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*fun enter_sub_envir' opewn_newctxt ctxt =
  if opewn_newctxt then enter_sub_envir ctxt else ctxt
fun exit_sub_envir' opewn_newctxt ctxt =
  if opewn_newctxt then exit_sub_envir ctxt else ctxt*)</span></span><span>

</span><span class="comment1"><span>(* Statistics *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>statistic_group</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>string</span><span>

</span><span class="comment1"><span>(*
structure Rule_Collection = Generic_Data (
  type T = reasoner Net.net Symtab.table
  val empty = Symtab.empty
  val merge = Symtab.join (K (Net.merge (op aconv o apply2 #name)))
)
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Under_Collecting</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.set</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.merge</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>start_collecting_reasoners</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Under_Collecting.map</span><span> </span><span>o</span><span> </span><span>Symtab.insert_set</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>stop_collecting_reasoners</span></span><span>  </span><span class="main"><span>=</span></span><span> </span><span>Under_Collecting.map</span><span> </span><span>o</span><span> </span><span>Symtab.remove_set</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_to_groups_under_collection</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>open_groups</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Under_Collecting.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>|&gt;</span><span> </span><span>Symtab.keys</span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span class="entity"><span>group</span></span><span class="main"><span>,</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span class="entity"><span>blacklist</span></span><span class="main"><span>,</span></span><span class="entity"><span>tactic</span></span><span class="main"><span>}</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>=</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> pos</span><span class="main"><span>=</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> mode</span><span class="main"><span>=</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> group</span><span class="main"><span>=</span></span><span>union</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>group</span></span><span> </span><span class="entity"><span>open_groups</span></span><span class="main"><span>,</span></span><span>
           pattern</span><span class="main"><span>=</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> blacklist</span><span class="main"><span>=</span></span><span class="entity"><span>blacklist</span></span><span class="main"><span>,</span></span><span> tactic</span><span class="main"><span>=</span></span><span class="entity"><span>tactic</span></span><span class="main"><span>}</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>



</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="entity_def" id="PLPR.collect_reasoner_statistics|attribute"><span>collect_reasoner_statistics</span></span><span>‚Ä∫</span></span></span><span> </span><span class="main"><span>(</span></span><span>
    </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Parse.name_position</span><span>
            </span><span>--</span><span> </span><span class="main"><span>(</span></span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"start"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span>true</span><span>
              </span><span>||</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"stop"</span></span><span>  </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span>false</span><span> </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>xname</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>start</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Reasoner_Group.check</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>xname</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>start</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>start_collecting_reasoners</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>stop_collecting_reasoners</span></span><span>  </span><span class="entity"><span>name</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"start or stop collecting LPR rule of the indicated group."</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(*** Reasoner Registry ***)</span></span><span>

</span><span class="comment1"><span>(** Hasher **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoner_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>serial</span><span>
</span><span class="comment1"><span>(*fun hasher_eq ((_,s1),(_,s2)) = (s1 = s2)*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>hasher_net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Synchronized.var</span><span> </span><span class="inner_quoted"><span>"Phi_Reasoner.reasoner_hasher"</span></span><span>
                                  </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span>iNet.empty</span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span> * </span><span class="entity"><span>reasoner_id</span></span><span class="main"><span>)</span></span><span> </span><span>iNet.net</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>hash</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Synchronized.change_result</span><span> </span><span class="entity"><span>hasher_net</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>iNet.lookup</span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>(</span></span><span>iNet.key_of_term</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>s</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>iNet.insert_term</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>N</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>net</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(** Main Registry **)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>registry_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="entity"><span>pat1</span></span><span class="main"><span>,</span></span><span class="entity"><span>id1</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span class="entity"><span>pat2</span></span><span class="main"><span>,</span></span><span class="entity"><span>id2</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>c2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>pat1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pat2</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>id1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>id2</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>reasoners</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span> * </span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>reasoner_id</span></span><span> * </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span>iNet.net</span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Reasoners</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>reasoners</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>iNet.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>T</span></span><span> * </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>iNet.merge</span><span> </span><span class="entity"><span>registry_eq</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reasoners</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Reasoners.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>content</span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>iNet.content</span><span> </span><span class="entity"><span>net</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_mode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cmode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bmode</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>bmode</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NO_BACKTRACK</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"default"</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NO_EXPLORATIVE_BACKTRACK</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"no explorative backtrack"</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>c</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>cmode</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>NO_CUT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>LOCAL_CUT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"!"</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>GLOBAL_CUT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"!!"</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>pb</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pc</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>block</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pb</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pc</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pc</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pc</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>pb</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pb</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_mode_priority</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>block</span><span> </span><span class="main"><span>(</span></span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"("</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
            </span><span>@</span><span> </span><span>the_list</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pretty_mode</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>)</span></span><span>
            </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>")"</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span>Pretty.chunks</span><span> </span><span class="main"><span>(</span></span><span>
    </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>Pretty.here</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pos </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
      </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Context.cases</span><span> </span><span>Syntax.pretty_term_global</span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pretty.item</span><span> </span><span class="main"><span>[</span></span><span>
          </span><span>str</span><span> </span><span class="inner_quoted"><span>"("</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="inner_quoted"><span>"): "</span></span><span class="main"><span>,</span></span><span>
          </span><span>Context.cases</span><span> </span><span>Syntax.pretty_term_global</span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pat</span></span><span>
        </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pattern </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
   </span><span>Pretty.block</span><span> </span><span class="main"><span>(</span></span><span>
     </span><span>Pretty.here</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pos </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
    </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"("</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>") on pattern "</span></span><span class="main"><span>,</span></span><span>
     </span><span>Context.cases</span><span> </span><span>Syntax.pretty_term_global</span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>" : "</span></span><span class="main"><span>,</span></span><span>
     </span><span>Pretty.fbrk</span><span class="main"><span>,</span></span><span>
     </span><span>Context.cases</span><span> </span><span>Syntax.pretty_term_global</span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ignore_dup_reasoner</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="entity_def" id="PLPR.\&lt;phi&gt;reason_ignore_dup|attribute"><span>œÜreason_ignore_dup</span></span><span>‚Ä∫</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>insert_net</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>:</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>hash</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>name </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.fastype_of</span><span> </span><span class="entity"><span>pat</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Type</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">type_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span>prop</span><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>error</span></span><span> </span><span class="inner_quoted"><span>"Bad reasoner, the pattern must be a proposition"</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chk</span></span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pattern </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>List.app</span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>blacklist </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>iNet.insert_term</span><span> </span><span class="entity"><span>registry_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>net</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span>iNet.INSERT</span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dups</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>iNet.lookup</span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>(</span></span><span>iNet.key_of_term</span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>y</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>registry_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span class="main"><span>,</span></span><span class="entity"><span>y</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get_generic</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ignore_dup_reasoner</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>net</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Exn.error</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.chunks</span><span> </span><span class="main"><span>(</span></span><span>
                </span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Clash with existing reasoner!"</span></span><span> </span><span>::</span><span>
                </span><span class="entity"><span>pretty'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span>
                </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pretty'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>d</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>dups</span></span><span>
             </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add</span></span><span> </span><span class="entity"><span>reasoner0</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>normalize_reasoner</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>reasoner0</span></span><span>
                  </span><span>|&gt;</span><span> </span><span class="entity"><span>add_to_groups_under_collection</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>info_pretty_generic</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span>Pretty.chunks</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Installing œÜ-LPR reasoner:"</span></span><span class="main"><span>,</span></span><span>
                               </span><span class="entity"><span>pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Reasoners.map</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>insert_net</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pattern </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>adds</span></span><span> </span><span class="entity"><span>reasoners</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Reasoners.map</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>reasoner0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>normalize_reasoner</span></span><span> </span><span>I</span><span> </span><span class="entity"><span>reasoner0</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>info_pretty_generic</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span>Pretty.chunks</span><span> </span><span class="main"><span>[</span></span><span>Pretty.str</span><span> </span><span class="inner_quoted"><span>"Installing œÜ-LPR reasoner:"</span></span><span class="main"><span>,</span></span><span>
                                 </span><span class="entity"><span>pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>insert_net</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pattern </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>add_to_groups_under_collection</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reasoners</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_lthy</span></span><span> </span><span class="entity"><span>reasoner</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Local_Theory.declaration</span><span> </span><span class="main"><span>{</span></span><span>syntax</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>,</span></span><span> pervasive</span><span class="main"><span>=</span></span><span>false</span><span class="main"><span>,</span></span><span> pos</span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span>pos </span><span class="entity"><span>reasoner</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="entity"><span>add</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>transform_reasoner</span></span><span> </span><span class="entity"><span>phi</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reasoners_of_group</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>iNet.content</span><span> </span><span class="main"><span>(</span></span><span>Reasoners.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>group </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>4</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>4</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clear_utilization_statistics_of_group_P</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>statistics_group</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_utilization</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Statistics.utilization</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>statistics_group</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>reasoners_of_group</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Theory</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>P</span></span><span>
   </span><span>|&gt;</span><span> </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>tactic </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tac_Rule</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract_term</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>prop'</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span>
                                 </span><span class="main"><span>(</span></span><span>Net.match_term</span><span> </span><span class="entity"><span>all_utilization</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cnt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cnt</span></span><span> </span><span>:=</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
           </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>clear_utilization_statistics_of_group</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>reasoner_group</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>clear_utilization_statistics_of_group_P</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>reasoner_group</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>utilization_of_group_P</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>P</span></span><span> </span><span class="entity"><span>statistics_group</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_utilization</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Statistics.utilization</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>statistics_group</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>reasoners_of_group</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Theory</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>P</span></span><span>
   </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>tactic </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tac_Rule</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract_term</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>prop'</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span>
                                 </span><span class="main"><span>(</span></span><span>Net.match_term</span><span> </span><span class="entity"><span>all_utilization</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cnt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>!</span><span class="entity"><span>cnt</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
           </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>utilization_of_group_in_all_theories</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>reasoner_group</span></span><span> </span><span class="entity"><span>statistics_groups</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_utilization</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Statistics.utilization_in_all_theories</span></span><span> </span><span class="entity"><span>statistics_groups</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>reasoners_of_group</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="entity"><span>reasoner_group</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>tactic </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tac_Rule</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract_term</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>prop'</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span>
                                 </span><span class="main"><span>(</span></span><span>Net.match_term</span><span> </span><span class="entity"><span>all_utilization</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cnt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>!</span><span class="entity"><span>cnt</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
           </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>utilization_of_groups_in_all_theories</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>reasoner_groups</span></span><span> </span><span class="entity"><span>statistics_groups</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_utilization</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Statistics.utilization_in_all_theories</span></span><span> </span><span class="entity"><span>statistics_groups</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>reasoners_of_group</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>member</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reasoner_groups</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>{</span></span><span>tactic </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tac_Rule</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract_term</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>find_first</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>prop'</span></span><span> </span><span>aconv</span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span>
                                 </span><span class="main"><span>(</span></span><span>Net.match_term</span><span> </span><span class="entity"><span>all_utilization</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cnt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span>!</span><span class="entity"><span>cnt</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
           </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(*** Implementing Functions ***)</span></span><span>

</span><span class="comment1"><span>(* Auxiliary Helpers *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chop_seq_head'</span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.chop</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>seq</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>ret</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span>::</span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="inner_quoted"><span>"Multi Resolution! For performance consideration, PLPR only takes\
                                 \ the first solution and discards the remains."</span></span><span class="main"><span>;</span></span><span>
                         </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chop_seq_head</span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>Seq.empty</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chop_seq_head'</span></span><span> </span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>single_RS'</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.biresolution</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span>false</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>chop_seq_head'</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>single_RS</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>Seq.empty</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>single_RS'</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guarded_RS</span></span><span> </span><span class="entity"><span>chk_guard</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>guarded</span></span><span class="main"><span>,</span></span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>guarded</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>single_RS'</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Option.mapPartial</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> 
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>delt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Syntax.rulify_antecedents</span></span><span> </span><span>false</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;r&gt;Guard_I|fact"><span>ùóãGuard_I</span></a><span class="antiquote"><span>}</span></span></span></span><span> </span><span>RS</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>info_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                      </span><span>block</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Checking"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>delt</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="inner_quoted"><span>"guards ..."</span></span><span class="main"><span>]</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_guard</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>delt</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th'</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ret</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>info_print</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"Guard passes"</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span>   </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>info_print</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="inner_quoted"><span>"Guard fails"</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ret</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>single_RS'</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>thm</span></span><span>
    </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>pair</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span>

</span><span class="comment1"><span>(* Main Reasoning Function *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>{</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span>string_of</span><span> </span><span class="main"><span>(</span></span><span>chunks</span><span> </span><span class="main"><span>[</span></span><span>
        </span><span>block</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"candidate reasoners ("</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>str</span><span> </span><span class="inner_quoted"><span>"): "</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span>here</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
        </span><span>Syntax.pretty_term</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_abbrev</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span>
      </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
fun concl_of_goal st i =
  let val (gi, rfrees) = Logic.goal_params st i
      val B = Logic.strip_assums_concl gi
      (*val As = Logic.strip_assums_hyp gi*)
  in subst_bounds (rfrees, B)
  end*)</span></span><span>

</span><span class="comment1"><span>(* fun beta_eta_contract_leading_antecedent th =
  if (case Thm.prop_of th
        of <span class="hidden">\&lt;^</span><span class="control">const</span><span class="hidden">&gt;</span>‚ÄπPure.imp‚Ä∫ $ X $ _ =&gt; Term.could_beta_eta_contract X
         | _ =&gt; false)
  then Thm.equal_elim (Conv.implies_conv Drule.beta_eta_conversion
                                         Conv.all_conv (Thm.cprop_of th)) th
  else th *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>distinct_rev</span></span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>lst</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>dist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rev_seen</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rev_seen</span></span><span>
      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>dist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rev_seen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>member</span><span> </span><span class="entity"><span>eq</span></span><span> </span><span class="entity"><span>xs</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>dist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rev_seen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>dist</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>x</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>rev_seen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>xs</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>dist</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>lst</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_reasoning_rules</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>K</span><span> </span><span>Seq.empty</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>apply_reasoning_rules</span></span><span> </span><span class="entity"><span>chk_guard</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>guarded_rule</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>guarded_RS</span></span><span> </span><span class="entity"><span>chk_guard</span></span><span> </span><span class="entity"><span>guarded_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sequent</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span>Seq.empty</span><span class="main"><span>)</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>apply_reasoning_rules</span></span><span> </span><span class="entity"><span>chk_guard</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>seqs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.of_list</span><span> </span><span class="entity"><span>rules</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span>Seq.map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>guarded_RS</span></span><span> </span><span class="entity"><span>chk_guard</span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>seqs</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>apply_tactic</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>bmode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tac_ML</span></span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bmode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>apply_tactic</span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="entity"><span>chk_guard</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Tac_Rule</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>;</span></span><span>
      </span><span class="entity"><span>apply_reasoning_rules</span></span><span> </span><span class="entity"><span>chk_guard</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>s</span></span><span>
    </span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_reasoners'</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>iNet.match_term</span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="entity"><span>term</span></span><span>
    </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>PLPR_Pattern.does_smatch</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span>not</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PLPR_Pattern.does_smatch</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>blacklist </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="entity"><span>c2</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>EQUAL</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mode_ord</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>mode </span><span class="entity"><span>r1</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>mode </span><span class="entity"><span>r2</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>ord</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ord</span></span><span class="main"><span>)</span></span><span>
    </span><span>|&gt;</span><span> </span><span class="entity"><span>distinct_rev</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>pointer_eq</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="comment1"><span>(*TODO: remove the 3rd projection, hash*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_reasoners</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>get_reasoners'</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_reasoners</span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Reasoners.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>all_reasoners</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>to_remove</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span> </span><span>iNet.unify_term</span><span> </span><span class="entity"><span>all_reasoners</span></span><span>
                            </span><span>#&gt;</span><span> </span><span>List.filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>patterns</span></span><span>
                     </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span>pointer_eq</span><span>
        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>to_remove</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>warn_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span>Pretty.para</span><span> </span><span class="inner_quoted"><span>"No reasoning rule is removed!"</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>info_pretty_generic</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                        </span><span>chunks</span><span> </span><span class="main"><span>(</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"Removing following reasoing rules..."</span></span><span> </span><span>::</span><span>
                          </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>item</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>to_remove</span></span><span class="main"><span>)</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>iNet.delete_term</span><span> </span><span class="entity"><span>registry_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span class="entity"><span>R</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
             </span><span class="entity"><span>to_remove</span></span><span> </span><span class="entity"><span>all_reasoners</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_reasoners_by_name</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>del_reasoners</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>match_reasoner</span></span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pattern</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_reasoner</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>iNet.unify_term</span><span> </span><span class="main"><span>(</span></span><span>Reasoners.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pattern</span></span><span>
    </span><span>|&gt;</span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
fun gen_call_reasoners trace score tactics ctxt th =
  Thm.major_prem_of th
    |&gt; Envir.beta_eta_contract
    |&gt; get_reasoners' (Proof_Context.theory_of ctxt) tactics
    |&gt; 3 &lt;= trace ? (fn rs =&gt; (List.app (debug ctxt) rs; rs))
    |&gt; map (fn (priority, _, _, r : reasoner) =&gt;
          (priority + score, #pos r, #mode r, #tactic r (ctxt,th)
                    (* Seq.make (fn () =&gt; Seq.pull (#tactic r (ctxt,th))) *))) *)</span></span><span>
    </span><span class="comment1"><span>(*|&gt; map_filter (fn (priority, _, _, r : reasoner) =&gt;
        case #mode r
          of GLOBAL_CUT =&gt;
               (case Seq.pull (#tactic r (ctxt,th))
                  of SOME (x,_) =&gt; raise Global_Cut x
                   | _ =&gt; NONE)
           | LOCAL_CUT =&gt;
               (case Seq.pull (#tactic r (ctxt,th))
                  of SOME (x,s) =&gt; raise Local_Cut (score + priority, #pos r, Seq.cons x s)
                   | _ =&gt; NONE)
           | NORMAL =&gt;
              SOME (priority + score, #pos r, false,
                    Seq.make (fn () =&gt; Seq.pull (#tactic r (ctxt,th))))
           | TO_BE_OVERRIDE =&gt;
              SOME (priority + score, #pos r, true,
                    Seq.make (fn () =&gt; Seq.pull (#tactic r (ctxt,th))))
              
      )
  handle Local_Cut (s,pos,seq) =&gt; [(s,pos,false,seq)]
       | Success s =&gt; Success_Handlers.invoke (fst s) s
                   |&gt; map (fn (x,y) =&gt; (score,x,false,y))
       | Global_Cut s =&gt; Global_Cut_Handlers.invoke (fst s) s
                      |&gt; map (fn (x,y) =&gt; (score,x,false,y))*)</span></span><span>

</span><span class="comment1"><span>(*fun call_reasoners (ctxt,th) =
  gen_call_reasoners (Config.get ctxt trace) (Reasoners.get (Context.Proof ctxt)) ctxt th *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>disabled_due_to_backtrack</span></span><span> </span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>disabled_due_to_backtrack</span></span><span> </span><span class="entity"><span>NO_BACKTRACK</span></span><span> </span><span class="entity"><span>NO_BACKTRACKING</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>disabled_due_to_backtrack</span></span><span> </span><span class="entity"><span>NO_BACKTRACK</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>disabled_due_to_backtrack</span></span><span> </span><span class="entity"><span>NO_EXPLORATIVE_BACKTRACK</span></span><span> </span><span class="entity"><span>EXPLORATIVE_BACKTRACKING</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>disabled_due_to_backtrack</span></span><span> </span><span class="entity"><span>NO_EXPLORATIVE_BACKTRACK</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_reason</span></span><span> </span><span class="entity"><span>ctxt00</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>handlers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>limit</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tactics</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Statistics.count</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt00</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>count_subgoal</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Statistics.count_subgoal</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt00</span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>backtracking</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoal_statistics</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>trace</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"Backtracking..."</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span>
             </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>backtracking</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>EXPLORATIVE_BACKTRACKING</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>EXPLORATIVE_BACKTRACKING</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>BACKTRACKING</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoal_statistics</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>backtracking</span></span><span class="main"><span>,</span></span><span>
                </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cut_mode</span></span><span class="main"><span>,</span></span><span class="entity"><span>backtrack_mode</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>L'</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span>
                </span><span class="entity"><span>subgoal_statistics</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>backtrack_mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>NO_EXPLORATIVE_BACKTRACK</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>iter</span></span><span> </span><span>&gt;</span><span> </span><span class="entity"><span>limit</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>error</span></span><span> </span><span class="inner_quoted"><span>"The reasoning reaches the limit of the number of reasoning steps.\n\
                                   \Perhaps an infinite loop is encountered.\nOtherwise, \
                                   \you can set œÜreasoning_step_limit to increase the limit of the steps\
                                   \if it is too small."</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>transition</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>NORMAL</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span>context_state * context_state Seq.seq</span><span class="main"><span>)</span></span><span> option
                                    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>GO_EXPLORATIVE_BACKTRACKING</span></span><span>
                                    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>GO_GLOBAL_CUT</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> context_state
                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pull</span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>NORMAL</span></span><span> </span><span class="main"><span>(</span></span><span>Seq.pull</span><span> </span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Success</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pull</span></span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
                                      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Explorative_Backtrack</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>GO_EXPLORATIVE_BACKTRACKING</span></span><span>
                                           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Global_Cut</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>GO_GLOBAL_CUT</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Global_Cut</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pull</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
                                      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Explorative_Backtrack</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>GO_EXPLORATIVE_BACKTRACKING</span></span><span>
                                           </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Global_Cut</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>GO_GLOBAL_CUT</span></span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Explorative_Backtrack</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>GO_EXPLORATIVE_BACKTRACKING</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>disabled_due_to_backtrack</span></span><span> </span><span class="entity"><span>backtrack_mode</span></span><span> </span><span class="entity"><span>backtracking</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>backtracking</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>L'</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoal_statistics</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pull</span></span><span> </span><span class="entity"><span>seq</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>NORMAL</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seq'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>trace</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"œÜreasoning("</span></span><span>^</span><span>string_of_int</span><span> </span><span class="entity"><span>score</span></span><span>^</span><span class="inner_quoted"><span>"):"</span></span><span>^</span><span>
                                          </span><span>Position.here</span><span> </span><span class="entity"><span>pos</span></span><span> </span><span>^</span><span class="inner_quoted"><span>"\n"</span></span><span> </span><span>^</span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ngoals</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Syntax.non_deferable_subgoals'</span></span><span> </span><span class="entity"><span>th</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_time</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>now</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Posix.ProcEnv.times</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                                       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>#</span></span><span>utime </span><span class="entity"><span>now</span></span><span> </span><span>+</span><span>  </span><span class="main"><span>#</span></span><span>stime </span><span class="entity"><span>now</span></span><span>
                                      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_if_subgoal_solved</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span>NONE</span><span>
                      </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_if_subgoal_solved</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>L0</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ngoals_end</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>timer</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reporter</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ngoals</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>ngoals_end</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>{</span></span><span>nongc</span><span class="main"><span>=</span></span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>usr</span></span><span class="main"><span>,</span></span><span class="entity"><span>sys</span></span><span class="main"><span>}</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>...</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Timer.checkCPUTimes</span><span> </span><span class="entity"><span>timer</span></span><span>
                                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>reporter</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>iter</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>iter'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>usr</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>sys</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span> </span><span>NONE</span><span>
                                 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>L0</span></span><span>

                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subgoal_statistics'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>chk_if_subgoal_solved</span></span><span> </span><span class="entity"><span>subgoal_statistics</span></span><span>
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subgoal_statistics'</span></span><span> </span><span class="main"><span>=</span></span><span>
                          </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>subgoal_statistics'</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span>
                             </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>count_subgoal</span></span><span> </span><span class="entity"><span>th</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                                 </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>reporter</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ngoals</span></span><span>-</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter</span></span><span class="main"><span>,</span></span><span> </span><span>Timer.startCPUTimer</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>reporter</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>some</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>some</span></span><span>

                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>score</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>57980</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ngoals</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>N</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Success</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.could_beta_eta_contract</span><span> </span><span class="main"><span>(</span></span><span>Thm.major_prem_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
                                               </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Conv.gconv_rule</span><span> </span><span class="entity"><span>Phi_Help.beta_eta_conversion</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>th</span></span><span>
                                               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>th</span></span><span>
                                     </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_guard</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>M</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                                           </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PLPR_Syntax.non_deferable_subgoals'</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>M</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NO_BACKTRACKING</span></span><span class="main"><span>,</span></span><span>
                                                 </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NORMAL_MODE</span></span><span class="main"><span>,</span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                                                 </span><span class="entity"><span>subgoal_statistics'</span></span><span class="main"><span>)</span></span><span>
                                            </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Success</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>s</span></span><span>
                                     </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.strip_meta_hhf_bvs</span></span><span>
                                                              </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>Logic.dest_implies</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>get_reasoners'</span></span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tactics</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="entity"><span>concl</span></span><span>
                                    </span><span>|&gt;</span><span> </span><span class="inner_numeral"><span>3</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>trace</span></span><span> </span><span>?</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>debug</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>;</span></span><span> </span><span class="entity"><span>rs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>reasoner</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                          </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>pos </span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>#</span></span><span>mode </span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span>
                                           </span><span class="entity"><span>apply_tactic</span></span><span> </span><span class="entity"><span>count</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>chk_guard</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>pos </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>backtracking</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span>tactic </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>th'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        
                    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>Z</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>cut_mode</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>GLOBAL_CUT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>trace</span></span><span>
                                                           </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"œÜreasoning cut:\n"</span></span><span> </span><span>^</span><span> </span><span>Thm.string_of_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span>
                                                           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                                                </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NORMAL_MODE</span></span><span class="main"><span>,</span></span><span> </span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
                                               </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                               </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>LOCAL_CUT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Z</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span>
                                                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>pointer_eq</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>seq'</span></span><span class="main"><span>,</span></span><span>Seq.empty</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>L</span></span><span>
                                                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span class="entity"><span>seq'</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NO_CUT</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Z</span></span><span> </span><span>::</span><span> </span><span class="main"><span>(</span></span><span>
                                      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>pointer_eq</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>seq'</span></span><span class="main"><span>,</span></span><span>Seq.empty</span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>L'</span></span><span>
                                                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span class="entity"><span>seq'</span></span><span class="main"><span>)</span></span><span>::</span><span class="entity"><span>L'</span></span><span> 
        
                                          </span><span class="comment1"><span>(*reasoning branches of identical priority are considered emitted
                                            simultaneously of which failures are not considered as backtracking
                                            to others.
                                            Therefore, once one branch is invoked successfully, the other
                                            candidates of identical priority will not check the backtracking anymore,
                                            so we set their modes to ALLOW_BACKTRACK.*)</span></span><span>
                                          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>qchk</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
                                            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>qchk</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>score'</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>bmode</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                                                </span><span class="entity"><span>score</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>score'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bmode</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>qchk</span></span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span>
                                          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>toggle_bmode</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
                                            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>toggle_bmode</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>origin</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>score'</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>cmode</span></span><span class="main"><span>,</span></span><span class="entity"><span>bmode</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>ls</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                                                </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>score</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>score'</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>bmode</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span>
                                                </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>score'</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>cmode</span></span><span class="main"><span>,</span></span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>toggle_bmode</span></span><span> </span><span class="entity"><span>ls</span></span><span>
                                                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>origin</span></span><span>
                                          </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>toggle_bmode'</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>qchk</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>toggle_bmode</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>t</span></span><span>
        
                                       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>toggle_bmode'</span></span><span> </span><span class="entity"><span>t</span></span><span> </span><span>::</span><span class="entity"><span>L</span></span><span>
                                      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                    </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NO_BACKTRACKING</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Z</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoal_statistics'</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>NORMAL</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>backtracking</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>L'</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoal_statistics</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>GO_EXPLORATIVE_BACKTRACKING</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>EXPLORATIVE_BACKTRACKING</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>L'</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoal_statistics</span></span><span class="main"><span>)</span></span><span>
               </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>GO_GLOBAL_CUT</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span>&lt;=</span><span> </span><span class="entity"><span>trace</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"œÜreasoning("</span></span><span>^</span><span>string_of_int</span><span> </span><span class="entity"><span>score</span></span><span>^</span><span class="inner_quoted"><span>"):"</span></span><span>^</span><span>
                                            </span><span>Position.here</span><span> </span><span class="entity"><span>pos</span></span><span> </span><span>^</span><span class="inner_quoted"><span>"\n"</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"Global cut."</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>loop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>iter</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NO_BACKTRACKING</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>score</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NORMAL_MODE</span></span><span class="main"><span>,</span></span><span> </span><span>Seq.single</span><span> </span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>subgoal_statistics</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>loop</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*Entry point*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_reason'</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>states</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Timing.cond_timeit</span><span> </span><span class="main"><span>(</span></span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>count_performance</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_quoted"><span>"Time spent by œÜ-LPR reasoning:"</span></span><span> </span><span class="main"><span>(</span></span><span>
    </span><span class="entity"><span>PLPR_Statistics.measure_time_of_reasoning</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
     </span><span class="main"><span>(</span></span><span class="entity"><span>gen_reason</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                 </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="entity"><span>default_handlers</span></span><span> </span><span class="entity"><span>handlers</span></span><span class="main"><span>,</span></span><span>
                  </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>trace</span></span><span class="main"><span>,</span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>step_limit</span></span><span class="main"><span>,</span></span><span> </span><span>Reasoners.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NO_BACKTRACKING</span></span><span class="main"><span>,</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>seq</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>,</span></span><span> </span><span>Position.none</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>NORMAL_MODE</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>seq</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>states</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Success</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>



</span><span class="comment1"><span>(* Various Interfaces for Invoking Reasoning *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>num_of_protected_prems</span></span><span>  </span><span class="main"><span>_</span></span><span>  </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>num_of_protected_prems</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>N</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>PLPR_Syntax.non_deferable_subgoals'</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span>-</span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>~</span><span class="entity"><span>N</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>internal_reason</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>S</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>S</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>internal_reason</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>PLPR_Syntax.non_deferable_subgoals'</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>gen_reason'</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_of_protected_prems</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="entity"><span>N</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span> </span><span class="main"><span>(</span></span><span>Seq.single</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>internal_reason</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>num</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>sequent</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reason1</span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>reason</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>sequent</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>error</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>internal_reason_s</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>seqs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span class="entity"><span>seqs'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>seqs</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen_reason'</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span> </span><span class="entity"><span>seqs'</span></span><span> </span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reason_sXXX</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>seqs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>internal_reason_s</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>seqs</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>singleton</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.export</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>sequent'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ret</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>reason_tac</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>stat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>gen_reason'</span></span><span> </span><span class="entity"><span>handlers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>num_of_protected_prems</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>N</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>[</span></span><span class="main"><span>[</span></span><span> </span><span class="main"><span>(</span></span><span>Seq.single</span><span> </span><span class="entity"><span>stat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>]</span></span><span class="main"><span>]</span></span><span>
       </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span> </span><span>Seq.Result</span><span>
                    </span><span>#&gt;</span><span> </span><span>rpair</span><span> </span><span>Seq.empty</span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>



</span><span class="comment1"><span>(*** Command Interface ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>default_mode_of</span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>1000000</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>GLOBAL_CUT</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>1000</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>LOCAL_CUT</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>NO_CUT</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_mode</span></span><span> </span><span class="entity"><span>prio</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>cm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>cm</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bm</span></span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>check_mode</span></span><span> </span><span class="entity"><span>prio</span></span><span> </span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>default_mode_of</span></span><span> </span><span class="entity"><span>prio</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bm</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_method_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_patterns</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>method</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_pattern</span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>priority</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>prio</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Reasoner_Group.check_group</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prio</span></span><span>
                               </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>100</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_patterns</span></span><span>
             </span><span>|&gt;</span><span> </span><span>Syntax.read_props</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>flag</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flag</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span class="main"><span>,</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="entity"><span>raw_patterns</span></span><span> </span><span class="entity"><span>terms</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_pats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sgn</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sgn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_pats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sgn</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sgn</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Free</span><span class="main"><span>(</span></span><span>Binding.name_of</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>dummyT</span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>method'</span></span><span class="main"><span>,</span></span><span class="entity"><span>lthy'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Method_Closure.method_cmd</span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="inner_quoted"><span>"œÜ-LPR"</span></span><span> </span><span class="entity"><span>method</span></span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>method''</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Method_Closure.apply_method</span></span><span> </span><span class="entity"><span>lthy'</span></span><span> </span><span class="entity"><span>method'</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>method'''</span></span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>method''</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>thm</span></span><span class="main"><span>)</span></span><span> </span><span>|&gt;</span><span> </span><span>Seq.filter_results</span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_lthy</span></span><span> </span><span class="main"><span>{</span></span><span>name</span><span class="main"><span>=</span></span><span class="entity"><span>name'</span></span><span class="main"><span>,</span></span><span> pos</span><span class="main"><span>=</span></span><span>Binding.pos_of</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> group</span><span class="main"><span>=</span></span><span>the_list</span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>,</span></span><span> mode </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_mode</span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span>
               pattern</span><span class="main"><span>=</span></span><span class="entity"><span>pos_pats</span></span><span class="main"><span>,</span></span><span> blacklist</span><span class="main"><span>=</span></span><span class="entity"><span>neg_pats</span></span><span class="main"><span>,</span></span><span> tactic</span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Tac_ML</span></span><span> </span><span class="entity"><span>method'''</span></span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>lthy'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_cmd</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>raw_patterns</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>tactic_src</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lthy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_pattern</span><span> </span><span class="entity"><span>lthy</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>priority</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>prio</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Reasoner_Group.check_group</span></span><span> </span><span>true</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prio</span></span><span>
                               </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>100</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.read_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>name</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_patterns</span></span><span>
             </span><span>|&gt;</span><span> </span><span>Syntax.read_props</span><span> </span><span class="entity"><span>ctxt</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>flag</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>flag</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>tm</span></span><span class="main"><span>,</span></span><span> </span><span>the_default</span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="entity"><span>c</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="entity"><span>raw_patterns</span></span><span> </span><span class="entity"><span>terms</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_pats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sign</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sign</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>neg_pats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>sign</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>sign</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>ML_Syntax</span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span class="entity"><span>lthy</span></span><span> </span><span>|&gt;</span><span> </span><span>Context.proof_map</span><span> </span><span class="main"><span>(</span></span><span>
      </span><span>ML_Context.expression</span><span> </span><span class="main"><span>(</span></span><span>Input.pos_of</span><span> </span><span class="entity"><span>tactic_src</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>(</span></span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>"Theory.local_setup (Phi_Reasoner.add_lthy {name=("</span></span><span> </span><span>@</span><span>
         </span><span>ML_Lex.read</span><span> </span><span class="main"><span>(</span></span><span>print_term</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span>ML_Lex.read</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"), pos=("</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
         </span><span>ML_Lex.read</span><span> </span><span class="main"><span>(</span></span><span>print_position</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>"), mode=("</span></span><span> </span><span>@</span><span>
         </span><span>ML_Lex.read</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>print_mode_ML</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>check_mode</span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>"), group=("</span></span><span>@</span><span>
         </span><span>ML_Lex.read</span><span> </span><span class="main"><span>(</span></span><span>print_list</span><span> </span><span class="entity"><span>Reasoner_Group.print_ML</span></span><span> </span><span class="main"><span>(</span></span><span>the_list</span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span> </span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>"), pattern=("</span></span><span> </span><span>@</span><span>
         </span><span>ML_Lex.read</span><span> </span><span class="main"><span>(</span></span><span>print_list</span><span> </span><span class="main"><span>(</span></span><span>print_pair</span><span> </span><span>print_term</span><span> </span><span>print_int</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pos_pats</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
         </span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>"), blacklist=("</span></span><span> </span><span>@</span><span> </span><span>ML_Lex.read</span><span> </span><span class="main"><span>(</span></span><span>print_list</span><span> </span><span>print_term</span><span> </span><span class="entity"><span>neg_pats</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
         </span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>"), tactic= Phi_Reasoner.Tac_ML ((let in "</span></span><span> </span><span>@</span><span>
         </span><span>ML_Lex.read_source</span><span> </span><span class="entity"><span>tactic_src</span></span><span> </span><span>@</span><span>
         </span><span>ML_Lex.read</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>" end) : Phi_Reasoner.backtracking * context_state -&gt; context_state Seq.seq)})"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cut_mode_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>!</span></span><span>‚Ä∫</span></span></span><span> </span><span>|--</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>!</span></span><span>‚Ä∫</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>GLOBAL_CUT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span>||</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>!</span></span><span>‚Ä∫</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>LOCAL_CUT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span>||</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>?</span></span><span>‚Ä∫</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>NO_CUT</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span>||</span><span> </span><span>Scan.succeed</span><span> </span><span>NONE</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>backtrack_mode_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"default"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>NO_BACKTRACK</span></span><span class="main"><span>)</span></span><span>
                         </span><span>||</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"no"</span></span><span> </span><span>--</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"backtrack"</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>NO_BACKTRACK</span></span><span class="main"><span>)</span></span><span>
                         </span><span>||</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"no"</span></span><span> </span><span>--</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"explorative"</span></span><span> </span><span>--</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"backtrack"</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="entity"><span>NO_EXPLORATIVE_BACKTRACK</span></span><span class="main"><span>)</span></span><span>
                         </span><span>||</span><span> </span><span>Scan.succeed</span><span> </span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode_and_priority</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>backtrack_mode_parser</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>cut_mode_parser</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>swap</span><span class="main"><span>)</span></span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span class="entity"><span>Reasoner_Group.parser</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode_and_priority'</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Scan.peek</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>mode_and_priority</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Reasoner_Group.check_group</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Parse.$$$</span><span> </span><span class="inner_quoted"><span>"("</span></span><span> </span><span>|--</span><span> </span><span>Parse.enum</span><span> </span><span class="inner_quoted"><span>"|"</span></span><span>
      </span><span class="main"><span>(</span></span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>except</span></span><span>‚Ä∫</span></span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span>true</span><span> </span><span>--</span><span> </span><span>Parse.term</span><span>
                </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>(</span></span><span>‚Ä∫</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.int</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>)</span></span><span>‚Ä∫</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span>--|</span><span> </span><span>Parse.$$$</span><span> </span><span class="inner_quoted"><span>")"</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>command_keyword</span></span><span> </span><span class="keyword1"><span>œÜreasoner_ML</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="inner_quoted"><span>"define œÜreasoner"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Parse.position</span><span> </span><span>Parse.term</span><span> </span><span>--</span><span> </span><span class="entity"><span>mode_and_priority</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>patterns</span></span><span>
        </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> </span><span class="keyword2"><span>=</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>--</span><span> </span><span>Parse.ML_source</span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>setup_cmd</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.local_theory</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>command_keyword</span></span><span> </span><span class="keyword1"><span>œÜreasoner</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span class="inner_quoted"><span>"define œÜreasoner"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Parse.binding</span><span> </span><span>--</span><span> </span><span class="entity"><span>mode_and_priority</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>patterns</span></span><span>
        </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>keyword</span></span><span> </span><span class="keyword2"><span>=</span></span><span class="antiquote"><span>}</span></span></span></span><span> </span><span>--</span><span> </span><span>Parse.args1</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
      </span><span>&gt;&gt;</span><span> </span><span class="entity"><span>setup_method_cmd</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Outer_Syntax.command</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">command_keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword1"><span>print_œÜreasoners</span></span><span>‚Ä∫</span></span></span><span>
    </span><span class="inner_quoted"><span>"print œÜreasoner matching the given pattern\n\
    \No question mark: prints what reasoners will be attempted on the given task exactly\n\
    \One question mark: pritns all reasoners whose binding patterns match the given term\n\
    \Two question mark: prints all reasoners whose binding patterns are matched by the given pattern"</span></span><span>
    </span><span class="main"><span>(</span></span><span>Parse.term</span><span> </span><span>--</span><span> </span><span class="main"><span>(</span></span><span>Scan.optional</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>Args.query</span><span> </span><span>|--</span><span> </span><span>Args.query</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="inner_numeral"><span>2</span></span><span class="main"><span>)</span></span><span> </span><span>||</span><span>
                                   </span><span class="main"><span>(</span></span><span>Args.query</span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span>
   </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>raw_pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>power</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>Toplevel.keep</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>top</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Toplevel.context_of</span></span><span> </span><span class="entity"><span>top</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.read_prop</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_pattern</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_pattern</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>all_reasoners</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Reasoners.get</span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reasoners</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>power</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>get_reasoners'</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>all_reasoners</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>pattern</span></span><span>
                               </span><span class="main"><span>|</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>iNet.match_term</span><span> </span><span class="entity"><span>all_reasoners</span></span><span> </span><span class="entity"><span>pattern</span></span><span>
                                        </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
                                        </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="entity"><span>c2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="main"><span>|</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>iNet.entries</span><span> </span><span class="entity"><span>all_reasoners</span></span><span>
                                        </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>match_reasoner</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span>
                                        </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>a</span></span><span class="main"><span>,</span></span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
                                        </span><span>|&gt;</span><span> </span><span>sort</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>c2</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>int_ord</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>c1</span></span><span class="main"><span>,</span></span><span class="entity"><span>c2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>reasoners</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>writeln</span><span> </span><span class="inner_quoted"><span>"No reasoner found."</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>writeln</span><span> </span><span class="main"><span>(</span></span><span>Pretty.string_of</span><span> </span><span class="main"><span>(</span></span><span>Pretty.chunks</span><span>
                              </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pretty</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>reasoners</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>



</span><span class="comment1"><span>(*** Reasoner for Reasoning Rule ***)</span></span><span>

</span><span class="comment1"><span>(** Default Reasoner Group \&amp; Priority **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>DRG_eq</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>eq_pair3</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span class="main"><span>=</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Default_Reasoner_Groups</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span> * </span><span class="entity"><span>spattern</span></span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span class="main"><span>)</span></span><span> </span><span>iNet.net</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>iNet.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>iNet.merge</span><span> </span><span class="entity"><span>DRG_eq</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_default_group_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>reasoner_groups</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Default_Reasoner_Groups.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>iNet.match_term</span><span> </span><span class="entity"><span>reasoner_groups</span></span><span> </span><span class="entity"><span>term</span></span><span>
        </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>PLPR_Pattern.does_smatch</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvs</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.max_of</span></span><span> </span><span class="main"><span>(</span></span><span>int_ord</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
        </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assign_default_group</span></span><span> </span><span class="entity"><span>groups</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Default_Reasoner_Groups.map</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>group</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>iNet.insert_term</span><span> </span><span class="entity"><span>DRG_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>groups</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(** Default Pattern **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Default_Pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Pattern_Translation</span></span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>parse_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.parse_prop</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>check_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.check_props</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>multi_translation_err_msg</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"Fail to determine which pattern is preferable. \
                                \Please indicate the pattern manually using syntax \
                                \‚ÄπœÜreason for ‚Äπpattern‚Ä∫‚Ä∫"</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>the_default_pattern_of'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="entity"><span>Default_Pattern.translate</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>PLPR_Syntax.strip_embedded_patterns</span></span><span> </span><span class="entity"><span>pattern</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>process_error_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.ERROR|const"><span>ERROR</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Exn.error</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Text_Encoding.decode_text_str</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_error_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.TRACING|const"><span>TRACING</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>tracing</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Text_Encoding.decode_text_str</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_error_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.WARNING|const"><span>WARNING</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Text_Encoding.decode_text_str</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_error_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.FAIL|const"><span>FAIL</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Text_Encoding.decode_text_str</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_error_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.TRACE_FAIL|const"><span>TRACE_FAIL</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>warning</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Text_Encoding.decode_text_str</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>text</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>process_error_rule</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>is_error</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.ERROR|const"><span>ERROR</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_error</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.TRACING|const"><span>TRACING</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_error</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.WARNING|const"><span>WARNING</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_error</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.FAIL|const"><span>FAIL</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_error</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR_error_msg.html#PLPR_error_msg.TRACE_FAIL|const"><span>TRACE_FAIL</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>is_error</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>the_default_pattern_of</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter_out</span><span> </span><span class="entity"><span>is_error</span></span><span> </span><span>oo</span><span> </span><span class="entity"><span>the_default_pattern_of'</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>default_pattern_ML_sender</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Theory.setup_result</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>Default_Pattern.setup_attribute</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="entity_def" id="PLPR.\&lt;phi&gt;reason_default_pattern_ML|attribute"><span class="entity_def" id="PLPR.\&lt;phi&gt;reason_default_pattern|attribute"><span>œÜreason_default_pattern</span></span></span><span>‚Ä∫</span></span></span><span>
          </span><span class="inner_quoted"><span>"Phi_Reasoner.default_pattern_ML_sender"</span></span><span>
          </span><span class="inner_quoted"><span>"set the default pattern of a reasoning rule once its conclusion matches some pattern"</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(** Reasoning Rule Pass **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pass_data</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*rules*)</span></span><span> * </span><span class="main"><span>(</span></span><span class="entity"><span>mode'</span></span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> *
                 </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>priority</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>pattern</span></span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span class="entity"><span>guard</span></span><span> </span><span>option</span><span> * </span><span>Context.generic</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rule_pass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Position.T</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pass_data</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>pass_data</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>pass_id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*identifier*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>rule_pass_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>n2</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>n2</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Rule_Pass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>term</span><span> </span><span class="comment1"><span>(*name*)</span></span><span> * </span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>rule_pass</span></span><span class="main"><span>)</span></span><span> </span><span>iNet.net</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>iNet.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>iNet.merge</span><span> </span><span class="entity"><span>rule_pass_eq</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_passes</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get</span></span><span> </span><span class="entity"><span>term</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>iNet.match_term</span><span> </span><span class="main"><span>(</span></span><span>Rule_Pass.get</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>term</span></span><span>
          </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pattern.matches</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span class="entity"><span>term</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>TM</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>union</span><span> </span><span class="entity"><span>rule_pass_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get</span></span><span> </span><span class="entity"><span>TM</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>terms</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>run_passes</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>data</span></span><span> </span><span class="keyword1"><span class="keyword"><span>as</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>f</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>get_passes</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>data</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_pass</span></span><span> </span><span class="entity"><span>rule_pass</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Rule_Pass.map</span><span> </span><span class="main"><span>(</span></span><span>iNet.insert_term_safe</span><span> </span><span class="entity"><span>rule_pass_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>rule_pass</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule_pass</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_pass</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pattern</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Rule_Pass.map</span><span> </span><span class="main"><span>(</span></span><span>iNet.delete_term_safe</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span>Term.dummy</span><span class="main"><span>,</span></span><span> </span><span>K</span><span> </span><span>I</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(*structure Rule_Pass *)</span></span><span>

</span><span class="comment1"><span>(** Main Function **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>intro_reasoner</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>mode0</span></span><span> </span><span class="entity"><span>priority0_group0</span></span><span> </span><span class="entity"><span>pats0</span></span><span> </span><span class="entity"><span>guard0</span></span><span> </span><span class="entity"><span>rules0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules01</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>priority_group</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>patterns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blacklist</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ML_guard</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>run_passes</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer''</span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules0</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>priority0_group0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rules01</span></span><span>
             </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Thm.is_free_dummy</span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>Thm.is_dummy</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>error</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"No rule is given!"</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span class="entity"><span>group</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>priority_group</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>prio_grp</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>prio_grp</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rules</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>the_default_group_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>grp</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>grp</span></span><span>
           </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="inner_numeral"><span>100</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_mode</span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="entity"><span>mode</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>complete_prio</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>e_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e_except</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inargs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>e_pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e_except</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inargs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>embedding_rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>complete_prio</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>PLPR_Syntax.elim_embedded_patterns</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>inargs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>null</span><span> </span><span class="entity"><span>inargs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>embedding_rules</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>error</span></span><span> </span><span class="inner_quoted"><span>"Embedded IN-arguments are not supported yet."</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

    </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>mk_reasoner</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>patterns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blacklist</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>rules0</span></span><span>
                    </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract</span></span><span>
                          </span><span>#&gt;</span><span> </span><span class="entity"><span>PLPR_Syntax.merge_guards</span></span><span> </span><span class="main"><span>{</span></span><span>merge_cond </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>}</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                          </span><span>#&gt;</span><span> </span><span>Drule.zero_var_indexes</span><span>
                          </span><span>#&gt;</span><span> </span><span>Thm.trim_context</span><span> </span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>patterns</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>rules</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rule</span></span><span>
                                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>the_default_pattern_of'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>concl</span></span><span>
                                  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pat'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>concl</span></span><span class="main"><span>]</span></span><span>
                                               </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>List.filter</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>process_error_rule</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat'</span></span><span>
                                </span><span class="comment1"><span>(* val _ = info_pretty_generic ctxt 1 (fn () =&gt; Pretty.chunks (
                                          Pretty.str "No pattern is given, use the default pattern:" ::
                                          map (Syntax.pretty_term (Context.proof_of ctxt)) pat
                                      )) *)</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>rpair</span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                             </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>error</span></span><span> </span><span class="inner_quoted"><span>"Pattern of the reasoner is required"</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>the_default</span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>patterns</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules_with_flag</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>has_Gaurd</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;r&gt;Guard|const"><span>ùóãGuard</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>true</span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has_Gaurd</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>has_Gaurd</span></span><span> </span><span class="entity"><span>X</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has_Gaurd</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span>Pure.imp</span><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>has_Gaurd</span></span><span> </span><span class="entity"><span>X</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has_Gaurd</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span>Pure.all</span><span>‚Ä∫</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>has_Gaurd</span></span><span> </span><span class="entity"><span>X</span></span><span>
                  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>has_Gaurd</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.prems_of</span><span> </span><span class="entity"><span>rule</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>    </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>false</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
                   </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>r</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="entity"><span>has_Gaurd</span></span><span> </span><span class="entity"><span>L</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>error</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"A reasoning rule can contain one ùóãGuard antecedent at \
                                         \the leading position."</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>has_Gaurd</span></span><span> </span><span class="entity"><span>r</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>ML_guard</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Tac_Rule</span></span><span> </span><span class="entity"><span>rules_with_flag</span></span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>apply_reasoning_rules</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>internal_reason</span></span><span> </span><span>NONE</span><span> </span><span>o</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules_with_flag</span></span><span>
                                    </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Tac_ML</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>s</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>G</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>app</span></span><span> </span><span class="entity"><span>s</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Seq.empty</span><span class="main"><span>)</span></span><span>
                                   </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>{</span></span><span>name </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>name_of_intro_reasoner</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span>
           pos </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span>
           group </span><span class="main"><span>=</span></span><span> </span><span>the_list</span><span> </span><span class="entity"><span>group</span></span><span class="main"><span>,</span></span><span>
           mode </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span>
           pattern </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span>
           blacklist </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>blacklist</span></span><span class="main"><span>,</span></span><span>
           tactic </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>tac</span></span><span class="main"><span>}</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>embedding_rules</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>e_pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e_except</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>mk_reasoner</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e_pattern</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>patterns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>e_except</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>blacklist</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>emb_rules</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>excepts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>null</span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>excepts</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>emb_rules</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>mk_reasoner</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>emb_rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>patterns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blacklist</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>excepts</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>mk_reasoner</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>patterns</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>excepts</span></span><span> </span><span>@</span><span> </span><span class="entity"><span>blacklist</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>emb_rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_rule</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>intro_reasoner</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="entity"><span>rules</span></span><span>
        </span><span>|-&gt;</span><span> </span><span class="entity"><span>adds</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>add_rule_param</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>thm</span><span> </span><span>list</span><span> * </span><span>Position.T</span><span> * </span><span class="entity"><span>mode'</span></span><span> * </span><span class="entity"><span>Reasoner_Group.group</span></span><span> </span><span>option</span><span>
                    * </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span> * </span><span class="entity"><span>priority</span></span><span> </span><span>option</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> * </span><span class="entity"><span>pattern</span></span><span> </span><span>list</span><span>
                    * </span><span class="main"><span>(</span></span><span class="entity"><span>context_state</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>bool</span><span class="main"><span>)</span></span><span> </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_rules</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>add_rules</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>fold_map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span class="entity"><span>blacklist</span></span><span class="main"><span>,</span></span><span class="entity"><span>guard</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="entity"><span>intro_reasoner</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span class="entity"><span>blacklist</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span>|-&gt;</span><span> </span><span class="entity"><span>adds</span></span><span> </span><span>o</span><span> </span><span>flat</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>del_rules</span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>del_reasoners</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pats</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>pats</span></span><span>
                                   </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>the_default_pattern_of</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span>Thm.concl_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>r</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>#</span></span><span>tactic </span><span class="entity"><span>r</span></span><span>
                               </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Tac_Rule</span></span><span> </span><span class="entity"><span>rules'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                      </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.equiv_thm</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span class="entity"><span>th'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules'</span></span><span>
                                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Tac_ML</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span>
                    </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="comment1"><span>(** Interfaces **)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Args</span><span> </span><span>Scan</span><span> </span><span>Parse</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_prop_mode</span></span><span> </span><span class="entity"><span>mode'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.read_prop</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.set_mode</span><span> </span><span class="entity"><span>mode'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>read_prop_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>read_prop_mode</span></span><span> </span><span>Proof_Context.mode_pattern</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.peek</span><span> </span><span class="main"><span>(</span></span><span>named_term</span><span> </span><span>o</span><span> </span><span class="entity"><span>read_prop_pattern</span></span><span> </span><span>o</span><span> </span><span>Context.proof_of</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ML_guard_parser_raw</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>depend</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>ML_source</span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>src</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
         </span><span>Synchronized.change_result</span><span> </span><span class="entity"><span>PLP_Reasoner_Guard_Parse_Sender_locker</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span>
                </span><span>|&gt;</span><span> </span><span>ML_Context.expression</span><span> </span><span class="main"><span>(</span></span><span>Input.pos_of</span><span> </span><span class="entity"><span>src</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="main"><span>(</span></span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>"PLP_Reasoner_Guard_Parse_Sender := SOME (("</span></span><span> </span><span>@</span><span>
                   </span><span>ML_Lex.read_source</span><span> </span><span class="entity"><span>src</span></span><span> </span><span>@</span><span>
                   </span><span>ML_Lex.read</span><span> </span><span class="inner_quoted"><span>") : context_state -&gt; bool)"</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ml</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>the</span><span> </span><span class="main"><span>(</span></span><span>!</span><span class="entity"><span>PLP_Reasoner_Guard_Parse_Sender</span></span><span class="main"><span>)</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLP_Reasoner_Guard_Parse_Sender</span></span><span> </span><span>:=</span><span> </span><span>NONE</span><span>
           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ctxt0</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ml</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
         </span><span class="main"><span>)</span></span><span>
       </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ML_guard_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>option</span><span> </span><span class="main"><span>(</span></span><span>lift</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>if</span></span><span>‚Ä∫</span></span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>ML_guard_parser_raw</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>attr_syntax'</span></span><span> </span><span class="entity"><span>ext</span></span><span> </span><span class="entity"><span>gen</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Args</span><span> </span><span>Scan</span><span> </span><span>Parse</span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pos_parser</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.pos_parser</span></span><span> </span><span class="inner_quoted"><span>"œÜreasoner"</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>(</span></span><span>‚Ä∫</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.int</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>)</span></span><span>‚Ä∫</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
    </span><span>lift</span><span> </span><span class="entity"><span>pos_parser</span></span><span>
    </span><span>--</span><span> </span><span class="main"><span>(</span></span><span>lift</span><span> </span><span class="main"><span>(</span></span><span>option</span><span> </span><span>add</span><span class="main"><span>)</span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>mode_and_priority'</span></span><span class="main"><span>)</span></span><span>
    </span><span>--</span><span> </span><span class="entity"><span>ext</span></span><span>
    </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>gen</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>attr_syntax</span></span><span> </span><span class="entity"><span>ext</span></span><span> </span><span class="entity"><span>gen</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Args</span><span> </span><span>Scan</span><span> </span><span>Parse</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>(</span></span><span>‚Ä∫</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.int</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>)</span></span><span>‚Ä∫</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>attr_syntax'</span></span><span> </span><span class="main"><span>(</span></span><span>
           </span><span class="entity"><span>ext</span></span><span>
        </span><span>--</span><span> </span><span class="main"><span>(</span></span><span>optional</span><span> </span><span class="main"><span>(</span></span><span>lift</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>for</span></span><span>‚Ä∫</span></span></span><span class="main"><span>)</span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_pattern</span></span><span> </span><span>--</span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
        </span><span>--</span><span>  </span><span>optional</span><span> </span><span class="main"><span>(</span></span><span>lift</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>except</span></span><span>‚Ä∫</span></span></span><span class="main"><span>)</span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat</span><span> </span><span class="entity"><span>prop_pattern</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
        </span><span>--</span><span> </span><span class="entity"><span>ML_guard_parser</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>ext</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="entity"><span>gen</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ext</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*fun attr_syntax gen =
  let open Args Scan Parse
    fun read_term_mode mode' ctxt tm = Syntax.read_term (Proof_Context.set_mode mode' ctxt) tm
    val read_term_pattern = read_term_mode Proof_Context.mode_pattern
    val term_pattern = Scan.peek (named_term o read_term_pattern o Context.proof_of)
  
    fun read_prop_mode mode' ctxt tm = Syntax.read_prop (Proof_Context.set_mode mode' ctxt) tm
    val read_prop_pattern = read_prop_mode Proof_Context.mode_pattern
    val prop_pattern = Scan.peek (named_term o read_prop_pattern o Context.proof_of)
    fun cterm (ctxt,toks) = let val (term,ret) = term_pattern (ctxt,toks)
                             in (Context.cases Thm.global_cterm_of Thm.cterm_of ctxt term, ret) end
    val pos_parser = Phi_Help.pos_parser "œÜreasoner"
    val ML_guard = depend (fn ctxt0 =&gt; ML_source &gt;&gt; (fn src =&gt;
         let val ctxt = Context.Proof (Context.proof_of ctxt0)
              |&gt; ML_Context.expression (Input.pos_of src)
                (ML_Lex.read "Theory.local_setup (PLP_Reasoner_Guard_Parse_Sender.put ((" @
                 ML_Lex.read_source src @
                 ML_Lex.read ") : context_state -&gt; bool))")
         in (ctxt0, PLP_Reasoner_Guard_Parse_Sender.get (Context.the_proof ctxt)) end
       ))
    val priority = Scan.lift (Scan.option (<span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span>‚Äπ(‚Ä∫ |-- Parse.int --| <span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span>‚Äπ)‚Ä∫))
  in
    lift pos_parser
    -- lift (option add |-- mode_and_priority)
    -- Attrib.thms
    -- option (lift (<span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span>‚Äπfor‚Ä∫ |-- Args.$$$ "action") |-- cterm)
    -- ( optional (lift (<span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span>‚Äπfor‚Ä∫) |-- Scan.repeat (prop_pattern -- priority)) []
      -- optional (lift (<span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span>‚Äπexcept‚Ä∫) |-- Scan.repeat prop_pattern) [])
    -- option (lift <span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span>‚Äπif‚Ä∫ |-- ML_guard)
    &gt;&gt; (fn (((((pos, (mode,priority)), additional_rules), action), (pattern, blacklist)), guard) =&gt;
          gen (pos, mode, priority, additional_rules, action, (pattern, blacklist), guard))
  end
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>gen_attr_add_intro'</span></span><span> </span><span class="entity"><span>pass</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>priority</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>additional_rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>action</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>blacklist</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span>::</span><span class="entity"><span>additional_rules</span></span><span class="main"><span>)</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>is_some</span><span> </span><span class="entity"><span>action</span></span><span> </span><span>?</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="entity"><span>th</span></span><span> </span><span>RS</span><span> </span><span class="main"><span>(</span></span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span>
                                                </span><span>Vars.make</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"A"</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>0</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">typ</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span>‚Äπ</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.action|type"><span>action</span></a><span>‚Ä∫</span></span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>the</span><span> </span><span class="entity"><span>action</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                                  </span><span class="main"><span>(</span></span><span>Thm.transfer''</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="antiquote"><span>@{</span></span><span class="operator"><span>thm'</span></span><span> </span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag_I|fact"><span>Action_Tag_I</span></a><span class="antiquote"><span>}</span></span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract</span></span><span>
                   </span><span>|&gt;</span><span> </span><span>Drule.zero_var_indexes_list</span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>pass</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>add_rule</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>mode</span></span><span> </span><span class="entity"><span>priority</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span class="entity"><span>blacklist</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="entity"><span>rules'</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>local</span></span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>read_term_mode</span></span><span> </span><span class="entity"><span>mode'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Syntax.read_term</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.set_mode</span><span> </span><span class="entity"><span>mode'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>read_term_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>read_term_mode</span></span><span> </span><span>Proof_Context.mode_pattern</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>term_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.peek</span><span> </span><span class="main"><span>(</span></span><span>Args.named_term</span><span> </span><span>o</span><span> </span><span class="entity"><span>read_term_pattern</span></span><span> </span><span>o</span><span> </span><span>Context.proof_of</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cterm</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>term_pattern</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span class="entity"><span>toks</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>Context.cases</span><span> </span><span>Thm.global_cterm_of</span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>term</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>                
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>attr_rule_syntax</span></span><span> </span><span class="entity"><span>pass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>attr_syntax</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>Attrib.thms</span></span><span> </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>for</span></span><span>‚Ä∫</span></span></span><span> </span><span>|--</span><span> </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"action"</span></span><span class="main"><span>)</span></span><span> </span><span>|--</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="entity"><span>gen_attr_add_intro'</span></span><span> </span><span class="entity"><span>pass</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attr_add_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>attr_rule_syntax</span></span><span> </span><span>I</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>attr_del_rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Scan.lift</span><span> </span><span>Args.del</span><span> </span><span>|--</span><span>
      </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>for</span></span><span>‚Ä∫</span></span></span><span> </span><span>|--</span><span> </span><span>Scan.repeat</span><span> </span><span class="entity"><span>prop_pattern</span></span><span class="main"><span>)</span></span><span>
   </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="entity"><span>del_rules</span></span><span> </span><span class="entity"><span>patterns</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span>
      </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="entity_def" id="PLPR.\&lt;phi&gt;reason|attribute"><span>œÜreason</span></span><span>‚Ä∫</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>attr_del_rule</span></span><span> </span><span>||</span><span> </span><span class="entity"><span>attr_add_rule</span></span><span class="main"><span>)</span></span><span>
    </span><span class="inner_quoted"><span>"Decalre or remove introduction rules in œÜ-LPR."</span></span><span>

</span><span>#&gt;</span><span> </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="entity_def" id="PLPR.\&lt;phi&gt;reasoned|attribute"><span>œÜreasoned</span></span><span>‚Ä∫</span></span></span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span>Parse.nat</span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>N</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span>Thm.rule_attribute</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>reason1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="inner_quoted"><span>"œÜ-LPR reasoning fails"</span></span><span class="main"><span>)</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>N</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="inner_quoted"><span>"Eliminate leading N antecedents by œÜ-LPR reasoning"</span></span><span>

</span><span>#&gt;</span><span> </span><span class="entity"><span>Method.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="entity_def" id="PLPR.\&lt;phi&gt;reason|method"><span>œÜreason</span></span><span>‚Ä∫</span></span></span><span>
</span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Scan</span><span> </span><span>Parse</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
  </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Scan.option</span><span> </span><span>Parse.nat</span><span class="main"><span>)</span></span><span> </span><span>--|</span><span>
  </span><span class="entity"><span>Method.sections</span></span><span> </span><span class="main"><span>[</span></span><span>
    </span><span>Parse.position</span><span> </span><span>Args.add</span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
               </span><span class="entity"><span>Method.modifier</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>gen_attr_add_intro'</span></span><span> </span><span>I</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span>NONE</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ALLOW_BACKTRACK</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>‚åÇ</span></span></span></span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>]</span></span><span> </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>num_prems</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ths</span></span><span> </span><span class="comment1"><span>(*what to do?*)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>reason_tac</span></span><span> </span><span>NONE</span><span> </span><span class="entity"><span>num_prems</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
</span><span class="inner_quoted"><span>"Apply œÜ-LPR as a proof method."</span></span><span>

</span><span>#&gt;</span><span> </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="entity_def" id="PLPR.\&lt;phi&gt;default_reasoner_group|attribute"><span>œÜdefault_reasoner_group</span></span><span>‚Ä∫</span></span></span><span>
      </span><span class="main"><span>(</span></span><span>Parse.and_list1'</span><span> </span><span class="main"><span>(</span></span><span>Scan.repeat1</span><span>
          </span><span class="main"><span>(</span></span><span class="entity"><span>prop_pattern</span></span><span> </span><span>--|</span><span> </span><span>Scan.lift</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>:</span></span><span>‚Ä∫</span></span></span><span> </span><span>--</span><span> </span><span>Scan.lift</span><span> </span><span class="entity"><span>Reasoner_Group.parser</span></span><span>
                         </span><span>--</span><span> </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>(</span></span><span>‚Ä∫</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.nat</span><span> </span><span>--|</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‚Äπ</span><span class="keyword2"><span>)</span></span><span>‚Ä∫</span></span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span>&gt;&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>raw_pat_groups</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pat_groups</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>t</span></span><span class="main"><span>,</span></span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Proof_Context.augment</span><span> </span><span class="entity"><span>t</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span>
                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t'</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.export_terms</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>t</span></span><span class="main"><span>]</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>p</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>t'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Reasoner_Group.check_group</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>g</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                  </span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>flat</span><span> </span><span class="entity"><span>raw_pat_groups</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>assign_default_group</span></span><span> </span><span class="entity"><span>pat_groups</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="inner_quoted"><span>"declare the default reasoner group for rules matching the given pattern"</span></span><span>

</span><span class="main"><span>)</span></span><span>



</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
</span></pre>
</body>

</html>