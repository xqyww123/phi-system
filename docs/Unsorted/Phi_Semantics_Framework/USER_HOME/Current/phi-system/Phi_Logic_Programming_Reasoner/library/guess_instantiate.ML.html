<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/guess_instantiate.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/guess_instantiate.ML›</h1>
</div>

<pre class="source"><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>GUESS_INSTANTIATE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> guess_inst </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>string</span><span> * </span><span>typ</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*frees that cannot be bound*)</span></span><span>
              </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>cterm</span><span> </span><span>Vars.table</span><span> </span><span>option</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> guess_inst_tac </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>int</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>tactic</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> guess_inst_solver </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>solver</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_guess_inst_solver </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_guess_inst_looper </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>Proof.context</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Guess_Instantiate</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>GUESS_INSTANTIATE</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Guess_Conflicts</span></span><span>



</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>qchk_one_side</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.strip_comb</span><span> </span><span class="entity"><span>tm</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Term.is_Var</span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
      </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>Type_Info.is_constructor</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
        </span><span class="entity"><span>Type_Info.is_selector</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span>
       </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qchk_one_side</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bvtys</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>





</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>bans</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>args</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cterm0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cterm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract_cterm</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.instantiate_cterm</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cterm0</span></span><span class="main"><span>)</span></span><span>
               </span><span>|&gt;</span><span> </span><span>fold_rev</span><span> </span><span>Thm.lambda</span><span> </span><span class="entity"><span>args</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="main"><span>(</span></span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Term.exists_subterm</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span>aconv</span><span> </span><span>Free</span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bans</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>cterm</span></span><span>
                     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Var</span><span> </span><span class="entity"><span>v'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>v</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="entity"><span>v'</span></span><span>
                      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>true</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Vars.lookup</span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="entity"><span>v</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Vars.add</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>cterm'</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>cterm</span></span><span> </span><span>aconv</span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>cterm'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>tab</span></span><span>
                               </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Guess_Conflicts</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tab</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoners.Automation_Fail</span></span><span>

</span><span class="comment1"><span>(*only instantiate LHS*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess_inst_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bans</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LHS</span></span><span class="main"><span>,</span></span><span class="entity"><span>RHS</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maxidx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LH</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>LARGS</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Drule.strip_comb</span><span> </span><span class="entity"><span>LHS</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>LH</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Var</span><span> </span><span class="entity"><span>v</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maxidx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="entity"><span>bans</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>LARGS</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>RHS</span></span><span class="main"><span>)</span></span><span>
          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Type_Info</span><span>
                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>h</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>LH</span></span><span>
                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>split_ctr</span></span><span> </span><span class="entity"><span>continue</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tyinfo</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.typ_of_cterm</span><span> </span><span class="entity"><span>LHS</span></span><span>
                                     </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                          </span><span class="entity"><span>get_info1</span></span><span> </span><span class="main"><span>{</span></span><span>load_bnf </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
                                                     load_bnf_fp </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
                                                     load_ctr </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span>
                                                    </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span>
                                      </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctrs_of</span></span><span> </span><span class="entity"><span>tyinfo</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>selss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sel_of</span></span><span> </span><span class="entity"><span>tyinfo</span></span><span>
                      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ci</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>find_index</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span>Term.aconv_untyped</span><span> </span><span class="entity"><span>h</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctrs</span></span><span>
                   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>ci</span></span><span> </span><span>&lt;&gt;</span><span> </span><span class="inner_numeral"><span>~1</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span class="entity"><span>ci</span></span><span> </span><span>&lt;</span><span> </span><span>length</span><span> </span><span class="entity"><span>selss</span></span><span>
                         </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>length</span><span> </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>selss</span></span><span> </span><span class="entity"><span>ci</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>length</span><span> </span><span class="entity"><span>LARGS</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>targs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_ctyp</span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of_cterm</span><span> </span><span class="entity"><span>LHS</span></span><span class="main"><span>)</span></span><span>
                               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>SS</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>inst_sel</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Thm.typ_of</span><span> </span><span class="entity"><span>targs</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                                            </span><span class="main"><span>(</span></span><span>nth</span><span> </span><span class="entity"><span>selss</span></span><span> </span><span class="entity"><span>ci</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>S</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>guess</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>L</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.apply</span><span> </span><span class="entity"><span>S</span></span><span> </span><span class="entity"><span>RHS</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>LARGS</span></span><span> </span><span class="entity"><span>SS</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maxidx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>continue</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

                </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>step_selector</span></span><span> </span><span class="entity"><span>continue</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>LARGS</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>LARG</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tyinfo</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.typ_of_cterm</span><span> </span><span class="entity"><span>LARG</span></span><span>
                                           </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Type</span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                                </span><span class="entity"><span>get_info1</span></span><span> </span><span class="main"><span>{</span></span><span>load_bnf </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
                                                           load_bnf_fp </span><span class="main"><span>=</span></span><span> </span><span>false</span><span class="main"><span>,</span></span><span>
                                                           load_ctr </span><span class="main"><span>=</span></span><span> </span><span>true</span><span class="main"><span>}</span></span><span>
                                                          </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>name</span></span><span>
                                            </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctrs_of</span></span><span> </span><span class="entity"><span>tyinfo</span></span><span>
                            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>selss</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>sel_of</span></span><span> </span><span class="entity"><span>tyinfo</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="main"><span>(</span></span><span>get_index</span><span> </span><span class="main"><span>(</span></span><span>get_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                        </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Term.aconv_untyped</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>h</span></span><span class="main"><span>,</span></span><span class="entity"><span>j</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>j</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
                                     </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>selss</span></span><span class="main"><span>)</span></span><span>
                              </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>j</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                    </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>targs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.dest_ctyp</span><span> </span><span class="main"><span>(</span></span><span>Thm.ctyp_of_cterm</span><span> </span><span class="entity"><span>LARG</span></span><span class="main"><span>)</span></span><span>
                                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctr</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>nth</span><span> </span><span class="entity"><span>ctrs</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span>|&gt;</span><span> </span><span class="entity"><span>inst_ctr</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Thm.typ_of</span><span> </span><span class="entity"><span>targs</span></span><span class="main"><span>)</span></span><span>
                                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cargs</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.binder_types</span><span> </span><span class="main"><span>(</span></span><span>Term.fastype_of</span><span> </span><span class="entity"><span>ctr</span></span><span class="main"><span>)</span></span><span>
                                                 </span><span>|&gt;</span><span> </span><span>map_index</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                                                      </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>j</span></span><span>
                                                      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>RHS</span></span><span>
                                                      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Thm.var</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"𝖺"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>maxidx</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span>+</span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.ctyp_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>)</span></span><span>
                                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>RHS'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cterm_of</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>ctr</span></span><span>
                                                </span><span>|&gt;</span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>a</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Thm.apply</span><span> </span><span class="entity"><span>f</span></span><span> </span><span class="entity"><span>a</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cargs</span></span><span>
                                     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>guess</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>LARG</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>RHS'</span></span><span class="main"><span>)</span></span><span>
                                              </span><span class="main"><span>(</span></span><span class="entity"><span>maxidx</span></span><span> </span><span>+</span><span> </span><span>length</span><span> </span><span class="entity"><span>cargs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span>
                                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                               </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>continue</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                     </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>continue</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>

      
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>split_ctr</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>step_selector</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maxidx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>maxidx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>guess</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess_inst'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bans</span></span><span> </span><span class="entity"><span>cterm</span></span><span> </span><span class="entity"><span>tab</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.term_of</span><span> </span><span class="entity"><span>cterm</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.conj|const"><span>HOL.conj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>guess_inst'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bans</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>guess_inst'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bans</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg1</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>bans</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>qchk_one_side</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>A</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>guess_inst_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bans</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg1</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>qchk_one_side</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>B</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>guess_inst_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bans</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.dest_arg1</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tab</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span>snd</span><span> </span><span class="entity"><span>bans</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>qchk_one_side</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>A</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>guess_inst_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bans</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg1</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>qchk_one_side</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>B</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>guess_inst_eq</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bans</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.dest_arg1</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>tab</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="entity"><span>guess_inst'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bans</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tab</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.All|const"><span>HOL.All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Variable.dest_abs_cterm</span><span> </span><span class="main"><span>(</span></span><span>Thm.dest_arg</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                 </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>var</span></span><span class="main"><span>,</span></span><span class="entity"><span>cterm'</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>guess_inst'</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span>Term.dest_Free</span><span> </span><span class="main"><span>(</span></span><span>Thm.term_of</span><span> </span><span class="entity"><span>var</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bans</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>cterm'</span></span><span> </span><span class="entity"><span>tab</span></span><span class="main"><span>)</span></span><span>
       </span><span class="comment1"><span>(*| Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹HOL.Ex›, _) $ Abs _ =&gt;
              (case Variable.dest_abs_cterm (Thm.dest_arg cterm) ctxt
                 of ((var,cterm'), ctxt') =&gt; guess_inst' ctxt' (Thm.term_of var::bans) cterm' tab) *)</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>tab</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>quick_check</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>qchk</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.conj|const"><span>HOL.conj</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="entity"><span>qchk</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>qchk</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>B</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>qchk</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="entity"><span>qchk_one_side</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>qchk_one_side</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>B</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>qchk</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
                  </span><span class="entity"><span>qchk_one_side</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>A</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span class="entity"><span>qchk_one_side</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>B</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>qchk</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qchk</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>qchk</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.All|const"><span>HOL.All</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span>Abs</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ty</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>qchk</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ty</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>bvtys</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>qchk</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>false</span><span>
        </span><span class="comment1"><span>(*| qchk bvtys (Const(<span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span>‹HOL.Ex›, _) $ Abs (_, Ty, X)) = qchk (Ty :: bvtys) X *)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>qchk</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess_inst</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bans</span></span><span> </span><span class="entity"><span>cterm</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>guess_inst'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>bans</span></span><span> </span><span class="entity"><span>cterm</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.maxidx_of_cterm</span><span> </span><span class="entity"><span>cterm</span></span><span class="main"><span>,</span></span><span> </span><span>Vars.empty</span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Vars.is_empty</span><span> </span><span class="entity"><span>ret</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>ret</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Guess_Conflicts</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>enable_inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Config.declare_bool</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"enable_inst"</span></span><span class="main"><span>,</span></span><span> </span><span class="antiquoted"><span class="operator"><span class="entity"><span>⌂</span></span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess_inst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Seq.make</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>bvtys</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.strip_meta_hhf_bvtys</span></span><span> </span><span class="main"><span>(</span></span><span>Logic.nth_prem</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>n</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.prop_of</span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>quick_check</span></span><span> </span><span class="main"><span>(</span></span><span>Context.Proof</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>bvtys</span></span><span> </span><span class="entity"><span>concl</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cprem</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.cprem_of</span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="entity"><span>n</span></span><span>
          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lb</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.strip_meta_hhf_c</span></span><span> </span><span class="entity"><span>cprem</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>enable_inst</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>guess_inst</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Term.dest_Free</span><span> </span><span>o</span><span> </span><span>Thm.term_of</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>lb</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>concl</span></span><span>
            </span><span>|&gt;</span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>,</span></span><span> </span><span>Seq.empty</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*val present_solvers = #1 (Raw_Simplifier.solvers <span class="hidden">\&lt;^</span><span class="control">context</span><span class="hidden">&gt;</span>)*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>solve_all_tac</span></span><span> </span><span class="entity"><span>solvers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>subgoal_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Raw_Simplifier.subgoal_tac</span><span> </span><span class="main"><span>(</span></span><span>Raw_Simplifier.set_solvers</span><span> </span><span class="entity"><span>solvers</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
    </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>solve_tac</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>subgoal_tac</span></span><span> </span><span>THEN_ALL_NEW</span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>no_tac</span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>DEPTH_SOLVE</span><span> </span><span>o</span><span> </span><span class="entity"><span>solve_tac</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>;</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>guess_inst_solver</span></span><span> </span><span class="entity"><span>ctxt0</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>Simplifier.mk_solver</span><span> </span><span class="inner_quoted"><span>"inst_var_by_Ctr_sels"</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
   </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>st</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Thm.major_prem_of</span><span> </span><span class="entity"><span>st</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.eq</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_Var</span><span> </span><span class="main"><span>(</span></span><span>Term.head_of</span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>is_Var</span><span> </span><span class="main"><span>(</span></span><span>Term.head_of</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Seq.empty</span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>guess_inst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>st</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.eq|const"><span>HOL.eq</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>A</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>is_Var</span><span> </span><span class="main"><span>(</span></span><span>Term.head_of</span><span> </span><span class="entity"><span>A</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>is_Var</span><span> </span><span class="main"><span>(</span></span><span>Term.head_of</span><span> </span><span class="entity"><span>B</span></span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Seq.empty</span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>guess_inst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>st</span></span><span>
         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>guess_inst_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span>
     </span><span>THEN</span><span> </span><span class="entity"><span>Simplifier.asm_full_simp_tac</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span>
    </span><span>ORELSE</span><span>
    </span><span>FIRST'</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Raw_Simplifier.solver</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span>Raw_Simplifier.solvers</span><span> </span><span class="entity"><span>ctxt0</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>n</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>st</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_guess_inst_looper</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span>addloop</span><span> </span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"inst_var_by_Ctr_sels"</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guess_inst_tac</span></span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_guess_inst_solver</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Raw_Simplifier.set_solvers</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>guess_inst_solver</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>Simplifier.map_theory_simpset</span><span> </span><span class="entity"><span>add_guess_inst_looper</span></span><span class="main"><span>)</span></span><span>


</span><span class="keyword2"><span class="keyword"><span>end</span></span></span></pre>
</body>

</html>