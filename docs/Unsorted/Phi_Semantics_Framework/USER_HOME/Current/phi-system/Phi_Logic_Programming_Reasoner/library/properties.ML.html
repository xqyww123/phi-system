<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>File ‹library/properties.ML›</title>
</head>


<body>
<div class="head">
<h1>File ‹library/properties.ML›</h1>
</div>

<pre class="source"><span class="comment1"><span>(*
▪ Storage of properties.
▪ Deriving rules from property-conditioned templates
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>signature</span></span></span><span> </span><span class="entity"><span>PHI_TYPE_TEMPLATE_PROPERTIES</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>sig</span></span></span><span>

</span><span class="comment1"><span>(*** Algebraic Properties ***)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>property_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span class="comment1"><span>(*pattern of the property, of type Pure.prop*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>property_pattern_i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> check_property </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>property_pattern</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>property_pattern_i</span></span><span> </span><span>option</span><span>
                     </span><span class="comment1"><span>(*returns normalized form if it is a registered property*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> assert_property_pattern </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>property_pattern</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>property_pattern_i</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_property_kinds </span><span class="main"><span>:</span></span><span> </span><span>term</span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>theory</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lookup_properties_match </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>property_pattern_i</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Position.T</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> lookup_properties_unify </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>property_pattern_i</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>Position.T</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_property_instance </span><span class="main"><span>:</span></span><span> </span><span>Position.T</span><span> * </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
</span><span class="comment1"><span>(*val list_functors : Context.generic -&gt; term list*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> invoking_instantiations </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span> </span><span class="comment1"><span>(*provides a controller to temporarily disable
  instantiations of templates that are invoked when property instances are given.*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> adding_property </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span>Config.T</span><span> </span><span class="comment1"><span>(*controls if for any new reasoning rules registered to φ-LPR,
  automatically checking whether the rule matches certain known form of properties and
  if so registering it as an instance of the property and invoking the related automation (if the
  `invoking_instantiations` is turned on)*)</span></span><span>

</span><span class="comment1"><span>(*** The Framework for Automation based on Algebraic Property ***)</span></span><span>

</span><span class="comment1"><span>(** Types **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>parameters</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>property_pattern</span></span><span> </span><span>option</span><span> </span><span>list</span><span> </span><span class="comment1"><span>(*corresponding to the premises of the template rule
          one to one respectively, and being NONE if the premise in the corresponded position is
          not a property for instantiating*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>instance_binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>indexname</span><span> </span><span>list</span><span> * </span><span>binding</span><span>
                        </span><span class="comment1"><span>(*^b a variable that will be instantiated to a φ-type, and the binding will
                          by qualified by the short-name of the heading constant of the φ-type*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rule_generation_pass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*default generation process*)</span></span><span>
                          * </span><span>Position.T</span><span> </span><span class="comment1"><span>(*where the template is instantiated*)</span></span><span>
                          * </span><span class="entity"><span>Proof.context</span></span><span>
                         </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> no_rule_generation_pass </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>rule_generation_pass</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>free_template_action</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span>Position.T</span><span> </span><span class="comment1"><span>(*Position where the instantiation happens*)</span></span><span> *
        </span><span class="main"><span>(</span></span><span> </span><span>Envir.env</span><span> </span><span class="comment1"><span>(*unifier for the template parameters and instantiating properties*)</span></span><span> *
          </span><span class="main"><span>(</span></span><span>Position.T</span><span> * </span><span>thm</span><span> </span><span class="comment1"><span>(*property*)</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>list</span><span> </span><span class="main"><span>)</span></span><span>
     </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>template_action</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>Instantiate_Rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> thm * </span><span class="main"><span>(</span></span><span>rule_generation_pass * Phi_Reasoner.rule_pass</span><span class="main"><span>)</span></span><span> option *
                                PLPR_Rule_Gen.instantiation_action * instance_binding option
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Free_Action</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> free_template_action </span><span class="comment1"><span>(*accept Automation_Fail*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parameters</span></span><span> * </span><span>Position.T</span><span> </span><span class="comment1"><span>(*position of the template*)</span></span><span> * </span><span class="entity"><span>template_action</span></span><span>

</span><span class="comment1"><span>(** Basic Operations: Add, List, Invoke **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> add_template </span><span class="main"><span>:</span></span><span> </span><span>bool</span><span> </span><span class="comment1"><span>(*if to invoke on the existing instantiations if any*)</span></span><span>
                </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> list_templates </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>template_argument</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Position.T</span><span> </span><span class="comment1"><span>(*position of the property*)</span></span><span> * </span><span>thm</span><span> </span><span class="comment1"><span>(*property*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> invoke_template </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>template_argument</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> invoke_instantiations_on_property </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>template_argument</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>
    </span><span class="comment1"><span>(*invokes any template depending on the given property and of all dependencies satisfied*)</span></span><span>

</span><span class="comment1"><span>(** Auxiliaries **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty_template </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> pretty_templates </span><span class="main"><span>:</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span> * </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span> </span><span>Ord_List.T</span><span> </span><span>Symtab.table</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Pretty.T</span><span>

</span><span class="comment1"><span>(*** Developer Tools ***)</span></span><span>

</span><span class="comment1"><span>(*Debugging use only*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> assert_derived_properties </span><span class="main"><span>:</span></span><span> </span><span>theory</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> * </span><span>term</span><span class="main"><span>)</span></span><span> </span><span>list</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>unit</span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>PLPR_Template_Properties</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>PHI_TYPE_TEMPLATE_PROPERTIES</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>struct</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Rule_Gen.Generation_Fail</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>property_pattern</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>property_pattern_i</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span>

</span><span class="comment1"><span>(*** Algebraic Property &amp; Automation ***)</span></span><span>

</span><span class="comment1"><span>(** Property Kind **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Property_Kinds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>term</span><span> </span><span>Net.net</span><span> </span><span class="comment1"><span>(*proposition form, with Trueprop*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.merge</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>op</span></span></span><span> </span><span>aconv</span><span class="main"><span>)</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trim_modifiers</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.Trueprop|const"><span>Trueprop</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.Trueprop</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>trim_modifiers</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>trim_modifiers</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.Action_Tag|const"><span>Action_Tag</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span> </span><span>$</span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;A&gt;_template_reason|const"><span>𝒜_template_reason</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trim_modifiers</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>trim_modifiers</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../Phi_Logic_Programming_Reasoner.PLPR.html#PLPR.\&lt;r&gt;Guard|const"><span>𝗋Guard</span></a><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trim_modifiers</span></span><span> </span><span class="entity"><span>X</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>trim_modifiers</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>X</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_property</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>kinds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Property_Kinds.get</span><span> </span><span class="entity"><span>thy</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trim_modifiers</span></span><span> </span><span class="entity"><span>X</span></span><span>
               </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pat</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pattern.matches</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pat</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                            </span><span class="main"><span>(</span></span><span>Net.match_term</span><span> </span><span class="entity"><span>kinds</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>X</span></span><span>
                  </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>NONE</span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>err_not_a_property_kind</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>string_of</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span>block</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>Syntax.pretty_term_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
               </span><span>text</span><span> </span><span class="inner_quoted"><span>"is not a known φ-type property. Please use ML function \
                    \‹Phi_Type.add_property_kind› to register it."</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assert_property_pattern</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_property</span></span><span> </span><span class="entity"><span>thy</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>chk</span></span><span> </span><span class="entity"><span>k</span></span><span>
                </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>x</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>x</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>err_not_a_property_kind</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>k</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Property DB **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>free_template_action</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Position.T</span><span> </span><span class="comment1"><span>(*Position where the instantiation happens*)</span></span><span> *
                            </span><span class="main"><span>(</span></span><span> </span><span>Envir.env</span><span> </span><span class="comment1"><span>(*unifier for the template parameters and instantiating properties*)</span></span><span> *
                              </span><span class="main"><span>(</span></span><span>Position.T</span><span> * </span><span>thm</span><span> </span><span class="comment1"><span>(*property*)</span></span><span class="main"><span>)</span></span><span> </span><span>option</span><span> </span><span>list</span><span> </span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>Context.generic</span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>parameters</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>property_pattern</span></span><span> </span><span>option</span><span> </span><span>list</span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>instance_binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>indexname</span><span> </span><span>list</span><span> * </span><span>binding</span><span>
                        </span><span class="comment1"><span>(*^b a variable that will be instantiated to a φ-type, and the binding will
                          by qualified by the short-name of the heading constant of the φ-type*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>rule_generation_pass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span class="main"><span>)</span></span><span> * </span><span>Position.T</span><span> * </span><span class="entity"><span>Proof.context</span></span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span class="main"><span>-&gt;</span></span><span> </span><span>thm</span><span> </span><span>list</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>no_rule_generation_pass</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>default</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>default</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>datatype</span></span></span><span> </span><span class="entity"><span>template_action</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="entity"><span>Instantiate_Rule</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> thm * </span><span class="main"><span>(</span></span><span>rule_generation_pass * Phi_Reasoner.rule_pass</span><span class="main"><span>)</span></span><span> option *
                                PLPR_Rule_Gen.instantiation_action * instance_binding option
          </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Free_Action</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> free_template_action

</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>parameters</span></span><span> * </span><span>Position.T</span><span> * </span><span class="entity"><span>template_action</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>template_argument</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Position.T</span><span> </span><span class="comment1"><span>(*position of the property*)</span></span><span> * </span><span>thm</span><span> </span><span class="comment1"><span>(*property*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>property_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>th1</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>th2</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.eq_thm_prop</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th1</span></span><span class="main"><span>,</span></span><span class="entity"><span>th2</span></span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Properties</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>Position.T</span><span> * </span><span>thm</span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span> </span><span class="comment1"><span>(*proposition form*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.merge</span><span> </span><span class="entity"><span>property_eq</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>template_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>s1</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>s2</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>s2</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>structure</span></span></span><span> </span><span class="entity"><span>Templates</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Generic_Data</span><span> </span><span class="main"><span>(</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>type</span></span></span><span> </span><span class="entity"><span>T</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>serial</span><span> * </span><span class="entity"><span>property_pattern</span></span><span> * </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span> </span><span>Net.net</span><span> </span><span class="comment1"><span>(*key: every parameter of a temlpate*)</span></span><span>
                     </span><span class="comment1"><span>(*convention, the property_pattern only contains schematic variables of negative indexes*)</span></span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>empty</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.empty</span><span>
  </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>merge</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.merge</span><span> </span><span class="entity"><span>template_eq</span></span><span>
</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>list_templates</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Templates.get</span><span> </span><span>#&gt;</span><span> </span><span>Net.content</span><span> </span><span>#&gt;</span><span> </span><span>distinct</span><span> </span><span class="entity"><span>template_eq</span></span><span> </span><span>#&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_template</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>action</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>chunks</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Instantiate_Rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="main"><span>[</span></span><span>block</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Template"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
                        </span><span>the_default</span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>single</span><span> </span><span>o</span><span> </span><span>Binding.pretty</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
                        </span><span>here</span><span> </span><span class="entity"><span>pos</span></span><span> </span><span>@</span><span>
                        </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Context.cases</span><span> </span><span>Thm.pretty_thm_global</span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>]</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Free_Action</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="main"><span>[</span></span><span>block</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"ML automation"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span>here</span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span>@</span><span>
        </span><span class="main"><span>[</span></span><span>para</span><span> </span><span class="inner_quoted"><span>"depending on:"</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
        </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>item</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span class="main"><span>]</span></span><span>
              </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>param</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>item</span><span> </span><span class="main"><span>[</span></span><span>Context.cases</span><span> </span><span>Syntax.pretty_term_global</span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>param</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span>
     </span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>pretty_templates</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>table</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>priority</span></span><span> * </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span> </span><span>Ord_List.T</span><span> </span><span>Symtab.table</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>templates</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Symtab.fold</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>insert</span><span> </span><span>pointer_eq</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>table</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>chunks</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>item</span><span> </span><span>o</span><span> </span><span>single</span><span> </span><span>o</span><span> </span><span class="entity"><span>pretty_template</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>templates</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*
fun check_termplate ((params, pos, act) : template) : template =
  let val idx = fold (fn SOME param =&gt; Term.maxidx_term param | _ =&gt; I) params ~1
   in if idx &gt;= 0 then (map (Option.map (Logic.incr_indexes ([],[],1-idx))) params, pos, act)
                  else (params, pos, act)
  end
*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trim_template</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>act</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="main"><span>(</span></span><span class="entity"><span>params</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>act</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Instantiate_Rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pass</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                </span><span class="entity"><span>Instantiate_Rule</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.trim_context</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pass</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>PLPR_Rule_Gen.trim_action</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>Free_Action</span></span><span> </span><span class="entity"><span>act</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>Free_Action</span></span><span> </span><span class="entity"><span>act</span></span><span class="main"><span>)</span></span><span>

</span><span class="comment1"><span>(*
fun close_phitype_operator phityp =
  let val i = maxidx_of_term phityp + 1
   in case Term.binder_types (Term.fastype_of phityp)
   of [] =&gt; phityp
    | L =&gt; fold_index (fn (j,Ty) =&gt; fn Tm =&gt; Tm $ Var(("x",i+j), Ty)) L phityp
  end*)</span></span><span>

</span><span class="comment1"><span>(*fun net_encode_phityp phityp = Const("F", dummyT) $ phityp*)</span></span><span>

</span><span class="comment1"><span>(*fun get_property_name thm =
  if Thm.is_dummy thm then ""
  else fst (Term.dest_Const (Term.head_of (HOLogic.dest_Trueprop (Thm.concl_of thm))))*)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_properties_match</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>properties</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Properties.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span>Net.match_term</span><span> </span><span class="entity"><span>properties</span></span><span> </span><span class="entity"><span>pattern</span></span><span>
   </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pattern.matches</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*no transfer*)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_property_unify'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>properties</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Properties.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>additions</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span>Envir.Envir</span><span> </span><span class="main"><span>{</span></span><span class="entity"><span>maxidx</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tenv</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tyenv</span></span><span class="main"><span>}</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>env</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>filter</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>th</span></span><span>
                                   </span><span>|&gt;</span><span> </span><span class="entity"><span>maxidx</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>?</span><span> </span><span>Logic.incr_indexes</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>maxidx</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>cidx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>maxidx</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Thm.maxidx_of</span><span> </span><span class="entity"><span>th</span></span><span> </span><span>+</span><span> </span><span class="entity"><span>maxidx</span></span><span> </span><span>+</span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span>Thm.maxidx_of</span><span> </span><span class="entity"><span>th</span></span><span>
                          </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>env'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Envir.Envir</span><span> </span><span class="main"><span>{</span></span><span>maxidx </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cidx</span></span><span class="main"><span>,</span></span><span> tenv</span><span class="main"><span>=</span></span><span class="entity"><span>tenv</span></span><span class="main"><span>,</span></span><span> tyenv</span><span class="main"><span>=</span></span><span class="entity"><span>tyenv</span></span><span class="main"><span>}</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.pull</span><span> </span><span class="main"><span>(</span></span><span>Unify.hounifiers</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ctxt</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env'</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>pattern</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>concl</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span>Seq.map</span><span> </span><span>fst</span><span> </span><span class="main"><span>(</span></span><span>uncurry</span><span> </span><span>Seq.cons</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>union</span><span> </span><span class="main"><span>(</span></span><span>pointer_eq</span><span> </span><span>o</span><span> </span><span>apply2</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>filter</span></span><span> </span><span class="entity"><span>additions</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>(</span></span><span class="entity"><span>filter</span></span><span> </span><span class="main"><span>(</span></span><span>Net.unify_term</span><span> </span><span class="entity"><span>properties</span></span><span> </span><span class="entity"><span>pattern</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>lookup_properties_unify</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lookup</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lookup_property_unify'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pattern</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
      </span><span class="entity"><span>lookup</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.empty</span><span> </span><span class="main"><span>(</span></span><span>Term.maxidx_of_term</span><span> </span><span class="entity"><span>pattern</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>pattern</span></span><span>
        </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>snd</span><span> </span><span>#&gt;</span><span> </span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(* Invoke template instantiation *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>instantiations_of_parameters</span></span><span> </span><span class="entity"><span>get_property</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ext</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>param</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>props</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
             </span><span class="entity"><span>get_property</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>param</span></span><span>
          </span><span>|&gt;</span><span> </span><span>map_filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>envs</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                    </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Seq.chop</span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>envs</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="entity"><span>env</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>props</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>NONE</span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span> </span><span>::</span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
                             </span><span class="entity"><span>Phi_Reasoner.warn_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>2</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
                                </span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"Multi-unififers in instantiating the"</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                                       </span><span>str</span><span> </span><span class="main"><span>(</span></span><span>string_of_int</span><span> </span><span class="entity"><span>i</span></span><span> </span><span>^</span><span> </span><span class="inner_quoted"><span>"th"</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span>
                                       </span><span>text</span><span> </span><span class="inner_quoted"><span>"parameter of a template. We only preserve the \
                                            \first unifier for performance consideration."</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                           </span><span class="main"><span>;</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>props</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>cross</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>rev</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ret</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>cross</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>ret</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>params</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>cross</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>i</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>maps</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext</span></span><span> </span><span class="entity"><span>i</span></span><span> </span><span class="entity"><span>param</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ret</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>init_idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.maxidx_term</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>params</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>params'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="entity"><span>cross</span></span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ext</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>param</span></span><span> </span><span class="main"><span>(</span></span><span>Envir.empty</span><span> </span><span class="entity"><span>init_idx</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params'</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>existing_instantiations_of_parameters</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>instantiations_of_parameters</span></span><span>
          </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup_property_unify'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>Seq.single</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>check_dependencies</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>property</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>Dep</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>didx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.maxidx_term</span><span> </span><span class="entity"><span>p</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>I</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span> </span><span class="inner_numeral"><span>~1</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop_concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>property</span></span><span>
                    </span><span>|&gt;</span><span> </span><span class="entity"><span>didx</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span>?</span><span> </span><span>Logic.incr_indexes</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="entity"><span>didx</span></span><span>+</span><span class="inner_numeral"><span>1</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>Thm.is_dummy</span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>andalso</span></span></span><span> </span><span>exists</span><span> </span><span class="main"><span>(</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>param</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.could_unify</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop_concl</span></span><span class="main"><span>)</span></span><span>
             </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>params</span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>lookup</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>lookup_property_unify'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_property</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="main"><span>(</span></span><span>SOME</span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lookup</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>property</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span class="entity"><span>p</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_property</span></span><span> </span><span class="entity"><span>env</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>(</span></span><span>Seq.single</span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span>NONE</span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
               </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ruless</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>instantiations_of_parameters</span></span><span> </span><span class="entity"><span>get_property</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>params</span></span><span>
                         </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span>exists</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>pointer_eq</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>false</span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span>snd</span><span class="main"><span>)</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                          </span><span class="entity"><span>action</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                          </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lev</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>msg</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span>
                                </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>msg'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>msg</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>msg'</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                                </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>Phi_Reasoner.warn_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>chunks</span><span> </span><span class="main"><span>(</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Automation Fail:"</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>msg'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span>
                              </span><span class="entity"><span>ctxt</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                    </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ruless</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Dep</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>normalize</span></span><span> </span><span class="entity"><span>th</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>th</span></span><span>
  </span><span>|&gt;</span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract</span></span><span>
  </span><span>|&gt;</span><span> </span><span>Drule.zero_var_indexes</span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invoke_template_action</span></span><span> </span><span class="entity"><span>template_pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Instantiate_Rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>template</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pass</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>action</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bind</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                           </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>positioned_props</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
      </span><span class="entity"><span>PLPR_Rule_Gen.invoke_generation</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>template_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pass</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>action</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>bind</span></span><span class="main"><span>)</span></span><span>
                                      </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>positioned_props</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
  </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>invoke_template_action</span></span><span> </span><span class="entity"><span>template_pos</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Free_Action</span></span><span> </span><span class="entity"><span>action</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span>
      </span><span class="entity"><span>Phi_Reasoner.info_pretty_generic</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
          </span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"invoking free template"</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>]</span></span><span> </span><span>@</span><span> </span><span>here</span><span> </span><span class="entity"><span>template_pos</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span>
      </span><span class="entity"><span>action</span></span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>apsnd</span><span> </span><span class="main"><span>(</span></span><span>Thm.transfer</span><span> </span><span class="main"><span>(</span></span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>arg</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>Automation_Fail</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>lev</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span>
        </span><span class="entity"><span>Phi_Reasoner.warn_pretty</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>lev</span></span><span> </span><span class="main"><span>(</span></span><span>Pretty.chunks</span><span> </span><span>o</span><span> </span><span class="entity"><span>prt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span>
        </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invoke_template</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>deps</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>action</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
</span><span class="main"><span>(</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>action</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="entity"><span>Instantiate_Rule</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span>SOME</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Binding.name_of</span><span> </span><span class="entity"><span>b</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="inner_quoted"><span>"aaaa"</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="comment1"><span>(*debug usage*)</span></span><span>
    </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span class="main"><span>;</span></span><span>

  </span><span class="entity"><span>check_dependencies</span></span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>invoke_template_action</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>action</span></span><span class="main"><span>)</span></span><span>

</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_template</span></span><span> </span><span class="entity"><span>invoke_on_existing_instantiations</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>:</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Reasoner.info_pretty_generic</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="inner_numeral"><span>1</span></span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span>
               </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>chunks</span><span> </span><span class="main"><span>(</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Registering reasoning rule template depending on "</span></span><span> </span><span>::</span><span>
                    </span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>item</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span class="main"><span>]</span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>pp</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>item</span><span> </span><span class="main"><span>[</span></span><span>Context.cases</span><span> </span><span>Syntax.pretty_term_global</span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pp</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                        </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invk_on_existing_instantiations</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>existing_ins</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>existing_instantiations_of_parameters</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>invoke_template_action</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span>
                                                           </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>3</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span>
                                                           </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>2</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>env</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>rules</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                 </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>existing_ins</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>template'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>trim_template</span></span><span> </span><span class="entity"><span>template</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>id</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>serial</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>negatize_param</span></span><span> </span><span class="entity"><span>param</span></span><span> </span><span class="main"><span>=</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>maxidx_of_term</span><span> </span><span class="entity"><span>param</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span class="entity"><span>idx</span></span><span> </span><span>&gt;=</span><span> </span><span class="inner_numeral"><span>0</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span>Logic.incr_indexes</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span class="inner_numeral"><span>~1</span></span><span>-</span><span class="entity"><span>idx</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>param</span></span><span> </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>param</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compact_deps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map_filter</span><span> </span><span>I</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>fold_types</span><span> </span><span>Term.declare_typ_names</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>compact_deps</span></span><span> </span><span>Name.context</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm_frees</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Term.declare_term_frees</span><span> </span><span class="entity"><span>compact_deps</span></span><span> </span><span>Name.context</span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Term.add_tvars</span><span> </span><span class="entity"><span>compact_deps</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm_vars</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold</span><span> </span><span>Term.add_vars</span><span> </span><span class="entity"><span>compact_deps</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_fixes_names</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span>Name.variant</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ty_vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ty_frees</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>tm_fixes_names</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>fold_map</span><span> </span><span>Name.variant</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span>fst</span><span> </span><span>o</span><span> </span><span>fst</span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm_vars</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm_frees</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>tm_fixes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.build</span><span> </span><span class="main"><span>(</span></span><span>fold2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>Ty</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>fix</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Vartab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>Ty</span></span><span class="main"><span>,</span></span><span> </span><span>Free</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Ty</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>tm_vars</span></span><span> </span><span class="entity"><span>tm_fixes_names</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ty_fixes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.build</span><span> </span><span class="main"><span>(</span></span><span>fold2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>fix</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Vartab.update_new</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>S</span></span><span class="main"><span>,</span></span><span> </span><span>TFree</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>fix</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>S</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ty_vars</span></span><span> </span><span class="entity"><span>ty_fixes_names</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>tm_fixes_of</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.build</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Vartab.update_new</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Vartab.lookup_key</span><span> </span><span class="entity"><span>tm_fixes</span></span><span> </span><span class="entity"><span>N</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Term.add_vars</span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>ty_fixes_of</span></span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Vartab.build</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Vartab.update_new</span><span> </span><span class="main"><span>(</span></span><span>the</span><span> </span><span class="main"><span>(</span></span><span>Vartab.lookup_key</span><span> </span><span class="entity"><span>ty_fixes</span></span><span> </span><span class="entity"><span>N</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>Term.add_tvars</span><span> </span><span class="entity"><span>tm</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>compact_deps</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>dep</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>forall</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>d</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
              </span><span>pointer_eq</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span class="main"><span>,</span></span><span class="entity"><span>dep</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span>
              </span><span>not</span><span> </span><span class="main"><span>(</span></span><span>can</span><span> </span><span class="main"><span>(</span></span><span>Pattern.match</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>d</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>dep</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>ty_fixes_of</span></span><span> </span><span class="entity"><span>dep</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>tm_fixes_of</span></span><span> </span><span class="entity"><span>dep</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
            </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>compact_deps</span></span><span>
          </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>compact_deps</span></span><span>

   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Templates.map</span><span> </span><span class="main"><span>(</span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>param</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Net.insert_term_safe</span><span> </span><span class="entity"><span>template_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>id</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>negatize_param</span></span><span> </span><span class="entity"><span>param</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>template'</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>compact_deps</span></span><span>
      </span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>invoke_on_existing_instantiations</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>invk_on_existing_instantiations</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>invoke_instantiations_on_property</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop_concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>property</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>templates</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Templates.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>Net.unify_term</span><span> </span><span class="entity"><span>templates</span></span><span> </span><span class="entity"><span>prop_concl</span></span><span>
   </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>param</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Term.could_unify</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>param</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop_concl</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>distinct</span><span> </span><span class="entity"><span>template_eq</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>templates</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>template</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>invoke_template</span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>templates</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(*fun list_functors ctxt =
  Net.unify_term (Properties.get ctxt) (net_encode_phityp (Var(("uu",0),TVar(("'uu",0),[]))))
    |&gt; map (fn (tm,_,_) =&gt; Logic.incr_indexes ([],[],1) tm)*)</span></span><span>

</span><span class="comment1"><span>(* fun is_a_registered_functor_i thy net the_functor =
  let val key = net_encode_phityp the_functor
   in Net.match_term net key
        |&gt; exists (fn (pat, _) =&gt; Pattern.matches thy (pat, the_functor))
  end *)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>adding_property</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="PLPR.\&lt;phi&gt;adding_property|attribute"><span>φadding_property</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>
</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>invoking_instantiations</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Attrib.setup_config_bool</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="PLPR.\&lt;phi&gt;invoking_property_instantiation|attribute"><span>φinvoking_property_instantiation</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>K</span><span> </span><span>true</span><span class="main"><span>)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_property_instance</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>property</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop_concl</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>property</span></span><span>
      </span><span class="comment1"><span>(*val key_phityp = net_encode_phityp phityp'*)</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>exception</span></span></span><span> </span><span class="entity"><span>SKIP</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_clashes</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Properties.get</span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>clashes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Net.unify_term</span><span> </span><span class="entity"><span>net</span></span><span> </span><span class="entity"><span>prop_concl</span></span><span>
                       </span><span>|&gt;</span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop'</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pattern.matches</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_concl</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>prop'</span></span><span class="main"><span>)</span></span><span>
                                            </span><span class="keyword1"><span class="keyword"><span>orelse</span></span></span><span> </span><span>Pattern.matches</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.concl_of</span><span> </span><span class="entity"><span>prop'</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop_concl</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>null</span><span> </span><span class="entity"><span>clashes</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span>
                 </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
             </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>warning</span><span> </span><span class="main"><span>(</span></span><span>string_of</span><span> </span><span class="main"><span>(</span></span><span>chunks</span><span> </span><span class="main"><span>(</span></span><span>
                  </span><span class="main"><span>[</span></span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"The given property either covers or is covered by other existing properties."</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"Given property:"</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                          </span><span>Context.cases</span><span> </span><span>Thm.pretty_thm_global</span><span> </span><span>Thm.pretty_thm</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span>
                   </span><span>block</span><span> </span><span class="main"><span>[</span></span><span>str</span><span> </span><span class="inner_quoted"><span>"Clashes"</span></span><span class="main"><span>,</span></span><span> </span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span>
                          </span><span>chunks</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>block</span><span> </span><span class="main"><span>(</span></span><span>
                                     </span><span>here</span><span> </span><span class="entity"><span>pos</span></span><span> </span><span>@</span><span> </span><span class="main"><span>[</span></span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span>
                                   </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>clashes</span></span><span class="main"><span>)</span></span><span class="main"><span>]</span></span><span class="main"><span>,</span></span><span>
                   </span><span>para</span><span> </span><span class="inner_quoted"><span>"We prohibit redundancy of φ-type properties as the redundancy \
                       \would be multiplied by template instantiation.\n\
                       \No automation will be invoked on this.\n\
                       \Instead, you should provide the most general rule and, if you want, \
                       \specialized (branched) reasoning on its antecedents."</span></span><span class="main"><span>]</span></span><span>
                 </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>;</span></span><span>
                </span><span class="keyword3"><span class="keyword"><span>raise</span></span></span><span> </span><span class="entity"><span>SKIP</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>property</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Thm.trim_context</span><span> </span><span class="entity"><span>property</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>chk_clashes</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Properties.map</span><span> </span><span class="main"><span>(</span></span><span>Net.insert_term</span><span> </span><span class="entity"><span>property_eq</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_concl</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                    </span><span class="comment1"><span>(*|&gt; insert_term false (key_phityp, (phityp',pos,Drule.dummy_thm))*)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Config.get_generic</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>invoking_instantiations</span></span><span> </span><span>?</span><span> </span><span class="entity"><span>invoke_instantiations_on_property</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>property</span></span><span class="main"><span>)</span></span><span>
      </span><span class="comment1"><span>(*Note: must ensure the property theorem inserted into the Net Data must be pointer-equal to
        the one sent to ‹invoke_instantiations_on_property›*)</span></span><span>
                    
   </span><span class="keyword3"><span class="keyword"><span>handle</span></span></span><span> </span><span class="entity"><span>SKIP</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
 </span><span class="comment1"><span>(* handle Net.INSERT =&gt; let open Pretty
      val term = Context.cases Syntax.pretty_term_global Syntax.pretty_term
       in error (string_of (chunks [
              block [str "On functor ", term ctxt the_functor,
                     str ", the following property has already been registered"],
              term ctxt (Thm.concl_of property)
            ]))
      end *)</span></span><span>
 </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_property_kinds</span></span><span> </span><span class="entity"><span>ks</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>add_prop</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rules'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>filter</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>Pattern.matches</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span>Thm.concl_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>fold</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>add_property_instance</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rules'</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>thy</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Property_Kinds.map</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>Net.insert_term</span><span> </span><span class="main"><span>(</span></span><span>Pattern.equiv</span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>o</span><span> </span><span class="entity"><span>trim_modifiers</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ks</span></span><span class="main"><span>)</span></span><span>
   </span><span>|&gt;</span><span> </span><span>Context.theory_map</span><span> </span><span class="main"><span>(</span></span><span>fold</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>k'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>trim_modifiers</span></span><span> </span><span class="entity"><span>k</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">const_name</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.term</span><span>›</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span>
                        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>X</span></span><span>
            </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>name</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span>Term.head_of</span><span> </span><span class="entity"><span>k'</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>Const</span><span class="main"><span>(</span></span><span class="entity"><span>N</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>N</span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"Bad Property: must be a predicate"</span></span><span>
         </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>Phi_Reasoner.add_pass</span></span><span> </span><span class="main"><span>(</span></span><span>Const</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>"property$"</span></span><span> </span><span>^</span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span>TFree</span><span class="main"><span>(</span></span><span class="inner_quoted"><span>""</span></span><span class="main"><span>,</span></span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>k</span></span><span class="main"><span>,</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                           </span><span class="main"><span>(</span></span><span class="entity"><span>rules</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>,</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Config.get_generic</span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>adding_property</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="entity"><span>add_prop</span></span><span> </span><span class="entity"><span>k</span></span><span> </span><span class="entity"><span>pos</span></span><span> </span><span class="entity"><span>rules</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
                            </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
        </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>ks</span></span><span class="main"><span>)</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>


</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>setup_rule_generation</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>template_pos</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>raw_dependencies</span></span><span class="main"><span>,</span></span><span class="entity"><span>pass</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>b</span></span><span class="main"><span>,</span></span><span class="entity"><span>gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>rule0</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.theory_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>rule</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>normalize</span></span><span> </span><span class="entity"><span>rule0</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>is_prop</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>check_property</span></span><span> </span><span class="entity"><span>thy</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>trim_Pure_term</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.term</span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>prop</span><span>›</span></span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>trim_Pure_term</span></span><span> </span><span class="main"><span>(</span></span><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Const</span><span class="hidden">&gt;</span></span></span><span>‹</span><span>Pure.term</span><span> </span><span class="quoted"><span class="antiquoted"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">Type</span><span class="hidden">&gt;</span></span></span><span>‹</span><a class="entity_ref" href="../../../../../../../HOL/HOL/HOL.html#HOL.bool|type"><span>bool</span></a><span>›</span></span></span><span>›</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>HOLogic.Trueprop</span></span><span> </span><span>$</span><span> </span><span class="entity"><span>X</span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>trim_Pure_term</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>X</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>get_prop_kinds</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>TM</span></span><span>::</span><span class="entity"><span>L</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>base</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>get_prop_kinds</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span class="main"><span>[</span></span><span>NONE</span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>L</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="entity"><span>L</span></span><span>
            </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>is_prop</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>trim_Pure_term</span></span><span> </span><span class="entity"><span>TM</span></span><span class="main"><span>)</span></span><span> </span><span>::</span><span> </span><span class="entity"><span>base</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
        </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>get_prop_kinds</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prop_kinds</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>raw_dependencies</span></span><span>
                         </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>SOME</span><span> </span><span class="entity"><span>deps</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>List.map</span><span> </span><span class="main"><span>(</span></span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>assert_property_pattern</span></span><span> </span><span class="entity"><span>thy</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>deps</span></span><span>
                          </span><span class="main"><span>|</span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="entity"><span>Phi_Help.strip_meta_hhf</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prems_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span>
                                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>used</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Term.add_frees</span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>rule</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span>|&gt;</span><span> </span><span>map</span><span> </span><span>fst</span><span>
                                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>burrow</span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span>Free</span><span> </span><span>o</span><span> </span><span>burrow_fst</span><span> </span><span class="main"><span>(</span></span><span>Name.variant_list</span><span> </span><span class="entity"><span>used</span></span><span> </span><span>o</span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span>prefix</span><span> </span><span class="inner_quoted"><span>"%"</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="main"><span>#</span></span><span class="inner_numeral"><span>1</span></span><span> </span><span class="entity"><span>prems</span></span><span class="main"><span>)</span></span><span>
                                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map2</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>fixes</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>subst_bounds</span><span> </span><span class="main"><span>(</span></span><span>rev</span><span> </span><span class="entity"><span>fixes</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>x</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems</span></span><span> </span><span class="entity"><span>fixes</span></span><span>
                                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>inst</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.instantiate_higher_order_var</span></span><span> </span><span class="main"><span>[</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>prems'</span></span><span>
                                        </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>prems'1</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>map</span><span> </span><span class="main"><span>(</span></span><span> </span><span>Term_Subst.instantiate</span><span> </span><span class="main"><span>(</span></span><span>TVars.empty</span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>inst</span></span><span class="main"><span>)</span></span><span>
                                                         </span><span>#&gt;</span><span> </span><span class="entity"><span>Phi_Help.beta_eta_contract_term</span></span><span> </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>prems'</span></span><span>
                                     </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>get_prop_kinds</span></span><span> </span><span class="entity"><span>prems'1</span></span><span>
                                    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
      </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>template</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>prop_kinds</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>template_pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>Instantiate_Rule</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>rule</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pass</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>gen</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>b</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
   </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
   </span><span>|&gt;</span><span> </span><span class="entity"><span>add_template</span></span><span> </span><span>true</span><span> </span><span class="entity"><span>template</span></span><span>
  </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="comment1"><span>(** Interfaces for Automation over Property **)</span></span><span>


</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Theory.setup</span><span> </span><span class="main"><span>(</span></span><span>

  </span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="PLPR.\&lt;phi&gt;type_property|attribute"><span>φtype_property</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>Scan.succeed</span><span> </span><span class="main"><span>(</span></span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span>curry</span><span> </span><span class="entity"><span>add_property_instance</span></span><span> </span><span>Position.none</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="inner_quoted"><span>"Declare a φ-type property that will be used to instantiate automation"</span></span><span>

</span><span>#&gt;</span><span class="entity"><span>Attrib.setup</span></span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">binding</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="entity_def" id="PLPR.\&lt;phi&gt;reason_template|attribute"><span>φreason_template</span></span><span>›</span></span></span><span> </span><span class="main"><span>(</span></span><span>
    </span><span class="entity"><span>Phi_Reasoner.attr_syntax</span></span><span>
      </span><span class="main"><span>(</span></span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"name"</span></span><span> </span><span>|--</span><span> </span><span>Scan.option</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>:</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.position</span><span> </span><span>Parse.long_ident</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span>--</span><span> </span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>
             </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>requires</span></span><span>›</span></span></span><span> </span><span>|--</span><span>
                </span><span class="main"><span>(</span></span><span>Parse.and_list</span><span> </span><span class="main"><span>(</span></span><span>Scan.repeat</span><span> </span><span class="main"><span>(</span></span><span>  </span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"_"</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>K</span><span> </span><span>NONE</span><span>
                                             </span><span>||</span><span> </span><span>Parse.term</span><span> </span><span>&gt;&gt;</span><span> </span><span>SOME</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span>&gt;&gt;</span><span> </span><span>flat</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span class="main"><span>(</span></span><span>Scan.lift</span><span> </span><span class="main"><span>(</span></span><span>Args.$$$</span><span> </span><span class="inner_quoted"><span>"pass"</span></span><span> </span><span>|--</span><span> </span><span class="antiquoted"><span class="entity"><span class="operator"><span><span class="hidden">\&lt;^</span><span class="control">keyword</span><span class="hidden">&gt;</span></span></span><span>‹</span><span class="keyword2"><span>:</span></span><span>›</span></span></span><span> </span><span>|--</span><span> </span><span>Parse.ML_source</span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
       </span><span>--</span><span> </span><span>Scan.option</span><span> </span><span class="entity"><span>Attrib.attribs</span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prio_group</span></span><span class="main"><span>,</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="main"><span>(</span></span><span class="entity"><span>raw_binding</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>raw_dependencies</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pass_src</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="entity"><span>attribs</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>guard</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
        </span><span>Thm.declaration_attribute</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Context.proof_of</span><span> </span><span class="entity"><span>ctxt</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>_</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>ctxt_parse</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.import</span><span> </span><span>true</span><span> </span><span class="main"><span>[</span></span><span class="entity"><span>thm</span></span><span class="main"><span>]</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>read_props</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.export_terms</span><span> </span><span class="entity"><span>ctxt_parse</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>o</span><span>
                               </span><span>Syntax.read_props</span><span> </span><span class="main"><span>(</span></span><span>Proof_Context.set_mode</span><span> </span><span>Proof_Context.mode_pattern</span><span> </span><span class="entity"><span>ctxt_parse</span></span><span class="main"><span>)</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>read_terms</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Variable.export_terms</span><span> </span><span class="entity"><span>ctxt_parse</span></span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span>o</span><span>
                               </span><span>Syntax.read_terms</span><span> </span><span class="entity"><span>ctxt_parse</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>dependencies</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span>burrow_options</span><span> </span><span class="entity"><span>read_props</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_dependencies</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>chk_binding_target</span></span><span> </span><span class="main"><span>(</span></span><span>Var</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>v</span></span><span class="main"><span>,</span></span><span class="main"><span>_</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>v</span></span><span>
                </span><span class="main"><span>|</span></span><span> </span><span class="entity"><span>chk_binding_target</span></span><span> </span><span class="entity"><span>X</span></span><span> </span><span class="main"><span>=</span></span><span>
                      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span>string_of</span><span> </span><span class="main"><span>(</span></span><span>
                            </span><span>block</span><span> </span><span class="main"><span>(</span></span><span>text</span><span> </span><span class="inner_quoted"><span>"The binding of the template instances must binds to a \
                                        \variable in the template that will be instantaited to to φ-type.\
                                        \ However, the given binding target is not a variable,"</span></span><span> </span><span>@</span><span>
                                   </span><span class="main"><span>[</span></span><span>brk</span><span> </span><span class="inner_numeral"><span>1</span></span><span class="main"><span>,</span></span><span> </span><span>Syntax.pretty_term</span><span> </span><span class="entity"><span>ctxt'</span></span><span> </span><span class="entity"><span>X</span></span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span>
                          </span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
                    
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>binding</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span>Option.map</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>long_name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>qualifiers</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>name</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>Phi_Help.split_last</span></span><span> </span><span class="main"><span>(</span></span><span>Long_Name.explode</span><span> </span><span class="entity"><span>long_name</span></span><span class="main"><span>)</span></span><span>
                       </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="main"><span>(</span></span><span>map</span><span> </span><span class="entity"><span>chk_binding_target</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>read_terms</span></span><span> </span><span class="entity"><span>qualifiers</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span> </span><span>Binding.make</span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>name</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pos</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
                      </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
                    </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>raw_binding</span></span><span>

              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="keyword2"><span class="keyword"><span>case</span></span></span><span> </span><span class="entity"><span>guard</span></span><span> </span><span class="keyword2"><span class="keyword"><span>of</span></span></span><span> </span><span>NONE</span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
                         </span><span class="main"><span>|</span></span><span> </span><span class="main"><span>_</span></span><span> </span><span class="main"><span>=&gt;</span></span><span> </span><span>error</span><span> </span><span class="inner_quoted"><span>"No guard is allowed here"</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>pass</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Rule_Gen.parse_pass</span></span><span> </span><span class="entity"><span>ctxt</span></span><span> </span><span class="entity"><span>pass_src</span></span><span>
              </span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>gen</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Rule_Gen.parse_action</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>mode</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prio_group</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>pats</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>attribs</span></span><span class="main"><span>)</span></span><span>
           </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span> </span><span class="entity"><span>setup_rule_generation</span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>pos</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>dependencies</span></span><span class="main"><span>,</span></span><span class="entity"><span>pass</span></span><span class="main"><span>)</span></span><span class="main"><span>,</span></span><span class="main"><span>(</span></span><span class="entity"><span>binding</span></span><span class="main"><span>,</span></span><span class="entity"><span>gen</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>thm</span></span><span> </span><span class="entity"><span>ctxt</span></span><span>
          </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span class="main"><span>)</span></span><span>
      </span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
  </span><span class="inner_quoted"><span>"declare a φreasoning rule template which will be instantiated automatically when the depended \
  \properties are given for a φ-type (operator).\n\
  \The properties must be in the leading antecedents and must be about an identical φ-type \
  \(of potential different type instantiations so therefore be represented by different fixed free variables).\n\
  \It is able to parse the depended properties from the leading antecedents greedily for all possible, \
  \and may caputre more dependencies than the expected. If so, you can specify the exact dependency \
  \explicilty by [[φreason_template requires ‹dependencies›]]"</span></span><span>
</span><span class="main"><span>)</span></span><span>


</span><span class="comment1"><span>(** Developer Tools **)</span></span><span>

</span><span class="keyword1"><span class="keyword"><span>fun</span></span></span><span> </span><span class="entity"><span>assert_derived_properties</span></span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>th_prop_pairs</span></span><span> </span><span class="main"><span>=</span></span><span>
  </span><span>List.app</span><span> </span><span class="main"><span>(</span></span><span class="keyword1"><span class="keyword"><span>fn</span></span></span><span> </span><span class="main"><span>(</span></span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span> </span><span class="main"><span>=&gt;</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>if</span></span></span><span> </span><span>Pattern.equiv</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="main"><span>(</span></span><span>Thm.prop_of</span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span> </span><span class="entity"><span>prop</span></span><span class="main"><span>)</span></span><span> </span><span class="keyword2"><span class="keyword"><span>then</span></span></span><span> </span><span class="main"><span>(</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>else</span></span></span><span> </span><span class="keyword2"><span class="keyword"><span>let</span></span></span><span> </span><span class="keyword3"><span class="keyword"><span>open</span></span></span><span> </span><span>Pretty</span><span> </span><span class="keyword2"><span class="keyword"><span>in</span></span></span><span>
      </span><span>error</span><span> </span><span class="main"><span>(</span></span><span>string_of</span><span> </span><span class="main"><span>(</span></span><span>chunks</span><span> </span><span class="main"><span>[</span></span><span>
        </span><span>para</span><span> </span><span class="inner_quoted"><span>"The derived property"</span></span><span class="main"><span>,</span></span><span>
        </span><span>Thm.pretty_thm_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>th</span></span><span class="main"><span>,</span></span><span>
        </span><span>para</span><span> </span><span class="inner_quoted"><span>"fails to meet the desired assertion"</span></span><span class="main"><span>,</span></span><span>
        </span><span>Syntax.pretty_term_global</span><span> </span><span class="entity"><span>thy</span></span><span> </span><span class="entity"><span>prop</span></span><span>
      </span><span class="main"><span>]</span></span><span class="main"><span>)</span></span><span class="main"><span>)</span></span><span>
    </span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>
  </span><span class="main"><span>)</span></span><span> </span><span class="entity"><span>th_prop_pairs</span></span><span>

</span><span class="keyword2"><span class="keyword"><span>end</span></span></span><span>

</span><span class="keyword1"><span class="keyword"><span>val</span></span></span><span> </span><span class="entity"><span>assert_derived_properties</span></span><span> </span><span class="main"><span>=</span></span><span> </span><span class="entity"><span>PLPR_Template_Properties.assert_derived_properties</span></span><span>

</span></pre>
</body>

</html>